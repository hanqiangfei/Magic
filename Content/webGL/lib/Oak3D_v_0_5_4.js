(function(k){var c={ArrayBuffer:typeof ArrayBuffer!=="undefined",DataView:typeof DataView!=="undefined"&&"getFloat64" in DataView.prototype,NodeBuffer:typeof Buffer!=="undefined",NodeBufferFull:typeof Buffer!=="undefined"&&"readInt8LE" in Buffer,NodeBufferEndian:typeof Buffer!=="undefined"&&"readInt8" in Buffer};var e=function(l,o,m,p){if(!(this instanceof arguments.callee)){throw new Error("Constructor may not be called as a function")}this.buffer=l;if(!(c.NodeBuffer&&l instanceof Buffer)&&!(c.ArrayBuffer&&l instanceof ArrayBuffer)&&typeof l!=="string"){throw new TypeError("Type error")}this._isArrayBuffer=c.ArrayBuffer&&l instanceof ArrayBuffer;this._isDataView=c.DataView&&this._isArrayBuffer;this._isNodeBuffer=c.NodeBuffer&&l instanceof Buffer;this._littleEndian=p===undefined?true:p;var n=this._isArrayBuffer?l.byteLength:l.length;if(o===undefined){o=0}this.byteOffset=o;if(m===undefined){m=n-o}this.byteLength=m;if(!this._isDataView){if(typeof o!=="number"){throw new TypeError("Type error")}if(typeof m!=="number"){throw new TypeError("Type error")}if(typeof o<0){throw new Error("INDEX_SIZE_ERR: DOM Exception 1")}if(typeof m<0){throw new Error("INDEX_SIZE_ERR: DOM Exception 1")}}if(this._isDataView){this._view=new DataView(l,o,m);this._start=0}this._start=o;if(o+m>n){throw new Error("INDEX_SIZE_ERR: DOM Exception 1")}this._offset=0};e.createBuffer=function(){if(c.NodeBuffer){var m=new Buffer(arguments.length);for(var n=0;n<arguments.length;++n){m[n]=arguments[n]}return m}if(c.ArrayBuffer){var m=new ArrayBuffer(arguments.length);var l=new Int8Array(m);for(var n=0;n<arguments.length;++n){l[n]=arguments[n]}return m}return String.fromCharCode.apply(null,arguments)};e.prototype={getString:function(o,n){var p;if(n===undefined){n=this._offset}if(typeof n!=="number"){throw new TypeError("Type error")}if(o<0||n+o>this.byteLength){throw new Error("INDEX_SIZE_ERR: DOM Exception 1")}if(this._isNodeBuffer){p=this.buffer.toString("ascii",this._start+n,this._start+n+o)}else{p="";for(var l=0;l<o;++l){var m=this.getUint8(n+l);p+=String.fromCharCode(m>127?65533:m)}}this._offset=n+o;return p},getChar:function(l){return this.getString(1,l)},tell:function(){return this._offset},seek:function(l){if(typeof l!=="number"){throw new TypeError("Type error")}if(l<0||l>this.byteLength){throw new Error("INDEX_SIZE_ERR: DOM Exception 1")}return this._offset=l},_endianness:function(m,o,l,n){return m+(n?l-o-1:o)},_getFloat64:function(o,l){var y=this._getUint8(this._endianness(o,0,8,l)),x=this._getUint8(this._endianness(o,1,8,l)),w=this._getUint8(this._endianness(o,2,8,l)),u=this._getUint8(this._endianness(o,3,8,l)),t=this._getUint8(this._endianness(o,4,8,l)),s=this._getUint8(this._endianness(o,5,8,l)),q=this._getUint8(this._endianness(o,6,8,l)),p=this._getUint8(this._endianness(o,7,8,l)),n=1-(2*(y>>7)),v=((((y<<1)&255)<<3)|(x>>4))-(Math.pow(2,10)-1),m=((x&15)*Math.pow(2,48))+(w*Math.pow(2,40))+(u*Math.pow(2,32))+(t*Math.pow(2,24))+(s*Math.pow(2,16))+(q*Math.pow(2,8))+p;if(v===1024){if(m!==0){return NaN}else{return n*Infinity}}if(v===-1023){return n*m*Math.pow(2,-1022-52)}return n*(1+m*Math.pow(2,-52))*Math.pow(2,v)},_getFloat32:function(n,l){var u=this._getUint8(this._endianness(n,0,4,l)),t=this._getUint8(this._endianness(n,1,4,l)),s=this._getUint8(this._endianness(n,2,4,l)),p=this._getUint8(this._endianness(n,3,4,l)),o=1-(2*(u>>7)),q=(((u<<1)&255)|(t>>7))-127,m=((t&127)<<16)|(s<<8)|p;if(q===128){if(m!==0){return NaN}else{return o*Infinity}}if(q===-127){return o*m*Math.pow(2,-126-23)}return o*(1+m*Math.pow(2,-23))*Math.pow(2,q)},_getInt32:function(m,n){var l=this._getUint32(m,n);return l>Math.pow(2,31)-1?l-Math.pow(2,32):l},_getUint32:function(p,q){var l=this._getUint8(this._endianness(p,0,4,q)),m=this._getUint8(this._endianness(p,1,4,q)),n=this._getUint8(this._endianness(p,2,4,q)),o=this._getUint8(this._endianness(p,3,4,q));return(l*Math.pow(2,24))+(m<<16)+(n<<8)+o},_getInt16:function(m,n){var l=this._getUint16(m,n);return l>Math.pow(2,15)-1?l-Math.pow(2,16):l},_getUint16:function(n,o){var l=this._getUint8(this._endianness(n,0,2,o)),m=this._getUint8(this._endianness(n,1,2,o));return(l<<8)+m},_getInt8:function(m){var l=this._getUint8(m);return l>Math.pow(2,7)-1?l-Math.pow(2,8):l},_getUint8:function(l){if(this._isArrayBuffer){return new Uint8Array(this.buffer,l,1)[0]}else{if(this._isNodeBuffer){return this.buffer[l]}else{return this.buffer.charCodeAt(l)&255}}}};var h={Int8:1,Int16:2,Int32:4,Uint8:1,Uint16:2,Uint32:4,Float32:4,Float64:8};var d={Int8:"Int8",Int16:"Int16",Int32:"Int32",Uint8:"UInt8",Uint16:"UInt16",Uint32:"UInt32",Float32:"Float",Float64:"Double"};for(var f in h){if(!h.hasOwnProperty(f)){continue}(function(m){var l=h[m];e.prototype["get"+m]=function(n,p){var o;if(p===undefined){p=this._littleEndian}if(n===undefined){n=this._offset}if(this._isDataView){o=this._view["get"+m](n,p)}else{if(this._isArrayBuffer&&(this._start+n)%l===0&&(l===1||p)){o=new k[m+"Array"](this.buffer,this._start+n,1)[0]}else{if(this._isNodeBuffer&&c.NodeBufferFull){if(p){o=this.buffer["read"+d[m]+"LE"](this._start+n)}else{o=this.buffer["read"+d[m]+"BE"](this._start+n)}}else{if(this._isNodeBuffer&&c.NodeBufferEndian){o=this.buffer["read"+d[m]](this._start+n,p)}else{if(typeof n!=="number"){throw new TypeError("Type error")}if(n+l>this.byteLength){throw new Error("INDEX_SIZE_ERR: DOM Exception 1")}o=this["_get"+m](this._start+n,p)}}}}this._offset=n+l;return o}})(f)}if(typeof jQuery!=="undefined"&&jQuery.fn.jquery>="1.6.2"){var a=function(m){var o;try{o=IEBinaryToArray_ByteStr(m)}catch(t){var n="Function IEBinaryToArray_ByteStr(Binary)\r\n	IEBinaryToArray_ByteStr = CStr(Binary)\r\nEnd Function\r\nFunction IEBinaryToArray_ByteStr_Last(Binary)\r\n	Dim lastIndex\r\n	lastIndex = LenB(Binary)\r\n	if lastIndex mod 2 Then\r\n		IEBinaryToArray_ByteStr_Last = AscB( MidB( Binary, lastIndex, 1 ) )\r\n	Else\r\n		IEBinaryToArray_ByteStr_Last = -1\r\n	End If\r\nEnd Function\r\n";window.execScript(n,"vbscript");o=IEBinaryToArray_ByteStr(m)}var q=IEBinaryToArray_ByteStr_Last(m),v="",s=0,p=o.length%8,u;while(s<p){u=o.charCodeAt(s++);v+=String.fromCharCode(u&255,u>>8)}p=o.length;while(s<p){v+=String.fromCharCode((u=o.charCodeAt(s++),u&255),u>>8,(u=o.charCodeAt(s++),u&255),u>>8,(u=o.charCodeAt(s++),u&255),u>>8,(u=o.charCodeAt(s++),u&255),u>>8,(u=o.charCodeAt(s++),u&255),u>>8,(u=o.charCodeAt(s++),u&255),u>>8,(u=o.charCodeAt(s++),u&255),u>>8,(u=o.charCodeAt(s++),u&255),u>>8)}if(q>-1){v+=String.fromCharCode(q)}return v};jQuery.ajaxSetup({converters:{"* dataview":function(l){return new e(l)}},accepts:{dataview:"text/plain; charset=x-user-defined"},responseHandler:{dataview:function(m,l,n){if("mozResponseArrayBuffer" in n){m.text=n.mozResponseArrayBuffer}else{if("responseType" in n&&n.responseType==="arraybuffer"&&n.response){m.text=n.response}else{if("responseBody" in n){m.text=a(n.responseBody)}else{m.text=n.responseText}}}}}});jQuery.ajaxPrefilter("dataview",function(l,n,m){if(jQuery.support.ajaxResponseType){if(!l.hasOwnProperty("xhrFields")){l.xhrFields={}}l.xhrFields.responseType="arraybuffer"}l.mimeType="text/plain; charset=x-user-defined"})}k.jDataView=(k.module||{}).exports=e})(this);var OAK={ERROR:0,TYPE_VEC2:1,TYPE_VEC3:2,TYPE_VEC4:4,TYPE_MAT4:8,TYPE_MAT43:16,AXIS_X:1,AXIS_Y:2,AXIS_Z:3,COLLIDE_FALSE:0,COLLIDE_TRUE:1,COLLIDE_CONTAIN:2,SPACE_LOCAL:1,SPACE_PARENT:2,SPACE_WORLD:3,SPACE_VIEW:4,BBOX_AABB:1,BBOX_OBB:2,FLOAT_PRECISION:0.000001,PROJMODE_PERSPECTIVE:1,PROJMODE_ORTHO:2,FTPLANE_NEAR:0,FTPLANE_FAR:1,FTPLANE_LEFT:2,FTPLANE_RIGHT:3,FTPLANE_TOP:4,FTPLANE_BOTTOM:5,SKBLEND_ACCUMULATE:1,SKBLEND_LERP:2,BLENDCHANNEL_COLOR:1,BLENDCHANNEL_ALPHA:2,BLENDCHANNEL_ALL:3,MCUSAGE_ALBEDO1:0,MCUSAGE_ALBEDO2:1,MCUSAGE_ALBEDO3:2,MCUSAGE_ALBEDO4:3,MCUSAGE_NORMAL:4,MCUSAGE_OPACITY:5,MCUSAGE_SPECULAR_LEVEL:6,ETYPE_UNKNOWN:0,ETYPE_STATIC:1,ETYPE_DYNAMIC:2,ETYPE_DCT_LIGHT:4,ETYPE_POINT_LIGHT:8,ETYPE_SPOT_LIGHT:16,ETYPE_TERRAIN:32,ETYPE_CUSTOM_MESH:64,ETYPE_VIDEO:128,ETYPE_PARTICLE:256,ETYPE_CONFIG:512,ETYPE_LIGHT:(4|8|16),ETYPE_VISIBLE:(1|2|32|64|128|256),ETYPE_INTREE:(1|2|32|64|128|256),ETYPE_UPDATE:(2|256),ETYPE_ALL:4294967295,ESTATE_UNAVAILABLE:1,ESTATE_BASIC_AVAILABLE:2,ESTATE_COMPLETE_AVAILABLE:4,RESDOCTYPE_XML:1,RESDOCTYPE_JSON:2,RESDOCTYPE_BINARY:3,RESTYPE_UNKNOWN:0,RESTYPE_MODEL:1,RESTYPE_TEXTURE:2,RESTYPE_SKANIMATION:3,RESSTATE_NONE:1,RESSTATE_UNLOAD:2,RESSTATE_LOADING:3,RESSTATE_LOADED:4,RESSTATE_READY:5,RESPRIORITY_HIGH:1,RESPRIORITY_NORMAL:2,RESPRIORITY_LOW:3,ENV_FOG1:1,RSTAGE_DEPTH:0,RSTAGE_SHADOW:1,RSTAGE_LIGHTING:2,WORLDMAP_NOT_READ:1,WORLDMAP_PARSING:2,WORLDMAP_PARSED:3,TEXTURE_IMAGE:1,TEXTURE_VIDEO:2,PARTIME_BEGIN:1,PARTIME_END:2,PARTIME_ALL:4294967295,DEPTH_BUFFER_BIT:256,STENCIL_BUFFER_BIT:1024,COLOR_BUFFER_BIT:16384,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773,DST_COLOR:774,ONE_MINUS_DST_COLOR:775,SRC_ALPHA_SATURATE:776,FUNC_ADD:32774,BLEND_EQUATION:32777,BLEND_EQUATION_RGB:32777,BLEND_EQUATION_ALPHA:34877,FUNC_SUBTRACT:32778,FUNC_REVERSE_SUBTRACT:32779,BLEND_DST_RGB:32968,BLEND_SRC_RGB:32969,BLEND_DST_ALPHA:32970,BLEND_SRC_ALPHA:32971,CONSTANT_COLOR:32769,ONE_MINUS_CONSTANT_COLOR:32770,CONSTANT_ALPHA:32771,ONE_MINUS_CONSTANT_ALPHA:32772,BLEND_COLOR:32773,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,ARRAY_BUFFER_BINDING:34964,ELEMENT_ARRAY_BUFFER_BINDING:34965,STREAM_DRAW:35040,STATIC_DRAW:35044,DYNAMIC_DRAW:35048,BUFFER_SIZE:34660,BUFFER_USAGE:34661,CURRENT_VERTEX_ATTRIB:34342,FRONT:1028,BACK:1029,FRONT_AND_BACK:1032,CULL_FACE:2884,BLEND:3042,DITHER:3024,STENCIL_TEST:2960,DEPTH_TEST:2929,SCISSOR_TEST:3089,POLYGON_OFFSET_FILL:32823,SAMPLE_ALPHA_TO_COVERAGE:32926,SAMPLE_COVERAGE:32928,NO_ERROR:0,INVALID_ENUM:1280,INVALID_VALUE:1281,INVALID_OPERATION:1282,OUT_OF_MEMORY:1285,CW:2304,CCW:2305,LINE_WIDTH:2849,ALIASED_POINT_SIZE_RANGE:33901,ALIASED_LINE_WIDTH_RANGE:33902,CULL_FACE_MODE:2885,FRONT_FACE:2886,DEPTH_RANGE:2928,DEPTH_WRITEMASK:2930,DEPTH_CLEAR_VALUE:2931,DEPTH_FUNC:2932,STENCIL_CLEAR_VALUE:2961,STENCIL_FUNC:2962,STENCIL_FAIL:2964,STENCIL_PASS_DEPTH_FAIL:2965,STENCIL_PASS_DEPTH_PASS:2966,STENCIL_REF:2967,STENCIL_VALUE_MASK:2963,STENCIL_WRITEMASK:2968,STENCIL_BACK_FUNC:34816,STENCIL_BACK_FAIL:34817,STENCIL_BACK_PASS_DEPTH_FAIL:34818,STENCIL_BACK_PASS_DEPTH_PASS:34819,STENCIL_BACK_REF:36003,STENCIL_BACK_VALUE_MASK:36004,STENCIL_BACK_WRITEMASK:36005,VIEWPORT:2978,SCISSOR_BOX:3088,COLOR_CLEAR_VALUE:3106,COLOR_WRITEMASK:3107,UNPACK_ALIGNMENT:3317,PACK_ALIGNMENT:3333,MAX_TEXTURE_SIZE:3379,MAX_VIEWPORT_DIMS:3386,SUBPIXEL_BITS:3408,RED_BITS:3410,GREEN_BITS:3411,BLUE_BITS:3412,ALPHA_BITS:3413,DEPTH_BITS:3414,STENCIL_BITS:3415,POLYGON_OFFSET_UNITS:10752,POLYGON_OFFSET_FACTOR:32824,TEXTURE_BINDING_2D:32873,SAMPLE_BUFFERS:32936,SAMPLES:32937,SAMPLE_COVERAGE_VALUE:32938,SAMPLE_COVERAGE_INVERT:32939,NUM_COMPRESSED_TEXTURE_FORMATS:34466,COMPRESSED_TEXTURE_FORMATS:34467,DONT_CARE:4352,FASTEST:4353,NICEST:4354,GENERATE_MIPMAP_HINT:33170,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DEPTH_COMPONENT:6402,ALPHA:6406,RGB:6407,RGBA:6408,LUMINANCE:6409,LUMINANCE_ALPHA:6410,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,FRAGMENT_SHADER:35632,VERTEX_SHADER:35633,MAX_VERTEX_ATTRIBS:34921,MAX_VERTEX_UNIFORM_VECTORS:36347,MAX_VARYING_VECTORS:36348,MAX_COMBINED_TEXTURE_IMAGE_UNITS:35661,MAX_VERTEX_TEXTURE_IMAGE_UNITS:35660,MAX_TEXTURE_IMAGE_UNITS:34930,MAX_FRAGMENT_UNIFORM_VECTORS:36349,SHADER_TYPE:35663,DELETE_STATUS:35712,LINK_STATUS:35714,VALIDATE_STATUS:35715,ATTACHED_SHADERS:35717,ACTIVE_UNIFORMS:35718,ACTIVE_UNIFORM_MAX_LENGTH:35719,ACTIVE_ATTRIBUTES:35721,ACTIVE_ATTRIBUTE_MAX_LENGTH:35722,SHADING_LANGUAGE_VERSION:35724,CURRENT_PROGRAM:35725,NEVER:512,LESS:513,EQUAL:514,LEQUAL:515,GREATER:516,NOTEQUAL:517,GEQUAL:518,ALWAYS:519,KEEP:7680,REPLACE:7681,INCR:7682,DECR:7683,INVERT:5386,INCR_WRAP:34055,DECR_WRAP:34056,VENDOR:7936,RENDERER:7937,VERSION:7938,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,TEXTURE_2D:3553,TEXTURE:5890,TEXTURE_CUBE_MAP:34067,TEXTURE_BINDING_CUBE_MAP:34068,TEXTURE_CUBE_MAP_POSITIVE_X:34069,TEXTURE_CUBE_MAP_NEGATIVE_X:34070,TEXTURE_CUBE_MAP_POSITIVE_Y:34071,TEXTURE_CUBE_MAP_NEGATIVE_Y:34072,TEXTURE_CUBE_MAP_POSITIVE_Z:34073,TEXTURE_CUBE_MAP_NEGATIVE_Z:34074,MAX_CUBE_MAP_TEXTURE_SIZE:34076,TEXTURE0:33984,TEXTURE1:33985,TEXTURE2:33986,TEXTURE3:33987,TEXTURE4:33988,TEXTURE5:33989,TEXTURE6:33990,TEXTURE7:33991,TEXTURE8:33992,TEXTURE9:33993,TEXTURE10:33994,TEXTURE11:33995,TEXTURE12:33996,TEXTURE13:33997,TEXTURE14:33998,TEXTURE15:33999,TEXTURE16:34000,TEXTURE17:34001,TEXTURE18:34002,TEXTURE19:34003,TEXTURE20:34004,TEXTURE21:34005,TEXTURE22:34006,TEXTURE23:34007,TEXTURE24:34008,TEXTURE25:34009,TEXTURE26:34010,TEXTURE27:34011,TEXTURE28:34012,TEXTURE29:34013,TEXTURE30:34014,TEXTURE31:34015,ACTIVE_TEXTURE:34016,REPEAT:10497,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,VERTEX_ATTRIB_ARRAY_ENABLED:34338,VERTEX_ATTRIB_ARRAY_SIZE:34339,VERTEX_ATTRIB_ARRAY_STRIDE:34340,VERTEX_ATTRIB_ARRAY_TYPE:34341,VERTEX_ATTRIB_ARRAY_NORMALIZED:34922,VERTEX_ATTRIB_ARRAY_POINTER:34373,VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:34975,COMPILE_STATUS:35713,INFO_LOG_LENGTH:35716,SHADER_SOURCE_LENGTH:35720,LOW_FLOAT:36336,MEDIUM_FLOAT:36337,HIGH_FLOAT:36338,LOW_INT:36339,MEDIUM_INT:36340,HIGH_INT:36341,FRAMEBUFFER:36160,RENDERBUFFER:36161,RGBA4:32854,RGB5_A1:32855,RGB565:36194,DEPTH_COMPONENT16:33189,STENCIL_INDEX:6401,STENCIL_INDEX8:36168,DEPTH_STENCIL:34041,RENDERBUFFER_WIDTH:36162,RENDERBUFFER_HEIGHT:36163,RENDERBUFFER_INTERNAL_FORMAT:36164,RENDERBUFFER_RED_SIZE:36176,RENDERBUFFER_GREEN_SIZE:36177,RENDERBUFFER_BLUE_SIZE:36178,RENDERBUFFER_ALPHA_SIZE:36179,RENDERBUFFER_DEPTH_SIZE:36180,RENDERBUFFER_STENCIL_SIZE:36181,FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE:36048,FRAMEBUFFER_ATTACHMENT_OBJECT_NAME:36049,FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL:36050,FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE:36051,COLOR_ATTACHMENT0:36064,DEPTH_ATTACHMENT:36096,STENCIL_ATTACHMENT:36128,DEPTH_STENCIL_ATTACHMENT:33306,NONE:0,FRAMEBUFFER_COMPLETE:36053,FRAMEBUFFER_INCOMPLETE_ATTACHMENT:36054,FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:36055,FRAMEBUFFER_INCOMPLETE_DIMENSIONS:36057,FRAMEBUFFER_UNSUPPORTED:36061,FRAMEBUFFER_BINDING:36006,RENDERBUFFER_BINDING:36007,MAX_RENDERBUFFER_SIZE:34024,INVALID_FRAMEBUFFER_OPERATION:1286,UNPACK_FLIP_Y_WEBGL:37440,UNPACK_PREMULTIPLY_ALPHA_WEBGL:37441,CONTEXT_LOST_WEBGL:37442,UNPACK_COLORSPACE_CONVERSION_WEBGL:37443,BROWSER_DEFAULT_WEBGL:37444};function okIsSupportWebGL(){if(OAK.__SUPPORT_WEBGL){return OAK.__SUPPORT_WEBGL}var c=document.createElement("canvas");if(c==null){OAK.__SUPPORT_WEBGL=false;return false}c.width=32;c.height=32;if(c.getContext==null){OAK.__SUPPORT_WEBGL=false;return false}var a=c.getContext("webgl");if(a==null){a=c.getContext("experimental-webgl")}if(a==null){OAK.__SUPPORT_WEBGL=false}else{OAK.__SUPPORT_WEBGL=true}return OAK.__SUPPORT_WEBGL}function okIsIE(){return navigator.appName=="Microsoft Internet Explorer"}function okGenCanvas(d,e,c){var a;if(okIsIE()){a=document.createElement("object");a.width=d;a.height=e;if(c){c.appendChild(a)}else{document.body.appendChild(a)}a.type="application/x-webgl"}else{a=document.createElement("canvas");a.width=d;a.height=e;if(c){c.appendChild(a)}else{document.body.appendChild(a)}}return a}var okRequestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(a){setTimeout(a,1000/60)};function okExtension(f){var d=f.getSupportedExtensions();for(var c=0;c<d.length;++c){var a=d[c];var e=f.getExtension(a);this[a]=e}}function okIsUndefined(a){return typeof a=="undefined"}function okIsString(a){return typeof a=="string"}function okIsElement(a){return a&&a.nodeType==1}function okIsFunction(a){return typeof a=="function"}function okIsObject(a){return typeof a=="object"}function okIsArray(a){return Object.prototype.toString.call(a)==="[object Array]"}function okIsNumber(a){return typeof a=="number"}function okIsBoolean(a){return typeof a=="boolean"}function okFileFilter(a){var c=a.lastIndexOf(".");return a.substring(c+1,a.length)}function okLog(d,c,a){window.console.log((c?("["+c+"]"):"")+d);if(a){alert("[Oak Debug Stop]")}}function okGenQuadMesh(s,o,e,q,n,c,d){var m=[o,e,0,o,n,0,q,n,0,q,e,0];var a=[0,0,1,0,0,1,0,0,1,0,0,1];var h=d?[0,1,0,0,1,0,1,1]:[0,0,0,1,1,1,1,0];var f=[0,1,2,0,2,3];s.createAttribute("Position",m.length,m);s.createAttribute("Normal",a.length,a);s.createAttribute("Texcoord1",h.length,h);s.createIndex("Default",f.length,f,35044,4);s.setVertexNum(4);s.computeBoundingInfo();if(c){var l=new Array;var p=f.length/3;for(var k=0;k<p;++k){l.push(f[k*3],f[k*3+1]);l.push(f[k*3+1],f[k*3+2]);l.push(f[k*3+2],f[k*3])}s.createIndex("Wireframe",l.length,l,35044,1)}return s}function okGenBoxMesh(n,l,o,a){var k=[l.x,l.y,l.z,l.x,l.y,o.z,l.x,o.y,o.z,l.x,o.y,l.z,o.x,l.y,l.z,o.x,o.y,l.z,o.x,o.y,o.z,o.x,l.y,o.z,l.x,o.y,l.z,l.x,o.y,o.z,o.x,o.y,o.z,o.x,o.y,l.z,l.x,l.y,l.z,o.x,l.y,l.z,o.x,l.y,o.z,l.x,l.y,o.z,l.x,o.y,o.z,l.x,l.y,o.z,o.x,l.y,o.z,o.x,o.y,o.z,l.x,o.y,l.z,o.x,o.y,l.z,o.x,l.y,l.z,l.x,l.y,l.z];var c=[-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1];var d=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];var e=[1/4,2/3,1/4,1/3,0,1/3,0,2/3,2/4,2/3,3/4,2/3,3/4,1/3,2/4,1/3,4/4,2/3,4/4,1/3,3/4,1/3,3/4,2/3,1/4,2/3,2/4,2/3,2/4,1/3,1/4,1/3,1/4,0,1/4,1/3,2/4,1/3,2/4,0,1/4,3/3,2/4,3/3,2/4,2/3,1/4,2/3];n.createAttribute("Position",k.length,k);n.createAttribute("Normal",c.length,c);n.createAttribute("Texcoord1",e.length,e);n.createIndex("Default",d.length,d,35044,4);n.setVertexNum(24);n.computeBoundingInfo();if(a){var h=new Array;var m=d.length/3;for(var f=0;f<m;++f){h.push(d[f*3],d[f*3+1]);h.push(d[f*3+1],d[f*3+2]);h.push(d[f*3+2],d[f*3])}n.createIndex("Wireframe",h.length,h,35044,1)}return n}function okGenSphereMesh(c,u,a,B,G){var w=new Array;w.push(0,u,0);for(var s=1;s<B;++s){var I=Math.sin(Math.PI/B*s)*u;var o=Math.cos(Math.PI/B*s)*u;for(var E=0;E<a;++E){var p=Math.sin(Math.PI*2/a*E)*I;var n=Math.cos(Math.PI*2/a*E)*I;w.push(p,o,n)}}w.push(0,-u,0);var q=new Array;var f=new Array;for(var D=0;D<w.length/3;++D){var e=new okVec3(w[D*3],w[D*3+1],w[D*3+2]);e=e.normalize();q.push(e.x,e.y,e.z);f.push(Math.asin(e.x)/Math.PI+0.5,Math.asin(e.y)/Math.PI+0.5)}var d=new Array;for(var E=0;E<a;++E){d.push(0,1+(E%a),1+((E+1)%a))}for(var s=1;s<B-1;++s){for(var E=0;E<a;++E){var t=1+(s-1)*a;var H=1+s*a;var m=t+(E%a),k=t+((E+1)%a);var C=H+(E%a),A=H+((E+1)%a);d.push(m,C,A);d.push(A,k,m)}}for(var E=0;E<a;++E){d.push(w.length/3-1,1+(B-2)*a+((E+1)%a),1+(B-2)*a+(E%a))}c.createAttribute("Position",w.length,w);c.createAttribute("Normal",q.length,q);c.createAttribute("Texcoord1",f.length,f);c.createIndex("Default",d.length,d,35044,4);c.setVertexNum(w.length/3);c.computeBoundingInfo();if(G){var l=new Array;var F=d.length/3;for(var D=0;D<F;++D){l.push(d[D*3],d[D*3+1]);l.push(d[D*3+1],d[D*3+2]);l.push(d[D*3+2],d[D*3])}c.createIndex("Wireframe",l.length,l,35044,1)}return c}function okGenColumnMesh(a,p,C,v,B){var q=new Array;var d=new Array;q.push(0,C*0.5,0);d.push(1/8,1/8);for(var y=0;y<v;++y){var m=Math.sin(Math.PI*2/v*y)*p;var k=Math.cos(Math.PI*2/v*y)*p;q.push(m,C*0.5,k);d.push(Math.sin(Math.PI*2/v*y)/8+1/8,1/8-Math.cos(Math.PI*2/v*y)/8)}q.push(0,-C*0.5,0);d.push(1/8,5/8);for(var y=0;y<v;++y){var m=Math.sin(Math.PI*2/v*y)*p;var k=Math.cos(Math.PI*2/v*y)*p;q.push(m,-C*0.5,k);d.push(Math.sin(Math.PI*2/v*y)/8+1/8,5/8-Math.cos(Math.PI*2/v*y)/8)}for(var y=0;y<v;++y){var m=Math.sin(Math.PI*2/v*y)*p;var k=Math.cos(Math.PI*2/v*y)*p;q.push(m,C*0.5,k);d.push(y/(2*v)+0.5,0)}for(var y=0;y<v;++y){var m=Math.sin(Math.PI*2/v*y)*p;var k=Math.cos(Math.PI*2/v*y)*p;q.push(m,-C*0.5,k);d.push(y/(2*v)+0.5,1)}var o=new Array;for(var w=0;w<v+1;++w){o.push(0,1,0)}for(var w=0;w<v+1;++w){o.push(0,-1,0)}for(var w=0;w<v;++w){var s=new okVec3(q[(v*2+2)*3+w*3],0,q[(v*2+2)*3+w*3+2]);s=s.normalize();o.push(s.x,s.y,s.z)}for(var w=0;w<v;++w){var s=new okVec3(q[(v*3+2)*3+w*3],0,q[(v*3+2)*3+w*3+2]);s=s.normalize();o.push(s.x,s.y,s.z)}var c=new Array;for(var y=0;y<v;++y){c.push(0,1+(y%v),1+((y+1)%v))}for(var y=0;y<v;++y){c.push(v+1,v+2+((y+1)%v),v+2+(y%v))}for(var y=0;y<v;++y){var l=v*2+2+y,e=v*2+2+(y+1)%v;var u=v*3+2+y,t=v*3+2+(y+1)%v;c.push(l,u,t);c.push(t,e,l)}a.createAttribute("Position",q.length,q);a.createAttribute("Normal",o.length,o);a.createAttribute("Texcoord1",d.length,d);a.createIndex("Default",c.length,c,35044,4);a.setVertexNum(q.length/3);a.computeBoundingInfo();if(B){var f=new Array;var A=c.length/3;for(var w=0;w<A;++w){f.push(c[w*3],c[w*3+1]);f.push(c[w*3+1],c[w*3+2]);f.push(c[w*3+2],c[w*3])}a.createIndex("Wireframe",f.length,f,35044,1)}return a}function okGenTaperMesh(a,t,E,y,D){var v=new Array;var l=new Array;v.push(0,-E*0.5,0);l.push(1/8,1/8);for(var B=0;B<y;++B){var p=Math.sin(Math.PI*2/y*B)*t;var o=Math.cos(Math.PI*2/y*B)*t;v.push(p,-E*0.5,o);l.push(Math.sin(Math.PI*2/y*B)/8+1/8,1/8-Math.cos(Math.PI*2/y*B)/8)}v.push(0,E*0.5,0);l.push(3/4,1/4);var d=Math.sqrt(t*t+E*E);for(var B=0;B<y;++B){var p=Math.sin(Math.PI*2/y*B)*t;var o=Math.cos(Math.PI*2/y*B)*t;v.push(p,-E*0.5,o);l.push(3/4+Math.sin(Math.PI*2/y*B*t/d)/4,1/4-Math.cos(Math.PI*2/y*B*t/d)/4)}var q=new Array;for(var A=0;A<y+1;++A){q.push(0,-1,0)}q.push(0,1,0);for(var A=0;A<y;++A){q.push(0,0,0)}for(var A=0;A<y;++A){var k=new okVec3(v[(y+1)*3],v[(y+1)*3+1],v[(y+1)*3+2]);var f=new okVec3(v[(y+2)*3+A*3],v[(y+2)*3+A*3+1],v[(y+2)*3+A*3+2]);var e=new okVec3(v[(y+2)*3+((A+1)%y)*3],v[(y+2)*3+((A+1)%y)*3+1],v[(y+2)*3+((A+1)%y)*3+2]);var u=okVec3Sub(f,k);var s=okVec3Sub(e,k);var w=okVec3Cross(u,s);w=w.normalize();q[(y+2)*3+A*3]+=w.x;q[(y+2)*3+A*3+1]+=w.y;q[(y+2)*3+A*3+2]+=w.z;q[(y+2)*3+((A+1)%y)*3]+=w.x;q[(y+2)*3+((A+1)%y)*3+1]+=w.y;q[(y+2)*3+((A+1)%y)*3+2]+=w.z}for(var A=0;A<y;++A){var w=new okVec3(q[(y+2)*3+A*3],q[(y+2)*3+A*3+1],q[(y+2)*3+A*3+2]);w=w.normalize();q[(y+2)*3+A*3]=w.x;q[(y+2)*3+A*3+1]=w.y;q[(y+2)*3+A*3+2]=w.z}var c=new Array;for(var B=0;B<y;++B){c.push(0,1+((B+1)%y),1+B)}for(var B=0;B<y;++B){c.push(y+1,y+2+B,y+2+(B+1)%y)}a.createAttribute("Position",v.length,v);a.createAttribute("Normal",q.length,q);a.createAttribute("Texcoord1",l.length,l);a.createIndex("Default",c.length,c,35044,4);a.setVertexNum(v.length/3);a.computeBoundingInfo();if(D){var m=new Array;var C=c.length/3;for(var A=0;A<C;++A){m.push(c[A*3],c[A*3+1]);m.push(c[A*3+1],c[A*3+2]);m.push(c[A*3+2],c[A*3])}a.createIndex("Wireframe",m.length,m,35044,1)}return a}function okGenFrustumMesh(p,o,a){var m=new Array;for(var f=0;f<8;++f){m.push(o.getPoint(f))}var k=new Array;k.push(m[0].x,m[0].y,m[0].z);k.push(m[1].x,m[1].y,m[1].z);k.push(m[2].x,m[2].y,m[2].z);k.push(m[3].x,m[3].y,m[3].z);k.push(m[5].x,m[5].y,m[5].z);k.push(m[4].x,m[4].y,m[4].z);k.push(m[7].x,m[7].y,m[7].z);k.push(m[6].x,m[6].y,m[6].z);k.push(m[1].x,m[1].y,m[1].z);k.push(m[5].x,m[5].y,m[5].z);k.push(m[6].x,m[6].y,m[6].z);k.push(m[2].x,m[2].y,m[2].z);k.push(m[4].x,m[4].y,m[4].z);k.push(m[0].x,m[0].y,m[0].z);k.push(m[3].x,m[3].y,m[3].z);k.push(m[7].x,m[7].y,m[7].z);k.push(m[3].x,m[3].y,m[3].z);k.push(m[2].x,m[2].y,m[2].z);k.push(m[6].x,m[6].y,m[6].z);k.push(m[7].x,m[7].y,m[7].z);k.push(m[1].x,m[1].y,m[1].z);k.push(m[0].x,m[0].y,m[0].z);k.push(m[4].x,m[4].y,m[4].z);k.push(m[5].x,m[5].y,m[5].z);var c=new Array;var e=okVec3Cross(okVec3Sub(m[1],m[0]),okVec3Sub(m[3],m[0])).normalize();c.push(e.x,e.y,e.z);c.push(e.x,e.y,e.z);c.push(e.x,e.y,e.z);c.push(e.x,e.y,e.z);e=okVec3Cross(okVec3Sub(m[4],m[5]),okVec3Sub(m[6],m[5])).normalize();c.push(e.x,e.y,e.z);c.push(e.x,e.y,e.z);c.push(e.x,e.y,e.z);c.push(e.x,e.y,e.z);e=okVec3Cross(okVec3Sub(m[5],m[1]),okVec3Sub(m[2],m[1])).normalize();c.push(e.x,e.y,e.z);c.push(e.x,e.y,e.z);c.push(e.x,e.y,e.z);c.push(e.x,e.y,e.z);e=okVec3Cross(okVec3Sub(m[0],m[4]),okVec3Sub(m[7],m[4])).normalize();c.push(e.x,e.y,e.z);c.push(e.x,e.y,e.z);c.push(e.x,e.y,e.z);c.push(e.x,e.y,e.z);e=okVec3Cross(okVec3Sub(m[2],m[3]),okVec3Sub(m[7],m[3])).normalize();c.push(e.x,e.y,e.z);c.push(e.x,e.y,e.z);c.push(e.x,e.y,e.z);c.push(e.x,e.y,e.z);e=okVec3Cross(okVec3Sub(m[0],m[1]),okVec3Sub(m[5],m[1])).normalize();c.push(e.x,e.y,e.z);c.push(e.x,e.y,e.z);c.push(e.x,e.y,e.z);c.push(e.x,e.y,e.z);var d=new Array;d.push(0,1,2,0,2,3);d.push(4,5,6,4,6,7);d.push(8,9,10,8,10,11);d.push(12,13,14,12,14,15);d.push(16,17,18,16,18,19);d.push(20,21,22,20,22,23);p.createAttribute("Position",k.length,k);p.createAttribute("Normal",c.length,c);p.createIndex("Default",d.length,d,35044,4);p.setVertexNum(k.length/3);p.computeBoundingInfo();if(a){var h=new Array;var l=d.length/3;for(var f=0;f<l;++f){h.push(d[f*3],d[f*3+1]);h.push(d[f*3+1],d[f*3+2]);h.push(d[f*3+2],d[f*3])}p.createIndex("Wireframe",h.length,h,35044,1)}return p}function okTouch(d,a){this.node=typeof d=="object"?d:document.getElementById(d);this.options={dragable:true,scalable:true,rotatable:true,opacity:true};if(typeof a=="object"){for(var c in a){this.options[c]=a[c]}}this.zIndexCount=1;this.startX=0;this.startY=0;this.curX=0;this.curY=0;this.elementPosX=0;this.elementPosY=0;this.rotation=0;this.scale=1;this.gesture=false;this.node.addEventListener("touchstart",this,false);this.node.addEventListener("touchmove",this,false);this.node.addEventListener("touchend",this,false);this.node.addEventListener("touchcancel",this,false)}okTouch.prototype={handleEvent:function(a){switch(a.type){case"touchstart":this.onTouchStart(a);break;case"touchmove":this.onTouchMove(a);break;case"touchend":this.onTouchEnd(a);break;case"touchcancel":this.onTouchCancel(a);break}},onTouchStart:function(a){a.preventDefault();this.node.style.zIndex=okTouch.zIndexCount++;if((a.targetTouches.length===1)&&(this.options.dragable)){this.startX=a.targetTouches[0].pageX;this.startY=a.targetTouches[0].pageY;this.elementPosX=this.node.offsetLeft;this.elementPosY=this.node.offsetTop}if(this.options.opacity){this.node.style.opacity="0.5"}},onTouchMove:function(c){c.preventDefault();if((c.targetTouches.length===1)&&(this.options.dragable)){this.curX=c.targetTouches[0].pageX-this.startX;this.curY=c.targetTouches[0].pageY-this.startY;this.node.style.left=(this.elementPosX+this.curX)+"px";this.node.style.top=(this.elementPosY+this.curY)+"px"}else{if((c.targetTouches.length===2)&&((this.options.scalable)||(this.options.rotatable))){this.gesture=true;var a="";if(this.options.scalable){a+="scale("+(this.scale*c.scale)+")"}if(this.options.rotatable){a+="rotate("+((this.rotation+c.rotation)%360)+"deg)"}this.node.style.webkitTransform=a}}},onTouchEnd:function(a){a.preventDefault();if(this.gesture){this.scale*=a.scale;this.rotation=(this.rotation+a.rotation)%360;this.gesture=false}this.startX=0;this.startY=0;this.elementPosX=0;this.elementPosY=0;if(this.options.opacity){this.node.style.opacity="1"}},onTouchCancel:function(a){a.preventDefault();if(this.gesture){this.scale*=a.scale;this.rotation=(this.rotation+a.rotation)%360;this.gesture=false}this.startX=0;this.startY=0;this.elementPosX=0;this.elementPosY=0;if(this.options.opacity){element.style.opacity="1"}}};function okCollection(){this.aDataList=new Array;this.iDataReserveHead=-1;this.iDataCount=0;this.iIterator=0}okCollection.prototype={clear:function(){this.aDataList.lengh=0;this.iDataReserveHead=-1;this.iDataCount=0;this.iIterator=0},add:function(d){if(this.iDataReserveHead!=-1){var c=this.iDataReserveHead;this.iDataReserveHead=this.aDataList[this.iDataReserveHead].reserve;this.aDataList[c].data=d;this.aDataList[c].reserve=-1;this.aDataList[c].bValid=true;this.iDataCount+=1;return c}else{var a=new Object;a.data=d;a.reserve=-1;a.bValid=true;this.aDataList.push(a);this.iDataCount+=1;return this.aDataList.length-1}},find:function(c){for(var a=this.aDataList.length-1;a>=0;--a){if(this.aDataList[a].bValid&&this.aDataList[a].data==c){return true}}return false},remove:function(c){for(var a=this.aDataList.length-1;a>=0;--a){if(this.aDataList[a].bValid&&this.aDataList[a].data==c){this.aDataList[a].reserve=this.iDataReserveHead;this.aDataList[a].bValid=false;this.iDataReserveHead=a;this.iDataCount-=1;return}}},removeByIndex:function(a){if(this.aDataList[a].bValid){this.aDataList[a].reserve=this.iDataReserveHead;this.aDataList[a].bValid=false;this.iDataReserveHead=a;this.iDataCount-=1}},getSize:function(){return this.iDataCount},getCapacity:function(){return this.aDataList.length},getDataByIndex:function(a){return this.aDataList[a].data},isIndexValid:function(a){return(a<this.aDataList.length)&&(a>=0)&&this.aDataList[a].bValid},resetIterator:function(){this.iIterator=0},iterate:function(){while(this.iIterator<this.aDataList.length&&this.aDataList[this.iIterator].bValid==false){this.iIterator++}if(this.iIterator>=this.aDataList.length){return null}return this.aDataList[this.iIterator++].data}};function okList(){this.root=null;this.tail=null;this.iSize=0;this.pool=new Array}okList.prototype={clear:function(){var c=this.root;while(c){var a=c.next;c.data=null;c.pre=null;c.next=null;this.pool.push(c);c=a}this.root=null;this.tail=null;this.iSize=0},getRoot:function(){return this.root},getTail:function(){return this.tail},getSize:function(){return this.iSize},isEmpty:function(){return(this.iSize==0)},pushFront:function(a){var c=this.pool.length?this.pool.shift():new Object;c.data=a;c.next=this.root;c.pre=null;if(this.root){this.root.pre=c}else{this.tail=c}this.root=c;this.iSize+=1},popFront:function(){if(this.root==null){return null}var a=this.root;this.root=this.root.next;if(this.root!=null){this.root.pre=null}else{this.tail=null}this.iSize-=1;a.pre=null;a.next=null;var c=a.data;a.data=null;this.pool.push(a);return c},front:function(){if(this.root){return this.root.data}return null},pushBack:function(c){var a=this.pool.length?this.pool.shift():new Object;a.data=c;a.pre=this.tail;a.next=null;if(this.tail){this.tail.next=a}else{this.root=a}this.tail=a;this.iSize+=1},popBack:function(){if(this.tail==null){return null}var a=this.tail;this.tail=this.tail.pre;if(this.tail!=null){this.tail.next=null}else{this.root=null}this.iSize-=1;a.pre=null;a.next=null;var c=a.data;a.data=null;this.pool.push(a);return c},back:function(){if(this.tail){return this.tail.data}return null},insertBefore:function(c,d){var a=this.pool.length?this.pool.shift():new Object;a.data=d;a.pre=c.pre;a.next=c;c.pre=a;if(a.pre==null){this.root=a}else{a.pre.next=a}this.iSize+=1},insertAfter:function(c,d){var a=this.pool.length?this.pool.shift():new Object;a.data=d;a.pre=c;a.next=c.next;c.next=a;if(a.next==null){this.tail=a}else{a.next.pre=a}this.iSize+=1},remove:function(a){if(a==null){return null}if(a.pre){a.pre.next=a.next}if(a.next){a.next.pre=a.pre}if(a==this.root){this.root=a.next}if(a==this.tail){this.tail=a.pre}a.pre=null;a.next=null;a.data=null;this.pool.push(a);this.iSize-=1},find:function(a){var c=this.root;while(c){if(c.data==a){return c}c=c.next}return null}};function okLayout2DHelper(a,c){this.aValidBlockList=new okList();this.aValidBlockList.pushBack(new okRect(0,0,a,c))}okLayout2DHelper.prototype={reset:function(a,c){this.aValidBlockList=new okList();this.aValidBlockList.pushBack(new okRect(0,0,a,c))},add:function(a,e){var k=this.aValidBlockList.getRoot();var h=null;var d=null,c=null;while(k){var f=k.data;if(f.width>=a&&f.height>=e){h=new okRect(f.x,f.y,a,e);this.aValidBlockList.remove(k);if((f.width!=a)&&(f.height!=e)){if(Math.max(f.height*(f.width-a),a*(f.height-e))>Math.max(f.width*(f.height-e),e*(f.width-a))){d=new okRect(f.x,f.y+e,a,f.height-e);c=new okRect(f.x+a,f.y,f.width-a,f.height)}else{d=new okRect(f.x,f.y+e,f.width,f.height-e);c=new okRect(f.x+a,f.y,f.width-a,e)}}else{if(f.width!=a){d=new okRect(f.x+a,f.y,f.width-a,f.height)}else{if(f.height!=e){d=new okRect(f.x,f.y+e,f.width,f.height-e)}}}break}k=k.next}if(d){this.appendBlankRect(d)}if(c){this.appendBlankRect(c)}return h},remove:function(a){this.appendBlankRect(a);return true},appendBlankRect:function(a){if(a==null||a.width<=0||a.height<=0){return}var d=this.aValidBlockList.getRoot();while(d){var c=d.data;if(c.width*c.height>a.width*a.height){this.aValidBlockList.insertBefore(d,a);break}d=d.next}if(d==null){this.aValidBlockList.pushBack(a)}}};function okPackVec3ToFloat(d){var a=d.x*255;var h=d.y*255;var f=d.z*255;var c=(a<<16)|(h<<8)|f;var e=c/(1<<24);return e}function okUnpackFloatToVec3(a){r=a-Math.floor(a);g=a*256-Math.floor(a*256);b=a*65536-Math.floor(a*65536);return new okVec3(r,g,b)}function okArray2D(){this.elementArray=new Array;this.oneDimLength;this.twoDimLength}okArray2D.prototype={clear:function(){for(var d=0;d<this.elementArray.length;++d){var c=this.elementArray[d];if(!c){continue}c=[]}this.elementArray=[]},addElement:function(d,a,c){var e=this.elementArray[d];if(!e){e=new Array;this.elementArray[d]=e}e[a]=c},getElement:function(c,a){if(c<0||c>=this.getOneDimLength()){return}if(a<0||a>=this.getTwoDimLength()){return}return this.elementArray[c][a]},getOneDimLength:function(){this.oneDimLength=this.elementArray.length;return this.elementArray.length},getTwoDimLength:function(){var c=0;for(var a=0;a<this.elementArray.length;++a){var d=this.elementArray[a];if(!d){d=new Array;this.elementArray[a]=d}if(c<d.length){c=d.length}}this.twoDimLength=c;return c}};function okGenXmlHttpRequest(){if(okIsIE()){return new ActiveXObject("Msxml2.XMLHTTP")}else{return new XMLHttpRequest()}return null}function okGetFileExtName(c){var a=c.lastIndexOf(".");if(a==-1){return""}return c.substr(a+1)}function okGetRelativePath(a,c){a=a.replace(/\\/g,"/");a=a.replace(/^\/+/g,"");a=a.replace(/\/$/g,"");c=c.replace(/\\/g,"/");c=c.replace(/^\/+/g,"");c=c.replace(/\/$/g,"");return a.substr(a.indexOf(c)+c.length)}function okExtend(d,a){var c=function(){};c.prototype=a.prototype;d.__parent=a.prototype;d.prototype=new c();d.prototype.constructor=d}function okBaseCall(h,e){var c=arguments.callee.caller;if(c.__parent){return c.__parent.constructor.apply(h,Array.prototype.slice.call(arguments,1))}var a=Array.prototype.slice.call(arguments,2);var f=false;for(var d=h.constructor;d;d=d.__parent&&d.__parent.constructor){if(d.prototype[e]===c){f=true}else{if(f){return d.prototype[e].apply(h,a)}}}if(h[e]===c){return h.constructor.prototype[e].apply(h,a)}else{throw Error("Called from a method of one name to a method of a different name")}}function okAllocatorPrototype(){this.aVec2=new Array;this.aVec3=new Array;this.aVec4=new Array;this.aMat3=new Array;this.aMat4=new Array;this.aMat43=new Array;this.aQuat=new Array;this.aPlane=new Array;this.aAABBox=new Array;this.aSceneNode=new Array;this.aRenderBatch=new Array;this.aParticle=new Array;this.aArray=new Array;this.aObjectArray=new Array}okAllocatorPrototype.prototype={object:function(){if(this.aObjectArray.length){return this.aObjectArray.shift()}return new Object},_object:function(c){for(var a in c){delete c[a]}this.aObjectArray.push(c)},array:function(){if(this.aArray.length){return this.aArray.shift()}return new Array},_array:function(a){a.length=0;this.aArray.push(a)},vec2:function(){if(this.aVec2.length){return this.aVec2.shift()}return new okVec2()},_vec2:function(a){a.x=0;a.y=0;this.aVec2.push(a)},vec3:function(d,c,a){if(this.aVec3.length){return this.aVec3.shift()}return new okVec3()},_vec3:function(a){a.x=0;a.y=0;a.z=0;this.aVec3.push(a)},vec4:function(){if(this.aVec4.length){return this.aVec4.shift()}return new okVec4()},_vec4:function(a){a.x=0;a.y=0;a.z=0;a.w=0;this.aVec4.push(a)},mat3:function(){if(this.aMat3.length){return this.aMat3.shift()}return new okMat3()},_mat3:function(a){a.m00=1;a.m10=0;a.m20=0;a.m01=0;a.m11=1;a.m21=0;a.m02=0;a.m12=0;a.m22=1;this.aMat3.push(a)},mat4:function(){if(this.aMat4.length){return this.aMat4.shift()}return new okMat4()},_mat4:function(a){a.m00=1;a.m10=0;a.m20=0;a.m30=0;a.m01=0;a.m11=1;a.m21=0;a.m31=0;a.m02=0;a.m12=0;a.m22=1;a.m32=0;a.m03=0;a.m13=0;a.m23=0;a.m33=1;this.aMat4.push(a)},mat43:function(){if(this.aMat43.length){return this.aMat43.shift()}return new okMat43()},_mat43:function(a){a.m00=1;a.m10=0;a.m20=0;a.m01=0;a.m11=1;a.m21=0;a.m02=0;a.m12=0;a.m22=1;a.m03=0;a.m13=0;a.m23=0;this.aMat43.push(a)},quat:function(){if(this.aQuat.length){return this.aQuat.shift()}return new okQuat()},_quat:function(a){a.s=1;a.x=0;a.y=0;a.z=0;this.aQuat.push(a)},plane:function(){if(this.aPlane.length){return this.aPlane.shift()}return new okPlane()},_plane:function(a){a.vOrigin.x=0;a.vOrigin.y=0;a.vOrigin.z=0;a.vNormal.x=0;a.vNormal.y=1;a.vNormal.z=0;this.aPlane.push(a)},aabbox:function(){if(this.aAABBox.length){return this.aAABBox.shift()}return new okAABBox()},_aabbox:function(a){a.set(OAK.VEC3_ZERO,OAK.VEC3_ZERO);this.aAABBox.push(a)},sceneNode:function(){if(this.aSceneNode.length){return this.aSceneNode.shift()}return new okSceneNode()},_sceneNode:function(a){a.clear();this.aSceneNode.push(a)},renderBatch:function(){if(this.aRenderBatch.length){return this.aRenderBatch.shift()}return new okRenderBatch()},_renderBatch:function(a){a.clear();this.aRenderBatch.push(a)},particle:function(){if(this.aParticle.length){return this.aParticle.shift()}return new okParticle()},_particle:function(a){a.lf=0;a.tlf=0;a.m.identity();a.v.x=0;a.v.y=0;a.v.z=0;a.ac.x=0;a.ac.y=0;a.ac.z=0;a.s.x=0.1;a.s.y=0.1;a.s0.x=0.1;a.s0.y=0.1;a.s1.x=0.1;a.s1.y=0.1;a.c.x=1;a.c.y=1;a.c.z=1;a.c0.x=1;a.c0.y=1;a.c0.z=1;a.c1.x=1;a.c1.y=1;a.c1.z=1;a.a=0;a.fdi=0;a.fdo=0;this.aParticle.push(a)}};var okAllocator=new okAllocatorPrototype();function okFloatEqual(c,a){if((c-a)<0.000001&&(c-a)>-0.000001){return true}return false}function okAlign(c,a){return(c+a-1)&~(a-1)}function okAlignPower2(a){--a;for(var c=1;c<32;c<<=1){a=a|a>>c}return a+1}function okIsPower2(a){return(a&(a-1))==0}function okVec2(c,a){this.x=((c!=null)?c:0);this.y=((a!=null)?a:0)}okVec2.prototype={set:function(c,a){this.x=c;this.y=a},clone:function(a){var a=(a?a:okAllocator.vec2());a.x=this.x;a.y=this.y;return a},equal:function(a){return this.x==a.x&&this.y==a.y},neg:function(a){var c=(a?this:okAllocator.vec2());c.x=-this.x;c.y=-this.y;return c},len:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(c){var d=(c?this:okAllocator.vec2());var a=1/Math.sqrt(this.x*this.x+this.y*this.y);d.x=this.x*a;d.y=this.y*a;return d},inverse:function(a){var c=(a?this:okAllocator.vec2());c.x=1/this.x;c.y=1/this.y;return c},translate:function(e,d,c){if(e.x){c=d;if(c){this.x+=e.x;this.y+=e.y;return this}else{var a=okAllocator.vec2();a.x=this.x+e.x;a.y=this.y+e.y;return a}}else{if(okIsNumber(d)){if(c){this.x+=e;this.y+=d;return this}else{var a=okAllocator.vec2();a.x=this.x+e;a.y=this.y+d;return a}}else{c=d;if(c){this.x+=e;this.y+=e;return this}else{var a=okAllocator.vec2();a.x=this.x+e;a.y=this.y+e;return a}}}},scale:function(e,d,c){if(e.x){c=d;if(c){this.x*=e.x;this.y*=e.y;return this}else{var a=okAllocator.vec2();a.x=this.x*e.x;a.y=this.y*e.y;return a}}else{if(okIsNumber(d)){if(c){this.x*=e;this.y*=d;return this}else{var a=okAllocator.vec2();a.x=this.x*e;a.y=this.y*d;return a}}else{c=d;if(c){this.x*=e;this.y*=e;return this}else{var a=okAllocator.vec2();a.x=this.x*e;a.y=this.y*e;return a}}}},toArray:function(a){if(a==null){a=okAllocator.array()}a.push(this.x,this.y);return a}};function okVec2Add(c,a){var d=okAllocator.vec2();d.x=c.x+a.x;d.y=c.y+a.y;return d}function okVec2AddVal(a,c){var d=okAllocator.vec2();d.x=a.x+c;d.y=a.y+c;return d}function okValAddVec2(c,a){var d=okAllocator.vec2();d.x=a.x+c;d.y=a.y+c;return d}function okVec2Sub(c,a){var d=okAllocator.vec2();d.x=c.x-a.x;d.y=c.y-a.y;return d}function okVec2SubVal(a,c){var d=okAllocator.vec2();d.x=a.x-c;d.y=a.y-c;return d}function okValSubVec2(c,a){var d=okAllocator.vec2();d.x=c-a.x;d.y=c-a.y;return d}function okVec2Mul(c,a){var d=okAllocator.vec2();d.x=c.x*a.x;d.y=c.y*a.y;return d}function okVec2MulVal(a,c){var d=okAllocator.vec2();d.x=a.x*c;d.y=a.y*c;return d}function okValMulVec2(c,a){var d=okAllocator.vec2();d.x=a.x*c;d.y=a.y*c;return d}function okVec2Div(c,a){var d=okAllocator.vec2();d.x=c.x/a.x;d.y=c.y/a.y;return d}function okVec2DivVal(a,c){var d=okAllocator.vec2();d.x=a.x/c;d.y=a.y/c;return d}function okValDivVec2(c,a){var d=okAllocator.vec2();d.x=c/a.x;d.y=c/a.y;return d}function okVec2Min(c,a){var d=okAllocator.vec2();d.x=c.x<a.x?c.x:a.x;d.y=c.y<a.y?c.y:a.y;return d}function okVec2Max(c,a){var d=okAllocator.vec2();d.x=c.x>a.x?c.x:a.x;d.y=c.y>a.y?c.y:a.y;return d}function okVec2Dot(c,a){return c.x*a.x+c.y*a.y}function okVec2Cross(c,a){return c.x*a.y-a.x*c.y}function okVec2Lerp(e,d,h){var c=okVec2MulVal(e,1-h);var a=okVec2MulVal(d,h);var f=okVec2Add(c,a);okAllocator._vec2(c);okAllocator._vec2(a);return f}function okVec2Len(e,d){var c=e.x-d.x;var a=e.y-d.y;return Math.sqrt(c*c+a*a)}function okVec3(d,c,a){this.x=((d!=null)?d:0);this.y=((c!=null)?c:0);this.z=((a!=null)?a:0)}okVec3.prototype={set:function(d,c,a){this.x=d;this.y=c;this.z=a},clone:function(a){var a=(a?a:okAllocator.vec3());a.x=this.x;a.y=this.y;a.z=this.z;return a},equal:function(a){return this.x==a.x&&this.y==a.y&&this.z==a.z},len:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},neg:function(a){var c=(a?this:okAllocator.vec3());c.x=-this.x;c.y=-this.y;c.z=-this.z;return c},normalize:function(c){var d=(c?this:okAllocator.vec3());var a=1/Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);d.x=this.x*a;d.y=this.y*a;d.z=this.z*a;return d},inverse:function(a){var c=(a?this:okAllocator.vec3());c.x=1/this.x;c.y=1/this.y;c.z=1/this.z;return c},translate:function(f,e,c,d){if(f.x){d=e;if(d){this.x+=f.x;this.y+=f.y;this.z+=f.z;return this}else{var a=okAllocator.vec3();a.x=this.x+f.x;a.y=this.y+f.y;a.z=this.z+f.z;return a}}else{if(c==null){d=e;if(d){this.x+=f;this.y+=f;this.z+=f;return this}else{var a=okAllocator.vec3();a.x=this.x+f;a.y=this.y+f;a.z=this.z+f;return a}}else{if(d){this.x+=f;this.y+=e;this.z+=c;return this}else{var a=okAllocator.vec3();a.x=this.x+f;a.y=this.y+e;a.z=this.z+c;return a}}}},scale:function(f,e,c,d){if(f.x){d=e;if(d){this.x*=f.x;this.y*=f.y;this.z*=f.z;return this}else{var a=okAllocator.vec3();a.x=this.x*f.x;a.y=this.y*f.y;a.z=this.z*f.z;return a}}else{if(c==null){d=e;if(d){this.x*=f;this.y*=f;this.z*=f;return this}else{var a=okAllocator.vec3();a.x=this.x*f;a.y=this.y*f;a.z=this.z*f;return a}}else{if(d){this.x*=f;this.y*=e;this.z*=c;return this}else{var a=okAllocator.vec3();a.x=this.x*f;a.y=this.y*e;a.z=this.z*c;return a}}}},rot:function(k,h,f,c,e){var d=okMat43Rot(k,h,f,c);var a=okMat43MulVec3(d,this);okAllocator._mat43(d);if(e){this.x=a.x;this.y=a.y;this.z=a.z;okAllocator._vec3(a);return this}else{return a}},rotX:function(e,d){var c=okMat43RotX(e);var a=okMat43MulVec3(c,this);okAllocator._mat43(c);if(d){this.x=a.x;this.y=a.y;this.z=a.z;okAllocator._vec3(a);return this}else{return a}},rotY:function(e,d){var c=okMat43RotY(e);var a=okMat43MulVec3(c,this);okAllocator._mat43(c);if(d){this.x=a.x;this.y=a.y;this.z=a.z;okAllocator._vec3(a);return this}else{return a}},rotZ:function(e,d){var c=okMat43RotZ(e);var a=okMat43MulVec3(c,this);okAllocator._mat43(c);if(d){this.x=a.x;this.y=a.y;this.z=a.z;okAllocator._vec3(a);return this}else{return a}},toVec4:function(a){if(a==null){a=okAllocator.vec4()}a.set(this.x,this.y,this.z,1);return a},toArray:function(a){if(a==null){a=okAllocator.array()}a.push(this.x,this.y,this.z);return a}};function okVec3Add(c,a){var d=okAllocator.vec3();d.x=c.x+a.x;d.y=c.y+a.y;d.z=c.z+a.z;return d}function okVec3AddVal(a,c){var d=okAllocator.vec3();d.x=a.x+c;d.y=a.y+c;d.z=a.z+c;return d}function okValAddVec3(c,a){var d=okAllocator.vec3();d.x=a.x+c;d.y=a.y+c;d.z=a.z+c;return d}function okVec3Sub(c,a){var d=okAllocator.vec3();d.x=c.x-a.x;d.y=c.y-a.y;d.z=c.z-a.z;return d}function okVec3SubVal(a,c){var d=okAllocator.vec3();d.x=a.x-c;d.y=a.y-c;d.z=a.z-c;return d}function okValSubVec3(c,a){var d=okAllocator.vec3();d.x=c-a.x;d.y=c-a.y;d.z=c-a.z;return d}function okVec3Mul(c,a){var d=okAllocator.vec3();d.x=c.x*a.x;d.y=c.y*a.y;d.z=c.z*a.z;return d}function okVec3MulVal(a,c){var d=okAllocator.vec3();d.x=a.x*c;d.y=a.y*c;d.z=a.z*c;return d}function okValMulVec3(c,a){var d=okAllocator.vec3();d.x=a.x*c;d.y=a.y*c;d.z=a.z*c;return d}function okVec3Div(c,a){var d=okAllocator.vec3();d.x=c.x/a.x;d.y=c.y/a.y;d.z=c.z/a.z;return d}function okVec3DivVal(a,c){var d=okAllocator.vec3();d.x=a.x/c;d.y=a.y/c;d.z=a.z/c;return d}function okValDivVec3(c,a){var d=okAllocator.vec3();d.x=c/a.x;d.y=c/a.y;d.z=c/a.z;return d}function okVec3Min(c,a){var d=okAllocator.vec3();d.x=c.x<a.x?c.x:a.x;d.y=c.y<a.y?c.y:a.y;d.z=c.z<a.z?c.z:a.z;return d}function okVec3Max(c,a){var d=okAllocator.vec3();d.x=c.x>a.x?c.x:a.x;d.y=c.y>a.y?c.y:a.y;d.z=c.z>a.z?c.z:a.z;return d}function okVec3Dot(c,a){return c.x*a.x+c.y*a.y+c.z*a.z}function okVec3Cross(c,a){var d=okAllocator.vec3();d.x=c.y*a.z-c.z*a.y;d.y=c.z*a.x-c.x*a.z;d.z=c.x*a.y-c.y*a.x;return d}function okVec3Lerp(e,c,h){var f=1-h;var d=h;var a=okAllocator.vec3();a.x=e.x*f+c.x*d;a.y=e.y*f+c.y*d;a.z=e.z*f+c.z*d;return a}function okVec3Len(e,d){var c=e.x-d.x;var a=e.y-d.y;var f=e.z-d.z;return Math.sqrt(c*c+a*a+f*f)}function okVec4(d,c,a,e){this.x=((d!=null)?d:0);this.y=((c!=null)?c:0);this.z=((a!=null)?a:0);this.w=((e!=null)?e:1)}okVec4.prototype={set:function(d,c,a,e){this.x=d;this.y=c;this.z=a;this.w=e},clone:function(a){var a=(a?a:okAllocator.vec4());a.x=this.x;a.y=this.y;a.z=this.z;a.w=this.w;return a},equal:function(a){return okFloatEqual(this.x,a.x)&&okFloatEqual(this.y,a.y)&&okFloatEqual(this.z,a.z)&&okFloatEqual(this.w,a.w)},len:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},neg:function(a){var c=(a?this:okAllocator.vec4());c.x=-this.x;c.y=-this.y;c.z=-this.z;c.w=-this.w;return c},normalize:function(c){var d=(c?this:okAllocator.vec4());var a=1/Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);d.x=this.x*a;d.y=this.y*a;d.z=this.z*a;d.w=this.w*a;return d},inverse:function(a){var c=(a?this:okAllocator.vec4());c.x=1/this.x;c.y=1/this.y;c.z=1/this.z;c.w=1/this.w;return c},toVec3:function(a){if(a==null){a=okAllocator.vec3()}a.x=this.x/this.w;a.y=this.y/this.w;a.z=this.z/this.w;return a},toArray:function(a){if(a==null){a=okAllocator.array()}a.push(this.x,this.y,this.z,this.w);return a}};function okVec4Add(c,a){var d=okAllocator.vec4();d.x=c.x+a.x;d.y=c.y+a.y;d.z=c.z+a.z;d.w=c.w+a.w;return d}function okVec4AddVal(a,c){var d=okAllocator.vec4();d.x=a.x+c;d.y=a.y+c;d.z=a.z+c;d.w=a.w+c;return d}function okValAddVec4(c,a){var d=okAllocator.vec4();d.x=a.x+c;d.y=a.y+c;d.z=a.z+c;d.w=a.w+c;return d}function okVec4Sub(c,a){var d=okAllocator.vec4();d.x=c.x-a.x;d.y=c.y-a.y;d.z=c.z-a.z;d.w=c.w-a.w;return d}function okVec4SubVal(a,c){var d=okAllocator.vec4();d.x=a.x-c;d.y=a.y-c;d.z=a.z-c;d.w=a.w-c;return d}function okValSubVec4(c,a){var d=okAllocator.vec4();d.x=c-a.x;d.y=c-a.y;d.z=c-a.z;d.w=c-a.w;return d}function okVec4Mul(c,a){var d=okAllocator.vec4();d.x=c.x*a.x;d.y=c.y*a.y;d.z=c.z*a.z;d.w=c.w*a.w;return d}function okVec4MulVal(a,c){var d=okAllocator.vec4();d.x=a.x*c;d.y=a.y*c;d.z=a.z*c;d.w=a.w*c;return d}function okValMulVec4(c,a){var d=okAllocator.vec4();d.x=a.x*c;d.y=a.y*c;d.z=a.z*c;d.w=a.w*c;return d}function okVec4Div(c,a){var d=okAllocator.vec4();d.x=c.x/a.x;d.y=c.y/a.y;d.z=c.z/a.z;d.w=c.w/a.w;return d}function okVec4DivVal(a,c){var d=okAllocator.vec4();d.x=a.x/c;d.y=a.y/c;d.z=a.z/c;d.w=a.w/c;return d}function okValDivVec4(c,a){var d=okAllocator.vec4();d.x=c/a.x;d.y=c/a.y;d.z=c/a.z;d.w=c/a.w;return d}function okVec4Min(c,a){var d=okAllocator.vec4();d.x=c.x<a.x?c.x:a.x;d.y=c.y<a.y?c.y:a.y;d.z=c.z<a.z?c.z:a.z;d.w=c.w<a.w?c.w:a.w;return d}function okVec4Max(c,a){var d=okAllocator.vec4();d.x=c.x>a.x?c.x:a.x;d.y=c.y>a.y?c.y:a.y;d.z=c.z>a.z?c.z:a.z;d.w=c.w>a.w?c.w:a.w;return d}function okVec4Dot(c,a){return c.x*a.x+c.y*a.y+c.z*a.z+c.w*a.w}function okVec4Lerp(e,d,h){var c=okVec4MulVal(e,1-h);var a=okVec4MulVal(d,h);var f=okVec4Add(c,a);okAllocator._vec4(c);okAllocator._vec4(a);return f}function okVec4Len(f,e){var c=f.x-e.x;var a=f.y-e.y;var h=f.z-e.z;var d=f.w-e.w;return Math.sqrt(c*c+a*a+h*h+d*d)}function okMat3(a){this.m00=((a!=null)?a:1);this.m10=0;this.m20=0;this.m01=0;this.m11=((a!=null)?a:1);this.m21=0;this.m02=0;this.m12=0;this.m22=((a!=null)?a:1)}okMat3.prototype={identity:function(){this.m00=1;this.m10=0;this.m20=0;this.m01=0;this.m11=1;this.m21=0;this.m02=0;this.m12=0;this.m22=1},set:function(a){this.m00=a[0];this.m10=a[1];this.m20=a[2];this.m01=a[3];this.m11=a[4];this.m21=a[5];this.m02=a[6];this.m12=a[7];this.m22=a[8]},clone:function(a){var a=(a?a:okAllocator.mat3());a.m00=this.m00;a.m10=this.m10;a.m20=this.m20;a.m01=this.m01;a.m11=this.m11;a.m21=this.m21;a.m02=this.m02;a.m12=this.m12;a.m22=this.m22;return a},equal:function(a){return okFloatEqual(this.m00,a.m00)&&okFloatEqual(this.m10,a.m10)&&okFloatEqual(this.m20,a.m20)&&okFloatEqual(this.m01,a.m01)&&okFloatEqual(this.m11,a.m11)&&okFloatEqual(this.m21,a.m21)&&okFloatEqual(this.m02,a.m02)&&okFloatEqual(this.m12,a.m12)&&okFloatEqual(this.m22,a.m22)},setColumn:function(d,c,a,e){if(d==0){if(okIsNumber(c)){this.m00=c;this.m10=a;this.m20=e}else{this.m00=c.x;this.m10=c.y;this.m20=c.z}}else{if(d==1){if(okIsNumber(c)){this.m01=c;this.m11=a;this.m21=e}else{this.m01=c.x;this.m11=c.y;this.m21=c.z}}else{if(d==2){if(okIsNumber(c)){this.m02=c;this.m12=a;this.m22=e}else{this.m02=c.x;this.m12=c.y;this.m22=c.z}}}}},getColumn:function(c){var a=okAllocator.vec3();if(c==0){a.set(this.m00,this.m10,this.m20)}else{if(c==1){a.set(this.m01,this.m11,this.m21)}else{if(c==2){a.set(this.m02,this.m12,this.m22)}}}return a},det:function(){var n=this.m00,m=this.m01,l=this.m02;var k=this.m10,f=this.m11,e=this.m12;var d=this.m20,c=this.m21,a=this.m22;var h=n*f*a+m*e*d+l*k*c-n*e*c-m*k*a-l*f*d;return h},inverse:function(m){var p=this.m00,o=this.m01,n=this.m02;var k=this.m10,h=this.m11,f=this.m12;var e=this.m20,d=this.m21,c=this.m22;var a=(m?this:okAllocator.mat3());a.m00=h*c-f*d;a.m01=n*d-o*c;a.m02=o*f-n*h;a.m10=f*e-k*c;a.m11=p*c-n*e;a.m12=n*k-p*f;a.m20=k*d-h*e;a.m21=o*e-p*d;a.m22=p*h-o*k;var q=p*h*c+o*f*e+n*k*d-p*f*d-o*k*c-n*h*e;var l=1/q;a.m00*=l;a.m01*=l;a.m02*=l;a.m10*=l;a.m11*=l;a.m12*=l;a.m20*=l;a.m21*=l;a.m22*=l;return a},transpose:function(l){var e=(l?this:okAllocator.mat3());var o=this.m00,n=this.m01,m=this.m02;var k=this.m10,h=this.m11,f=this.m12;var d=this.m20,c=this.m21,a=this.m22;e.m00=o;e.m10=n;e.m20=m;e.m01=k;e.m11=h;e.m21=f;e.m02=d;e.m12=c;e.m22=a;return e},rot:function(C,a,y,x,w,e){var s=okAllocator.vec3();if(w!=null){s.x=y;s.y=x;s.z=w}else{s.x=y.x;s.y=y.y;s.z=y.z;e=x}s.normalize(true);var h=a*Math.PI/180;var u=Math.cos(h*0.5);var v=Math.sin(h*0.5);var o=okAllocator.quat();o.s=u;o.x=v*s.x;o.y=v*s.y;o.z=v*s.z;okAllocator._vec3(s);var t=okAllocator.mat3();o.toMat3(t);var p=this.m00;var B=this.m10;var f=this.m20;var n=this.m01;var A=this.m11;var d=this.m21;var l=this.m02;var z=this.m12;var c=this.m22;var k=(e?this:okAllocator.mat3());if(C==3){k.m00=t.m00*p+t.m01*B+t.m02*f;k.m10=t.m10*p+t.m11*B+t.m12*f;k.m20=t.m20*p+t.m21*B+t.m22*f;k.m01=t.m00*n+t.m01*A+t.m02*d;k.m11=t.m10*n+t.m11*A+t.m12*d;k.m21=t.m20*n+t.m21*A+t.m22*d;k.m02=t.m00*l+t.m01*z+t.m02*c;k.m12=t.m10*l+t.m11*z+t.m12*c;k.m22=t.m20*l+t.m21*z+t.m22*c}else{k.m00=p*t.m00+n*t.m10+l*t.m20;k.m10=B*t.m00+A*t.m10+z*t.m20;k.m20=f*t.m00+d*t.m10+c*t.m20;k.m01=p*t.m01+n*t.m11+l*t.m21;k.m11=B*t.m01+A*t.m11+z*t.m21;k.m21=f*t.m01+d*t.m11+c*t.m21;k.m02=p*t.m02+n*t.m12+l*t.m22;k.m12=B*t.m02+A*t.m12+z*t.m22;k.m22=f*t.m02+d*t.m12+c*t.m22}okAllocator._mat3(t);okAllocator._quat(o);return k},rotX:function(x,c,f){var l=c*Math.PI/180;var k=Math.cos(l),s=Math.sin(l);var q=this.m00;var w=this.m10;var h=this.m20;var p=this.m01;var v=this.m11;var e=this.m21;var o=this.m02;var u=this.m12;var d=this.m22;var n=this.m03;var t=this.m13;var a=this.m23;var m=(f?this:this.clone());if(x==3){m.m10=k*w-s*h;m.m20=s*w+k*h;m.m11=k*v-s*e;m.m21=s*v+k*e;m.m12=k*u-s*d;m.m22=s*u+k*d}else{m.m01=p*k+o*s;m.m11=v*k+u*s;m.m21=e*k+d*s;m.m02=p*-s+o*k;m.m12=v*-s+u*k;m.m22=e*-s+d*k}return m},rotY:function(a,o,q){var d=o*Math.PI/180;var l=Math.cos(d),p=Math.sin(d);var u=this.m00;var n=this.m10;var h=this.m20;var t=this.m01;var m=this.m11;var e=this.m21;var s=this.m02;var k=this.m12;var c=this.m22;var f=(q?this:this.clone());if(a==3){f.m00=l*u+p*h;f.m20=-p*u+l*h;f.m01=l*t+p*e;f.m21=-p*t+l*e;f.m02=l*s+p*c;f.m22=-p*s+l*c}else{f.m00=u*l+s*-p;f.m10=n*l+k*-p;f.m20=h*l+c*-p;f.m02=u*p+s*l;f.m12=n*p+k*l;f.m22=h*p+c*l}return f},rotZ:function(x,c,f){var l=c*Math.PI/180;var k=Math.cos(l),s=Math.sin(l);var q=this.m00;var w=this.m10;var h=this.m20;var p=this.m01;var v=this.m11;var e=this.m21;var o=this.m02;var u=this.m12;var d=this.m22;var n=this.m03;var t=this.m13;var a=this.m23;var m=(f?this:this.clone());if(x==3){m.m00=k*q+-s*w;m.m10=s*q+k*w;m.m01=k*p+-s*v;m.m11=s*p+k*v;m.m02=k*o+-s*u;m.m12=s*o+k*u}else{m.m00=q*k+p*s;m.m10=w*k+v*s;m.m20=h*k+e*s;m.m01=q*-s+p*k;m.m11=w*-s+v*k;m.m21=h*-s+e*k}return m},scale:function(a,h,e,d,m){var l,k,f;if(e){l=h;k=e;f=d}else{if(h.x){l=h.x;e=h.y;d=h.z;m=e}else{l=h;e=h;d=h;m=e}}var c=(m?this:this.clone());if(a==3){c.m00*=l;c.m10*=k;c.m20*=f;c.m01*=l;c.m11*=k;c.m21*=f;c.m02*=l;c.m12*=k;c.m22*=f}else{c.m00*=l;c.m10*=l;c.m20*=l;c.m01*=k;c.m11*=k;c.m21*=k;c.m02*=f;c.m12*=f;c.m22*=f}return c},toMat4:function(a){if(a==null){a=okAllocator.mat4()}a.m00=this.m00;a.m10=this.m10;a.m20=this.m20;a.m30=0;a.m01=this.m01;a.m11=this.m11;a.m21=this.m21;a.m31=0;a.m02=this.m02;a.m12=this.m12;a.m22=this.m22;a.m32=0;a.m03=0;a.m13=0;a.m23=0;a.m33=1;return a},toMat43:function(a){if(a==null){a=okAllocator.mat43()}a.m00=this.m00;a.m10=this.m10;a.m20=this.m20;a.m01=this.m01;a.m11=this.m11;a.m21=this.m21;a.m02=this.m02;a.m12=this.m12;a.m22=this.m22;a.m03=0;a.m13=0;a.m23=0;return a},toQuat:function(a){if(a==null){a=okAllocator.quat()}var d=this.m00+this.m11+this.m22;if(d>0){var c=Math.sqrt(d+1)*2;a.s=0.25*c;a.x=(this.m21-this.m12)/c;a.y=(this.m02-this.m20)/c;a.z=(this.m10-this.m01)/c}else{if((this.m00>this.m11)&&(this.m00>this.m22)){var c=Math.sqrt(1+this.m00-this.m11-this.m22)*2;a.s=(this.m21-this.m12)/c;a.x=0.25*c;a.y=(this.m01+this.m10)/c;a.z=(this.m02+this.m20)/c}else{if(this.m11>this.m22){var c=Math.sqrt(1+this.m11-this.m00-this.m22)*2;a.s=(this.m02-this.m20)/c;a.x=(this.m01+this.m10)/c;a.y=0.25*c;a.z=(this.m12+this.m21)/c}else{var c=Math.sqrt(1+this.m22-this.m00-this.m11)*2;a.s=(this.m10-this.m01)/c;a.x=(this.m02+this.m20)/c;a.y=(this.m12+this.m21)/c;a.z=0.25*c}}}return a},toArray:function(a){if(a==null){a=okAllocator.array()}a.push(this.m00,this.m10,this.m20,this.m01,this.m11,this.m21,this.m02,this.m12,this.m22,this.m03,this.m13,this.m23);return a}};function okMat3Add(d,c){var a=okAllocator.mat3();a.m00=d.m00+c.m00;a.m10=d.m10+c.m10;a.m20=d.m20+c.m20;a.m01=d.m01+c.m01;a.m11=d.m11+c.m11;a.m21=d.m21+c.m21;a.m02=d.m02+c.m02;a.m12=d.m12+c.m12;a.m22=d.m22+c.m22;return a}function okMat3AddVal(c,d){var a=okAllocator.mat3();a.m00=c.m00+d;a.m10=c.m10+d;a.m20=c.m20+d;a.m01=c.m01+d;a.m11=c.m11+d;a.m21=c.m21+d;a.m02=c.m02+d;a.m12=c.m12+d;a.m22=c.m22+d;return a}function okValAddMat3(d,c){var a=okAllocator.mat3();a.m00=c.m00+d;a.m10=c.m10+d;a.m20=c.m20+d;a.m01=c.m01+d;a.m11=c.m11+d;a.m21=c.m21+d;a.m02=c.m02+d;a.m12=c.m12+d;a.m22=c.m22+d;return a}function okMat3Sub(d,c){var a=okAllocator.mat3();a.m00=d.m00-c.m00;a.m10=d.m10-c.m10;a.m20=d.m20-c.m20;a.m01=d.m01-c.m01;a.m11=d.m11-c.m11;a.m21=d.m21-c.m21;a.m02=d.m02-c.m02;a.m12=d.m12-c.m12;a.m22=d.m22-c.m22;return a}function okMat3SubVal(c,d){var a=okAllocator.mat3();a.m00=c.m00-d;a.m10=c.m10-d;a.m20=c.m20-d;a.m01=c.m01-d;a.m11=c.m11-d;a.m21=c.m21-d;a.m02=c.m02-d;a.m12=c.m12-d;a.m22=c.m22-d;return a}function okValSubMat3(d,c){var a=okAllocator.mat3();a.m00=d-c.m00;a.m10=d-c.m10;a.m20=d-c.m20;a.m01=d-c.m01;a.m11=d-c.m11;a.m21=d-c.m21;a.m02=d-c.m02;a.m12=d-c.m12;a.m22=d-c.m22;return a}function okMat3Mul(d,c){var a=okAllocator.mat3();a.m00=d.m00*c.m00+d.m01*c.m10+d.m02*c.m20;a.m10=d.m10*c.m00+d.m11*c.m10+d.m12*c.m20;a.m20=d.m20*c.m00+d.m21*c.m10+d.m22*c.m20;a.m01=d.m00*c.m01+d.m01*c.m11+d.m02*c.m21;a.m11=d.m10*c.m01+d.m11*c.m11+d.m12*c.m21;a.m21=d.m20*c.m01+d.m21*c.m11+d.m22*c.m21;a.m02=d.m00*c.m02+d.m01*c.m12+d.m02*c.m22;a.m12=d.m10*c.m02+d.m11*c.m12+d.m12*c.m22;a.m22=d.m20*c.m02+d.m21*c.m12+d.m22*c.m22;return a}function okMat3MulVal(c,d){var a=okAllocator.mat3();a.m00=c.m00*d;a.m10=c.m10*d;a.m20=c.m20*d;a.m01=c.m01*d;a.m11=c.m11*d;a.m21=c.m21*d;a.m02=c.m02*d;a.m12=c.m12*d;a.m22=c.m22*d;return a}function okValMulMat3(d,c){var a=okAllocator.mat3();a.m00=c.m00*d;a.m10=c.m10*d;a.m20=c.m20*d;a.m01=c.m01*d;a.m11=c.m11*d;a.m21=c.m21*d;a.m02=c.m02*d;a.m12=c.m12*d;a.m22=c.m22*d;return a}function okMat3MulVec3(c,a){var d=okAllocator.vec3();d.x=c.m00*a.x+c.m01*a.y+c.m02*a.z;d.y=c.m10*a.x+c.m11*a.y+c.m12*a.z;d.z=c.m20*a.x+c.m21*a.y+c.m22*a.z;return d}function okMat3Lerp(d,c,e){var a=okAllocator.mat3();a.m00=d.m00*(1-e)+c.m00*e;a.m10=d.m10*(1-e)+c.m10*e;a.m20=d.m20*(1-e)+c.m20*e;a.m01=d.m01*(1-e)+c.m01*e;a.m11=d.m11*(1-e)+c.m11*e;a.m21=d.m21*(1-e)+c.m21*e;a.m02=d.m02*(1-e)+c.m02*e;a.m12=d.m12*(1-e)+c.m12*e;a.m22=d.m22*(1-e)+c.m22*e;return a}function okMat3Scale(e,d,c){var f=okAllocator.vec3();if(d!=null){f.x=e;f.y=d;f.z=c}else{f.x=e.x;f.y=e.y;f.z=e.z}var a=okAllocator.mat3();a.m00=f.x;a.m11=f.y;a.m22=f.z;okAllocator._vec3(f);return a}function okMat3RotX(e){var f=e*Math.PI/180;var a=Math.cos(f),d=Math.sin(f);var c=okAllocator.mat3();c.m11=a;c.m12=-d;c.m21=d;c.m22=a;return c}function okMat3RotY(e){var f=e*Math.PI/180;var a=Math.cos(f),d=Math.sin(f);var c=okAllocator.mat3();c.m00=a;c.m02=d;c.m20=-d;c.m22=a;return c}function okMat3RotZ(e){var f=e*Math.PI/180;var a=Math.cos(f),d=Math.sin(f);var c=okAllocator.mat3();c.m00=a;c.m01=-d;c.m10=d;c.m11=a;return c}function okMat3Rot(l,o,n,m){var d=l*Math.PI/180;var h=okAllocator.vec3();if(n!=null){h.x=o;h.y=n;h.z=m}else{h.x=o.x;h.y=o.y;h.z=o.z}var k=h.normalize();okAllocator._vec3(h);var e=Math.cos(d*0.5);var c=Math.sin(d*0.5);var a=new okQuat();a.s=e;a.x=c*k.x;a.y=c*k.y;a.z=c*k.z;okAllocator._vec3(k);var f=okAllocator.mat3();a.toMat3(f);okAllocator._quat(a);return f}function okMat4(a){this.m00=((a!=null)?a:1);this.m10=0;this.m20=0;this.m30=0;this.m01=0;this.m11=((a!=null)?a:1);this.m21=0;this.m31=0;this.m02=0;this.m12=0;this.m22=((a!=null)?a:1);this.m32=0;this.m03=0;this.m13=0;this.m23=0;this.m33=((a!=null)?a:1)}okMat4.prototype={set:function(a){this.m00=a[0];this.m10=a[1];this.m20=a[2];this.m30=a[3];this.m01=a[4];this.m11=a[5];this.m21=a[6];this.m31=a[7];this.m02=a[8];this.m12=a[9];this.m22=a[10];this.m32=a[11];this.m03=a[12];this.m13=a[13];this.m23=a[14];this.m33=a[15]},identity:function(){this.m00=1;this.m10=0;this.m20=0;this.m30=0;this.m01=0;this.m11=1;this.m21=0;this.m31=0;this.m02=0;this.m12=0;this.m22=1;this.m32=0;this.m03=0;this.m13=0;this.m23=0;this.m33=1},clone:function(a){var a=(a?a:okAllocator.mat4());a.m00=this.m00;a.m10=this.m10;a.m20=this.m20;a.m30=this.m30;a.m01=this.m01;a.m11=this.m11;a.m21=this.m21;a.m31=this.m31;a.m02=this.m02;a.m12=this.m12;a.m22=this.m22;a.m32=this.m32;a.m03=this.m03;a.m13=this.m13;a.m23=this.m23;a.m33=this.m33;return a},equal:function(a){return okFloatEqual(this.m00,a.m00)&&okFloatEqual(this.m10,a.m10)&&okFloatEqual(this.m20,a.m20)&&okFloatEqual(this.m30,a.m30)&&okFloatEqual(this.m01,a.m01)&&okFloatEqual(this.m11,a.m11)&&okFloatEqual(this.m21,a.m21)&&okFloatEqual(this.m31,a.m31)&&okFloatEqual(this.m02,a.m02)&&okFloatEqual(this.m12,a.m12)&&okFloatEqual(this.m22,a.m22)&&okFloatEqual(this.m32,a.m32)&&okFloatEqual(this.m03,a.m03)&&okFloatEqual(this.m13,a.m13)&&okFloatEqual(this.m23,a.m23)&&okFloatEqual(this.m33,a.m33)},setColumn:function(d,c,a,f,e){if(d==0){if(okIsNumber(c)){this.m00=c;this.m10=a;this.m20=f;this.m30=(e?e:this.m30)}else{this.m00=c.x;this.m10=c.y;this.m20=c.z;this.m30=(c.w?c.w:this.m30)}}else{if(d==1){if(okIsNumber(c)){this.m01=c;this.m11=a;this.m21=f;this.m31=(e?e:this.m31)}else{this.m01=c.x;this.m11=c.y;this.m21=c.z;this.m31=(c.w?c.w:this.m31)}}else{if(d==2){if(okIsNumber(c)){this.m02=c;this.m12=a;this.m22=f;this.m32=(e?e:this.m32)}else{this.m02=c.x;this.m12=c.y;this.m22=c.z;this.m32=(c.w?c.w:this.m32)}}else{if(d==3){if(okIsNumber(c)){this.m03=c;this.m13=a;this.m23=f;this.m33=(e?e:this.m33)}else{this.m03=c.x;this.m13=c.y;this.m23=c.z;this.m33=(c.w?c.w:this.m33)}}}}}},getColumn:function(c){var a=okAllocator.vec4();if(c==0){a.set(this.m00,this.m10,this.m20,this.m30)}else{if(c==1){a.set(this.m01,this.m11,this.m21,this.m31)}else{if(c==2){a.set(this.m02,this.m12,this.m22,this.m32)}else{if(c==3){a.set(this.m03,this.m13,this.m23,this.m33)}}}}return a},det:function(){var v=this.m00,u=this.m01,s=this.m02,p=this.m03;var m=this.m10,k=this.m11,h=this.m12,f=this.m13;var e=this.m20,d=this.m21,c=this.m22,a=this.m23;var t=this.m30,q=this.m31,o=this.m32,n=this.m33;var l=v*k*c*n+v*h*a*q+v*f*d*o+u*m*a*o+u*h*e*n+u*f*c*t+s*m*d*n+s*k*a*t+s*f*e*q+p*m*c*q+p*k*e*o+p*h*d*t-v*k*a*o-v*h*d*n-v*f*c*q-u*m*c*n-u*h*a*t-u*f*e*o-s*m*a*q-s*k*e*n-s*f*d*t-p*m*d*o-p*k*c*t-p*h*e*q;return l},inverse:function(l){var h=this.m00,e=this.m01,c=this.m02,a=this.m03;var t=this.m10,s=this.m11,q=this.m12,p=this.m13;var y=this.m20,x=this.m21,w=this.m22,v=this.m23;var m=this.m30,k=this.m31,f=this.m32,d=this.m33;var o=(l?this:okAllocator.mat4());o.m00=s*w*d+q*v*k+p*x*f-s*v*f-q*x*d-p*w*k;o.m01=e*v*f+c*x*d+a*w*k-e*w*d-c*v*k-a*x*f;o.m02=e*q*d+c*p*k+a*s*f-e*p*f-c*s*d-a*q*k;o.m03=e*p*w+c*s*v+a*q*x-e*q*v-c*p*x-a*s*w;o.m10=t*v*f+q*y*d+p*w*m-t*w*d-q*v*m-p*y*f;o.m11=h*w*d+c*v*m+a*y*f-h*v*f-c*y*d-a*w*m;o.m12=h*p*f+c*t*d+a*q*m-h*q*d-c*p*m-a*t*f;o.m13=h*q*v+c*p*y+a*t*w-h*p*w-c*t*v-a*q*y;o.m20=t*x*d+s*v*m+p*y*k-t*v*k-s*y*d-p*x*m;o.m21=h*v*k+e*y*d+a*x*m-h*x*d-e*v*m-a*y*k;o.m22=h*s*d+e*p*m+a*t*k-h*p*k-e*t*d-a*s*m;o.m23=h*p*x+e*t*v+a*s*y-h*s*v-e*p*y-a*t*x;o.m30=t*w*k+s*y*f+q*x*m-t*x*f-s*w*m-q*y*k;o.m31=h*x*f+e*w*m+c*y*k-h*w*k-e*y*f-c*x*m;o.m32=h*q*k+e*t*f+c*s*m-h*s*f-e*q*m-c*t*k;o.m33=h*s*w+e*q*y+c*t*x-h*q*x-e*t*w-c*s*y;var u=h*s*w*d+h*q*v*k+h*p*x*f+e*t*v*f+e*q*y*d+e*p*w*m+c*t*x*d+c*s*v*m+c*p*y*k+a*t*w*k+a*s*y*f+a*q*x*m-h*s*v*f-h*q*x*d-h*p*w*k-e*t*w*d-e*q*v*m-e*p*y*f-c*t*v*k-c*s*y*d-c*p*x*m-a*t*x*f-a*s*w*m-a*q*y*k;var n=1/u;o.m00*=n;o.m01*=n;o.m02*=n;o.m03*=n;o.m10*=n;o.m11*=n;o.m12*=n;o.m13*=n;o.m20*=n;o.m21*=n;o.m22*=n;o.m23*=n;o.m30*=n;o.m31*=n;o.m32*=n;o.m33*=n;return o},transpose:function(e){var h=(e?this:okAllocator.mat4());var p=this.m00,n=this.m01,m=this.m02,k=this.m03;var w=this.m10,v=this.m11,u=this.m12,t=this.m13;var f=this.m20,d=this.m21,c=this.m22,a=this.m23;var s=this.m30,q=this.m31,o=this.m32,l=this.m33;h.m00=p;h.m10=n;h.m20=m;h.m30=k;h.m01=w;h.m11=v;h.m21=u;h.m31=t;h.m02=f;h.m12=d;h.m22=c;h.m32=a;h.m03=s;h.m13=q;h.m23=o;h.m33=l;return h},translate:function(h,f,e,c,d){if(f.x){d=e;e=f.y;c=f.z;f=f.x}else{if(c==null){d=e;e=f;c=f}}var a=(d?this:this.clone());if(h==3){a.m00=this.m00+f*this.m30;a.m10=this.m10+e*this.m30;a.m20=this.m20+c*this.m30;a.m01=this.m01+f*this.m31;a.m11=this.m11+e*this.m31;a.m21=this.m21+c*this.m31;a.m02=this.m02+f*this.m32;a.m12=this.m12+e*this.m32;a.m22=this.m22+c*this.m32;a.m03=this.m03+f*this.m33;a.m13=this.m13+e*this.m33;a.m23=this.m23+c*this.m33}else{a.m03=this.m03+this.m00*f+this.m01*e+this.m02*c;a.m13=this.m13+this.m10*f+this.m11*e+this.m12*c;a.m23=this.m23+this.m20*f+this.m21*e+this.m22*c;a.m33=this.m33+this.m30*f+this.m31*e+this.m32*c}return a},rot:function(J,c,E,D,C,f){var x=okAllocator.vec3();if(C!=null){x.x=E;x.y=D;x.z=C}else{x.x=E.x;x.y=E.y;x.z=E.z;f=D}x.normalize(true);var k=c*Math.PI/180;var A=Math.cos(k*0.5);var B=Math.sin(k*0.5);var u=okAllocator.quat();u.s=A;u.x=B*x.x;u.y=B*x.y;u.z=B*x.z;okAllocator._vec3(x);var z=okAllocator.mat4();u.toMat4(z);var w=this.m00;var I=this.m10;var h=this.m20;var y=this.m30;var t=this.m01;var H=this.m11;var e=this.m21;var v=this.m31;var p=this.m02;var G=this.m12;var d=this.m22;var s=this.m32;var n=this.m03;var F=this.m13;var a=this.m23;var o=this.m33;var l=(f?this:okAllocator.mat4());if(J==3){l.m00=z.m00*w+z.m01*I+z.m02*h+z.m03*y;l.m10=z.m10*w+z.m11*I+z.m12*h+z.m13*y;l.m20=z.m20*w+z.m21*I+z.m22*h+z.m23*y;l.m30=z.m30*w+z.m31*I+z.m32*h+z.m33*y;l.m01=z.m00*t+z.m01*H+z.m02*e+z.m03*v;l.m11=z.m10*t+z.m11*H+z.m12*e+z.m13*v;l.m21=z.m20*t+z.m21*H+z.m22*e+z.m23*v;l.m31=z.m30*t+z.m31*H+z.m32*e+z.m33*v;l.m02=z.m00*p+z.m01*G+z.m02*d+z.m03*s;l.m12=z.m10*p+z.m11*G+z.m12*d+z.m13*s;l.m22=z.m20*p+z.m21*G+z.m22*d+z.m23*s;l.m32=z.m30*p+z.m31*G+z.m32*d+z.m33*s;l.m03=z.m00*n+z.m01*F+z.m02*a+z.m03*o;l.m13=z.m10*n+z.m11*F+z.m12*a+z.m13*o;l.m23=z.m20*n+z.m21*F+z.m22*a+z.m23*o;l.m33=z.m30*n+z.m31*F+z.m32*a+z.m33*o}else{l.m00=w*z.m00+t*z.m10+p*z.m20+n*z.m30;l.m10=I*z.m00+H*z.m10+G*z.m20+F*z.m30;l.m20=h*z.m00+e*z.m10+d*z.m20+a*z.m30;l.m30=y*z.m00+v*z.m10+s*z.m20+o*z.m30;l.m01=w*z.m01+t*z.m11+p*z.m21+n*z.m31;l.m11=I*z.m01+H*z.m11+G*z.m21+F*z.m31;l.m21=h*z.m01+e*z.m11+d*z.m21+a*z.m31;l.m31=y*z.m01+v*z.m11+s*z.m21+o*z.m31;l.m02=w*z.m02+t*z.m12+p*z.m22+n*z.m32;l.m12=I*z.m02+H*z.m12+G*z.m22+F*z.m32;l.m22=h*z.m02+e*z.m12+d*z.m22+a*z.m32;l.m32=y*z.m02+v*z.m12+s*z.m22+o*z.m32;l.m03=w*z.m03+t*z.m13+p*z.m23+n*z.m33;l.m13=I*z.m03+H*z.m13+G*z.m23+F*z.m33;l.m23=h*z.m03+e*z.m13+d*z.m23+a*z.m33;l.m33=y*z.m03+v*z.m13+s*z.m23+o*z.m33}okAllocator._mat4(z);okAllocator._quat(u);return l},rotX:function(B,c,f){var l=c*Math.PI/180;var k=Math.cos(l),w=Math.sin(l);var t=this.m00;var A=this.m10;var h=this.m20;var v=this.m30;var s=this.m01;var z=this.m11;var e=this.m21;var u=this.m31;var p=this.m02;var y=this.m12;var d=this.m22;var q=this.m32;var n=this.m03;var x=this.m13;var a=this.m23;var o=this.m33;var m=(f?this:this.clone());if(B==3){m.m10=k*A-w*h;m.m20=w*A+k*h;m.m11=k*z-w*e;m.m21=w*z+k*e;m.m12=k*y-w*d;m.m22=w*y+k*d;m.m03=n;m.m13=k*x-w*a;m.m23=w*x+k*a}else{m.m01=s*k+p*w;m.m11=z*k+y*w;m.m21=e*k+d*w;m.m31=u*k+q*w;m.m02=s*-w+p*k;m.m12=z*-w+y*k;m.m22=e*-w+d*k;m.m32=u*-w+q*k}return m},rotY:function(B,c,f){var l=c*Math.PI/180;var k=Math.cos(l),w=Math.sin(l);var t=this.m00;var A=this.m10;var h=this.m20;var v=this.m30;var s=this.m01;var z=this.m11;var e=this.m21;var u=this.m31;var p=this.m02;var y=this.m12;var d=this.m22;var q=this.m32;var n=this.m03;var x=this.m13;var a=this.m23;var o=this.m33;var m=(f?this:this.clone());if(B==3){m.m00=k*t+w*h;m.m20=-w*t+k*h;m.m01=k*s+w*e;m.m21=-w*s+k*e;m.m02=k*p+w*d;m.m22=-w*p+k*d;m.m03=k*n+w*a;m.m23=-w*n+k*a}else{m.m00=t*k+p*-w;m.m10=A*k+y*-w;m.m20=h*k+d*-w;m.m30=v*k+q*-w;m.m02=t*w+p*k;m.m12=A*w+y*k;m.m22=h*w+d*k;m.m32=v*w+q*k}return m},rotZ:function(B,c,f){var l=c*Math.PI/180;var k=Math.cos(l),w=Math.sin(l);var t=this.m00;var A=this.m10;var h=this.m20;var v=this.m30;var s=this.m01;var z=this.m11;var e=this.m21;var u=this.m31;var p=this.m02;var y=this.m12;var d=this.m22;var q=this.m32;var n=this.m03;var x=this.m13;var a=this.m23;var o=this.m33;var m=(f?this:this.clone());if(B==3){m.m00=k*t+-w*A;m.m10=w*t+k*A;m.m01=k*s+-w*z;m.m11=w*s+k*z;m.m02=k*p+-w*y;m.m12=w*p+k*y;m.m03=k*n+-w*x;m.m13=w*n+k*x}else{m.m00=t*k+s*w;m.m10=A*k+z*w;m.m20=h*k+e*w;m.m30=v*k+u*w;m.m01=t*-w+s*k;m.m11=A*-w+z*k;m.m21=h*-w+e*k;m.m31=v*-w+u*k}return m},scale:function(a,h,e,d,m){var l,k,f;if(d){l=h;k=e;f=d}else{if(h.x){l=h.x;e=h.y;d=h.z;m=e}else{l=h;e=h;d=h;m=e}}var c=(m?this:this.clone());if(a==3){c.m00*=l;c.m10*=k;c.m20*=f;c.m01*=l;c.m11*=k;c.m21*=f;c.m02*=l;c.m12*=k;c.m22*=f;c.m03*=l;c.m13*=k;c.m23*=f}else{c.m00*=l;c.m10*=l;c.m20*=l;c.m30*=l;c.m01*=k;c.m11*=k;c.m21*=k;c.m31*=k;c.m02*=f;c.m12*=f;c.m22*=f;c.m32*=f}return c},toMat3:function(a){if(a==null){a=okAllocator.mat3()}a.m00=this.m00;a.m10=this.m10;a.m20=this.m20;a.m01=this.m01;a.m11=this.m11;a.m21=this.m21;a.m02=this.m02;a.m12=this.m12;a.m22=this.m22;return a},toMat43:function(a){if(a==null){a=okAllocator.mat43()}a.m00=this.m00;a.m10=this.m10;a.m20=this.m20;a.m01=this.m01;a.m11=this.m11;a.m21=this.m21;a.m02=this.m02;a.m12=this.m12;a.m22=this.m22;a.m03=this.m03;a.m13=this.m13;a.m23=this.m23;return a},toQuat:function(a){if(a==null){a=okAllocator.quat()}var d=this.m00+this.m11+this.m22;if(d>0){var c=Math.sqrt(d+1)*2;a.s=0.25*c;a.x=(this.m21-this.m12)/c;a.y=(this.m02-this.m20)/c;a.z=(this.m10-this.m01)/c}else{if((this.m00>this.m11)&&(this.m00>this.m22)){var c=Math.sqrt(1+this.m00-this.m11-this.m22)*2;a.s=(this.m21-this.m12)/c;a.x=0.25*c;a.y=(this.m01+this.m10)/c;a.z=(this.m02+this.m20)/c}else{if(this.m11>this.m22){var c=Math.sqrt(1+this.m11-this.m00-this.m22)*2;a.s=(this.m02-this.m20)/c;a.x=(this.m01+this.m10)/c;a.y=0.25*c;a.z=(this.m12+this.m21)/c}else{var c=Math.sqrt(1+this.m22-this.m00-this.m11)*2;a.s=(this.m10-this.m01)/c;a.x=(this.m02+this.m20)/c;a.y=(this.m12+this.m21)/c;a.z=0.25*c}}}return a},toArray:function(a){if(a==null){a=okAllocator.array()}a.push(this.m00,this.m10,this.m20,this.m30,this.m01,this.m11,this.m21,this.m31,this.m02,this.m12,this.m22,this.m32,this.m03,this.m13,this.m23,this.m33);return a}};function okMat4Add(d,c){var a=okAllocator.mat4();a.m00=d.m00+c.m00;a.m10=d.m10+c.m10;a.m20=d.m20+c.m20;a.m30=d.m30+c.m30;a.m01=d.m01+c.m01;a.m11=d.m11+c.m11;a.m21=d.m21+c.m21;a.m31=d.m31+c.m31;a.m02=d.m02+c.m02;a.m12=d.m12+c.m12;a.m22=d.m22+c.m22;a.m32=d.m32+c.m32;a.m03=d.m03+c.m03;a.m13=d.m13+c.m13;a.m23=d.m23+c.m23;a.m33=d.m33+c.m33;return a}function okMat4AddVal(c,d){var a=okAllocator.mat4();a.m00=c.m00+d;a.m10=c.m10+d;a.m20=c.m20+d;a.m30=c.m30+d;a.m01=c.m01+d;a.m11=c.m11+d;a.m21=c.m21+d;a.m31=c.m31+d;a.m02=c.m02+d;a.m12=c.m12+d;a.m22=c.m22+d;a.m32=c.m32+d;a.m03=c.m03+d;a.m13=c.m13+d;a.m23=c.m23+d;a.m33=c.m33+d;return a}function okValAddMat4(d,c){var a=okAllocator.mat4();a.m00=c.m00+d;a.m10=c.m10+d;a.m20=c.m20+d;a.m30=c.m30+d;a.m01=c.m01+d;a.m11=c.m11+d;a.m21=c.m21+d;a.m31=c.m31+d;a.m02=c.m02+d;a.m12=c.m12+d;a.m22=c.m22+d;a.m32=c.m32+d;a.m03=c.m03+d;a.m13=c.m13+d;a.m23=c.m23+d;a.m33=c.m33+d;return a}function okMat4Sub(d,c){var a=okAllocator.mat4();a.m00=d.m00-c.m00;a.m10=d.m10-c.m10;a.m20=d.m20-c.m20;a.m30=d.m30-c.m30;a.m01=d.m01-c.m01;a.m11=d.m11-c.m11;a.m21=d.m21-c.m21;a.m31=d.m31-c.m31;a.m02=d.m02-c.m02;a.m12=d.m12-c.m12;a.m22=d.m22-c.m22;a.m32=d.m32-c.m32;a.m03=d.m03-c.m03;a.m13=d.m13-c.m13;a.m23=d.m23-c.m23;a.m33=d.m33-c.m33;return a}function okMat4SubVal(c,d){var a=okAllocator.mat4();a.m00=c.m00-d;a.m10=c.m10-d;a.m20=c.m20-d;a.m30=c.m30-d;a.m01=c.m01-d;a.m11=c.m11-d;a.m21=c.m21-d;a.m31=c.m31-d;a.m02=c.m02-d;a.m12=c.m12-d;a.m22=c.m22-d;a.m32=c.m32-d;a.m03=c.m03-d;a.m13=c.m13-d;a.m23=c.m23-d;a.m33=c.m33-d;return a}function okValSubMat4(d,c){var a=okAllocator.mat4();a.m00=d-c.m00;a.m10=d-c.m10;a.m20=d-c.m20;a.m30=d-c.m30;a.m01=d-c.m01;a.m11=d-c.m11;a.m21=d-c.m21;a.m31=d-c.m31;a.m02=d-c.m02;a.m12=d-c.m12;a.m22=d-c.m22;a.m32=d-c.m32;a.m03=d-c.m03;a.m13=d-c.m13;a.m23=d-c.m23;a.m33=d-c.m33;return a}function okMat4Mul(d,c){var a=okAllocator.mat4();a.m00=d.m00*c.m00+d.m01*c.m10+d.m02*c.m20+d.m03*c.m30;a.m10=d.m10*c.m00+d.m11*c.m10+d.m12*c.m20+d.m13*c.m30;a.m20=d.m20*c.m00+d.m21*c.m10+d.m22*c.m20+d.m23*c.m30;a.m30=d.m30*c.m00+d.m31*c.m10+d.m32*c.m20+d.m33*c.m30;a.m01=d.m00*c.m01+d.m01*c.m11+d.m02*c.m21+d.m03*c.m31;a.m11=d.m10*c.m01+d.m11*c.m11+d.m12*c.m21+d.m13*c.m31;a.m21=d.m20*c.m01+d.m21*c.m11+d.m22*c.m21+d.m23*c.m31;a.m31=d.m30*c.m01+d.m31*c.m11+d.m32*c.m21+d.m33*c.m31;a.m02=d.m00*c.m02+d.m01*c.m12+d.m02*c.m22+d.m03*c.m32;a.m12=d.m10*c.m02+d.m11*c.m12+d.m12*c.m22+d.m13*c.m32;a.m22=d.m20*c.m02+d.m21*c.m12+d.m22*c.m22+d.m23*c.m32;a.m32=d.m30*c.m02+d.m31*c.m12+d.m32*c.m22+d.m33*c.m32;a.m03=d.m00*c.m03+d.m01*c.m13+d.m02*c.m23+d.m03*c.m33;a.m13=d.m10*c.m03+d.m11*c.m13+d.m12*c.m23+d.m13*c.m33;a.m23=d.m20*c.m03+d.m21*c.m13+d.m22*c.m23+d.m23*c.m33;a.m33=d.m30*c.m03+d.m31*c.m13+d.m32*c.m23+d.m33*c.m33;return a}function okMat4MulVal(c,d){var a=okAllocator.mat4();a.m00=c.m00*d;a.m10=c.m10*d;a.m20=c.m20*d;a.m30=c.m30*d;a.m01=c.m01*d;a.m11=c.m11*d;a.m21=c.m21*d;a.m31=c.m31*d;a.m02=c.m02*d;a.m12=c.m12*d;a.m22=c.m22*d;a.m32=c.m32*d;a.m03=c.m03*d;a.m13=c.m13*d;a.m23=c.m23*d;a.m33=c.m33*d;return a}function okValMulMat4(d,c){var a=okAllocator.mat4();a.m00=c.m00*d;a.m10=c.m10*d;a.m20=c.m20*d;a.m30=c.m30*d;a.m01=c.m01*d;a.m11=c.m11*d;a.m21=c.m21*d;a.m31=c.m31*d;a.m02=c.m02*d;a.m12=c.m12*d;a.m22=c.m22*d;a.m32=c.m32*d;a.m03=c.m03*d;a.m13=c.m13*d;a.m23=c.m23*d;a.m33=c.m33*d;return a}function okMat4MulVec4(c,a){var d=okAllocator.vec4();d.x=c.m00*a.x+c.m01*a.y+c.m02*a.z+c.m03*a.w;d.y=c.m10*a.x+c.m11*a.y+c.m12*a.z+c.m13*a.w;d.z=c.m20*a.x+c.m21*a.y+c.m22*a.z+c.m23*a.w;d.w=c.m30*a.x+c.m31*a.y+c.m32*a.z+c.m33*a.w;return d}function okMat4MulVec3(d,c){var a=okAllocator.vec4();a.x=d.m00*c.x+d.m01*c.y+d.m02*c.z+d.m03;a.y=d.m10*c.x+d.m11*c.y+d.m12*c.z+d.m13;a.z=d.m20*c.x+d.m21*c.y+d.m22*c.z+d.m23;a.w=d.m30*c.x+d.m31*c.y+d.m32*c.z+d.m33;var e=1/a.w;var f=okAllocator.vec3();f.x=a.x*e;f.y=a.y*e;f.z=a.z*e;return f}function okMat4Lerp(d,c,e){var a=okAllocator.mat4();a.m00=d.m00*(1-e)+c.m00*e;a.m10=d.m10*(1-e)+c.m10*e;a.m20=d.m20*(1-e)+c.m20*e;a.m30=d.m30*(1-e)+c.m30*e;a.m01=d.m01*(1-e)+c.m01*e;a.m11=d.m11*(1-e)+c.m11*e;a.m21=d.m21*(1-e)+c.m21*e;a.m31=d.m31*(1-e)+c.m31*e;a.m02=d.m02*(1-e)+c.m02*e;a.m12=d.m12*(1-e)+c.m12*e;a.m22=d.m22*(1-e)+c.m22*e;a.m32=d.m32*(1-e)+c.m32*e;a.m03=d.m03*(1-e)+c.m03*e;a.m13=d.m13*(1-e)+c.m13*e;a.m23=d.m23*(1-e)+c.m23*e;a.m33=d.m33*(1-e)+c.m33*e;return a}function okMat4Trans(f,e,d){var c=okAllocator.vec3();if(e!=null){c.x=f;c.y=e;c.z=d}else{c.x=f.x;c.y=f.y;c.z=f.z}var a=okAllocator.mat4();a.setColumn(3,c.x,c.y,c.z,1);okAllocator._vec3(c);return a}function okMat4Scale(e,d,c){var f=okAllocator.vec3();if(d!=null){f.x=e;f.y=d;f.z=c}else{f.x=e.x;f.y=e.y;f.z=e.z}var a=okAllocator.mat4();a.m00=f.x;a.m11=f.y;a.m22=f.z;okAllocator._vec3(f);return a}function okMat4Rot(l,o,n,m){var h=okAllocator.vec3();if(n!=null){h.x=o;h.y=n;h.z=m}else{h.x=o.x;h.y=o.y;h.z=o.z}var k=h.normalize();okAllocator._vec3(h);var d=l*Math.PI/180;var e=Math.cos(d*0.5);var c=Math.sin(d*0.5);var a=new okQuat();a.s=e;a.x=c*k.x;a.y=c*k.y;a.z=c*k.z;okAllocator._vec3(k);var f=okAllocator.mat4();a.toMat4(f);return f}function okMat4RotX(e){var f=e*Math.PI/180;var a=Math.cos(f),d=Math.sin(f);var c=okAllocator.mat4();c.m11=a;c.m12=-d;c.m21=d;c.m22=a;return c}function okMat4RotY(e){var f=e*Math.PI/180;var a=Math.cos(f),d=Math.sin(f);var c=okAllocator.mat4();c.m00=a;c.m02=d;c.m20=-d;c.m22=a;return c}function okMat4RotZ(e){var f=e*Math.PI/180;var a=Math.cos(f),d=Math.sin(f);var c=okAllocator.mat4();c.m00=a;c.m01=-d;c.m10=d;c.m11=a;return c}function okMat4Proj(c,l,h,k){var f=c*Math.PI/360;var a=k-h;var e=1/Math.tan(f);var d=okAllocator.mat4();d.m00=e/l;d.m11=e;d.m22=-(k+h)/a;d.m32=-1;d.m23=-2*h*k/a;d.m33=0;return d}function okMat4Ortho(a,h,e,d,f,k){var c=okAllocator.mat4();c.m00=2/(h-a);c.m11=2/(e-d);c.m22=-2/(k-f);c.m03=-(h+a)/(h-a);c.m13=-(e+d)/(e-d);c.m23=-(k+f)/(k-f);return c}function okMat43(a){this.m00=((a!=null)?a:1);this.m10=0;this.m20=0;this.m01=0;this.m11=((a!=null)?a:1);this.m21=0;this.m02=0;this.m12=0;this.m22=((a!=null)?a:1);this.m03=0;this.m13=0;this.m23=0}okMat43.prototype={set:function(a){this.m00=a[0];this.m10=a[1];this.m20=a[2];this.m01=a[3];this.m11=a[4];this.m21=a[5];this.m02=a[6];this.m12=a[7];this.m22=a[8];this.m03=a[9];this.m13=a[10];this.m23=a[11]},identity:function(){this.m00=1;this.m10=0;this.m20=0;this.m01=0;this.m11=1;this.m21=0;this.m02=0;this.m12=0;this.m22=1;this.m03=0;this.m13=0;this.m23=0},clone:function(a){var a=(a?a:okAllocator.mat43());a.m00=this.m00;a.m10=this.m10;a.m20=this.m20;a.m01=this.m01;a.m11=this.m11;a.m21=this.m21;a.m02=this.m02;a.m12=this.m12;a.m22=this.m22;a.m03=this.m03;a.m13=this.m13;a.m23=this.m23;return a},equal:function(a){return okFloatEqual(this.m00,a.m00)&&okFloatEqual(this.m10,a.m10)&&okFloatEqual(this.m20,a.m20)&&okFloatEqual(this.m01,a.m01)&&okFloatEqual(this.m11,a.m11)&&okFloatEqual(this.m21,a.m21)&&okFloatEqual(this.m02,a.m02)&&okFloatEqual(this.m12,a.m12)&&okFloatEqual(this.m22,a.m22)&&okFloatEqual(this.m03,a.m03)&&okFloatEqual(this.m13,a.m13)&&okFloatEqual(this.m23,a.m23)},setColumn:function(d,c,a,e){if(d==0){if(okIsNumber(c)){this.m00=c;this.m10=a;this.m20=e}else{this.m00=c.x;this.m10=c.y;this.m20=c.z}}else{if(d==1){if(okIsNumber(c)){this.m01=c;this.m11=a;this.m21=e}else{this.m01=c.x;this.m11=c.y;this.m21=c.z}}else{if(d==2){if(okIsNumber(c)){this.m02=c;this.m12=a;this.m22=e}else{this.m02=c.x;this.m12=c.y;this.m22=c.z}}else{if(d==3){if(okIsNumber(c)){this.m03=c;this.m13=a;this.m23=e}else{this.m03=c.x;this.m13=c.y;this.m23=c.z}}}}}},getColumn:function(c){var a=okAllocator.vec3();if(c==0){a.set(this.m00,this.m10,this.m20)}else{if(c==1){a.set(this.m01,this.m11,this.m21)}else{if(c==2){a.set(this.m02,this.m12,this.m22)}else{if(c==3){a.set(this.m03,this.m13,this.m23)}}}}return a},det:function(){var q=this.m00,p=this.m01,o=this.m02,n=this.m03;var m=this.m10,k=this.m11,h=this.m12,f=this.m13;var e=this.m20,d=this.m21,c=this.m22,a=this.m23;var l=q*k*c+p*h*e+o*m*d-q*h*d-p*m*c-o*k*e;return l},inverse:function(p){var t=this.m00,s=this.m01,q=this.m02,o=this.m03;var m=this.m10,l=this.m11,k=this.m12,h=this.m13;var f=this.m20,e=this.m21,d=this.m22,c=this.m23;var a=(p?this:okAllocator.mat43());a.m00=l*d-k*e;a.m01=q*e-s*d;a.m02=s*k-q*l;a.m03=s*h*d+q*l*c+o*k*e-s*k*c-q*h*e-o*l*d;a.m10=k*f-m*d;a.m11=t*d-q*f;a.m12=q*m-t*k;a.m13=t*k*c+q*h*f+o*m*d-t*h*d-q*m*c-o*k*f;a.m20=m*e-l*f;a.m21=s*f-t*e;a.m22=t*l-s*m;a.m23=t*h*e+s*m*c+o*l*f-t*l*c-s*h*f-o*m*e;var u=t*l*d+s*k*f+q*m*e-t*k*e-s*m*d-q*l*f;var n=1/u;a.m00*=n;a.m01*=n;a.m02*=n;a.m03*=n;a.m10*=n;a.m11*=n;a.m12*=n;a.m13*=n;a.m20*=n;a.m21*=n;a.m22*=n;a.m23*=n;return a},transpose:function(l){var e=(l?this:okAllocator.mat43());var o=this.m00,n=this.m01,m=this.m02;var k=this.m10,h=this.m11,f=this.m12;var d=this.m20,c=this.m21,a=this.m22;e.m00=o;e.m10=n;e.m20=m;e.m01=k;e.m11=h;e.m21=f;e.m02=d;e.m12=c;e.m22=a;e.m03=0;e.m13=0;e.m23=0;return e},translate:function(h,f,e,c,d){if(f.x){d=e;c=f.z;e=f.y;f=f.x}else{if(c==null){d=e;c=f;e=f}}var a=this;if(d){a=this.clone()}if(h==3){a.m03+=f;a.m13+=e;a.m23+=c}else{a.m03+=this.m00*f+this.m01*e+this.m02*c;a.m13+=this.m10*f+this.m11*e+this.m12*c;a.m23+=this.m20*f+this.m21*e+this.m22*c}return a},rot:function(F,c,A,z,y,f){var u=okAllocator.vec3();if(y!=null){u.x=A;u.y=z;u.z=y}else{u.x=A.x;u.y=A.y;u.z=A.z;f=z}u.normalize(true);var k=c*Math.PI/180;var w=Math.cos(k*0.5);var x=Math.sin(k*0.5);var s=okAllocator.quat();s.s=w;s.x=x*u.x;s.y=x*u.y;s.z=x*u.z;okAllocator._vec3(u);var v=okAllocator.mat4();s.toMat4(v);var t=this.m00;var E=this.m10;var h=this.m20;var p=this.m01;var D=this.m11;var e=this.m21;var o=this.m02;var C=this.m12;var d=this.m22;var n=this.m03;var B=his.m13;var a=this.m23;var l=(f?this:okAllocator.mat43());if(F==3){l.m00=v.m00*t+v.m01*E+v.m02*h;l.m10=v.m10*t+v.m11*E+v.m12*h;l.m20=v.m20*t+v.m21*E+v.m22*h;l.m01=v.m00*p+v.m01*D+v.m02*e;l.m11=v.m10*p+v.m11*D+v.m12*e;l.m21=v.m20*p+v.m21*D+v.m22*e;l.m02=v.m00*o+v.m01*C+v.m02*d;l.m12=v.m10*o+v.m11*C+v.m12*d;l.m22=v.m20*o+v.m21*C+v.m22*d;l.m03=v.m00*n+v.m01*B+v.m02*a+v.m03;l.m13=v.m10*n+v.m11*B+v.m12*a+v.m13;l.m23=v.m20*n+v.m21*B+v.m22*a+v.m23}else{l.m00=t*v.m00+p*v.m10+o*v.m20;l.m10=E*v.m00+D*v.m10+C*v.m20;l.m20=h*v.m00+e*v.m10+d*v.m20;l.m01=t*v.m01+p*v.m11+o*v.m21;l.m11=E*v.m01+D*v.m11+C*v.m21;l.m21=h*v.m01+e*v.m11+d*v.m21;l.m02=t*v.m02+p*v.m12+o*v.m22;l.m12=E*v.m02+D*v.m12+C*v.m22;l.m22=h*v.m02+e*v.m12+d*v.m22;l.m03=t*v.m03+p*v.m13+o*v.m23+n;l.m13=E*v.m03+D*v.m13+C*v.m23+B;l.m23=h*v.m03+e*v.m13+d*v.m23+a}okAllocator._mat4(v);okAllocator._quat(s);return l},rotX:function(x,c,f){var l=c*Math.PI/180;var k=Math.cos(l),s=Math.sin(l);var q=this.m00;var w=this.m10;var h=this.m20;var p=this.m01;var v=this.m11;var e=this.m21;var o=this.m02;var u=this.m12;var d=this.m22;var n=this.m03;var t=this.m13;var a=this.m23;var m=(f?this:this.clone());if(x==3){m.m10=k*w-s*h;m.m20=s*w+k*h;m.m11=k*v-s*e;m.m21=s*v+k*e;m.m12=k*u-s*d;m.m22=s*u+k*d;m.m03=n;m.m13=k*t-s*a;m.m23=s*t+k*a}else{m.m01=p*k+o*s;m.m11=v*k+u*s;m.m21=e*k+d*s;m.m02=p*-s+o*k;m.m12=v*-s+u*k;m.m22=e*-s+d*k}return m},rotY:function(x,c,f){var l=c*Math.PI/180;var k=Math.cos(l),s=Math.sin(l);var q=this.m00;var w=this.m10;var h=this.m20;var p=this.m01;var v=this.m11;var e=this.m21;var o=this.m02;var u=this.m12;var d=this.m22;var n=this.m03;var t=this.m13;var a=this.m23;var m=(f?this:this.clone());if(x==3){m.m00=k*q+s*h;m.m20=-s*q+k*h;m.m01=k*p+s*e;m.m21=-s*p+k*e;m.m02=k*o+s*d;m.m22=-s*o+k*d;m.m03=k*n+s*a;m.m23=-s*n+k*a}else{m.m00=q*k+o*-s;m.m10=w*k+u*-s;m.m20=h*k+d*-s;m.m02=q*s+o*k;m.m12=w*s+u*k;m.m22=h*s+d*k}return m},rotZ:function(x,c,f){var l=c*Math.PI/180;var k=Math.cos(l),s=Math.sin(l);var q=this.m00;var w=this.m10;var h=this.m20;var p=this.m01;var v=this.m11;var e=this.m21;var o=this.m02;var u=this.m12;var d=this.m22;var n=this.m03;var t=this.m13;var a=this.m23;var m=(f?this:this.clone());if(x==3){m.m00=k*q+-s*w;m.m10=s*q+k*w;m.m01=k*p+-s*v;m.m11=s*p+k*v;m.m02=k*o+-s*u;m.m12=s*o+k*u;m.m03=k*n+-s*t;m.m13=s*n+k*t}else{m.m00=q*k+p*s;m.m10=w*k+v*s;m.m20=h*k+e*s;m.m01=q*-s+p*k;m.m11=w*-s+v*k;m.m21=h*-s+e*k}return m},scale:function(a,h,e,d,m){var l,k,f;if(e){l=h;k=e;f=d}else{if(h.x){l=h.x;e=h.y;d=h.z;m=e}else{l=h;e=h;d=h;m=e}}var c=(m?this:this.clone());if(a==3){c.m00*=l;c.m10*=k;c.m20*=f;c.m01*=l;c.m11*=k;c.m21*=f;c.m02*=l;c.m12*=k;c.m22*=f;c.m03*=l;c.m13*=k;c.m23*=f}else{c.m00*=l;c.m10*=l;c.m20*=l;c.m01*=k;c.m11*=k;c.m21*=k;c.m02*=f;c.m12*=f;c.m22*=f}return c},toMat3:function(a){if(a==null){a=okAllocator.mat3()}a.m00=this.m00;a.m10=this.m10;a.m20=this.m20;a.m30=0;a.m01=this.m01;a.m11=this.m11;a.m21=this.m21;a.m31=0;a.m02=this.m02;a.m12=this.m12;a.m22=this.m22;a.m32=0;return a},toMat4:function(a){if(a==null){a=okAllocator.mat4()}a.m00=this.m00;a.m10=this.m10;a.m20=this.m20;a.m30=0;a.m01=this.m01;a.m11=this.m11;a.m21=this.m21;a.m31=0;a.m02=this.m02;a.m12=this.m12;a.m22=this.m22;a.m32=0;a.m03=this.m03;a.m13=this.m13;a.m23=this.m23;a.m33=1;return a},toQuat:function(a){if(a==null){a=okAllocator.quat()}var d=this.m00+this.m11+this.m22;if(d>0){var c=Math.sqrt(d+1)*2;a.s=0.25*c;a.x=(this.m21-this.m12)/c;a.y=(this.m02-this.m20)/c;a.z=(this.m10-this.m01)/c}else{if((this.m00>this.m11)&&(this.m00>this.m22)){var c=Math.sqrt(1+this.m00-this.m11-this.m22)*2;a.s=(this.m21-this.m12)/c;a.x=0.25*c;a.y=(this.m01+this.m10)/c;a.z=(this.m02+this.m20)/c}else{if(this.m11>this.m22){var c=Math.sqrt(1+this.m11-this.m00-this.m22)*2;a.s=(this.m02-this.m20)/c;a.x=(this.m01+this.m10)/c;a.y=0.25*c;a.z=(this.m12+this.m21)/c}else{var c=Math.sqrt(1+this.m22-this.m00-this.m11)*2;a.s=(this.m10-this.m01)/c;a.x=(this.m02+this.m20)/c;a.y=(this.m12+this.m21)/c;a.z=0.25*c}}}return a},toArray:function(a){if(a==null){a=okAllocator.array()}a.push(this.m00,this.m10,this.m20,this.m01,this.m11,this.m21,this.m02,this.m12,this.m22,this.m03,this.m13,this.m23);return a}};function okMat43Add(d,c){var a=okAllocator.mat43();a.m00=d.m00+c.m00;a.m10=d.m10+c.m10;a.m20=d.m20+c.m20;a.m01=d.m01+c.m01;a.m11=d.m11+c.m11;a.m21=d.m21+c.m21;a.m02=d.m02+c.m02;a.m12=d.m12+c.m12;a.m22=d.m22+c.m22;a.m03=d.m03+c.m03;a.m13=d.m13+c.m13;a.m23=d.m23+c.m23;return a}function okMat43AddVal(c,d){var a=okAllocator.mat43();a.m00=c.m00+d;a.m10=c.m10+d;a.m20=c.m20+d;a.m01=c.m01+d;a.m11=c.m11+d;a.m21=c.m21+d;a.m02=c.m02+d;a.m12=c.m12+d;a.m22=c.m22+d;a.m03=c.m03+d;a.m13=c.m13+d;a.m23=c.m23+d;return a}function okValAddMat43(d,c){var a=okAllocator.mat43();a.m00=c.m00+d;a.m10=c.m10+d;a.m20=c.m20+d;a.m01=c.m01+d;a.m11=c.m11+d;a.m21=c.m21+d;a.m02=c.m02+d;a.m12=c.m12+d;a.m22=c.m22+d;a.m03=c.m03+d;a.m13=c.m13+d;a.m23=c.m23+d;return a}function okMat43Sub(d,c){var a=okAllocator.mat43();a.m00=d.m00-c.m00;a.m10=d.m10-c.m10;a.m20=d.m20-c.m20;a.m01=d.m01-c.m01;a.m11=d.m11-c.m11;a.m21=d.m21-c.m21;a.m02=d.m02-c.m02;a.m12=d.m12-c.m12;a.m22=d.m22-c.m22;a.m03=d.m03-c.m03;a.m13=d.m13-c.m13;a.m23=d.m23-c.m23;return a}function okMat43SubVal(c,d){var a=okAllocator.mat43();a.m00=c.m00-d;a.m10=c.m10-d;a.m20=c.m20-d;a.m01=c.m01-d;a.m11=c.m11-d;a.m21=c.m21-d;a.m02=c.m02-d;a.m12=c.m12-d;a.m22=c.m22-d;a.m03=c.m03-d;a.m13=c.m13-d;a.m23=c.m23-d;return a}function okValSubMat43(d,c){var a=okAllocator.mat43();a.m00=d-c.m00;a.m10=d-c.m10;a.m20=d-c.m20;a.m01=d-c.m01;a.m11=d-c.m11;a.m21=d-c.m21;a.m02=d-c.m02;a.m12=d-c.m12;a.m22=d-c.m22;a.m03=d-c.m03;a.m13=d-c.m13;a.m23=d-c.m23;return a}function okMat43Mul(d,c){var a=okAllocator.mat43();a.m00=d.m00*c.m00+d.m01*c.m10+d.m02*c.m20;a.m10=d.m10*c.m00+d.m11*c.m10+d.m12*c.m20;a.m20=d.m20*c.m00+d.m21*c.m10+d.m22*c.m20;a.m01=d.m00*c.m01+d.m01*c.m11+d.m02*c.m21;a.m11=d.m10*c.m01+d.m11*c.m11+d.m12*c.m21;a.m21=d.m20*c.m01+d.m21*c.m11+d.m22*c.m21;a.m02=d.m00*c.m02+d.m01*c.m12+d.m02*c.m22;a.m12=d.m10*c.m02+d.m11*c.m12+d.m12*c.m22;a.m22=d.m20*c.m02+d.m21*c.m12+d.m22*c.m22;a.m03=d.m00*c.m03+d.m01*c.m13+d.m02*c.m23+d.m03;a.m13=d.m10*c.m03+d.m11*c.m13+d.m12*c.m23+d.m13;a.m23=d.m20*c.m03+d.m21*c.m13+d.m22*c.m23+d.m23;return a}function okMat43MulVal(c,d){var a=okAllocator.mat43();a.m00=c.m00*d;a.m10=c.m10*d;a.m20=c.m20*d;a.m01=c.m01*d;a.m11=c.m11*d;a.m21=c.m21*d;a.m02=c.m02*d;a.m12=c.m12*d;a.m22=c.m22*d;a.m03=c.m03*d;a.m13=c.m13*d;a.m23=c.m23*d;return a}function okValMulMat43(d,c){var a=okAllocator.mat43();a.m00=c.m00*d;a.m10=c.m10*d;a.m20=c.m20*d;a.m01=c.m01*d;a.m11=c.m11*d;a.m21=c.m21*d;a.m02=c.m02*d;a.m12=c.m12*d;a.m22=c.m22*d;a.m03=c.m03*d;a.m13=c.m13*d;a.m23=c.m23*d;return a}function okMat43MulVec3(c,a){var d=okAllocator.vec3();d.x=c.m00*a.x+c.m01*a.y+c.m02*a.z+c.m03;d.y=c.m10*a.x+c.m11*a.y+c.m12*a.z+c.m13;d.z=c.m20*a.x+c.m21*a.y+c.m22*a.z+c.m23;return d}function okMat43Lerp(d,c,e){var a=okAllocator.mat43();a.m00=d.m00*(1-e)+c.m00*e;a.m10=d.m10*(1-e)+c.m10*e;a.m20=d.m20*(1-e)+c.m20*e;a.m01=d.m01*(1-e)+c.m01*e;a.m11=d.m11*(1-e)+c.m11*e;a.m21=d.m21*(1-e)+c.m21*e;a.m02=d.m02*(1-e)+c.m02*e;a.m12=d.m12*(1-e)+c.m12*e;a.m22=d.m22*(1-e)+c.m22*e;a.m03=d.m03*(1-e)+c.m03*e;a.m13=d.m13*(1-e)+c.m13*e;a.m23=d.m23*(1-e)+c.m23*e;return a}function okMat43Trans(f,e,d){var c=okAllocator.vec3();if(e!=null){c.x=f;c.y=e;c.z=d}else{c.x=f.x;c.y=f.y;c.z=f.z}var a=okAllocator.mat43();a.setColumn(3,c.x,c.y,c.z);okAllocator._vec3(c);return a}function okMat43Scale(e,d,c){var f=okAllocator.vec3();if(d!=null){f.x=e;f.y=d;f.z=c}else{f.x=e.x;f.y=e.y;f.z=e.z}var a=okAllocator.mat43();a.m00=f.x;a.m11=f.y;a.m22=f.z;okAllocator._vec3(f);return a}function okMat43RotX(e){var f=e*Math.PI/180;var a=Math.cos(f),d=Math.sin(f);var c=okAllocator.mat43();c.m11=a;c.m12=-d;c.m21=d;c.m22=a;return c}function okMat43RotY(e){var f=e*Math.PI/180;var a=Math.cos(f),d=Math.sin(f);var c=okAllocator.mat43();c.m00=a;c.m02=d;c.m20=-d;c.m22=a;return c}function okMat43RotZ(e){var f=e*Math.PI/180;var a=Math.cos(f),d=Math.sin(f);var c=okAllocator.mat43();c.m00=a;c.m01=-d;c.m10=d;c.m11=a;return c}function okMat43Rot(l,o,n,m){var d=l*Math.PI/180;var h=okAllocator.vec3();if(n!=null){h.x=o;h.y=n;h.z=m}else{h.x=o.x;h.y=o.y;h.z=o.z}var k=h.normalize();okAllocator._vec3(h);var e=Math.cos(d*0.5);var c=Math.sin(d*0.5);var a=new okQuat();a.s=e;a.x=c*k.x;a.y=c*k.y;a.z=c*k.z;okAllocator._vec3(k);var f=okAllocator.mat43();a.toMat43(f);return f}function okQuat(e,d,c,a){this.s=((e!=null)?e:1);this.x=((d!=null)?d:0);this.y=((c!=null)?c:0);this.z=((a!=null)?a:0)}okQuat.prototype={set:function(e,d,c,a){this.s=e;this.x=d;this.y=c;this.z=a},clone:function(a){var a=(a?a:okAllocator.quat());a.s=this.s;a.x=this.x;a.y=this.y;a.z=this.z;return a},equal:function(a){return this.s==a.s&&this.x==a.x&&this.y==a.y&&this.z==a.z},getImVec3:function(){var a=okAllocator.vec3();a.x=this.x;a.y=this.y;a.z=this.z;return a},len:function(){return Math.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z)},lenSquare:function(){return this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z},normalize:function(d){if(d){var c=1/Math.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z);this.s*=c;this.x*=c;this.y*=c;this.z*=c}else{var a=okAllocator.quat();var c=1/Math.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z);a.s=this.s*c;a.x=this.x*c;a.y=this.y*c;a.z=this.z*c;return a}},conjugate:function(c){var a=c?this:okAllocator.quat();a.set(this.s,-this.x,-this.y,-this.z);return a},inverse:function(e){var d=this.conjugate();var a=1/(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z);var c=e?this:okAllocator.quat();c.set(d.s*a,d.x*a,d.y*a,d.z*a);okAllocator._quat(d);return c},toMat3:function(a){var c=2/Math.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z);if(a==null){a=okAllocator.mat3()}a.m00=1-c*(this.y*this.y+this.z*this.z);a.m10=c*this.x*this.y+c*this.s*this.z;a.m20=-c*this.s*this.y+c*this.x*this.z;a.m01=c*this.x*this.y-c*this.s*this.z;a.m11=1-c*(this.x*this.x+this.z*this.z);a.m21=c*this.s*this.x+c*this.y*this.z;a.m02=c*this.s*this.y+c*this.x*this.z;a.m12=-c*this.s*this.x+c*this.y*this.z;a.m22=1-c*(this.x*this.x+this.y*this.y);return a},toMat4:function(a){var c=2/Math.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z);if(a==null){a=okAllocator.mat4()}a.m00=1-c*(this.y*this.y+this.z*this.z);a.m10=c*this.x*this.y+c*this.s*this.z;a.m20=-c*this.s*this.y+c*this.x*this.z;a.m01=c*this.x*this.y-c*this.s*this.z;a.m11=1-c*(this.x*this.x+this.z*this.z);a.m21=c*this.s*this.x+c*this.y*this.z;a.m02=c*this.s*this.y+c*this.x*this.z;a.m12=-c*this.s*this.x+c*this.y*this.z;a.m22=1-c*(this.x*this.x+this.y*this.y);return a},toMat43:function(a){var c=2/Math.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z);if(a==null){a=okAllocator.mat43()}a.m00=1-c*(this.y*this.y+this.z*this.z);a.m10=c*this.x*this.y+c*this.s*this.z;a.m20=-c*this.s*this.y+c*this.x*this.z;a.m01=c*this.x*this.y-c*this.s*this.z;a.m11=1-c*(this.x*this.x+this.z*this.z);a.m21=c*this.s*this.x+c*this.y*this.z;a.m02=c*this.s*this.y+c*this.x*this.z;a.m12=-c*this.s*this.x+c*this.y*this.z;a.m22=1-c*(this.x*this.x+this.y*this.y);return a}};function okQuatAdd(d,a){var c=okAllocator.quat();c.s=d.s+a.s;c.x=d.x+a.x;c.y=d.y+a.y;c.z=d.z+a.z;return c}function okQuatSub(d,a){var c=okAllocator.quat();c.s=d.s-a.s;c.x=d.x-a.x;c.y=d.y-a.y;c.z=d.z-a.z;return c}function okQuatMul(f,e){var a=okAllocator.quat();var d=f.getImVec3();var c=e.getImVec3();a.s=f.s*e.s-okVec3Dot(d,c);var m=okVec3Cross(d,c);var l=okVec3MulVal(d,e.s);var k=okVec3MulVal(c,f.s);var n=okVec3Add(m,l);var h=okVec3Add(n,k);a.x=h.x;a.y=h.y;a.z=h.z;okAllocator._vec3(d);okAllocator._vec3(c);okAllocator._vec3(m);okAllocator._vec3(l);okAllocator._vec3(k);okAllocator._vec3(n);okAllocator._vec3(h);return a}function okQuatDot(c,a){return c.s*a.s+c.x*a.x+c.y*a.y+c.z*a.z}function okQuatSlerp(e,d,m){if(e.equal(d)){return e.clone()}var f=okAllocator.quat();var k=e.s*d.s+e.x*d.x+e.y*d.y+e.z*d.z;if(k<0){k=-k;f.s=-d.s;f.x=-d.x;f.y=-d.y;f.z=-d.z}else{f.s=d.s;f.x=d.x;f.y=d.y;f.z=d.z}k=(k<1?k:1);var c,a;if(k!=1&&k!=-1){var l=Math.acos(k);var h=Math.sin(l);c=Math.sin((1-m)*l)/h;a=Math.sin(m*l)/h}else{c=1-m;a=m}f.s=c*e.s+a*f.s;f.x=c*e.x+a*f.x;f.y=c*e.y+a*f.y;f.z=c*e.z+a*f.z;return f}function okQuatRot(n,l,k,h){var c=n*Math.PI/180;var f=okAllocator.vec3();if(k!=null){f.x=l;f.y=k;f.z=h}else{f.x=l.x;f.y=l.y;f.z=l.z}var m=f.normalize();okAllocator._vec3(f);var d=Math.cos(c*0.5);var a=Math.sin(c*0.5);var e=okAllocator.quat();e.s=d;e.x=a*m.x;e.y=a*m.y;e.z=a*m.z;okAllocator._vec3(m);return e}function okPlane(a,c){this.vOrigin=okAllocator.vec3();this.vNormal=okAllocator.vec3();if(a){this.vOrigin.x=a.x;this.vOrigin.y=a.y;this.vOrigin.z=a.z}if(c){this.vNormal.x=c.x;this.vNormal.y=c.y;this.vNormal.z=c.z}else{this.vNormal.x=0;this.vNormal.y=1;this.vNormal.z=0}}okPlane.prototype={clone:function(a){var a=(a?a:okAllocator.plane());a.vOrigin.x=this.vOrigin.x;a.vOrigin.y=this.vOrigin.y;a.vOrigin.z=this.vOrigin.z;a.vNormal.x=this.vNormal.x;a.vNormal.y=this.vNormal.y;a.vNormal.z=this.vNormal.z;return a},set:function(a,d){this.vOrigin.x=a.x;this.vOrigin.y=a.y;this.vOrigin.z=a.z;var c=1/Math.sqrt(d.x*d.x+d.y*d.y+d.z*d.z);this.vNormal.x=d.x*c;this.vNormal.y=d.y*c;this.vNormal.z=d.z*c},setOrigin:function(a){this.vOrigin.x=a.x;this.vOrigin.y=a.y;this.vOrigin.z=a.z},setNormal:function(c){var a=1/Math.sqrt(c.x*c.x+c.y*c.y+c.z*c.z);this.vNormal.x=c.x*a;this.vNormal.y=c.y*a;this.vNormal.z=c.z*a},setByCoefficients:function(f,d,c,a){var e=1/Math.sqrt(f*f+d*d+c*c);this.vNormal.x=f*e;this.vNormal.y=d*e;this.vNormal.z=c*e;if(!okFloatEqual(f,0)){this.vOrigin.x=-a/f;this.vOrigin.y=0;this.vOrigin.z=0}else{if(!okFloatEqual(d,0)){this.vOrigin.x=0;this.vOrigin.y=-a/d;this.vOrigin.z=0}else{this.vOrigin.x=0;this.vOrigin.y=0;this.vOrigin.z=-a/c}}},collideVertex:function(c){var d=this.vNormal.x*this.vOrigin.x+this.vNormal.y*this.vOrigin.y+this.vNormal.z*this.vOrigin.z;var a=this.vNormal.x*c.x+this.vNormal.y*c.y+this.vNormal.z*c.z;if(okFloatEqual(a,d)){return 2}else{if(a>d){return 1}else{return 0}}},collideLine:function(d,h,c){var a=(h.x-d.x)*this.vNormal.x+(h.y-d.y)*this.vNormal.y+(h.z-d.z)*this.vNormal.z;if(okFloatEqual(a,0)){if(this.collideVertex(d)==2){return 2}return 0}var f=okVec3Sub(this.vOrigin,d);var e=okVec3Dot(this.vNormal,f)/a;okAllocator._vec3(f);if(c!=null){c.fT=e}return 1},collideRay:function(d,f,c){var a=okVec3Dot(f,this.vNormal);if(okFloatEqual(a,0)){if(this.collideVertex(d)==2){return 2}return 0}var h=okVec3Sub(this.vOrigin,d);var e=okVec3Dot(this.vNormal,h)/a;okAllocator._vec3(h);if(e<0){return 0}if(c!=null){c.fT=e}return 1}};function okPlaneIntersect3(q,o,m){var n=q.vNormal;var l=o.vNormal;var k=m.vNormal;var f=okVec3Cross(l,k);var c=okVec3Cross(k,n);var p=okVec3Cross(n,l);var e=okVec3Dot(q.vOrigin,n);var d=okVec3Dot(o.vOrigin,l);var a=okVec3Dot(m.vOrigin,k);var v=okVec3MulVal(f,e);var t=okVec3MulVal(c,d);var s=okVec3MulVal(p,a);var h=n.x*(l.y*k.z-k.y*l.z)+l.x*(k.y*n.z-n.y*k.z)+k.x*(n.y*l.z-n.z*l.y);var u=okAllocator.vec3();u.x=(v.x+t.x+s.x)/h;u.y=(v.y+t.y+s.y)/h;u.z=(v.z+t.z+s.z)/h;okAllocator._vec3(f);okAllocator._vec3(c);okAllocator._vec3(p);okAllocator._vec3(v);okAllocator._vec3(t);okAllocator._vec3(s);return u}function okAABBox(c,a){this.vMin=okAllocator.vec3();this.vMax=okAllocator.vec3();if(c!=null){this.vMin.x=c.x;this.vMin.y=c.y;this.vMin.z=c.z}if(a!=null){this.vMax.x=a.x;this.vMax.y=a.y;this.vMax.z=a.z}this.aPointList=[okAllocator.vec3(),okAllocator.vec3(),okAllocator.vec3(),okAllocator.vec3(),okAllocator.vec3(),okAllocator.vec3(),okAllocator.vec3(),okAllocator.vec3()];this.bPointDirty=true}okAABBox.prototype={clone:function(a){var c=(a?a:okAllocator.aabbox());c.set(this.vMin,this.vMax);return c},set:function(c,a){this.vMin.x=c.x;this.vMin.y=c.y;this.vMin.z=c.z;this.vMax.x=a.x;this.vMax.y=a.y;this.vMax.z=a.z;this.bPointDirty=true},setMin:function(d,c,a){if(c==null){this.vMin.x=d.x;this.vMin.y=d.y;this.vMin.z=d.z}else{this.vMin.x=d;this.vMin.y=c;this.vMin.z=a}this.bPointDirty=true},setMax:function(d,c,a){if(c==null){this.vMax.x=d.x;this.vMax.y=d.y;this.vMax.z=d.z}else{this.vMax.x=d;this.vMax.y=c;this.vMax.z=a}this.bPointDirty=true},union:function(d){var e=okVec3Min(this.vMin,d.vMin);var c=okVec3Max(this.vMax,d.vMax);var a=okAllocator.aabbox();a.set(e,c);okAllocator._vec3(e);okAllocator._vec3(c);return a},intersect:function(e){var f=okVec3Max(this.vMin,e.vMin);var c=okVec3Min(this.vMax,e.vMax);var d=okVec3Max(this.vMin,c);var a=okAllocator.aabbox();a.set(f,d);okAllocator._vec3(f);okAllocator._vec3(c);okAllocator._vec3(d);return a},getExtent:function(a){if(a==1){return Math.max(0,this.vMax.x-this.vMin.x)}else{if(a==2){return Math.max(0,this.vMax.y-this.vMin.z)}else{return Math.max(0,this.vMax.z-this.vMin.z)}}},getVolume:function(){return Math.max(0,(this.vMax.x-this.vMin.x))*Math.max(0,(this.vMax.y-this.vMin.y))*Math.max(0,(this.vMax.z-this.vMin.z))},getPoint:function(c){if(this.bPointDirty){var o=this.aPointList[0];o.x=this.vMin.x;o.y=this.vMin.y;o.z=this.vMin.z;var n=this.aPointList[1];n.x=this.vMax.x;n.y=this.vMin.y;n.z=this.vMin.z;var m=this.aPointList[2];m.x=this.vMax.x;m.y=this.vMax.y;m.z=this.vMin.z;var k=this.aPointList[3];k.x=this.vMin.x;k.y=this.vMax.y;k.z=this.vMin.z;var h=this.aPointList[4];h.x=this.vMin.x;h.y=this.vMin.y;h.z=this.vMax.z;var f=this.aPointList[5];f.x=this.vMax.x;f.y=this.vMin.y;f.z=this.vMax.z;var e=this.aPointList[6];e.x=this.vMax.x;e.y=this.vMax.y;e.z=this.vMax.z;var d=this.aPointList[7];d.x=this.vMin.x;d.y=this.vMax.y;d.z=this.vMax.z;this.bPointDirty=false}var a=this.aPointList[c];var l=okAllocator.vec3();l.x=a.x;l.y=a.y;l.z=a.z;return l},transformMat:function(d){var f=okAllocator.vec3();var e=okAllocator.vec3();var a=okAllocator.vec3();var c=okAllocator.vec3();a.x=this.vMin.x;a.y=this.vMin.y;a.z=this.vMin.z;c.x=d.m00*a.x+d.m01*a.y+d.m02*a.z+d.m03;c.y=d.m10*a.x+d.m11*a.y+d.m12*a.z+d.m13;c.z=d.m20*a.x+d.m21*a.y+d.m22*a.z+d.m23;f.x=c.x;f.y=c.y;f.z=c.z;e.x=c.x;e.y=c.y;e.z=c.z;a.x=this.vMax.x;a.y=this.vMin.y;a.z=this.vMin.z;c.x=d.m00*a.x+d.m01*a.y+d.m02*a.z+d.m03;c.y=d.m10*a.x+d.m11*a.y+d.m12*a.z+d.m13;c.z=d.m20*a.x+d.m21*a.y+d.m22*a.z+d.m23;f.x=((f.x<c.x)?f.x:c.x);f.y=((f.y<c.y)?f.y:c.y);f.z=((f.z<c.z)?f.z:c.z);e.x=((e.x>c.x)?e.x:c.x);e.y=((e.y>c.y)?e.y:c.y);e.z=((e.z>c.z)?e.z:c.z);a.x=this.vMin.x;a.y=this.vMax.y;a.z=this.vMin.z;c.x=d.m00*a.x+d.m01*a.y+d.m02*a.z+d.m03;c.y=d.m10*a.x+d.m11*a.y+d.m12*a.z+d.m13;c.z=d.m20*a.x+d.m21*a.y+d.m22*a.z+d.m23;f.x=((f.x<c.x)?f.x:c.x);f.y=((f.y<c.y)?f.y:c.y);f.z=((f.z<c.z)?f.z:c.z);e.x=((e.x>c.x)?e.x:c.x);e.y=((e.y>c.y)?e.y:c.y);e.z=((e.z>c.z)?e.z:c.z);a.x=this.vMin.x;a.y=this.vMin.y;a.z=this.vMax.z;c.x=d.m00*a.x+d.m01*a.y+d.m02*a.z+d.m03;c.y=d.m10*a.x+d.m11*a.y+d.m12*a.z+d.m13;c.z=d.m20*a.x+d.m21*a.y+d.m22*a.z+d.m23;f.x=((f.x<c.x)?f.x:c.x);f.y=((f.y<c.y)?f.y:c.y);f.z=((f.z<c.z)?f.z:c.z);e.x=((e.x>c.x)?e.x:c.x);e.y=((e.y>c.y)?e.y:c.y);e.z=((e.z>c.z)?e.z:c.z);a.x=this.vMax.x;a.y=this.vMax.y;a.z=this.vMin.z;c.x=d.m00*a.x+d.m01*a.y+d.m02*a.z+d.m03;c.y=d.m10*a.x+d.m11*a.y+d.m12*a.z+d.m13;c.z=d.m20*a.x+d.m21*a.y+d.m22*a.z+d.m23;f.x=((f.x<c.x)?f.x:c.x);f.y=((f.y<c.y)?f.y:c.y);f.z=((f.z<c.z)?f.z:c.z);e.x=((e.x>c.x)?e.x:c.x);e.y=((e.y>c.y)?e.y:c.y);e.z=((e.z>c.z)?e.z:c.z);a.x=this.vMax.x;a.y=this.vMin.y;a.z=this.vMax.z;c.x=d.m00*a.x+d.m01*a.y+d.m02*a.z+d.m03;c.y=d.m10*a.x+d.m11*a.y+d.m12*a.z+d.m13;c.z=d.m20*a.x+d.m21*a.y+d.m22*a.z+d.m23;f.x=((f.x<c.x)?f.x:c.x);f.y=((f.y<c.y)?f.y:c.y);f.z=((f.z<c.z)?f.z:c.z);e.x=((e.x>c.x)?e.x:c.x);e.y=((e.y>c.y)?e.y:c.y);e.z=((e.z>c.z)?e.z:c.z);a.x=this.vMin.x;a.y=this.vMax.y;a.z=this.vMax.z;c.x=d.m00*a.x+d.m01*a.y+d.m02*a.z+d.m03;c.y=d.m10*a.x+d.m11*a.y+d.m12*a.z+d.m13;c.z=d.m20*a.x+d.m21*a.y+d.m22*a.z+d.m23;f.x=((f.x<c.x)?f.x:c.x);f.y=((f.y<c.y)?f.y:c.y);f.z=((f.z<c.z)?f.z:c.z);e.x=((e.x>c.x)?e.x:c.x);e.y=((e.y>c.y)?e.y:c.y);e.z=((e.z>c.z)?e.z:c.z);a.x=this.vMax.x;a.y=this.vMax.y;a.z=this.vMax.z;c.x=d.m00*a.x+d.m01*a.y+d.m02*a.z+d.m03;c.y=d.m10*a.x+d.m11*a.y+d.m12*a.z+d.m13;c.z=d.m20*a.x+d.m21*a.y+d.m22*a.z+d.m23;f.x=((f.x<c.x)?f.x:c.x);f.y=((f.y<c.y)?f.y:c.y);f.z=((f.z<c.z)?f.z:c.z);e.x=((e.x>c.x)?e.x:c.x);e.y=((e.y>c.y)?e.y:c.y);e.z=((e.z>c.z)?e.z:c.z);this.vMin.x=f.x;this.vMin.y=f.y;this.vMin.z=f.z;this.vMax.x=e.x;this.vMax.y=e.y;this.vMax.z=e.z;okAllocator._vec3(f);okAllocator._vec3(e);okAllocator._vec3(a);okAllocator._vec3(c);this.bPointDirty=true},collideVertex:function(a){if(a.x>=this.vMin.x&&a.x<=this.vMax.x&&a.y>=this.vMin.y&&a.y<=this.vMax.y&&a.z>=this.vMin.z&&a.z<=this.vMax.z){return 1}return 0},collideLine:function(f,d,a){var v=OAK.VEC3_X;var u=OAK.VEC3_Y;var t=OAK.VEC3_Z;var w=okAllocator.plane();w.set(this.vMin,v);var c=okAllocator.plane();c.set(this.vMax,v);var e=okAllocator.plane();e.set(this.vMin,u);var h=okAllocator.plane();h.set(this.vMax,u);var k=okAllocator.plane();k.set(this.vMin,t);var m=okAllocator.plane();m.set(this.vMax,t);var p,o;var l=okAllocator.object(),n=okAllocator.object();var q,s;if(w.collideLine(f,d,l)==1){c.collideLine(f,d,n);p=((l.fT<n.fT)?l.fT:n.fT);o=((l.fT>n.fT)?l.fT:n.fT)}if(e.collideLine(f,d,l)==1){h.collideLine(f,d,n);if(p!=null){q=((l.fT<n.fT)?l.fT:n.fT);s=((l.fT>n.fT)?l.fT:n.fT);p=((p>q)?p:q);o=((o<s)?o:s)}else{p=((l.fT<n.fT)?l.fT:n.fT);o=((l.fT>n.fT)?l.fT:n.fT)}}if(k.collideLine(f,d,l)==1){m.collideLine(f,d,n);if(p!=null){q=((l.fT<n.fT)?l.fT:n.fT);s=((l.fT>n.fT)?l.fT:n.fT);p=((p>q)?p:q);o=((o<s)?o:s)}else{p=((l.fT<n.fT)?l.fT:n.fT);o=((l.fT>n.fT)?l.fT:n.fT)}}okAllocator._plane(w);okAllocator._plane(c);okAllocator._plane(e);okAllocator._plane(h);okAllocator._plane(k);okAllocator._plane(m);okAllocator._object(l);okAllocator._object(n);if(p<=o){if(a){a.fT0=p;a.fT1=o}return 1}return 0},collideRay:function(f,p,a){var d=okAllocator.vec3();d.x=f.x+p.x;d.y=f.y+p.y;d.z=f.z+p.z;var w=OAK.VEC3_X;var v=OAK.VEC3_Y;var u=OAK.VEC3_Z;var x=okAllocator.plane();x.set(this.vMin,w);var c=okAllocator.plane();c.set(this.vMax,w);var e=okAllocator.plane();e.set(this.vMin,v);var h=okAllocator.plane();h.set(this.vMax,v);var k=okAllocator.plane();k.set(this.vMin,u);var m=okAllocator.plane();m.set(this.vMax,u);var q,o;var l=okAllocator.object(),n=okAllocator.object();var s,t;if(x.collideLine(f,d,l)==1){c.collideLine(f,d,n);q=((l.fT<n.fT)?l.fT:n.fT);o=((l.fT>n.fT)?l.fT:n.fT)}if(e.collideLine(f,d,l)==1){h.collideLine(f,d,n);if(q!=null){s=((l.fT<n.fT)?l.fT:n.fT);t=((l.fT>n.fT)?l.fT:n.fT);q=((q>s)?q:s);o=((o<t)?o:t)}else{q=((l.fT<n.fT)?l.fT:n.fT);o=((l.fT>n.fT)?l.fT:n.fT)}}if(k.collideLine(f,d,l)==1){m.collideLine(f,d,n);if(q!=null){s=((l.fT<n.fT)?l.fT:n.fT);t=((l.fT>n.fT)?l.fT:n.fT);q=((q>s)?q:s);o=((o<t)?o:t)}else{q=((l.fT<n.fT)?l.fT:n.fT);o=((l.fT>n.fT)?l.fT:n.fT)}}okAllocator._plane(x);okAllocator._plane(c);okAllocator._plane(e);okAllocator._plane(h);okAllocator._plane(k);okAllocator._plane(m);okAllocator._object(l);okAllocator._object(n);okAllocator._vec3(d);if((q<=o)&&(o>=0)){if(a){a.fT0=q;a.fT1=o}return 1}return 0},collideAABBox:function(e){var d=okVec3Max(this.vMin,e.vMin);var a=okVec3Min(this.vMax,e.vMax);var c=0;if(d.x>a.x||d.y>a.y||d.z>a.z){c=0}else{if(d.equal(e.vMin)&&a.equal(e.vMax)){c=2}else{c=1}}okAllocator._vec3(d);okAllocator._vec3(a);return c}};okAABBox.prototype.transformMat43=okAABBox.prototype.transformMat;okAABBox.prototype.transformMat4=okAABBox.prototype.transformMat;function okOBBox(d,c,a){this.vMin=(d!=null)?d.clone():new okVec3(0,0,0);this.vMax=(c!=null)?c.clone():new okVec3(0,0,0);this.mMat=okAllocator.mat43();if(a){a.clone(this.mMat)}this.bMatNDirty=true;this.bMinMaxWDirty=true;this.aPointList=[new okVec3(this.vMin.x,this.vMin.y,this.vMin.z),new okVec3(this.vMax.x,this.vMin.y,this.vMin.z),new okVec3(this.vMax.x,this.vMax.y,this.vMin.z),new okVec3(this.vMin.x,this.vMax.y,this.vMin.z),new okVec3(this.vMin.x,this.vMin.y,this.vMax.z),new okVec3(this.vMax.x,this.vMin.y,this.vMax.z),new okVec3(this.vMax.x,this.vMax.y,this.vMax.z),new okVec3(this.vMin.x,this.vMax.y,this.vMax.z)];this.bPointDirty=true}okOBBox.prototype={clone:function(a){var a=(a?a:new okOBBox());a.set(this.vMin,this.vMax,this.mMat);return a},set:function(d,c,a){d.clone(this.vMin);c.clone(this.vMax);if(a){a.clone(this.mMat)}this.bMatNDirty=true;this.bMinMaxWDirty=true;this.bPointDirty=true},setMin:function(d,c,a){if(c==null){d.clone(this.vMin)}else{this.vMin.set(d,c,a)}this.bMinMaxWDirty=true;this.bPointDirty=true},setMax:function(d,c,a){if(c==null){d.clone(this.vMax)}else{this.vMax.set(d,c,a)}this.bMinMaxWDirty=true;this.bPointDirty=true},setMat:function(a){a.clone(this.mMat);this.bMatNDirty=true;this.bMinMaxWDirty=true;this.bPointDirty=true},getExtent:function(a){if(a==1){return Math.max(0,this.vMax.x-this.vMin.x)}else{if(a==2){return Math.max(0,this.vMax.y-this.vMin.z)}else{return Math.max(0,this.vMax.z-this.vMin.z)}}},getVolume:function(){return Math.max(0,(this.vMax.x-this.vMin.x))*Math.max(0,(this.vMax.y-this.vMin.y))*Math.max(0,(this.vMax.z-this.vMin.z))},getPoint:function(c){if(this.bPointDirty){var o=this.aPointList[0];o.x=this.mMat.m00*this.vMin.x+this.mMat.m01*this.vMin.y+this.mMat.m02*this.vMin.z+this.mMat.m03;o.y=this.mMat.m10*this.vMin.x+this.mMat.m11*this.vMin.y+this.mMat.m12*this.vMin.z+this.mMat.m13;o.z=this.mMat.m20*this.vMin.x+this.mMat.m21*this.vMin.y+this.mMat.m22*this.vMin.z+this.mMat.m23;var n=this.aPointList[1];n.x=this.mMat.m00*this.vMax.x+this.mMat.m01*this.vMin.y+this.mMat.m02*this.vMin.z+this.mMat.m03;n.y=this.mMat.m10*this.vMax.x+this.mMat.m11*this.vMin.y+this.mMat.m12*this.vMin.z+this.mMat.m13;n.z=this.mMat.m20*this.vMax.x+this.mMat.m21*this.vMin.y+this.mMat.m22*this.vMin.z+this.mMat.m23;var m=this.aPointList[2];m.x=this.mMat.m00*this.vMax.x+this.mMat.m01*this.vMax.y+this.mMat.m02*this.vMin.z+this.mMat.m03;m.y=this.mMat.m10*this.vMax.x+this.mMat.m11*this.vMax.y+this.mMat.m12*this.vMin.z+this.mMat.m13;m.z=this.mMat.m20*this.vMax.x+this.mMat.m21*this.vMax.y+this.mMat.m22*this.vMin.z+this.mMat.m23;var k=this.aPointList[3];k.x=this.mMat.m00*this.vMin.x+this.mMat.m01*this.vMax.y+this.mMat.m02*this.vMin.z+this.mMat.m03;k.y=this.mMat.m10*this.vMin.x+this.mMat.m11*this.vMax.y+this.mMat.m12*this.vMin.z+this.mMat.m13;k.z=this.mMat.m20*this.vMin.x+this.mMat.m21*this.vMax.y+this.mMat.m22*this.vMin.z+this.mMat.m23;var h=this.aPointList[4];h.x=this.mMat.m00*this.vMin.x+this.mMat.m01*this.vMin.y+this.mMat.m02*this.vMax.z+this.mMat.m03;h.y=this.mMat.m10*this.vMin.x+this.mMat.m11*this.vMin.y+this.mMat.m12*this.vMax.z+this.mMat.m13;h.z=this.mMat.m20*this.vMin.x+this.mMat.m21*this.vMin.y+this.mMat.m22*this.vMax.z+this.mMat.m23;var f=this.aPointList[5];f.x=this.mMat.m00*this.vMax.x+this.mMat.m01*this.vMin.y+this.mMat.m02*this.vMax.z+this.mMat.m03;f.y=this.mMat.m10*this.vMax.x+this.mMat.m11*this.vMin.y+this.mMat.m12*this.vMax.z+this.mMat.m13;f.z=this.mMat.m20*this.vMax.x+this.mMat.m21*this.vMin.y+this.mMat.m22*this.vMax.z+this.mMat.m23;var e=this.aPointList[6];e.x=this.mMat.m00*this.vMax.x+this.mMat.m01*this.vMax.y+this.mMat.m02*this.vMax.z+this.mMat.m03;e.y=this.mMat.m10*this.vMax.x+this.mMat.m11*this.vMax.y+this.mMat.m12*this.vMax.z+this.mMat.m13;e.z=this.mMat.m20*this.vMax.x+this.mMat.m21*this.vMax.y+this.mMat.m22*this.vMax.z+this.mMat.m23;var d=this.aPointList[7];d.x=this.mMat.m00*this.vMin.x+this.mMat.m01*this.vMax.y+this.mMat.m02*this.vMax.z+this.mMat.m03;d.y=this.mMat.m10*this.vMin.x+this.mMat.m11*this.vMax.y+this.mMat.m12*this.vMax.z+this.mMat.m13;d.z=this.mMat.m20*this.vMin.x+this.mMat.m21*this.vMax.y+this.mMat.m22*this.vMax.z+this.mMat.m23;this.bPointDirty=false}var a=this.aPointList[c];var l=okAllocator.vec3();l.x=a.x;l.y=a.y;l.z=a.z;return l},_updateData:function(){if(this.bMatNDirty){this.mMatN=this.mMat.inverse().transpose(true);this.bMatNDirty=false}if(this.bMinMaxWDirty){this.vMinW=okMat43MulVec3(this.mMat,this.vMin);this.vMaxW=okMat43MulVec3(this.mMat,this.vMax);this.bMinMaxWDirty=false}},collideLine:function(f,d,a){this._updateData();var v=okMat43MulVec3(this.mMatN,OAK.VEC3_X);var u=okMat43MulVec3(this.mMatN,OAK.VEC3_Y);var t=okMat43MulVec3(this.mMatN,OAK.VEC3_Z);var w=new okPlane(this.vMinW,v);var c=new okPlane(this.vMaxW,v);var e=new okPlane(this.vMinW,u);var h=new okPlane(this.vMaxW,u);var k=new okPlane(this.vMinW,t);var m=new okPlane(this.vMaxW,t);var p,o;var l=okAllocator.object(),n=okAllocator.object();var q,s;if(w.collideLine(f,d,l)==1){c.collideLine(f,d,n);p=((l.fT<n.fT)?l.fT:n.fT);o=((l.fT>n.fT)?l.fT:n.fT)}if(e.collideLine(f,d,l)==1){h.collideLine(f,d,n);if(p!=null){q=((l.fT<n.fT)?l.fT:n.fT);s=((l.fT>n.fT)?l.fT:n.fT);p=((p>q)?p:q);o=((o<s)?o:s)}else{p=((l.fT<n.fT)?l.fT:n.fT);o=((l.fT>n.fT)?l.fT:n.fT)}}if(p>o){return 0}if(k.collideLine(f,d,l)==1){m.collideLine(f,d,n);if(p!=null){q=((l.fT<n.fT)?l.fT:n.fT);s=((l.fT>n.fT)?l.fT:n.fT);p=((p>q)?p:q);o=((o<s)?o:s)}else{p=((l.fT<n.fT)?l.fT:n.fT);o=((l.fT>n.fT)?l.fT:n.fT)}}okAllocator._object(l);okAllocator._object(n);if(p<=o){if(a){a.fT0=p;a.fT1=o}return 1}return 0},collideRay:function(f,p,a){this._updateData();var d=okAllocator.vec3();d.x=f.x+p.x;d.y=f.y+p.y;d.z=f.z+p.z;var w=okMat43MulVec3(this.mMatN,OAK.VEC3_X);var v=okMat43MulVec3(this.mMatN,OAK.VEC3_Y);var u=okMat43MulVec3(this.mMatN,OAK.VEC3_Z);var x=new okPlane(this.vMinW,w);var c=new okPlane(this.vMaxW,w);var e=new okPlane(this.vMinW,v);var h=new okPlane(this.vMaxW,v);var k=new okPlane(this.vMinW,u);var m=new okPlane(this.vMaxW,u);var q,o;var l=okAllocator.object(),n=okAllocator.object();var s,t;if(x.collideLine(f,d,l)==1){c.collideLine(f,d,n);q=((l.fT<n.fT)?l.fT:n.fT);o=((l.fT>n.fT)?l.fT:n.fT)}if(e.collideLine(f,d,l)==1){h.collideLine(f,d,n);if(q!=null){s=((l.fT<n.fT)?l.fT:n.fT);t=((l.fT>n.fT)?l.fT:n.fT);q=((q>s)?q:s);o=((o<t)?o:t)}else{q=((l.fT<n.fT)?l.fT:n.fT);o=((l.fT>n.fT)?l.fT:n.fT)}}if(q>o){return 0}if(k.collideLine(f,d,l)==1){m.collideLine(f,d,n);if(q!=null){s=((l.fT<n.fT)?l.fT:n.fT);t=((l.fT>n.fT)?l.fT:n.fT);q=((q>s)?q:s);o=((o<t)?o:t)}else{q=((l.fT<n.fT)?l.fT:n.fT);o=((l.fT>n.fT)?l.fT:n.fT)}}okAllocator._object(l);okAllocator._object(n);okAllocator._vec3(d);if(q<=o&&o>=0){if(a){a.fT0=q;a.fT1=o}return 1}return 0}};function okFrustum(){this.mViewProjMat=okAllocator.mat4();this.aPlaneList=[okAllocator.plane(),okAllocator.plane(),okAllocator.plane(),okAllocator.plane(),okAllocator.plane(),okAllocator.plane()];this.aPointList=[okAllocator.vec3(),okAllocator.vec3(),okAllocator.vec3(),okAllocator.vec3(),okAllocator.vec3(),okAllocator.vec3(),okAllocator.vec3(),okAllocator.vec3()];this.bPointDirty=true}okFrustum.prototype={setByViewProjMat:function(a){a.clone(this.mViewProjMat);this.aPlaneList[3].setByCoefficients(a.m30-a.m00,a.m31-a.m01,a.m32-a.m02,a.m33-a.m03);this.aPlaneList[2].setByCoefficients(a.m30+a.m00,a.m31+a.m01,a.m32+a.m02,a.m33+a.m03);this.aPlaneList[5].setByCoefficients(a.m30+a.m10,a.m31+a.m11,a.m32+a.m12,a.m33+a.m13);this.aPlaneList[4].setByCoefficients(a.m30-a.m10,a.m31-a.m11,a.m32-a.m12,a.m33-a.m13);this.aPlaneList[1].setByCoefficients(a.m30-a.m20,a.m31-a.m21,a.m32-a.m22,a.m33-a.m23);this.aPlaneList[0].setByCoefficients(a.m30+a.m20,a.m31+a.m21,a.m32+a.m22,a.m33+a.m23);this.bPointDirty=true},getPlane:function(a){return this.aPlaneList[a]},setPlane:function(c,a){a.clone(this.aPlaneList[c]);this.bPointDirty=true},getPoint:function(a){if(this.bPointDirty){this._genPointList();this.bPointDirty=false}return this.aPointList[a]},collideVertex:function(a){if(this.aPlaneList[0].collideVertex(a)==0){return 0}if(this.aPlaneList[1].collideVertex(a)==0){return 0}if(this.aPlaneList[2].collideVertex(a)==0){return 0}if(this.aPlaneList[3].collideVertex(a)==0){return 0}if(this.aPlaneList[4].collideVertex(a)==0){return 0}if(this.aPlaneList[5].collideVertex(a)==0){return 0}return 1},collideAABBox:function(a){a.getPoint(0);return this._collideBox(a.aPointList)},collideOBBox:function(a){a.getPoint(0);return this._collideBox(a.aPointList)},_collideBox:function(a){var t=a[0];var p=a[1];var o=a[2];var n=a[3];var m=a[4];var l=a[5];var h=a[6];var e=a[7];var f=true;var d=true;var s=true;var c=this.aPlaneList[0];var k,q;q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*t.x+c.vNormal.y*t.y+c.vNormal.z*t.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*p.x+c.vNormal.y*p.y+c.vNormal.z*p.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*o.x+c.vNormal.y*o.y+c.vNormal.z*o.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*n.x+c.vNormal.y*n.y+c.vNormal.z*n.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*m.x+c.vNormal.y*m.y+c.vNormal.z*m.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*l.x+c.vNormal.y*l.y+c.vNormal.z*l.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*h.x+c.vNormal.y*h.y+c.vNormal.z*h.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*e.x+c.vNormal.y*e.y+c.vNormal.z*e.z;d=d&&(k>=q);s=s&&(k<q);if(s){return 0}s=true;var c=this.aPlaneList[1];var k,q;q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*t.x+c.vNormal.y*t.y+c.vNormal.z*t.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*p.x+c.vNormal.y*p.y+c.vNormal.z*p.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*o.x+c.vNormal.y*o.y+c.vNormal.z*o.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*n.x+c.vNormal.y*n.y+c.vNormal.z*n.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*m.x+c.vNormal.y*m.y+c.vNormal.z*m.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*l.x+c.vNormal.y*l.y+c.vNormal.z*l.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*h.x+c.vNormal.y*h.y+c.vNormal.z*h.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*e.x+c.vNormal.y*e.y+c.vNormal.z*e.z;d=d&&(k>=q);s=s&&(k<q);if(s){return 0}s=true;var c=this.aPlaneList[2];var k,q;q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*t.x+c.vNormal.y*t.y+c.vNormal.z*t.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*p.x+c.vNormal.y*p.y+c.vNormal.z*p.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*o.x+c.vNormal.y*o.y+c.vNormal.z*o.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*n.x+c.vNormal.y*n.y+c.vNormal.z*n.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*m.x+c.vNormal.y*m.y+c.vNormal.z*m.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*l.x+c.vNormal.y*l.y+c.vNormal.z*l.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*h.x+c.vNormal.y*h.y+c.vNormal.z*h.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*e.x+c.vNormal.y*e.y+c.vNormal.z*e.z;d=d&&(k>=q);s=s&&(k<q);if(s){return 0}s=true;var c=this.aPlaneList[3];var k,q;q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*t.x+c.vNormal.y*t.y+c.vNormal.z*t.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*p.x+c.vNormal.y*p.y+c.vNormal.z*p.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*o.x+c.vNormal.y*o.y+c.vNormal.z*o.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*n.x+c.vNormal.y*n.y+c.vNormal.z*n.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*m.x+c.vNormal.y*m.y+c.vNormal.z*m.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*l.x+c.vNormal.y*l.y+c.vNormal.z*l.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*h.x+c.vNormal.y*h.y+c.vNormal.z*h.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*e.x+c.vNormal.y*e.y+c.vNormal.z*e.z;d=d&&(k>=q);s=s&&(k<q);if(s){return 0}s=true;var c=this.aPlaneList[4];var k,q;q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*t.x+c.vNormal.y*t.y+c.vNormal.z*t.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*p.x+c.vNormal.y*p.y+c.vNormal.z*p.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*o.x+c.vNormal.y*o.y+c.vNormal.z*o.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*n.x+c.vNormal.y*n.y+c.vNormal.z*n.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*m.x+c.vNormal.y*m.y+c.vNormal.z*m.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*l.x+c.vNormal.y*l.y+c.vNormal.z*l.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*h.x+c.vNormal.y*h.y+c.vNormal.z*h.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*e.x+c.vNormal.y*e.y+c.vNormal.z*e.z;d=d&&(k>=q);s=s&&(k<q);if(s){return 0}s=true;var c=this.aPlaneList[5];var k,q;q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*t.x+c.vNormal.y*t.y+c.vNormal.z*t.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*p.x+c.vNormal.y*p.y+c.vNormal.z*p.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*o.x+c.vNormal.y*o.y+c.vNormal.z*o.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*n.x+c.vNormal.y*n.y+c.vNormal.z*n.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*m.x+c.vNormal.y*m.y+c.vNormal.z*m.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*l.x+c.vNormal.y*l.y+c.vNormal.z*l.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*h.x+c.vNormal.y*h.y+c.vNormal.z*h.z;d=d&&(k>=q);s=s&&(k<q);q=c.vNormal.x*c.vOrigin.x+c.vNormal.y*c.vOrigin.y+c.vNormal.z*c.vOrigin.z;k=c.vNormal.x*e.x+c.vNormal.y*e.y+c.vNormal.z*e.z;d=d&&(k>=q);s=s&&(k<q);if(s){return 0}if(d){return 2}return 1},_genPointList:function(){this.aPointList[0]=okPlaneIntersect3(this.aPlaneList[0],this.aPlaneList[5],this.aPlaneList[2]);this.aPointList[1]=okPlaneIntersect3(this.aPlaneList[0],this.aPlaneList[5],this.aPlaneList[3]);this.aPointList[2]=okPlaneIntersect3(this.aPlaneList[0],this.aPlaneList[4],this.aPlaneList[3]);this.aPointList[3]=okPlaneIntersect3(this.aPlaneList[0],this.aPlaneList[4],this.aPlaneList[2]);this.aPointList[4]=okPlaneIntersect3(this.aPlaneList[1],this.aPlaneList[5],this.aPlaneList[2]);this.aPointList[5]=okPlaneIntersect3(this.aPlaneList[1],this.aPlaneList[5],this.aPlaneList[3]);this.aPointList[6]=okPlaneIntersect3(this.aPlaneList[1],this.aPlaneList[4],this.aPlaneList[3]);this.aPointList[7]=okPlaneIntersect3(this.aPlaneList[1],this.aPlaneList[4],this.aPlaneList[2])}};function okRect(e,c,d,a){this.x=((e!=null)?e:0);this.y=((c!=null)?c:0);this.width=((d!=null)?d:0);this.height=((a!=null)?a:0)}okRect.prototype={set:function(d,c,e,a){this.x=d;this.y=c;this.width=width;this.height=height},clone:function(a){var a=(a?a:new okRect());a.set(this.x,this.y,this.width,this.height);return a}};function okRectMerge(e,d){var c=Math.min(e.x,d.x);var h=Math.min(e.y,d.y);var f=Math.max(e.x+e.width-c,d.x+d.width-c);var a=Math.max(e.y+e.height-h,d.y+d.height-h);return new okRect(c,h,f,a)}OAK.VEC2_ZERO=new okVec2(0,0);OAK.VEC2_ONE=new okVec2(1,1);OAK.VEC2_X=new okVec2(1,0);OAK.VEC2_Y=new okVec2(0,1);OAK.VEC3_ZERO=new okVec3(0,0,0);OAK.VEC3_ONE=new okVec3(1,1,1);OAK.VEC3_X=new okVec3(1,0,0);OAK.VEC3_Y=new okVec3(0,1,0);OAK.VEC3_Z=new okVec3(0,0,1);OAK.VEC3_RED=OAK.VEC3_X;OAK.VEC3_GREEN=OAK.VEC3_Y;OAK.VEC3_BLUE=OAK.VEC3_Z;OAK.VEC3_YELLOW=new okVec3(1,1,0);OAK.VEC3_BLACK=OAK.VEC3_ZERO;OAK.VEC3_WHITE=OAK.VEC3_ONE;OAK.VEC4_ZERO=new okVec4(0,0,0,0);OAK.VEC4_ONE=new okVec4(1,1,1,1);OAK.VEC4_X=new okVec3(1,0,0,0);OAK.VEC4_Y=new okVec3(0,1,0,0);OAK.VEC4_Z=new okVec3(0,0,1,0);OAK.VEC4_W=new okVec3(0,0,0,1);OAK.MAT3_ZERO=new okMat3(0);OAK.MAT3_I=new okMat4(1);OAK.MAT4_ZERO=new okMat4(0);OAK.MAT4_I=new okMat4(1);OAK.MAT43_ZERO=new okMat43(0);OAK.MAT43_I=new okMat43(1);function okXmlDoc(a){this.doc=a}okXmlDoc.prototype={getRootNode:function(){return new okXmlNode(this.doc.documentElement)}};function okXmlNode(c){this.element=c;this.childNodes=new Array();this.sText="";if(okIsIE()){for(var a=0;a<this.element.childNodes.length;++a){if(this.element.childNodes[a].nodeType==1){this.childNodes.push(this.element.childNodes[a])}else{if(this.element.childNodes[a].nodeType==3){this.sText+=this.element.childNodes[a].text}}}}else{for(var a=0;a<this.element.childNodes.length;++a){if(this.element.childNodes[a].nodeType==Node.ELEMENT_NODE){this.childNodes.push(this.element.childNodes[a])}else{if(this.element.childNodes[a].nodeType==Node.TEXT_NODE){this.sText+=this.element.childNodes[a].textContent}}}}}okXmlNode.prototype={getName:function(){return this.element.nodeName},getText:function(){return this.sText},getChildNum:function(){return this.childNodes.length},getChild:function(a,e){if(okIsNumber(a)){return new okXmlNode(this.childNodes[a])}else{if(e){a=a.toLowerCase()}for(var d=0;d<this.childNodes.length;++d){var c=e?(this.childNodes[d].nodeName.toLowerCase()==a):(this.childNodes[d].nodeName==a);if(c){return new okXmlNode(this.childNodes[d])}}return null}},getAttribNum:function(){return this.element.attributes.length},getAttribName:function(a){return this.element.attributes[a].name},getAttribValueString:function(d,e){if(okIsNumber(d)){return this.element.attributes[d].value}else{if(e){d=d.toLowerCase()}for(var c=0;c<this.element.attributes.length;++c){var a=e?(this.element.attributes[c].name.toLowerCase()==d):(this.element.attributes[c].name==d);if(a){return this.element.attributes[c].value}}}return null},getAttribValueInt:function(d,e){if(okIsNumber(d)){return parseInt(this.element.attributes[d].value)}else{if(e){d=d.toLowerCase()}for(var c=0;c<this.element.attributes.length;++c){var a=e?(this.element.attributes[c].name.toLowerCase()==d):(this.element.attributes[c].name==d);if(a){return parseInt(this.element.attributes[c].value)}}}return null},getAttribValueFloat:function(d,e){if(okIsNumber(d)){return parseFloat(this.element.attributes[d].value)}else{if(e){d=d.toLowerCase()}for(var c=0;c<this.element.attributes.length;++c){var a=e?(this.element.attributes[c].name.toLowerCase()==d):(this.element.attributes[c].name==d);if(a){return parseFloat(this.element.attributes[c].value)}}}return null},getAttribValueVec2:function(d,h){if(okIsNumber(d)){var f=this.element.attributes[d].value.split(" ");var e=okAllocator.vec2();e.x=parseFloat(f[0]);e.y=parseFloat(f[1]);return e}else{if(h){d=d.toLowerCase()}for(var c=0;c<this.element.attributes.length;++c){var a=h?(this.element.attributes[c].name.toLowerCase()==d):(this.element.attributes[c].name==d);if(a){var f=this.element.attributes[c].value.split(" ");var e=okAllocator.vec2();e.x=parseFloat(f[0]);e.y=parseFloat(f[1]);return e}}}return null},getAttribValueVec3:function(d,h){if(okIsNumber(d)){var f=this.element.attributes[d].value.split(" ");var e=okAllocator.vec3();e.x=parseFloat(f[0]);e.y=parseFloat(f[1]);e.z=parseFloat(f[2]);return e}else{if(h){d=d.toLowerCase()}for(var c=0;c<this.element.attributes.length;++c){var a=h?(this.element.attributes[c].name.toLowerCase()==d):(this.element.attributes[c].name==d);if(a){var f=this.element.attributes[c].value.split(" ");var e=okAllocator.vec3();e.x=parseFloat(f[0]);e.y=parseFloat(f[1]);e.z=parseFloat(f[2]);return e}}}return null},getAttribValueVec4:function(d,h){if(okIsNumber(d)){var f=this.element.attributes[d].value.split(" ");var e=okAllocator.vec4();e.x=parseFloat(f[0]);e.y=parseFloat(f[1]);e.z=parseFloat(f[2]);e.w=parseFloat(f[3]);return e}else{if(h){d=d.toLowerCase()}for(var c=0;c<this.element.attributes.length;++c){var a=h?(this.element.attributes[c].name.toLowerCase()==d):(this.element.attributes[c].name==d);if(a){var f=this.element.attributes[c].value.split(" ");var e=okAllocator.vec3();e.x=parseFloat(f[0]);e.y=parseFloat(f[1]);e.z=parseFloat(f[2]);e.w=parseFloat(f[3]);return e}}}return null},getAttribValueMat4:function(e,h){if(okIsNumber(e)){var f=this.element.attributes[e].value.split(" ");var c=okAllocator.mat4();c.m00=parseFloat(f[0]);c.m10=parseFloat(f[1]);c.m20=parseFloat(f[2]);c.m30=parseFloat(f[3]);c.m01=parseFloat(f[4]);c.m11=parseFloat(f[5]);c.m21=parseFloat(f[6]);c.m31=parseFloat(f[7]);c.m02=parseFloat(f[8]);c.m12=parseFloat(f[9]);c.m22=parseFloat(f[10]);c.m32=parseFloat(f[11]);c.m03=parseFloat(f[12]);c.m13=parseFloat(f[13]);c.m23=parseFloat(f[14]);c.m33=parseFloat(f[15]);return c}else{if(h){e=e.toLowerCase()}for(var d=0;d<this.element.attributes.length;++d){var a=h?(this.element.attributes[d].name.toLowerCase()==e):(this.element.attributes[d].name==e);if(a){var f=this.element.attributes[d].value.split(" ");var c=okAllocator.mat4();c.m00=parseFloat(f[0]);c.m10=parseFloat(f[1]);c.m20=parseFloat(f[2]);c.m30=parseFloat(f[3]);c.m01=parseFloat(f[4]);c.m11=parseFloat(f[5]);c.m21=parseFloat(f[6]);c.m31=parseFloat(f[7]);c.m02=parseFloat(f[8]);c.m12=parseFloat(f[9]);c.m22=parseFloat(f[10]);c.m32=parseFloat(f[11]);c.m03=parseFloat(f[12]);c.m13=parseFloat(f[13]);c.m23=parseFloat(f[14]);c.m33=parseFloat(f[15]);return c}}}return null},getAttribValueMat43:function(e,h){if(okIsNumber(e)){var f=this.element.attributes[e].value.split(" ");var c=okAllocator.mat43();c.m00=parseFloat(f[0]);c.m10=parseFloat(f[1]);c.m20=parseFloat(f[2]);c.m01=parseFloat(f[3]);c.m11=parseFloat(f[4]);c.m21=parseFloat(f[5]);c.m02=parseFloat(f[6]);c.m12=parseFloat(f[7]);c.m22=parseFloat(f[8]);c.m03=parseFloat(f[9]);c.m13=parseFloat(f[10]);c.m23=parseFloat(f[11]);return c}else{if(h){e=e.toLowerCase()}for(var d=0;d<this.element.attributes.length;++d){var a=h?(this.element.attributes[d].name.toLowerCase()==e):(this.element.attributes[d].name==e);if(a){var f=this.element.attributes[d].value.split(" ");var c=okAllocator.mat43();c.m00=parseFloat(f[0]);c.m10=parseFloat(f[1]);c.m20=parseFloat(f[2]);c.m01=parseFloat(f[3]);c.m11=parseFloat(f[4]);c.m21=parseFloat(f[5]);c.m02=parseFloat(f[6]);c.m12=parseFloat(f[7]);c.m22=parseFloat(f[8]);c.m03=parseFloat(f[9]);c.m13=parseFloat(f[10]);c.m23=parseFloat(f[11]);return c}}}return null},getAttribValueQuat:function(e,h){if(okIsNumber(e)){var f=this.element.attributes[e].value.split(" ");var c=okAllocator.quat();c.s=parseFloat(f[0]);c.x=parseFloat(f[1]);c.y=parseFloat(f[2]);c.z=parseFloat(f[3]);return c}else{if(h){e=e.toLowerCase()}for(var d=0;d<this.element.attributes.length;++d){var a=h?(this.element.attributes[d].name.toLowerCase()==e):(this.element.attributes[d].name==e);if(a){var f=this.element.attributes[d].value.split(" ");var c=okAllocator.quat();c.s=parseFloat(f[0]);c.x=parseFloat(f[1]);c.y=parseFloat(f[2]);c.z=parseFloat(f[3]);return c}}}return null},getAttribValueIntArray:function(e,h){if(okIsNumber(e)){var f=this.element.attributes[e].value.split(" ");var d=okAllocator.array();for(var c=0;c<f.length;++c){d.push(parseInt(f[c]))}return d}else{if(h){e=e.toLowerCase()}for(var c=0;c<this.element.attributes.length;++c){var a=h?(this.element.attributes[c].name.toLowerCase()==e):(this.element.attributes[c].name==e);if(a){var f=this.element.attributes[c].value.split(" ");var d=okAllocator.array();for(var c=0;c<f.length;++c){d.push(parseInt(f[c]))}return d}}}return null},getAttribValueFloatArray:function(e,h){if(okIsNumber(e)){var f=this.element.attributes[e].value.split(" ");var d=okAllocator.array();for(var c=0;c<f.length;++c){d.push(parseFloat(f[c]))}return d}else{if(h){e=e.toLowerCase()}for(var c=0;c<this.element.attributes.length;++c){var a=h?(this.element.attributes[c].name.toLowerCase()==e):(this.element.attributes[c].name==e);if(a){var f=this.element.attributes[c].value.split(" ");var d=okAllocator.array();for(var c=0;c<f.length;++c){d.push(parseFloat(f[c]))}return d}}}return null},getAttribValueStringArray:function(d,e){if(okIsNumber(d)){return this.element.attributes[d].value.split(" ")}else{if(e){d=d.toLowerCase()}for(var c=0;c<this.element.attributes.length;++c){var a=e?(this.element.attributes[c].name.toLowerCase()==d):(this.element.attributes[c].name==d);if(a){return this.element.attributes[c].value.split(" ")}}}return null}};function okParseXML(a){var c;if(okIsIE()){c=new ActiveXObject("Microsoft.XMLDOM");c.async="false";c.loadXML(a)}else{var d=new DOMParser();c=d.parseFromString(a,"text/xml")}return c}okPackXMLShaderSource=function(a){var f=a.split("");var e=f.length;for(var c=0;c<e;++c){if(f[c]=="<"){var h=c;c++;if(f[c]=="/"){while(c<e&&f[c]!=">"){++c}continue}while(c<e&&f[c]==" "){++c}for(;c<e;++c){var k=f[c];if(k==">"){break}else{if(k==" "){while(c<e&&f[c]==" "){++c}if(f[c]!=">"){f[h]="$0";--c}break}else{if(k<"0"||(k>"9"&&k<"A")||(k>"Z"&&k<"a")||k>"z"){f[h]="$0";--c;break}}}}}else{if(f[c]==">"){f[c]=="$1"}else{if(f[c]=="&"){f[c]="$2"}}}}var d="";for(var c=0;c<e;++c){d+=f[c]}return d};okUnpackXMLShaderSource=function(a){a=a.replace(/\$0/g,"<");a=a.replace(/\$1/g,">");a=a.replace(/\$2/g,"&");return a};function okBinDoc(c,d){this.doc=new jDataView(c);if(d){var a=this.doc.getString(d.length);if(a!=d){this.doc=null;return}}this.rootNode=new okBinNode(this.doc,d?d.length:0)}okBinDoc.prototype={isValid:function(){return this.doc!=null},getRootNode:function(){return this.rootNode}};function okBinNode(l,k){this.doc=l;l.seek(k);var a=l.getUint16();this.sName=l.getString(a);var h=okAllocator.array();var f=okAllocator.array();this.iAttribNum=l.getUint16();for(var e=0;e<this.iAttribNum;++e){h.push(l.getUint32())}this.iChildNum=l.getUint16();for(var e=0;e<this.iChildNum;++e){f.push(l.getUint32())}this.attribLayOut=new Object;for(var e=0;e<this.iAttribNum;++e){var d=new Object;d.iOffset=h[e];this.doc.seek(h[e]);var c=l.getUint16();d.sName=l.getString(c);d.iOffset+=(2+c);this.attribLayOut[d.sName]=d}this.childLayOut=new Object;this.childNameArray=new Array;for(var e=0;e<this.iChildNum;++e){var d=new Object;d.iOffset=f[e];this.doc.seek(f[e]);var c=l.getUint16();d.sName=l.getString(c);this.childLayOut[d.sName]=d;this.childNameArray.push(d.sName)}okAllocator._array(h);okAllocator._array(f);this.children=new Object}okBinNode.prototype={getName:function(){return this.sName},getChildNum:function(){return this.iChildNum},getChild:function(a){if(okIsNumber(a)){a=this.childNameArray[a]}if(this.childLayOut[a]==null){return null}if(this.children[a]==null){this.children[a]=new okBinNode(this.doc,this.childLayOut[a].iOffset)}return this.children[a]},getChildMap:function(){for(var a in this.childLayOut){if(this.children[a]==null){this.children[a]=new okBinNode(this.doc,this.childLayOut[a].iOffset)}}return this.children},getAttribNum:function(){return this.iAttribNum},isAttribExisted:function(a){return this.attribLayOut[a]!=null},getAttribValueString:function(c){if(this.attribLayOut[c]==null){return null}this.doc.seek(this.attribLayOut[c].iOffset);var a=this.doc.getUint16();return this.doc.getString(a)},getAttribValueInt:function(a){if(this.attribLayOut[a]==null){return null}this.doc.seek(this.attribLayOut[a].iOffset);return this.doc.getInt32()},getAttribValueFloat:function(a){if(this.attribLayOut[a]==null){return null}this.doc.seek(this.attribLayOut[a].iOffset);return this.doc.getFloat32()},getAttribValueVec2:function(c){if(this.attribLayOut[c]==null){return null}this.doc.seek(this.attribLayOut[c].iOffset);var a=okAllocator.vec2();a.set(this.doc.getFloat32(),this.doc.getFloat32());return a},getAttribValueVec3:function(c){if(this.attribLayOut[c]==null){return null}this.doc.seek(this.attribLayOut[c].iOffset);var a=okAllocator.vec3();a.set(this.doc.getFloat32(),this.doc.getFloat32(),this.doc.getFloat32());return a},getAttribValueVec4:function(c){if(this.attribLayOut[c]==null){return null}this.doc.seek(this.attribLayOut[c].iOffset);var a=okAllocator.vec4();a.set(this.doc.getFloat32(),this.doc.getFloat32(),this.doc.getFloat32(),this.doc.getFloat32());return a},getAttribValueMat4:function(c){if(this.attribLayOut[c]==null){return null}this.doc.seek(this.attribLayOut[c].iOffset);var a=okAllocator.mat4();a.m00=this.doc.getFloat32();a.m10=this.doc.getFloat32();a.m20=this.doc.getFloat32();a.m30=this.doc.getFloat32();a.m01=this.doc.getFloat32();a.m11=this.doc.getFloat32();a.m21=this.doc.getFloat32();a.m31=this.doc.getFloat32();a.m02=this.doc.getFloat32();a.m12=this.doc.getFloat32();a.m22=this.doc.getFloat32();a.m32=this.doc.getFloat32();a.m03=this.doc.getFloat32();a.m13=this.doc.getFloat32();a.m23=this.doc.getFloat32();a.m33=this.doc.getFloat32();return a},getAttribValueMat43:function(c){if(this.attribLayOut[c]==null){return null}this.doc.seek(this.attribLayOut[c].iOffset);var a=okAllocator.mat43();a.m00=this.doc.getFloat32();a.m10=this.doc.getFloat32();a.m20=this.doc.getFloat32();a.m01=this.doc.getFloat32();a.m11=this.doc.getFloat32();a.m21=this.doc.getFloat32();a.m02=this.doc.getFloat32();a.m12=this.doc.getFloat32();a.m22=this.doc.getFloat32();a.m03=this.doc.getFloat32();a.m13=this.doc.getFloat32();a.m23=this.doc.getFloat32();return a},getAttribValueQuat:function(c){if(this.attribLayOut[c]==null){return null}this.doc.seek(this.attribLayOut[c].iOffset);var a=okAllocator.quat();a.set(this.doc.getFloat32(),this.doc.getFloat32(),this.doc.getFloat32(),this.doc.getFloat32());return a},getAttribValueIntArray:function(e){if(this.attribLayOut[e]==null){return null}this.doc.seek(this.attribLayOut[e].iOffset);var d=okAllocator.array();var a=this.doc.getInt32();for(var c=0;c<a;++c){d.push(this.doc.getInt32())}return d},getAttribValueUshortArray:function(e){if(this.attribLayOut[e]==null){return null}this.doc.seek(this.attribLayOut[e].iOffset);var d=okAllocator.array();var a=this.doc.getInt32();for(var c=0;c<a;++c){d.push(this.doc.getUint16())}return d},getAttribValueFloatArray:function(e){if(this.attribLayOut[e]==null){return null}this.doc.seek(this.attribLayOut[e].iOffset);var d=okAllocator.array();var a=this.doc.getInt32();for(var c=0;c<a;++c){d.push(this.doc.getFloat32())}return d},getAttribValueStringArray:function(f){if(this.attribLayOut[f]==null){return null}this.doc.seek(this.attribLayOut[f].iOffset);var e=okAllocator.array();var a=this.doc.getInt32();for(var d=0;d<a;++d){var c=this.doc.getUint16();e.push(this.doc.getString(c))}return e}};var okResourceParser=new Object;okResourceParser.loadModel=function(a,d,c,h,e,f){if(a==1){return okResourceParser._loadModelXML(d,c,h,e,f)}else{if(a==3){return okResourceParser._loadModelBinary(d,c,h,e,f)}else{return false}}};okResourceParser._loadModelBinary=function(e,m,l,w,o){var y=new okBinDoc(m,"OKMDBI");if(!y.isValid()){return false}var v=y.getRootNode();var p=v.getAttribValueString("Version");var x=p.split(".");e.clear();var d=new Array;var f=v.getChild("MaterialList");if(f){for(var c in f.getChildMap()){var a=f.getChild(c);var h=new okMaterial(e.rc);if(this._parseMaterialBinary(c,a,h,o)==false){return false}d[c]=h}}var n=v.getChild("MeshList");if(n){var t=okAllocator.object();var k=okAllocator.object();if(l){for(var s in n.getChildMap()){k[s]=true}}var u=n.getChildNum();for(var s in n.getChildMap()){var q=n.getChild(s);if(l&&k[s]==null){continue}t[s]=true}for(var s in n.getChildMap()){var q=n.getChild(s);if(l&&k[s]==null){continue}if(this._parseMeshBinary(s,q,e,d,t,w,o)==false){return false}}okAllocator._object(t);okAllocator._object(k)}e.computeBoundingInfo();return true};okResourceParser._parseMaterialBinary=function(t,l,k,c){k.setDesc(t);if(l.isAttribExisted("Emissive")){k.setEmissive(l.getAttribValueVec3("Emissive"))}if(l.isAttribExisted("Ambient")){k.setAmbient(l.getAttribValueVec3("Ambient"))}if(l.isAttribExisted("Diffuse")){k.setDiffuse(l.getAttribValueVec3("Diffuse"))}if(l.isAttribExisted("Specular")){k.setSpecular(l.getAttribValueVec3("Specular"))}if(l.isAttribExisted("SpecularLevel")){k.setSpecularLevel(l.getAttribValueFloat("SpecularLevel"))}if(l.isAttribExisted("Glossiness")){k.setGlossiness(l.getAttribValueFloat("Glossiness"))}if(l.isAttribExisted("Alpha")){k.setAlpha(l.getAttribValueFloat("Alpha"))}if(l.isAttribExisted("Blend")){k.enableBlend(l.getAttribValueInt("Blend")==1)}if(l.isAttribExisted("AlphaTest")){k.enableAlphaTest(l.getAttribValueInt("AlphaTest")==1)}if(l.isAttribExisted("AlphaTestValue")){k.setAlphaTestValue(l.getAttribValueFloat("AlphaTestValue"))}if(l.isAttribExisted("DynamicLighting")){k.enableDynamicLighting(l.getAttribValueInt("DynamicLighting")==1)}if(l.isAttribExisted("Wireframe")){k.enableWireframe(l.getAttribValueInt("Wireframe")==1)}if(l.isAttribExisted("VertexColor")){k.enableVertexColor(l.getAttribValueInt("VertexColor")==1)}if(l.isAttribExisted("DepthTest")){k.enableDepthTest(l.getAttribValueInt("DepthTest")==1)}if(l.isAttribExisted("TwoSide")){k.enableTwoSide(l.getAttribValueInt("TwoSide")==1)}var e=l.getChild("TextureList");if(e){for(var s in e.getChildMap()){var d=e.getChild(s);var q=0;if(s=="Albedo1"){q=0}else{if(s=="Albedo2"){q=1}else{if(s=="Albedo3"){q=2}else{if(s=="Albedo4"){q=3}else{if(s=="Normal"){q=4}else{if(s=="Opacity"){q=5}else{if(s=="SpecularLevel"){q=6}}}}}}}var h=d.getAttribValueString("Name");if(h){k.setTextureName(q,h)}var o=d.getAttribValueString("Texcoord");if(o){k.setTextureCoord(q,o)}var f=d.getAttribValueString("Tangent");if(f){k.setTextureTangent(q,f)}var n=d.getAttribValueString("Binormal");if(n){k.setTextureBinormal(q,n)}var a=d.getAttribValueString("Type");if(a){if(a=="2D"){k.setTextureType(q,3553)}else{if(a=="Cube"){k.setTextureType(q,34067)}}}var p=d.getAttribValueString("Filter");if(p){if(p=="Linear"){k.setTextureFilter(q,9729)}else{if(p=="Nearest"){k.setTextureFilter(q,9728)}}}var m=d.getAttribValueString("Wrap");if(m){if(m=="Repeat"){k.setTextureWrap(q,10497)}else{if(m=="Clamp"){k.setTextureWrap(q,33071)}else{if(m=="Mirror"){k.setTextureWrap(q,33648)}}}}var m=d.getAttribValueString("WrapU");if(m){if(m=="Repeat"){k.setTextureWrapU(q,10497)}else{if(m=="Clamp"){k.setTextureWrapU(q,33071)}else{if(m=="Mirror"){k.setTextureWrapU(q,33648)}}}}var m=d.getAttribValueString("WrapV");if(m){if(m=="Repeat"){k.setTextureWrapV(q,10497)}else{if(m=="Clamp"){k.setTextureWrapV(q,33071)}else{if(m=="Mirror"){k.setTextureWrapV(q,33648)}}}}}}return true};okResourceParser._parseMeshBinary=function(v,k,d,z,R,c,aj){var w=okAllocator.array();var H=(k.getAttribValueInt("VertexCount")?k.getAttribValueInt("VertexCount"):0);var W=(k.getChild("IndexList")?k.getChild("IndexList").getChildNum():0);var Z=okAllocator.object();var Y=okAllocator.object();var n=okAllocator.object();var ac=okAllocator.object();var ab=okAllocator.object();var P={Triangles:4,TriangleStrip:5,TriangleFan:6,Lines:1,LineStrip:3,LineLoop:2,Points:0};var ad={Triangles:3,TriangleStrip:0,TriangleFan:0,Lines:2,LineStrip:0,LineLoop:0,Points:1};var o=k.getChild("AttributeList");for(var a in o.getChildMap()){var V=o.getChild(a);var O=a;var q=V.getAttribValueFloatArray("Data");var t=q.length/H;if(t-Math.floor(t)!=0){return false}Z[O]=q;Y[O]=t}var al=k.getChild("IndexList");for(var u in al.getChildMap()){var x=al.getChild(u);var O=u;var q=(H<=65536?x.getAttribValueUshortArray("Data"):x.getAttribValueIntArray("Data"));var ae=x.getAttribValueString("Topology");n[O]=q;ac[O]=P[ae?ae:"Triangles"];ab[O]=ad[ae?ae:"Triangles"]}if(aj){var af=okAllocator.array();var aq=okResourceParser._packMeshAttributes(H,Z,Y,af);okAllocator._object(Z);Z=okAllocator.object();Z[aq]=af;okAllocator._object(Y);Y=okAllocator.object();Y[aq]=af.length/H}var h="";var U=null;var K=0;var e=0;var L=0;for(var u in ac){h=u;U=n[u];L=U.length;K=ac[u];e=ab[u];break}if(H>65536&&W==1&&(K==4||K==1||K==0)){var G=0;while(G<L){var S=0;while(R[v+"_SV_"+S]!=null){S++}R[v+"_SV_"+S]=true;var E=d.createMesh(v+"_SV_"+S);var ao=0;var I=new Array();for(var ah=0;ah<H;++ah){I.push(-1)}var s=okAllocator.object();for(var a in Z){s[a]=okAllocator.array()}var y=okAllocator.array();while(G<L){var p=G;var m=Math.min(G+e,L);var N=ao;for(var ah=p;ah<m;++ah){var am=U[ah];if(I[am]==-1){I[am]=ao;for(var a in s){var t=Y[a];var ai=Z[a];var at=s[a];for(var ag=0;ag<t;++ag){at.push(ai[am*t+ag])}}ao+=1}y.push(I[am])}if(ao>65536){ao=N;for(var a in s){var at=s[a];var t=Y[a];while(at.length>65536*t){at.pop()}}for(var ah=p;ah<m;++ah){y.pop()}break}G+=e}for(var a in s){var F=s[a];if(F.length>0){E.createAttribute(a,F.length,F)}}if(y.length>0){E.createIndex(h,y.length,y,35044,K)}E.setVertexNum(ao);w.push(E)}}else{var E=d.createMesh(v);for(var a in Z){var F=Z[a];if(F.length>0){E.createAttribute(a,F.length,F)}}for(var u in n){var M=n[u];if(M.length>0){E.createIndex(u,M.length,M,35044,ac[u])}}E.setVertexNum(H);w.push(E)}okAllocator._object(Z);okAllocator._object(Y);okAllocator._object(n);okAllocator._object(ac);okAllocator._object(ab);var X=k.getChild("Skin");if(X){for(var v in w){var E=w[v];var B=E.getSkin();B.clear();var aa=X.getChild("BoundingBox");B.setBoundingBox(aa.getAttribValueVec3("Min"),aa.getAttribValueVec3("Max"));var D=X.getChild("BoneList");for(var Q in D.getChildMap()){var C=D.getChild(Q);B.addBone(Q,C.getAttribValueMat43("InitMatrix"))}B.setRefAttributeName(X.getAttribValueString("VertexBoneIndexAttribName"),X.getAttribValueString("VertexBoneWeightAttribName"))}}var aa=k.getChild("BoundingBox");for(var v in w){var E=w[v];E.setBoundingBox(aa.getAttribValueVec3("Min"),aa.getAttribValueVec3("Max"))}var T=k.getAttribValueString("Material");if(T&&T!=""){for(var v in w){var E=w[v];z[T].clone(E.getMaterial())}}if(c!=false){for(var v in w){var E=w[v];var J=E.getIndexArray("Default");var A=new Array;var l=J.length/3;for(var ak=0;ak<l;++ak){var ar=J[ak*3];var ap=J[ak*3+1];var an=J[ak*3+2];A.push(ar,ap,ap,an,an,ar)}E.createIndex("Wireframe",A.length,A)}}};okResourceParser._loadModelXML=function(f,o,m,z,p){var C=o.indexOf("<");var c=o.lastIndexOf(">");if(C==-1||c==-1){return false}var n=okParseXML(o.substr(C,c-C+1));if(n==null){return false}var B=new okXmlDoc(n);var y=B.getRootNode();if(y.getName().toLowerCase()!="oak3dmodeldocument"){return false}var q=y.getAttribValueString("Version",true);var A=q.split(".");f.clear();var e=new Array;for(var w=0;w<y.getChildNum();++w){var d=y.getChild(w);if(d.getName()=="MaterialList"){var l=d.getChildNum();for(var u=0;u<l;++u){var a=d.getChild(u);var h=new okMaterial(f.rc);if(this._parseMaterialXML(a,h,p)==false){return false}e[a.getAttribValueString("Name")]=h}}else{if(d.getName()=="MeshList"){var v=okAllocator.object();var k=okAllocator.object();if(m){for(var u=0;u<m.length;++u){k[m[u]]=true}}var x=d.getChildNum();for(var u=0;u<x;++u){var s=d.getChild(u);var t=s.getAttribValueString("Name",true);if(t==null){return false}if(m&&k[t]==null){continue}v[t]=true}for(var u=0;u<x;++u){var s=d.getChild(u);var t=s.getAttribValueString("Name",true);if(m&&k[t]==null){continue}if(this._parseMeshXML(d.getChild(u),f,e,v,z,p)==false){return false}}okAllocator._object(v);okAllocator._object(k)}}}f.computeBoundingInfo();return true};okResourceParser._parseMaterialXML=function(a,u,o){var v=a.getAttribValueString("name",true);if(v){u.setDesc(v)}var h=a.getAttribNum();for(var s=0;s<h;++s){var m=a.getAttribName(s).toLowerCase();switch(m){case"emissive":u.setEmissive(a.getAttribValueVec3(s));break;case"ambient":u.setAmbient(a.getAttribValueVec3(s));break;case"diffuse":u.setDiffuse(a.getAttribValueVec3(s));break;case"specular":u.setSpecular(a.getAttribValueVec3(s));break;case"specularlevel":u.setSpecularLevel(a.getAttribValueFloat(s));break;case"glossiness":u.setGlossiness(a.getAttribValueFloat(s));break;case"alpha":u.setAlpha(a.getAttribValueFloat(s));break;case"blend":u.enableBlend(a.getAttribValueString(s).toLowerCase()=="true");break;case"alphatest":u.enableAlphaTest(a.getAttribValueString(s).toLowerCase()=="true");break;case"alphatestvalue":u.setAlphaTestValue(a.getAttribValueFloat(s));break;case"dynamiclighting":u.enableDynamicLighting(a.getAttribValueString(s).toLowerCase()=="true");break;case"wireframe":u.enableWireframe(a.getAttribValueString(s).toLowerCase()=="true");break;case"vertexcolor":u.enableVertexColor(a.getAttribValueString(s).toLowerCase()=="true");break;case"depthtest":u.enableDepthTest(a.getAttribValueString(s).toLowerCase()=="true");break;case"twoside":u.enableTwoSide(a.getAttribValueString(s).toLowerCase()=="true");break}}for(var s=0;s<a.getChildNum();++s){var c=a.getChild(s);if(c.getName()=="Texture"){var e=c.getAttribValueString("channel",true).toLowerCase();var w=0;if(e=="albedo1"){w=0}else{if(e=="albedo2"){w=1}else{if(e=="albedo3"){w=2}else{if(e=="albedo4"){w=3}else{if(e=="normal"){w=4}else{if(e=="opacity"){w=5}else{if(e=="specularlevel"){w=6}}}}}}}var h=c.getAttribNum();for(var q=0;q<h;++q){var m=c.getAttribName(q).toLowerCase();switch(m){case"name":u.setTextureName(w,c.getAttribValueString(q));break;case"texcoord":u.setTextureCoord(w,c.getAttribValueString(q));break;case"type":var f=c.getAttribValueString(q).toLowerCase();if(f=="2d"){u.setTextureType(w,3553)}else{if(f=="cube"){u.setTextureType(w,34067)}}break;case"filter":var k=c.getAttribValueString(q).toLowerCase();if(k=="linear"){u.setTextureFilter(w,9729)}else{if(k=="nearest"){u.setTextureFilter(w,9728)}}break;case"wrap":var p=c.getAttribValueString(q).toLowerCase();if(p=="repeat"){u.setTextureWrap(w,10497)}else{if(p=="clamp"){u.setTextureWrap(w,33071)}else{if(p=="mirror"){u.setTextureWrap(w,33648)}}}break;case"wrapu":var p=c.getAttribValueString(q).toLowerCase();if(p=="repeat"){u.setTextureWrapU(w,10497)}else{if(p=="clamp"){u.setTextureWrapU(w,33071)}else{if(p=="mirror"){u.setTextureWrapU(w,33648)}}}break;case"wrapv":var p=c.getAttribValueString(q).toLowerCase();if(p=="repeat"){u.setTextureWrapV(w,10497)}else{if(p=="clamp"){u.setTextureWrapV(w,33071)}else{if(p=="mirror"){u.setTextureWrapV(w,33648)}}}break;case"tangent":u.setTextureTangent(w,c.getAttribValueString(q));break;case"binormal":u.setTextureBinormal(w,c.getAttribValueString(q));break}}}else{if(c.getName().toLowerCase()==("Script").toLowerCase()){for(var q=0;q<c.getChildNum();++q){var n=c.getChild(q);var t=n.getName().toLowerCase();var d=n.getAttribValueString("Code",true);if(d==null){d=n.getText()}var l=n.getAttribValueString("Enable",true);if(t=="emissive"){if(d){u.setEmissiveScript(d)}if(l){u.enableEmissiveScript(l.toLowerCase()=="true")}}else{if(t=="diffuse"){if(d){u.setDiffuseScript(d)}if(l){u.enableDiffuseScript(l.toLowerCase()=="true")}}else{if(t=="specular"){if(d){u.setSpecularScript(d)}if(l){u.enableSpecularScript(l.toLowerCase()=="true")}}else{if(t=="specularpower"){if(d){u.setSpecularPowerScript(d)}if(l){u.enableSpecularPowerScript(l.toLowerCase()=="true")}}else{if(t=="normal"){if(d){u.setNormalScript(d)}if(l){u.enableNormalScript(l.toLowerCase()=="true")}}else{if(t=="alpha"){if(d){u.setAlphaScript(d)}if(l){u.enableAlphaScript(l.toLowerCase()=="true")}}else{if(t=="dctlight"){if(d){u.setDctLightScript(d)}if(l){u.enableDctLightScript(l.toLowerCase()=="true")}}else{if(t=="pointlight"){if(d){u.setPointLightScript(d)}if(l){u.enablePointLightScript(l.toLowerCase()=="true")}}else{if(t=="spotlight"){if(d){u.setSpotLightScript(d)}if(l){u.enableSpotLightScript(l.toLowerCase()=="true")}}}}}}}}}}}}}}return true};okResourceParser._packMeshAttributes=function(h,a,n,p){var f=new okList();for(var o in a){if(o.toLowerCase()=="position"||o.toLowerCase().indexOf("position/")==0){f.pushFront(o)}else{if(o!="Texcoord1"&&o!="Texcoord2"&&o!="Texcoord3"&&o!="Texcoord4"){f.pushBack(o)}}}if(a.Texcoord1){f.pushBack("Texcoord1")}if(a.Texcoord2){f.pushBack("Texcoord2")}if(a.Texcoord3){f.pushBack("Texcoord3")}if(a.Texcoord4){f.pushBack("Texcoord4")}for(var m=0;m<h;++m){var e=f.getRoot();while(e){var o=e.data;var l=a[o];var d=n[o];for(var k=0;k<d;++k){p.push(l[m*d+k])}e=e.next}}var c="";var e=f.getRoot();while(e){c+=(c!=""?"/":"")+e.data;e=e.next}return c};okResourceParser._parseMeshXML=function(l,d,A,Q,c,ah){if(l.getName()!="Mesh"){return false}var w=l.getAttribValueString("Name",true);var x=okAllocator.array();var H=(l.getAttribValueInt("VertexCount",true)?l.getAttribValueInt("VertexCount",true):0);var V=(l.getChild("IndexList",true)?l.getChild("IndexList",true).getChildNum():0);var Y=okAllocator.object();var X=okAllocator.object();var o=okAllocator.object();var aa=okAllocator.object();var Z=okAllocator.object();var P={triangles:4,trianglestrip:5,trianglefan:6,lines:1,linestrip:3,lineloop:2,points:0};var ab={triangles:3,trianglestrip:0,trianglefan:0,lines:2,linestrip:0,lineloop:0,points:1};var p=l.getChild("AttributeList",true);for(var ae=0;ae<p.getChildNum();++ae){var U=p.getChild(ae);if(U.getName().toLowerCase()=="attribute"){var O=U.getAttribValueString("Name",true);var s=U.getAttribValueFloatArray("Data",true);var u=s.length/H;if(u-Math.floor(u)!=0){return false}Y[O]=s;X[O]=u}}var aj=l.getChild("IndexList",true);for(var ae=0;ae<aj.getChildNum();++ae){var y=aj.getChild(ae);if(y.getName().toLowerCase()=="index"){var O=y.getAttribValueString("Name",true);var s=y.getAttribValueIntArray("Data",true);var ac=y.getAttribValueIntArray("Topology",true);o[O]=s;aa[O]=P[ac?ac:"triangles"];Z[O]=ab[ac?ac:"triangles"]}}if(ah){var ad=okAllocator.array();var ao=okResourceParser._packMeshAttributes(H,Y,X,ad);okAllocator._object(Y);Y=okAllocator.object();Y[ao]=ad;okAllocator._object(X);X=okAllocator.object();X[ao]=ad.length/H}var k="";var T=null;var K=0;var h=0;var L=0;for(var v in aa){k=v;T=o[v];L=T.length;K=aa[v];h=Z[v];break}if(H>65536&&V==1&&(K==4||K==1||K==0)){var G=0;while(G<L){var R=0;while(Q[w+"_SV_"+R]!=null){R++}Q[w+"_SV_"+R]=true;var E=d.createMesh(w+"_SV_"+R);var am=0;var I=new Array();for(var af=0;af<H;++af){I.push(-1)}var t=okAllocator.object();for(var a in Y){t[a]=okAllocator.array()}var z=okAllocator.array();while(G<L){var q=G;var n=Math.min(G+h,L);var N=am;for(var af=q;af<n;++af){var ak=T[af];if(I[ak]==-1){I[ak]=am;for(var a in t){var u=X[a];var ag=Y[a];var aq=t[a];for(var ae=0;ae<u;++ae){aq.push(ag[ak*u+ae])}}am+=1}z.push(I[ak])}if(am>65536){am=N;for(var a in t){var aq=t[a];var u=X[a];while(aq.length>65536*u){aq.pop()}}for(var af=q;af<n;++af){z.pop()}break}G+=h}for(var a in t){var F=t[a];if(F.length>0){E.createAttribute(a,F.length,F)}}if(z.length>0){E.createIndex(k,z.length,z,35044,K)}E.setVertexNum(am);x.push(E)}}else{var E=d.createMesh(w);for(var a in Y){var F=Y[a];if(F.length>0){E.createAttribute(a,F.length,F)}}for(var v in o){var M=o[v];if(M.length>0){E.createIndex(v,M.length,M,35044,aa[v])}}E.setVertexNum(H);x.push(E)}okAllocator._object(Y);okAllocator._object(X);okAllocator._object(o);okAllocator._object(aa);okAllocator._object(Z);for(var af=0;af<l.getChildNum();++af){var D=l.getChild(af);var e=D.getName();switch(e){case"Skin":var W=D;for(var w in x){var E=x[w];var C=E.getSkin();C.clear();for(var ae=0;ae<W.getChildNum();++ae){var D=W.getChild(ae);if(D.getName()=="Bone"){C.addBone(D.getAttribValueString("Name"),D.getAttribValueMat43("InitMatrix"))}else{if(D.getName()=="BoundingBox"){C.setBoundingBox(D.getAttribValueVec3("Min"),D.getAttribValueVec3("Max"))}}}C.setRefAttributeName(W.getAttribValueString("VertexBoneIndexAttribName"),W.getAttribValueString("VertexBoneWeightAttribName"))}break;case"BoundingBox":for(var w in x){var E=x[w];E.setBoundingBox(D.getAttribValueVec3("Min"),D.getAttribValueVec3("Max"))}break}}var S=l.getAttribValueString("Material");if(S!=""){for(var w in x){var E=x[w];A[S].clone(E.getMaterial())}}if(c!=false){for(var w in x){var E=x[w];var J=E.getIndexArray("Default");var B=new Array;var m=J.length/3;for(var ai=0;ai<m;++ai){var ap=J[ai*3];var an=J[ai*3+1];var al=J[ai*3+2];B.push(ap,an,an,al,al,ap)}E.createIndex("Wireframe",B.length,B)}}};okResourceParser.loadSkAnimation=function(a,d,c){if(a==1){return okResourceParser._loadSkAnimationXML(d,c)}else{if(a==3){return okResourceParser._loadSkAnimationBinary(d,c)}else{return false}}};okResourceParser._loadSkAnimationXML=function(q,n){var z=n.indexOf("<");var d=n.lastIndexOf(">");if(z==-1||d==-1){return false}var m=okParseXML(n.substr(z,d-z+1));var y=new okXmlDoc(m);var w=y.getRootNode();if(w.getName()!="Oak3DAnimationDocument"){return false}var o=w.getAttribValueString("Version");var x=o.split(".");q.clear();for(var u=0;u<w.getChildNum();++u){var e=w.getChild(u);if(e.getName()=="AnimationInfo"){}else{if(e.getName()=="KeyFrameList"){q.setFrameNum(e.getAttribValueInt("Count"));if(e.getAttribValueFloat("FrameTime")!=null){q.setFrameTime(e.getAttribValueFloat("FrameTime"))}q.loadKeyFrameList(e.getAttribValueIntArray("KeyTimeList"))}else{if(e.getName()=="BoundingBox"){q.setBoundingBox(e.getAttribValueVec3("Min"),e.getAttribValueVec3("Max"))}else{if(e.getName()=="BoneList"){for(var t=0;t<e.getChildNum();++t){var c=e.getChild(t);if(c.getName()=="Bone"){var f=new okSkAnimBone();var v=new Array;var l=new Array;f.setName(c.getAttribValueString("Name"));for(var s=0;s<c.getChildNum();++s){var a=c.getChild(s);v.push(a.getAttribValueVec3("Translation"));l.push(a.getAttribValueQuat("Rotation"))}f.loadKeyTranslateList(v);f.loadKeyQuaternionList(l);q.addBone(f)}}for(var t=0;t<e.getChildNum();++t){var c=e.getChild(t);if(c.getName()=="Bone"){var h=q.getBone(c.getAttribValueString("Name"));var p=c.getAttribValueString("Parent");if(p!=""){h.setParent(q.getBone(p))}}}}}}}}return true};okResourceParser._loadSkAnimationBinary=function(s,m){var y=new okBinDoc(m,"OKAMBI");if(!y.isValid()){return false}var v=y.getRootNode();var o=v.getAttribValueString("Version");var x=o.split(".");s.clear();var d=v.getChild("AnimationInfo");var q=v.getChild("KeyFrameList");if(q){s.setFrameNum(q.getAttribValueInt("Count"));if(q.isAttribExisted("FrameTime")){s.setFrameTime(q.getAttribValueFloat("FrameTime"))}s.loadKeyFrameList(q.getAttribValueIntArray("KeyTimeList"))}var n=v.getChild("BoneList");if(n){for(var e in n.getChildMap()){var a=n.getChild(e);var f=new okSkAnimBone();var u=new Array;var l=new Array;f.setName(e);var h=a.getChild("KeyList");if(h){for(var t=0;t<h.getChildNum();++t){var c=h.getChild(t);var w=c.getAttribValueFloatArray("TQ");u.push(new okVec3(w[0],w[1],w[2]));l.push(new okQuat(w[3],w[4],w[5],w[6]))}f.loadKeyTranslateList(u);f.loadKeyQuaternionList(l)}s.addBone(f)}for(var e in n.getChildMap()){var a=n.getChild(e);var k=s.getBone(e);var p=a.getAttribValueString("Parent");if(p!=""){k.setParent(s.getBone(p))}}}return true};okResourceParser.loadShaderSource=function(k,q,l,d){var h=okPackXMLShaderSource(d);var n=new okXmlDoc(okParseXML(h));var c=n.getRootNode();if(c.getName().toLowerCase()!=("OakShader").toLowerCase()){return false}var f=c.getChild("Common",true);var o=okUnpackXMLShaderSource((f!=null)?f.getText():"");if(q!=null){var m=c.getChild("Vertex",true);if(m!=null){var e="";var a=okUnpackXMLShaderSource(m.getText());q.loadSource(o+"\n"+a)}else{return false}}if(l!=null){var p=c.getChild("Fragment",true);if(p!=null){var a=okUnpackXMLShaderSource(p.getText());l.loadSource(o+"\n"+a)}else{return false}}return true};okResourceParser.loadShaderSourceToMap=function(k,l,e){var f=okPackXMLShaderSource(e);var m=new okXmlDoc(okParseXML(f));var d=m.getRootNode();if(d.getName().toLowerCase()!=("OakShader").toLowerCase()){return false}if(l==null){return false}var a=d.getChildNum();for(var h=0;h<a;++h){var c=d.getChild(h);var e=okUnpackXMLShaderSource(c.getText());l[c.getName()]=e}return true};okResourceParser.loadTextureFromImage=function(d,e,c){if(!okIsPower2(e.width)||!okIsPower2(e.height)){if(okIsUndefined(this.texSupportedCanvas)&&!okIsIE()){this.texSupportedCanvas=document.createElement("canvas")}if(this.texSupportedCanvas){this.texSupportedCanvas.width=okAlignPower2(e.width);this.texSupportedCanvas.height=okAlignPower2(e.height);var a=this.texSupportedCanvas.getContext("2d");a.drawImage(e,0,0,e.width,e.height,0,0,this.texSupportedCanvas.width,this.texSupportedCanvas.height);e=this.texSupportedCanvas}else{return false}}d.createTexture(3553,e.width,e.height,c,5121,e);return true};okResourceParser.loadTextureFromVideo=function(c,d,a){c.createTexture(3553,d.width,d.height,a,5121,d);return true};okResourceParser.loadTerrainFromXml=function(e,p,t){var w=new okXmlDoc(p);var s=w.getRootNode();if(s.getName()!="Oak3DModelDocument"){return false}var l=s.getAttribValueString("Version");var v=l.split(".");for(var o=0;o<s.getChildNum();++o){var a=s.getChild(o);if(a.getName()=="terrainInfo"){var c=a.getAttribValueInt("cw");var h=a.getAttribValueInt("ch");var u=a.getAttribValueInt("ww");var f=a.getAttribValueInt("wh");e.setChunkSize(c,h);e.setWorldMapSize(u,f)}if(a.getName()=="WorldMap"){var x=new okTerrainTile(e.resourceManager.rc);var m=a.getAttribValueFloatArray("min");var n=a.getAttribValueFloatArray("max");x.setBoundingBox(new okVec3(m[0],m[1],m[2]),new okVec3(n[0],n[1],n[2]));var k=a.getAttribValueInt("i");var q=a.getAttribValueInt("j");x.setGlobalIndex(k,q);var d=a.getAttribValueString("url");x.setUrl(d);e.addWorldMap(x)}}return true},okResourceParser.loadWorldMapFromXml=function(d,h){var o=new okXmlDoc(h);var e=o.getRootNode();if(e.getName()!="Oak3DModelDocument"){return false}var m=e.getAttribValueString("Version");var p=m.split(".");var l;var c=e.getAttribValueString("n");for(var k=0;k<d.aWorldMapArray.length;++k){if(d.aWorldMapArray[k].getUrl()==c){l=d.aWorldMapArray[k];break}}if(!l){return}for(var k=0;k<e.getChildNum();++k){var a=e.getChild(k);if(a.getName()=="Textures"){this._parseTerrainTextureInOmx(l,a)}if(a.getName()=="WorldMap"){var f=a.getAttribValueFloatArray("min");var n=a.getAttribValueFloatArray("max");l.setBoundingBox(new okVec3(f[0],f[1],f[2]),new okVec3(n[0],n[1],n[2]));l.setGlobalIndex(a.getAttribValueInt("i"),a.getAttribValueInt("j"));this._parseTerrainMeshInOmx(l,a);l.computeNormal();l.fixNormal(d.getWorldMapMap());l.createAttributeArrayBuffer("Normal")}}l.setState(3);return true};okResourceParser._parseTerrainMeshInOmx=function(u,o){for(var z=0;z<o.getChildNum();++z){var d=o.getChild(z);var c;if(d.getName()=="Mesh"){c=new okTerrainTile(u.rc)}else{c=new okTerrainMesh(u.rc)}u.addChlidMesh(c);var t=d.getAttribValueFloatArray("min");var v=d.getAttribValueFloatArray("max");c.setBoundingBox(new okVec3(t[0],t[1],t[2]),new okVec3(v[0],v[1],v[2]));var k=d.getAttribValueInt("i");var f=d.getAttribValueInt("j");c.setGlobalIndex(k,f);if(d.getName()=="Mesh"){this._parseTerrainMeshInOmx(c,d)}else{c.setName("chunk_"+k.toString()+"_"+f.toString());var e=new Array;var E=d.getAttribValueFloat("sx");var D=d.getAttribValueFloat("sy");var l=c.getChunkWidth();var A=c.getChunkHeight();var p=d.getAttribValueFloatArray("data");for(var q=0;q<A;++q){for(var s=0;s<l;++s){var B=new Array;B[0]=E*(k*(l-1)+s);B[1]=D*(f*(A-1)+q);B[2]=p[q*l+s];for(var C=0;C<B.length;C++){e.push(B[C])}}}c.createAttribute("Position",e.length,e,35044)}}};okResourceParser._parseTerrainTextureInOmx=function(l,a){for(var e=0;e<a.getChildNum();++e){var f=a.getChild(e);var c=f.getAttribValueFloatArray("data");l.loadTextureFromXml("Texcoord1",c);var m=f.getAttribValueString("name");var h=l.getMaterialArray();for(var d=0;d<h.length;++d){var k=h[d];if(!k){continue}k.setTextureName(0,m)}}};okResourceParser.loadTerrainFromBmp=function(d){var c=d.width;var a=d.height};function okArrayBuffer(a){this.rc=a;this.glArrayBuffer=null;this.iBufferType=0;this.iDataType=0;this.iDataSize=0;this.iBufferLength=0}okArrayBuffer.prototype={createBuffer:function(d,e,a,c){this.releaseBuffer();this.glArrayBuffer=this.rc.createBuffer();this.iBufferType=d;this.rc.bindBuffer(this.iBufferType,this.glArrayBuffer);this.iDataType=e;this.iDataSize=((e==5123)?2:4);if(okIsNumber(c)){this.iBufferLength=c;this.rc.bufferData(this.iBufferType,c*this.iDataSize,a)}else{this.iBufferLength=c.length;if(okIsArray(c)){if(e==5126){this.rc.bufferData(this.iBufferType,new Float32Array(c),a)}else{if(e==5123){this.rc.bufferData(this.iBufferType,new Uint16Array(c),a)}}}else{this.rc.bufferData(this.iBufferType,c,a)}}},releaseBuffer:function(){if(this.glArrayBuffer!=null){this.rc.deleteBuffer(this.glArrayBuffer)}this.glArrayBuffer=null},updateBuffer:function(a,c,d){this.rc.bindBuffer(this.iBufferType,this.glArrayBuffer);if(okIsArray(d)){if(this.iDataType==5126){this.rc.bufferSubData(this.iBufferType,a*this.iDataSize,new Float32Array(d))}else{if(this.iDataType==5123){this.rc.bufferSubData(this.iBufferType,a*this.iDataSize,new Uint16Array(d))}}}else{this.rc.bufferSubData(this.iBufferType,a*this.iDataSize,d)}},getLength:function(){return this.iBufferLength},bindAttrib:function(d,c,e,a){this.rc.bindBuffer(this.iBufferType,this.glArrayBuffer);this.rc.enableVertexAttribArray(d);this.rc.vertexAttribPointer(d,c,this.iDataType,false,a*this.iDataSize,e*this.iDataSize)},bind:function(){this.rc.bindBuffer(this.iBufferType,this.glArrayBuffer)},drawIndex:function(a,c,d){this.rc.bindBuffer(this.iBufferType,this.glArrayBuffer);this.rc.drawElements(a,d?d:this.iBufferLength,this.iDataType,c?c*this.iDataSize:0)}};function okRenderBuffer(a){this.rc=a;this.glRenderBufferObj=null;this.iBufferFormat=0;this.iWidth=0;this.iHeight=0}okRenderBuffer.prototype={createBuffer:function(a,c,d){this.releaseBuffer();this.glRenderBufferObj=this.rc.createRenderbuffer();this.rc.bindRenderbuffer(36161,this.glRenderBufferObj);this.rc.renderbufferStorage(36161,a,c,d);this.iBufferFormat=a;this.iWidth=c;this.iHeight=d},releaseBuffer:function(){if(this.glRenderBufferObj!=null){this.rc.deleteRenderbuffer(this.glRenderBufferObj)}this.glRenderBufferObj=null;this.iBufferFormat=0;this.iWidth=0;this.iHeight=0}};function okFrameBuffer(a){this.rc=a;this.glFrameBufferObj=null}okFrameBuffer.prototype={createBuffer:function(){this.glFrameBufferObj=this.rc.createFramebuffer()},releaseBuffer:function(){if(this.glFrameBufferObj!=null){this.rc.deleteFramebuffer(this.glFrameBufferObj)}this.glFrameBufferObj=null},bind:function(){this.rc.bindFramebuffer(36160,this.glFrameBufferObj)},unbind:function(){this.rc.bindFramebuffer(36160,null)},attachRenderTexture:function(c,a){this.rc.framebufferTexture2D(36160,36064+c,3553,a?a.glTextureObj:null,0)},attachDepthBuffer:function(a){this.rc.framebufferRenderbuffer(36160,36096,36161,a.glRenderBufferObj)},attachStencilBuffer:function(a){this.rc.framebufferRenderbuffer(36160,36128,36161,a.glRenderBufferObj)},attachDepthStencilBuffer:function(a){this.rc.framebufferRenderbuffer(36160,33306,36161,a?a.glRenderBufferObj:null)}};function okShader(c,a){this.iShaderType=a;this.rc=c;this.glShaderObj=this.rc.createShader(this.iShaderType);this.sShaderSource="";this.sFloatPrecision="mediump"}okShader.prototype={releaseShader:function(){if(this.glShaderObj!=null){this.rc.deleteShader(this.glShaderObj)}this.glShaderObj=null},releaseSource:function(){this.sShaderSource=""},loadSource:function(c,a){if(a){this.sShaderSource=this._processInc(c,a)}else{this.sShaderSource=c.substr(0,c.length)}},setFloatPrecision:function(a){this.sFloatPrecision=a},compile:function(e,a){var h="";if(e!=null){for(var f in e){h+=("\n#define "+f+" "+e[f]+"\n")}}var d="";if(this.iShaderType==35632){d="\nprecision "+this.sFloatPrecision+" float;\n"}if(this.glShaderObj==null){this.glShaderObj=this.rc.createShader(this.iShaderType)}var c=d+((e!=null)?h+this.sShaderSource:this.sShaderSource);this.rc.shaderSource(this.glShaderObj,c);this.rc.compileShader(this.glShaderObj);if(!this.rc.getShaderParameter(this.glShaderObj,35713)){if(a){a.errorMsg=shaderInfo}return false}return true},_processInc:function(d,c){var e=okAllocator.array();var k=okAllocator.array();var q=okAllocator.array();var p=-1;p=d.indexOf("#include");while(p!=-1){var o=p+8;while(d[o]!='"'&&o<d.length){++o}if(d[o]!='"'){return""}var u=o+1;while(d[u]!='"'&&u<d.length){++u}if(d[u]!='"'){return""}if(u==(o+1)){return""}var a=d.substr(o+1,u-(o+1));e.push(p);k.push(u);q.push(a);if(u<d.length-1){p=d.indexOf("#include",u)}else{p=-1}}var n=0;var f="";var t=e.length;for(var m=0;m<t;++m){var h=e[m];var v=k[m];var l=q[m];var s=c[l];if(h-n>0){f+=d.substr(n,h-n)}if(s){f+=s}n=v+1}if(n<d.length){f+=d.substr(n)}okAllocator._array(e);okAllocator._array(k);okAllocator._array(q);return f}};function okProgram(a){this.rc=a;this.glProgramObj=this.rc.createProgram();this.vertexShader=null;this.fragmentShader=null;this.aAddrA=null;this.aAddrU=null;this.aTexBind=null;this.tempFloat3x3Array=[0,0,0,0,0,0,0,0,0];this.tempFloat4x3Array=[0,0,0,0,0,0,0,0,0,0,0,0];this.tempFloat4x4Array=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.tempArray=new Array}okProgram.prototype={releaseProgram:function(){if(this.glProgramObj!=null){this.rc.deleteProgram(this.glProgramObj)}this.glProgramObj=null},attachVertexShader:function(a){this.vertexShader=a},attachFragmentShader:function(a){this.fragmentShader=a},link:function(a){if(this.glProgramObj==null){this.glProgramObj=this.rc.createProgram()}this.rc.attachShader(this.glProgramObj,this.vertexShader.glShaderObj);this.rc.attachShader(this.glProgramObj,this.fragmentShader.glShaderObj);this.rc.linkProgram(this.glProgramObj);if(!this.rc.getProgramParameter(this.glProgramObj,35714)){if(a){a.errorMsg=programInfo}return false}this.aAddrA=new Object;this.aAddrU=new Object;this.aTexBind=new Object;var d=this.rc.getProgramParameter(this.glProgramObj,35721);var h=this.rc.getProgramParameter(this.glProgramObj,35718);for(var e=0;e<d;++e){var k=this.rc.getActiveAttrib(this.glProgramObj,e);var c=k.name.replace(/\[\d*\]/g,"");this.aAddrA[c]=this.rc.getAttribLocation(this.glProgramObj,c)}var f=0;for(var e=0;e<h;++e){var k=this.rc.getActiveUniform(this.glProgramObj,e);var c=k.name.replace(/\[\d*\]/g,"");this.aAddrU[c]=this.rc.getUniformLocation(this.glProgramObj,c);if(k.type==35678||k.type==35680){this.aTexBind[c]=f;f+=k.size}}return true},setUniformInt:function(a,c){this.rc.uniform1i(this.aAddrU[a],c)},setUniformInt2:function(c,a,d){if(typeof a=="number"){this.rc.uniform2i(this.aAddrU[c],a,d)}else{this.rc.uniform2i(this.aAddrU[c],a.x,a.y)}},setUniformInt3:function(c,a,e,d){if(typeof a=="number"){this.rc.uniform3i(this.aAddrU[c],a,e,d)}else{this.rc.uniform3i(this.aAddrU[c],a.x,a.y,a.z)}},setUniformInt4:function(d,a,f,e,c){if(typeof a=="number"){this.rc.uniform4i(this.aAddrU[d],a,f,e,c)}else{this.rc.uniform4i(this.aAddrU[d],a.x,a.y,a.z,a.w)}},setUniformIntArray:function(c,a){this.rc.uniform1iv(this.aAddrU[c],a)},setUniformInt2Array:function(c,a){this.rc.uniform2iv(this.aAddrU[c],a)},setUniformInt3Array:function(c,a){this.rc.uniform3iv(this.aAddrU[c],a)},setUniformInt4Array:function(c,a){this.rc.uniform4iv(this.aAddrU[c],a)},setUniformFloat:function(c,a){this.rc.uniform1f(this.aAddrU[c],a)},setUniformFloat2:function(d,c,a){if(typeof c=="number"){this.rc.uniform2f(this.aAddrU[d],c,a)}else{this.rc.uniform2f(this.aAddrU[d],c.x,c.y)}},setUniformFloat3:function(e,d,c,a){if(typeof d=="number"){this.rc.uniform3f(this.aAddrU[e],d,c,a)}else{this.rc.uniform3f(this.aAddrU[e],d.x,d.y,d.z)}},setUniformFloat4:function(f,d,c,a,e){if(typeof d=="number"){this.rc.uniform4f(this.aAddrU[f],d,c,a,e)}else{this.rc.uniform4f(this.aAddrU[f],d.x,d.y,d.z,d.w)}},setUniformFloatArray:function(c,a){this.rc.uniform1fv(this.aAddrU[c],a)},setUniformFloat2Array:function(c,a){this.rc.uniform2fv(this.aAddrU[c],a)},setUniformFloat3Array:function(c,a){this.rc.uniform3fv(this.aAddrU[c],a)},setUniformFloat4Array:function(c,a){this.rc.uniform4fv(this.aAddrU[c],a)},setUniformVec2Array:function(e,d){var f=okAllocator.array();var a=d.length;for(var c=0;c<a;++c){var h=d[c];f.push(h.x,h.y)}this.rc.uniform2fv(this.aAddrU[e],f);okAllocator._array(f)},setUniformVec3Array:function(e,d){var f=okAllocator.array();var a=d.length;for(var c=0;c<a;++c){var h=d[c];f.push(h.x,h.y,h.z)}this.rc.uniform3fv(this.aAddrU[e],f);okAllocator._array(f)},setUniformVec4Array:function(e,d){var f=okAllocator.array();var a=d.length;for(var c=0;c<a;++c){var h=d[c];f.push(h.x,h.y,h.z,h.w)}this.rc.uniform4fv(this.aAddrU[e],f);okAllocator._array(f)},setUniformMat3:function(c,a){var d=this.tempFloat3x3Array;d[0]=a.m00;d[1]=a.m10;d[2]=a.m20;d[3]=a.m01;d[4]=a.m11;d[5]=a.m21;d[6]=a.m02;d[7]=a.m12;d[8]=a.m22;this.rc.uniformMatrix3fv(this.aAddrU[c],false,d)},setUniformMat3Array:function(e,d){var f=this.tempArray;f.length=0;var a=d.length;for(var c=0;c<a;++c){f.push(d[c].m00,d[c].m10,d[c].m20,d[c].m01,d[c].m11,d[c].m21,d[c].m02,d[c].m12,d[c].m22)}this.rc.uniformMatrix3fv(this.aAddrU[e],false,f)},setUniformMat4:function(c,a){var d=this.tempFloat4x4Array;d[0]=a.m00;d[1]=a.m10;d[2]=a.m20;d[3]=a.m30;d[4]=a.m01;d[5]=a.m11;d[6]=a.m21;d[7]=a.m31;d[8]=a.m02;d[9]=a.m12;d[10]=a.m22;d[11]=a.m32;d[12]=a.m03;d[13]=a.m13;d[14]=a.m23;d[15]=a.m33;this.rc.uniformMatrix4fv(this.aAddrU[c],false,d)},setUniformMat4Array:function(f,e){var h=this.tempArray;h.length=0;var c=e.length;for(var d=0;d<c;++d){var a=e[d];h.push(a.m00,a.m10,a.m20,a.m30,a.m01,a.m11,a.m21,a.m31,a.m02,a.m12,a.m22,a.m32,a.m03,a.m13,a.m23,a.m33)}this.rc.uniformMatrix4fv(this.aAddrU[f],false,h)},setUniformMat43:function(d,c,a){if(!a){var e=this.tempFloat4x3Array;e[0]=c.m00;e[1]=c.m01;e[2]=c.m02;e[3]=c.m03;e[4]=c.m10;e[5]=c.m11;e[6]=c.m12;e[7]=c.m13;e[8]=c.m20;e[9]=c.m21;e[10]=c.m22;e[11]=c.m23;this.rc.uniform4fv(this.aAddrU[d],e)}else{var e=this.tempFloat4x4Array;e[0]=c.m00;e[1]=c.m10;e[2]=c.m20;e[3]=0;e[4]=c.m01;e[5]=c.m11;e[6]=c.m21;e[7]=0;e[8]=c.m02;e[9]=c.m12;e[10]=c.m22;e[11]=0;e[12]=c.m03;e[13]=c.m13;e[14]=c.m23;e[15]=1;this.rc.uniformMatrix4fv(this.aAddrU[d],false,e)}},setUniformMat43Array:function(f,e,c){var h=this.tempArray;h.length=0;if(!c){var a=e.length;for(var d=0;d<a;++d){h.push(e[d].m00,e[d].m01,e[d].m02,e[d].m03,e[d].m10,e[d].m11,e[d].m12,e[d].m13,e[d].m20,e[d].m21,e[d].m22,e[d].m23)}this.rc.uniform4fv(this.aAddrU[f],h)}else{var a=e.length;for(var d=0;d<a;++d){h.push(e[d].m00,e[d].m10,e[d].m20,0,e[d].m01,e[d].m11,e[d].m21,0,e[d].m02,e[d].m12,e[d].m22,0,e[d].m03,e[d].m13,e[d].m23,1)}this.rc.uniformMatrix4fv(this.aAddrU[f],false,h)}},setSampler:function(a,c){this.rc.uniform1i(this.aAddrU[a],c)},setSamplerArray:function(a,c){this.rc.uniform1iv(this.aAddrU[a],c)},setTexture:function(h,c,f,a,d){if(c){var l=this.aAddrU[h];var k=this.aTexBind[h];this.rc.uniform1i(this.aAddrU[h],k);c.bind(k);var e=c.getType();f=f?f:10497;this.rc.texParameteri(e,10242,f);this.rc.texParameteri(e,10243,f);if(c.isMipMap()){if(a==9728||a==9729){a+=9984-9728}else{if(a==null){a=9985}}}else{a=a?a:9729}this.rc.texParameteri(e,10241,a);d=d?d:9729;this.rc.texParameteri(e,10240,d)}},setTextureArray:function(t,n,a,e,k){var f=this.aAddrU[t];var q=this.aTexBind[t];var m=okAllocator.array();var q=this.aTexBind[t];var c=n.length;for(var h=0;h<c;++h){var p=n[h];var d=(a?(okIsNumber(a)?a:a[h]):null);var l=(e?(okIsNumber(e)?e:e[h]):null);var o=(k?(okIsNumber(k)?k:k[h]):null);p.bind(q);var s=p.getType();d=d?d:10497;this.rc.texParameteri(s,10242,d);this.rc.texParameteri(s,10243,d);if(p.isMipMap()){if(l==9728||l==9729){l+=9984-9728}else{if(l==null){l=9985}}}else{l=l?l:9729}this.rc.texParameteri(s,10241,l);o=o?o:9729;this.rc.texParameteri(s,10240,o);m.push(q++)}this.rc.uniform1iv(this.aAddrU[t],m);okAllocator._array(m)},setAttribute:function(f,e,d,c,a){var h=this.aAddrA[f];if(h!=null){e.bindAttrib(h,d,(c!=null)?c:0,(a!=null)?a:0)}},bind:function(){this.rc.useProgram(this.glProgramObj)}};function okTexture(a){this.rc=a;this.glTextureObj=null;this.iType=0;this.iSizeU=0;this.iSizeV=0;this.iFormat=0;this.bMipMap=false;this.video=null}okTexture.prototype={isValid:function(){return(this.glTextureObj!=null)},getType:function(){return this.iType},createTexture:function(n,h,f,o,c,m,e,l,d,k,a){this.releaseTexture();this.glTextureObj=this.rc.createTexture();this.iType=n;this.iSizeU=h;this.iSizeV=f;this.iFormat=o;this.bMipMap=false;if(n==3553){this.rc.bindTexture(3553,this.glTextureObj);if(m==null){this.rc.texImage2D(3553,0,o,h,f,0,o,c?c:5121,null)}else{if(m.width!=null&&m.height!=null){this.rc.texImage2D(3553,0,o,o,c?c:5121,m)}else{if(okIsArray(m)){switch(c){case 5126:m=new Float32Array(m);break;default:m=new Uint8Array(m)}}this.rc.texImage2D(3553,0,o,h,f,0,o,c?c:5121,m)}}}else{if(n==34067){this.rc.bindTexture(34067,this.glTextureObj);switch(c){case 5126:m=okIsArray(m)?new Float32Array(m):m;e=okIsArray(e)?new Float32Array(e):e;l=okIsArray(l)?new Float32Array(l):l;d=okIsArray(d)?new Float32Array(d):d;k=okIsArray(k)?new Float32Array(k):k;a=okIsArray(a)?new Float32Array(a):a;break;default:m=okIsArray(m)?new Uint8Array(m):m;e=okIsArray(e)?new Uint8Array(e):e;l=okIsArray(l)?new Uint8Array(l):l;d=okIsArray(d)?new Uint8Array(d):d;k=okIsArray(k)?new Uint8Array(k):k;a=okIsArray(a)?new Uint8Array(a):a}if(m.width!=null&&m.height!=null){this.rc.texImage2D(34069,0,o,o,c?c:5121,m)}else{this.rc.texImage2D(34069,0,o,h,f,0,o,c?c:5121,m)}if(e.width!=null&&e.height!=null){this.rc.texImage2D(34070,0,o,o,c?c:5121,e)}else{this.rc.texImage2D(34070,0,o,h,f,0,o,c?c:5121,e)}if(l.width!=null&&l.height!=null){this.rc.texImage2D(34071,0,o,o,c?c:5121,l)}else{this.rc.texImage2D(34071,0,o,h,f,0,o,c?c:5121,l)}if(d.width!=null&&d.height!=null){this.rc.texImage2D(34072,0,o,o,c?c:5121,d)}else{this.rc.texImage2D(34072,0,o,h,f,0,o,c?c:5121,d)}if(k.width!=null&&k.height!=null){this.rc.texImage2D(34073,0,o,o,c?c:5121,k)}else{this.rc.texImage2D(34073,0,o,h,f,0,o,c?c:5121,k)}if(a.width!=null&&a.height!=null){this.rc.texImage2D(34074,0,o,o,c?c:5121,a)}else{this.rc.texImage2D(34074,0,o,h,f,0,o,c?c:5121,a)}}}},releaseTexture:function(){if(this.glTextureObj!=null){this.rc.deleteTexture(this.glTextureObj);this.glTextureObj=null}this.iType=0;this.iSizeU=0;this.iSizeV=0;this.iFormat=0;this.bMipMap=false},updateTexture:function(l,k,h,f,c,o,e,n,d,m,a){if(this.iType==3553){this.rc.bindTexture(3553,this.glTextureObj);if(o.width!=null&&o.height!=null){this.rc.texSubImage2D(3553,0,l,k,this.iFormat,c?c:5121,o)}else{if(okIsArray(o)){switch(c){case 5126:o=new Float32Array(o);break;default:o=new Uint8Array(o)}}this.rc.texSubImage2D(3553,0,l,k,h,f,this.iFormat,c?c:5121,o)}}else{if(this.iType==34067){this.rc.bindTexture(34067,this.glTextureObj);switch(c){case 5126:o=okIsArray(o)?new Float32Array(o):o;e=okIsArray(e)?new Float32Array(e):e;n=okIsArray(n)?new Float32Array(n):n;d=okIsArray(d)?new Float32Array(d):d;m=okIsArray(m)?new Float32Array(m):m;a=okIsArray(a)?new Float32Array(a):a;break;default:o=okIsArray(o)?new Uint8Array(o):o;e=okIsArray(e)?new Uint8Array(e):e;n=okIsArray(n)?new Uint8Array(n):n;d=okIsArray(d)?new Uint8Array(d):d;m=okIsArray(m)?new Uint8Array(m):m;a=okIsArray(a)?new Uint8Array(a):a}if(o){if(o.width!=null&&o.height!=null){this.rc.texSubImage2D(34069,0,l,k,this.iFormat,c?c:5121,o)}else{this.rc.texSubImage2D(34069,0,l,k,h,f,this.iFormat,c?c:5121,o)}}if(e){if(e.width!=null&&e.height!=null){this.rc.texSubImage2D(34070,0,l,k,this.iFormat,c?c:5121,e)}else{this.rc.texSubImage2D(34070,0,l,k,h,f,this.iFormat,c?c:5121,e)}}if(n){if(n.width!=null&&n.height!=null){this.rc.texSubImage2D(34071,0,l,k,this.iFormat,c?c:5121,n)}else{this.rc.texSubImage2D(34071,0,l,k,h,f,this.iFormat,c?c:5121,n)}}if(d){if(d.width!=null&&d.height!=null){this.rc.texSubImage2D(34072,0,l,k,this.iFormat,c?c:5121,d)}else{this.rc.texSubImage2D(34072,0,l,k,h,f,this.iFormat,c?c:5121,d)}}if(m){if(m.width!=null&&m.height!=null){this.rc.texSubImage2D(34073,0,l,k,this.iFormat,c?c:5121,m)}else{this.rc.texSubImage2D(34073,0,l,k,h,f,this.iFormat,c?c:5121,m)}}if(a){if(a.width!=null&&a.height!=null){this.rc.texSubImage2D(34074,0,l,k,this.iFormat,c?c:5121,a)}else{this.rc.texSubImage2D(34074,0,l,k,h,f,this.iFormat,c?c:5121,a)}}}}},getSizeU:function(a){var c=(this.iSizeU>>((a!=null)?a:0));return(c>0)?c:1},getSizeV:function(a){var c=(this.iSizeV>>((a!=null)?a:0));return(c>0)?c:1},bind:function(a){this.rc.activeTexture(33984+((a!=null)?a:0));this.rc.bindTexture(this.iType,this.glTextureObj)},updateVideoTexture:function(){if(!this.video){return}if(this.video.readyState===this.video.HAVE_ENOUGH_DATA){this.updateTexture(0,0,0,0,5121,this.video);this.rc.texParameteri(3553,10242,33071);this.rc.texParameteri(3553,10243,33071);this.rc.texParameteri(3553,10240,9729);this.rc.texParameteri(3553,10241,9729)}},isVideoTexture:function(){if(!this.video){return false}return true},genMipMap:function(){this.rc.generateMipmap(this.iType);this.bMipMap=true},isMipMap:function(){return this.bMipMap}};function okCamera(a){this.rc=a;this.sName="";this.scene=null;this.mCamMat=new okMat43(1);this.mViewMat=new okMat43(1);this.bViewMatDirty=true;this.iProjMode=1;this.mProjMat=new okMat4(1);this.bProjDirty=true;this.mViewProjMat=new okMat4(1);this.mViewProjInvMat=new okMat4(1);this.bViewProjDirty=true;this.frustum=new okFrustum();this.bFrustumDirty=true;this.iViewportX=0;this.iViewportY=0;this.iViewportWidth=0;this.iViewportHeight=0;this.vBackColor=new okVec3(0,0,0);this.sBackTex="";this.iBackTexId=-1;this.fFov=45;this.fZNear=1;this.fZFar=10000}okCamera.prototype={clear:function(){this.sName="";this.mCamMat.identity();this.mViewMat.identity();this.bViewMatDirty=true;this.iProjMode=1;this.mProjMat.identity();this.bProjDirty=true;this.mViewProjMat.identity();this.mViewProjInvMat.identity();this.bViewProjDirty=true;this.frustum=new okFrustum();this.bFrustumDirty=true;this.iViewportX=0;this.iViewportY=0;this.iViewportWidth=0;this.iViewportHeight=0;this.vBackColor.set(0,0,0);this.sBackTex="";if(this.iBackTexId!=-1){var a=this.scene.resourceManager;a.deleteResource(this.iBackTexId);this.iBackTexId=-1}this.fFov=45;this.fZNear=1;this.fZFar=10000},reset:function(c,a){if(c!=false){this.mCamMat.setColumn(3,0,0,0)}if(a!=false){this.mCamMat.setColumn(0,1,0,0);this.mCamMat.setColumn(1,0,1,0);this.mCamMat.setColumn(2,0,0,1)}this.bViewMatDirty=true;this.bViewProjDirty=true;this.bFrustumDirty=true},setName:function(a){this.sName=a},getName:function(){return this.sName},setMat:function(a){a.clone(this.mCamMat);this.bViewMatDirty=true;this.bViewProjDirty=true;this.bFrustumDirty=true},setPos:function(d,c,a){if(d!=null&&a!=null){this.mCamMat.m03=d;this.mCamMat.m13=c;this.mCamMat.m23=a}else{this.mCamMat.m03=d.x;this.mCamMat.m13=d.y;this.mCamMat.m23=d.z}this.bViewMatDirty=true;this.bViewProjDirty=true;this.bFrustumDirty=true},getPos:function(){return this.mCamMat.getColumn(3)},move:function(e,d,c,a){if(e==3){if(d!=null&&a!=null){this.mCamMat.m03+=d;this.mCamMat.m13+=c;this.mCamMat.m23+=a}else{this.mCamMat.m03+=d.x;this.mCamMat.m13+=d.y;this.mCamMat.m23+=d.z}}else{if(d!=null&&a!=null){this.mCamMat.m03+=(d*this.mCamMat.m00+c*this.mCamMat.m01+a*this.mCamMat.m02);this.mCamMat.m13+=(d*this.mCamMat.m10+c*this.mCamMat.m11+a*this.mCamMat.m12);this.mCamMat.m23+=(d*this.mCamMat.m20+c*this.mCamMat.m21+a*this.mCamMat.m22)}else{this.mCamMat.m03+=(d.x*this.mCamMat.m00+d.y*this.mCamMat.m01+d.z*this.mCamMat.m02);this.mCamMat.m13+=(d.x*this.mCamMat.m10+d.y*this.mCamMat.m11+d.z*this.mCamMat.m12);this.mCamMat.m23+=(d.x*this.mCamMat.m20+d.y*this.mCamMat.m21+d.z*this.mCamMat.m22)}}this.bViewMatDirty=true;this.bViewProjDirty=true;this.bFrustumDirty=true},moveRight:function(a){this.mCamMat.m03+=a*this.mCamMat.m00;this.mCamMat.m13+=a*this.mCamMat.m10;this.mCamMat.m23+=a*this.mCamMat.m20;this.bViewMatDirty=true;this.bViewProjDirty=true;this.bFrustumDirty=true},moveUp:function(a){this.mCamMat.m03+=a*this.mCamMat.m01;this.mCamMat.m13+=a*this.mCamMat.m11;this.mCamMat.m23+=a*this.mCamMat.m21;this.bViewMatDirty=true;this.bViewProjDirty=true;this.bFrustumDirty=true},moveForward:function(a){this.mCamMat.m03-=a*this.mCamMat.m02;this.mCamMat.m13-=a*this.mCamMat.m12;this.mCamMat.m23-=a*this.mCamMat.m22;this.bViewMatDirty=true;this.bViewProjDirty=true;this.bFrustumDirty=true},rotX:function(k,h){var a=okMat43RotX(h);if(k==3){var e=this.mCamMat.m03;var d=this.mCamMat.m13;var c=this.mCamMat.m23;var f=okMat43Mul(a,this.mCamMat);okAllocator._mat43(this.mCamMat);this.mCamMat=f;this.mCamMat.m03=e;this.mCamMat.m13=d;this.mCamMat.m23=c}else{var f=okMat43Mul(this.mCamMat,a);okAllocator._mat43(this.mCamMat);this.mCamMat=f}okAllocator._mat43(a);this.bViewMatDirty=true;this.bViewProjDirty=true;this.bFrustumDirty=true},rotY:function(k,h){var a=okMat43RotY(h);if(k==3){var e=this.mCamMat.m03;var d=this.mCamMat.m13;var c=this.mCamMat.m23;var f=okMat43Mul(a,this.mCamMat);okAllocator._mat43(this.mCamMat);this.mCamMat=f;this.mCamMat.m03=e;this.mCamMat.m13=d;this.mCamMat.m23=c}else{var f=okMat43Mul(this.mCamMat,a);okAllocator._mat43(this.mCamMat);this.mCamMat=f}okAllocator._mat43(a);this.bViewMatDirty=true;this.bViewProjDirty=true;this.bFrustumDirty=true},rotZ:function(k,h){var a=okMat43RotZ(h);if(k==3){var e=this.mCamMat.m03;var d=this.mCamMat.m13;var c=this.mCamMat.m23;var f=okMat43Mul(a,this.mCamMat);okAllocator._mat43(this.mCamMat);this.mCamMat=f;this.mCamMat.m03=e;this.mCamMat.m13=d;this.mCamMat.m23=c}else{var f=okMat43Mul(this.mCamMat,a);okAllocator._mat43(this.mCamMat);this.mCamMat=f}okAllocator._mat43(a);this.bViewMatDirty=true;this.bViewProjDirty=true;this.bFrustumDirty=true},rotRight:function(d){var a=okMat43RotX(d);var c=okMat43Mul(this.mCamMat,a);okAllocator._mat43(this.mCamMat);this.mCamMat=c;this.bViewMatDirty=true;this.bViewProjDirty=true;this.bFrustumDirty=true},rotUp:function(d){var a=okMat43RotY(d);var c=okMat43Mul(this.mCamMat,a);okAllocator._mat43(this.mCamMat);this.mCamMat=c;this.bViewMatDirty=true;this.bViewProjDirty=true;this.bFrustumDirty=true},rotForward:function(d){var a=okMat43RotZ(-d);var c=okMat43Mul(this.mCamMat,a);okAllocator._mat43(this.mCamMat);this.mCamMat=c;this.bViewMatDirty=true;this.bViewProjDirty=true;this.bFrustumDirty=true},rotTarget:function(e,h,f){var c=okAllocator.mat43();this.mCamMat.clone(c);c.m03-=h.x;c.m13-=h.y;c.m23-=h.z;var a=okMat43Rot(e,f);var d=okMat43Mul(a,c);okAllocator._mat43(c);d.m03+=h.x;d.m13+=h.y;d.m23+=h.z;d.clone(this.mCamMat);okAllocator._mat43(d);this.bViewMatDirty=true;this.bViewProjDirty=true;this.bFrustumDirty=true},getRightDir:function(){var a=okAllocator.vec3();a.x=this.mCamMat.m00;a.y=this.mCamMat.m10;a.z=this.mCamMat.m20;return a},getUpDir:function(){var a=okAllocator.vec3();a.x=this.mCamMat.m01;a.y=this.mCamMat.m11;a.z=this.mCamMat.m21;return a},getForwardDir:function(){var a=okAllocator.vec3();a.x=-this.mCamMat.m02;a.y=-this.mCamMat.m12;a.z=-this.mCamMat.m22;return a},lookAt:function(n,l,h,k,f,e){var m=okAllocator.vec3();var c=okAllocator.vec3();if(typeof n=="number"){m.x=n;m.y=l;m.z=h;if(f){c.x=k;c.y=f;c.z=e}else{if(k){c.x=k.x;c.y=k.y;c.z=k.z}else{c.x=this.mCamMat.m01;c.y=this.mCamMat.m11;c.z=this.mCamMat.m21}}}else{m.x=n.x;m.y=n.y;m.z=n.z;if(h){c.x=l;c.y=h;c.z=k}else{if(l){c.x=l.x;c.y=l.y;c.z=l.z}else{c.x=this.mCamMat.m01;c.y=this.mCamMat.m11;c.z=this.mCamMat.m21}}}var a=okAllocator.vec3();a.x=this.mCamMat.m03-m.x;a.y=this.mCamMat.m13-m.y;a.z=this.mCamMat.m23-m.z;a.normalize(true);var d=okVec3Cross(c,a);if(d.equal(OAK.VEC3_ZERO)){d.x=this.mCamMat.m00;d.y=this.mCamMat.m10;d.z=this.mCamMat.m20;d.normalize(true);c=okVec3Cross(a,d);okAllocator._vec3(d);d=okVec3Cross(c,a)}else{okAllocator._vec3(c);c=okVec3Cross(a,d)}d.normalize(true);c.normalize(true);this.mCamMat.m00=d.x;this.mCamMat.m10=d.y;this.mCamMat.m20=d.z;this.mCamMat.m01=c.x;this.mCamMat.m11=c.y;this.mCamMat.m21=c.z;this.mCamMat.m02=a.x;this.mCamMat.m12=a.y;this.mCamMat.m22=a.z;this.bViewMatDirty=true;this.bViewProjDirty=true;this.bFrustumDirty=true},getViewMat4:function(){if(this.bViewMatDirty){okAllocator._mat43(this.mViewMat);this.mViewMat=this.mCamMat.inverse();this.bViewMatDirty=false}var a=okAllocator.mat4();this.mViewMat.toMat4(a);return a},getViewMat43:function(){if(this.bViewMatDirty){okAllocator._mat43(this.mViewMat);this.mViewMat=this.mCamMat.inverse();this.bViewMatDirty=false}var a=okAllocator.mat43();this.mViewMat.clone(a);return a},getMat4:function(){var a=okAllocator.mat4();this.mCamMat.toMat4(a);return a},getMat43:function(){var a=okAllocator.mat43();this.mCamMat.clone(a);return a},getViewInvMat4:function(){var a=okAllocator.mat4();this.mCamMat.toMat4(a);return a},getViewInvMat43:function(){var a=okAllocator.mat43();this.mCamMat.clone(a);return a},setViewport:function(d,c,a,e){this.iViewportX=d;this.iViewportY=c;this.iViewportWidth=a;this.iViewportHeight=e;this.bProjDirty=true;this.bViewProjDirty=true;this.bFrustumDirty=true},getViewportLeft:function(){return this.iViewportX},getViewportTop:function(){return this.iViewportY},getViewportWidth:function(){return this.iViewportWidth},getViewportHeight:function(){return this.iViewportHeight},bindViewport:function(){var a=this.rc.canvas.clientHeight;this.rc.viewport(this.iViewportX,a-(this.iViewportY+this.iViewportHeight),this.iViewportWidth,this.iViewportHeight);this.rc.scissor(this.iViewportX,a-(this.iViewportY+this.iViewportHeight),this.iViewportWidth,this.iViewportHeight)},setBackColor:function(c,a,d,e){if(a==null){this.vBackColor.x=c.x;this.vBackColor.y=c.y;this.vBackColor.z=c.z;this.vBackColor.w=(c.w?c.w:1)}else{this.vBackColor.x=c;this.vBackColor.y=a;this.vBackColor.z=d;this.vBackColor.w=((e!=null)?e:1)}},getBackColor:function(){return this.vBackColor},setBackTexture:function(a){var e=this.scene.resourceManager;if(a!=""){var d=this.scene._packTextureUrl(a);this.iBackTexId=e.createResource(2,d);var c=e.getResourceState(this.iBackTexId);if(c==2){e.loadTextureByUrl(this.iBackTexId,d,6408)}}else{if(this.iBackTexId!=-1){e.deleteResource(this.iBackTexId)}this.iBackTexId=-1}this.sBackTex=a},getBackTextureResourceId:function(){return this.iBackTexId},setFov:function(a){this.fFov=a;this.bProjDirty=true;this.bViewProjDirty=true},getFov:function(){return this.fFov},setVisibleRange:function(a,c){this.fZNear=Math.max(0.01,a);this.fZFar=c;this.bProjDirty=true;this.bViewProjDirty=true},setVisibleNear:function(a){this.fZNear=a},setVisibleFar:function(a){this.fZFar=a},getVisibleNear:function(){return this.fZNear},getVisibleFar:function(){return this.fZFar},setProjMode:function(a){this.iProjMode=a;this.bProjDirty=true;this.bViewProjDirty=true},getProjMode:function(){return this.iProjMode},getProjMat4:function(){if(this.bProjDirty){if(this.iProjMode==1){okAllocator._mat4(this.mProjMat);this.mProjMat=okMat4Proj(this.fFov,this.iViewportWidth/this.iViewportHeight,this.fZNear,this.fZFar);this.bProjDirty=false}else{okAllocator._mat4(this.mProjMat);this.mProjMat=okMat4Ortho(-this.iViewportWidth/this.iViewportHeight,this.iViewportWidth/this.iViewportHeight,1,-1,this.fZNear,this.fZFar);this.bProjDirty=false}}return this.mProjMat},getViewProjMat4:function(){if(this.bViewProjDirty){okAllocator._mat4(this.mViewProjMat);okAllocator._mat4(this.mViewProjInvMat);this.mViewProjMat=okMat4Mul(this.getProjMat4(),this.getViewMat4());this.mViewProjInvMat=this.mViewProjMat.inverse();this.bViewProjDirty=false}return this.mViewProjMat},getViewProjInvMat4:function(){if(this.bViewProjDirty){okAllocator._mat4(this.mViewProjMat);okAllocator._mat4(this.mViewProjInvMat);this.mViewProjMat=okMat4Mul(this.getProjMat4(),this.getViewMat4());this.mViewProjInvMat=this.mViewProjMat.inverse();this.bViewProjDirty=false}return this.mViewProjInvMat},getFrustum:function(){if(this.bFrustumDirty){this.frustum.setByViewProjMat(this.getViewProjMat4());this.bFrustumDirty=false}return this.frustum},getPickPoint:function(c,h){var a=c-this.iViewportX;var f=this.iViewportHeight-(h-this.iViewportY);var d=okAllocator.vec3();d.x=a/this.iViewportWidth*2-1;d.y=f/this.iViewportHeight*2-1;d.z=-0.99;var e=okMat4MulVec3(this.getViewProjInvMat4(),d);okAllocator._vec3(d);return e},getPickDir:function(c,k){var a=c-this.iViewportX;var h=this.iViewportHeight-(k-this.iViewportY);var d=okAllocator.vec3();d.x=a/this.iViewportWidth*2-1;d.y=h/this.iViewportHeight*2-1;d.z=0;var f=okMat4MulVec3(this.getViewProjInvMat4(),d);var e=okAllocator.vec3();e.x=f.x-this.mCamMat.m03;e.y=f.y-this.mCamMat.m13;e.z=f.z-this.mCamMat.m23;okAllocator._vec3(d);okAllocator._vec3(f);return e},getPickFrustum:function(v,u,s,p){var o=v+((s>0)?0:s);var n=u+((p>0)?0:p);s=(s>0)?s:-s;p=(p>0)?p:-p;var q=okAllocator.vec3();q.x=this.mCamMat.m03;q.y=this.mCamMat.m13;q.z=this.mCamMat.m23;var f=this.getPickPoint(o,n);var d=this.getPickPoint(o+s,n);var c=this.getPickPoint(o+s,n+p);var a=this.getPickPoint(o,n+p);var m=okAllocator.vec3();var l=okAllocator.vec3();var h=okAllocator.vec3();var e=okAllocator.vec3();m.x=f.x-q.x;m.y=f.y-q.y;m.z=f.z-q.z;l.x=d.x-q.x;l.y=d.y-q.y;l.z=d.z-q.z;h.x=c.x-q.x;h.y=c.y-q.y;h.z=c.z-q.z;e.x=a.x-q.x;e.y=a.y-q.y;e.z=a.z-q.z;var k=new okFrustum();k.setByViewProjMat(this.getViewProjMat4());var t=okAllocator.plane();var w=okVec3Cross(m,l);t.set(q,w);okAllocator._vec3(w);k.setPlane(4,t);var w=okVec3Cross(h,e);t.set(q,w);okAllocator._vec3(w);k.setPlane(5,t);var w=okVec3Cross(e,m);t.set(q,w);okAllocator._vec3(w);k.setPlane(2,t);var w=okVec3Cross(l,h);t.set(q,w);okAllocator._vec3(w);k.setPlane(3,t);okAllocator._vec3(q);okAllocator._vec3(f);okAllocator._vec3(d);okAllocator._vec3(c);okAllocator._vec3(a);okAllocator._vec3(m);okAllocator._vec3(l);okAllocator._vec3(h);okAllocator._vec3(e);return k}};function okMaterial(){this.sDesc="";this.vEmissive=new okVec3(0,0,0);this.vAmbient=new okVec3(0,0,0);this.vDiffuse=new okVec3(1,1,1);this.vSpecular=new okVec3(0,0,0);this.fSpecularLevel=0;this.fGlossiness=8;this.fAlpha=1;this.bBlend=false;this.iBlendEquation=32774;this.iBlendEquationAlpha=32774;this.iBlendSrc=770;this.iBlendDest=771;this.iBlendSrcAlpha=1;this.iBlendDestAlpha=1;this.bAlphaTest=false;this.fAlphaTestValue=0;this.bDynamicLighting=true;this.bWireframe=false;this.fLineWidth=1;this.bVertexColor=false;this.bDepthTest=true;this.bDepthWrite=true;this.bTwoSide=false;this.vGlowColor=new okVec3(1,1,1);this.bGlow=false;this.bFog=true;this.aTextureList=["","","","","","",""];this.aTextureTypeList=[3553,3553,3553,3553,3553,3553,3553];this.aTextureFilterList=[9729,9729,9729,9729,9729,9729,9729];this.aTextureWrapUList=[33071,33071,33071,33071,33071,33071,33071];this.aTextureWrapVList=[33071,33071,33071,33071,33071,33071,33071];this.aUvAttribList=["Texcoord1","Texcoord1","Texcoord1","Texcoord1","Texcoord1","Texcoord1","Texcoord1"];this.aTangentAttribList=["","","","","","",""];this.aBinormalAttribList=["","","","","","",""];this.bEmissiveScript=true;this.bDiffuseScript=true;this.bDiffusePowerScript=true;this.bSpecularScript=true;this.bSpecularPowerScript=true;this.bNormalScript=true;this.bAlphaScript=true;this.bGlowScript=true;this.bDctLightScript=true;this.bPointLightScript=true;this.bSpotLightScript=true;this.sEmissiveScript="";this.sDiffuseScript="";this.sDiffusePowerScript="";this.sSpecularScript="";this.sSpecularPowerScript="";this.sNormalScript="";this.sAlphaScript="";this.sGlowScript="";this.sDctLightScript="";this.sPointLightScript="";this.sSpotLightScript="";this.sPackedEmissiveScript="";this.sPackedDiffuseScript="";this.sPackedDiffusePowerScript="";this.sPackedSpecularScript="";this.sPackedSpecularPowerScript="";this.sPackedNormalScript="";this.sPackedAlphaScript="";this.sPackedGlowScript="";this.sPackedDctLightScript="";this.sPackedPointLightScript="";this.sPackedSpotLightScript="";this.entity=null;this.aTextureResIdList=[-1,-1,-1,-1,-1,-1,-1];this.sShdKeyV="";this.sShdKeyF="";this.sShdKeyP="";this.aShdDef=okAllocator.object();this.bShdKeyDirty=true;this.bShdDefDirty=true}okMaterial.prototype={clear:function(){this.sDesc="";this.vEmissive.set(0,0,0);this.vAmbient.set(0,0,0);this.vDiffuse.set(1,1,1);this.vSpecular.set(0,0,0);this.fSpecularLevel=0;this.fGlossiness=0;this.fAlpha=1;this.bBlend=false;this.iBlendEquation=32774;this.iBlendEquationAlpha=32774;this.iBlendSrc=770;this.iBlendDest=771;this.iBlendSrcAlpha=1;this.iBlendDestAlpha=1;this.bAlphaTest=false;this.fAlphaTestValue=0;this.bDynamicLighting=true;this.bWireframe=false;this.fLineWidth=1;this.bVertexColor=false;this.bDepthTest=true;this.bDepthWrite=true;this.bTwoSide=false;this.vGlowColor.set(1,1,1);this.bGlow=false;this.bFog=true;for(var a=0;a<7;++a){this.aTextureList[a]="";this.aTextureTypeList[a]=3553;this.aTextureFilterList[a]=9729;this.aTextureWrapUList[a]=33071;this.aTextureWrapVList[a]=33071;this.aUvAttribList[a]="Texcoord1";this.aTangentAttribList[a]="";this.aBinormalAttribList[a]=""}this.bEmissiveScript=true;this.bDiffuseScript=true;this.bDiffusePowerScript=true;this.bSpecularScript=true;this.bSpecularPowerScript=true;this.bNormalScript=true;this.bAlphaScript=true;this.bGlowScript=true;this.bDctLightScript=true;this.bPointLightScript=true;this.bSpotLightScript=true;this.sEmissiveScript="";this.sDiffuseScript="";this.sDiffusePowerScript="";this.sSpecularScript="";this.sSpecularPowerScript="";this.sNormalScript="";this.sAlphaScript="";this.sGlowScript="";this.sDctLightScript="";this.sPointLightScript="";this.sSpotLightScript="";this.sPackedEmissiveScript="";this.sPackedDiffuseScript="";this.sPackedDiffusePowerScript="";this.sPackedSpecularScript="";this.sPackedSpecularPowerScript="";this.sPackedNormalScript="";this.sPackedAlphaScript="";this.sPackedGlowScript="";this.sPackedDctLightScript="";this.sPackedPointLightScript="";this.sPackedSpotLightScript="";for(var a=0;a<7;++a){this.aTextureResIdList[a]=-1}this.sShdKeyV="";this.sShdKeyF="";this.sShdKeyP="";okAllocator._object(this.aShdDef);this.aShdDef=okAllocator.object();this.bShdKeyDirty=true;this.bShdDefDirty=true},clone:function(a){var a=(a?a:new okMaterial());a.sDesc=this.sDesc;a.vEmissive=this.vEmissive.clone();a.vAmbient=this.vAmbient.clone();a.vDiffuse=this.vDiffuse.clone();a.vSpecular=this.vSpecular.clone();a.fSpecularLevel=this.fSpecularLevel;a.fGlossiness=this.fGlossiness;a.fAlpha=this.fAlpha;a.bBlend=this.bBlend;a.iBlendEquation=this.iBlendEquation;a.iBlendEquationAlpha=this.iBlendEquationAlpha;a.iBlendSrc=this.iBlendSrc;a.iBlendDest=this.iBlendDest;a.iBlendSrcAlpha=this.iBlendSrcAlpha;a.iBlendDestAlpha=this.iBlendDestAlpha;a.bAlphaTest=this.bAlphaTest;a.fAlphaTestValue=this.fAlphaTestValue;a.bDynamicLighting=this.bDynamicLighting;a.bWireframe=this.bWireframe;a.fLineWidth=this.fLineWidth;a.bVertexColor=this.bVertexColor;a.bDepthTest=this.bDepthTest;a.bDepthWrite=this.bDepthWrite;a.bTwoSide=this.bTwoSide;this.vGlowColor.clone(a.vGlowColor);a.bGlow=this.bGlow;a.bFog=this.bFog;for(var c=0;c<7;++c){a.setTextureName(c,this.aTextureList[c]);a.setTextureType(c,this.aTextureTypeList[c]);a.setTextureFilter(c,this.aTextureFilterList[c]);a.setTextureWrapU(c,this.aTextureWrapUList[c]);a.setTextureWrapV(c,this.aTextureWrapVList[c]);a.setTextureCoord(c,this.aUvAttribList[c]);a.setTextureTangent(c,this.aTangentAttribList[c]);a.setTextureBinormal(c,this.aBinormalAttribList[c])}a.bEmissiveScript=this.bEmissiveScript;a.bDiffuseScript=this.bDiffuseScript;a.bDiffusePowerScript=this.bDiffusePowerScript;a.bSpecularScript=this.bSpecularScript;a.bGlossinessScript=this.bGlossinessScript;a.bAlphaScript=this.bAlphaScript;a.bNormalScript=this.bNormalScript;a.bGlowScript=this.bGlowScript;a.bDctLightScript=this.bDctLightScript;a.bPointLightScript=this.bPointLightScript;a.bSpotLightScript=this.bSpotLightScript;a.sEmissiveScript=this.sEmissiveScript;a.sDiffuseScript=this.sDiffuseScript;a.sDiffusePowerScript=this.sDiffusePowerScript;a.sSpecularScript=this.sSpecularScript;a.sSpecularPowerScript=this.sSpecularPowerScript;a.sAlphaScript=this.sAlphaScript;a.sNormalScript=this.sNormalScript;a.sGlowScript=this.sGlowScript;a.sDctLightScript=this.sDctLightScript;a.sPointLightScript=this.sPointLightScript;a.sSpotLightScript=this.sSpotLightScript;a.sPackedEmissiveScript=this.sPackedEmissiveScript;a.sPackedDiffuseScript=this.sPackedDiffuseScript;a.sPackedDiffusePowerScript=this.sPackedDiffusePowerScript;a.sPackedSpecularScript=this.sPackedSpecularScript;a.sPackedSpecularPowerScript=this.sPackedSpecularPowerScript;a.sPackedAlphaScript=this.sPackedAlphaScript;a.sPackedNormalScript=this.sPackedNormalScript;a.sPackedGlowScript=this.sPackedGlowScript;a.sPackedDctLightScript=this.sPackedDctLightScript;a.sPackedPointLightScript=this.sPackedPointLightScript;a.sPackedSpotLightScript=this.sPackedSpotLightScript;a.bShdKeyDirty=true;a.bShdDefDirty=true;return a},setDesc:function(a){this.sDesc=a},getDesc:function(){return this.sDesc},setEmissive:function(c,a,d){if(a!=null&&d!=null){this.vEmissive.set(c,a,d)}else{this.vEmissive=c.clone()}},getEmissive:function(){return this.vEmissive.clone()},setAmbient:function(c,a,d){if(a!=null&&d!=null){this.vAmbient.set(c,a,d)}else{this.vAmbient=c.clone()}},getAmbient:function(){return this.vAmbient.clone()},setDiffuse:function(c,a,d){if(a!=null&&d!=null){this.vDiffuse.set(c,a,d)}else{this.vDiffuse=c.clone()}},getDiffuse:function(){return this.vDiffuse.clone()},setSpecular:function(c,a,d){if(a!=null&&d!=null){this.vSpecular.set(c,a,d)}else{this.vSpecular=c.clone()}},getSpecular:function(){return this.vSpecular.clone()},setSpecularLevel:function(a){this.fSpecularLevel=a},getSpecularLevel:function(){return this.fSpecularLevel},setGlossiness:function(a){this.fGlossiness=a},getGlossiness:function(){return this.fGlossiness},setAlpha:function(a){this.fAlpha=a},getAlpha:function(){return this.fAlpha},enableBlend:function(a){this.bBlend=a},isBlend:function(){return this.bBlend},isBlendEnabled:function(){return this.bBlend},setBlendEquation:function(a,c){if(a==3||a==1){this.iBlendEquation=c}if(a==3||a==2){this.iBlendEquationAlpha=c}},getBlendEquation:function(a){if(a==1||a==3){return this.iBlendEquation}else{if(a==2){return this.iBlendEquationAlpha}}},setBlendFunc:function(a,d,c){if(a==3||a==1){this.iBlendSrc=d;this.iBlendDest=c}if(a==3||a==2){this.iBlendSrcAlpha=d;this.iBlendDestAlpha=c}},getBlendFuncSrc:function(a){if(a==1||a==3){return this.iBlendSrc}else{if(a==2){return this.iBlendSrcAlpha}}},getBlendFuncDest:function(a){if(a==1||a==3){return this.iBlendDest}else{if(a==2){return this.iBlendDestAlpha}}},enableFog:function(a){this.bFog=a;this.bShdKeyDirty=true;this.bShdDefDirty=true},isFogEnabled:function(){return this.bFog},enableAlphaTest:function(a){this.bAlphaTest=a;this.bShdKeyDirty=true;this.bShdDefDirty=true},isAlphaTest:function(){return this.bAlphaTest},isAlphaTestEnabled:function(){return this.bAlphaTest},setAlphaTestValue:function(a){this.fAlphaTestValue=a},getAlphaTestValue:function(a){return this.fAlphaTestValue},enableDynamicLighting:function(a){this.bDynamicLighting=a;this.bShdKeyDirty=true;this.bShdDefDirty=true},isDynamicLighting:function(){return this.bDynamicLighting},isDynamicLightingEnabled:function(){return this.bDynamicLighting},enableWireframe:function(a){this.bWireframe=a;this.bShdKeyDirty=true;this.bShdDefDirty=true},isWireframe:function(){return this.bWireframe},isWireframeEnabled:function(){return this.bWireframe},setLineWidth:function(a){this.fLineWidth=a},getLineWidth:function(){return this.fLineWidth},enableVertexColor:function(a){this.bVertexColor=a;this.bShdKeyDirty=true;this.bShdDefDirty=true},isVertexColor:function(){return this.bVertexColor},isVertexColorEnabled:function(){return this.bVertexColor},enableDepthTest:function(a){this.bDepthTest=a},isDepthTest:function(){return this.bDepthTest},isDepthTestEnabled:function(){return this.bDepthTest},enableDepthWrite:function(a){this.bDepthWrite=a},isDepthWrite:function(){return this.bDepthWrite},isDepthWriteEnabled:function(){return this.bDepthWrite},enableTwoSide:function(a){this.bTwoSide=a;this.bShdKeyDirty=true;this.bShdDefDirty=true},isTwoSide:function(){return this.bTwoSide},isTwoSideEnabled:function(){return this.bTwoSide},enableGlow:function(a){this.bGlow=a;this.bShdKeyDirty=true;this.bShdDefDirty=true},isGlow:function(){return this.bGlow},isGlowEnabled:function(){return this.bGlow},setGlowColor:function(c,a,d){if(a!=null&&d!=null){this.vGlowColor.set(c,a,d)}else{c.clone(this.vGlowColor)}},getGlowColor:function(){return this.vGlowColor},setTextureName:function(f,o){o=o.replace(/\\/g,"/");o=o.replace(/^\/+/g,"");this.aTextureList[f]=o;if(o!=""){var m=o.split(" ");if(m.length==6){this.aTextureTypeList[f]=34067}}if(this.entity!=null){var h=this.entity;var a=h.zone.scene.resourceManager;var d=h.zone.scene;if(o!=""){var c=h.zone.scene._packTextureUrl(o);var n=a.createResource(2,c);h.addResourceRef(n);this.aTextureResIdList[f]=n;var k=a.getResourceState(n);if(k==2){if(this.aTextureTypeList[f]==3553){a.loadTextureByUrl(n,c,6408)}else{if(this.aTextureTypeList[f]==34067){var l=o.split(" ");if(l.length==6){a.loadCubeTextureByUrl(n,d._packTextureUrl(l[0]),d._packTextureUrl(l[1]),d._packTextureUrl(l[2]),d._packTextureUrl(l[3]),d._packTextureUrl(l[4]),d._packTextureUrl(l[5]))}else{}}}}}else{this.aTextureResIdList[f]=-1}}this.bShdKeyDirty=true;this.bShdDefDirty=true;this.sPackedEmissiveScript="";this.sPackedDiffuseScript="";this.sPackedDiffusePowerScript="";this.sPackedSpecularScript="";this.sPackedSpecularPowerScript="";this.sPackedNormalScript="";this.sPackedAlphaScript="";this.sPackedGlowScript="";this.sPackedDctLightScript="";this.sPackedPointLightScript="";this.sPackedSpotLightScript=""},getTextureName:function(a){return this.aTextureList[a]},getTextureResourceId:function(a){return this.aTextureResIdList[a]},setTextureType:function(c,a){this.aTextureTypeList[c]=a;if(this.aTextureList[c]!=""){this.setTextureName(c,this.aTextureList[c])}this.sPackedEmissiveScript="";this.sPackedDiffuseScript="";this.sPackedDiffusePowerScript="";this.sPackedSpecularScript="";this.sPackedSpecularPowerScript="";this.sPackedNormalScript="";this.sPackedAlphaScript="";this.sPackedDctLightScript="";this.sPackedPointLightScript="";this.sPackedSpotLightScript="";this.bShdKeyDirty=true;this.bShdDefDirty=true;this.sPackedEmissiveScript="";this.sPackedDiffuseScript="";this.sPackedDiffusePowerScript="";this.sPackedSpecularScript="";this.sPackedSpecularPowerScript="";this.sPackedNormalScript="";this.sPackedAlphaScript="";this.sPackedGlowScript="";this.sPackedDctLightScript="";this.sPackedPointLightScript="";this.sPackedSpotLightScript=""},getTextureType:function(a){return this.aTextureTypeList[a]},setTextureFilter:function(c,a){this.aTextureFilterList[c]=a},getTextureFilter:function(a){return this.aTextureFilterList[a]},setTextureWrap:function(c,a){this.aTextureWrapUList[c]=a;this.aTextureWrapVList[c]=a},setTextureWrapU:function(c,a){this.aTextureWrapUList[c]=a},setTextureWrapV:function(c,a){this.aTextureWrapVList[c]=a},getTextureWrapU:function(a){return this.aTextureWrapUList[a]},getTextureWrapV:function(a){return this.aTextureWrapVList[a]},setTextureCoord:function(c,a){this.aUvAttribList[c]=a;this.bShdKeyDirty=true;this.bShdDefDirty=true},getTextureCoord:function(a){return this.aUvAttribList[a]},setTextureTangent:function(c,a){this.aTangentAttribList[c]=a;this.bShdKeyDirty=true;this.bShdDefDirty=true},getTextureTangent:function(a){return this.aTangentAttribList[a]},setTextureBinormal:function(c,a){this.aBinormalAttribList[c]=a;this.bShdKeyDirty=true;this.bShdDefDirty=true},getTextureBinormal:function(a){return this.aBinormalAttribList[a]},enableEmissiveScript:function(a){this.bEmissiveScript=a;this.bShdKeyDirty=true;this.bShdDefDirty=true},isEmissiveScriptEnabled:function(){return this.bEmissiveScript},enableDiffuseScript:function(a){this.bDiffuseScript=a;this.bShdKeyDirty=true;this.bShdDefDirty=true},isDiffuseScriptEnabled:function(){return this.bDiffuseScript},enableDiffusePowerScript:function(a){this.bDiffusePowerScript=a;this.bShdKeyDirty=true;this.bShdDefDirty=true},isDiffusePowerScriptEnabled:function(){return this.bDiffusePowerScript},enableSpecularScript:function(a){this.bSpecularScript=a;this.bShdKeyDirty=true;this.bShdDefDirty=true},isSpecularScriptEnabled:function(){return this.bSpecularScript},enableSpecularPowerScript:function(a){this.bSpecularPowerScript=a;this.bShdKeyDirty=true;this.bShdDefDirty=true},isSpecularPowerScriptEnabled:function(){return this.bSpecularPowerScript},enableAlphaScript:function(a){this.bAlphaScript=a;this.bShdKeyDirty=true;this.bShdDefDirty=true},isAlphaScriptEnabled:function(){return this.bAlphaScript},enableNormalScript:function(a){this.bNormalScript=a;this.bShdKeyDirty=true;this.bShdDefDirty=true},isNormalScriptEnabled:function(){return this.bNormalScript},enableDctLightScript:function(a){this.bDctLightScript=a;this.bShdKeyDirty=true;this.bShdDefDirty=true},isDctLightScriptEnabled:function(){return this.bDctLightScript},enablePointLightScript:function(a){this.bPointLightScript=a;this.bShdKeyDirty=true;this.bShdDefDirty=true},isPointLightScriptEnabled:function(){return this.bPointLightScript},enableSpotLightScript:function(a){this.bSpotLightScript=a;this.bShdKeyDirty=true;this.bShdDefDirty=true},isSpotLightScriptEnabled:function(){return this.bSpotLightScript},setEmissiveScript:function(a){this.sEmissiveScript=a;this.sPackedEmissiveScript="";this.bShdKeyDirty=true;this.bShdDefDirty=true},getEmissiveScript:function(){return this.sEmissiveScript},getPackedEmissiveScript:function(){if(this.sEmissiveScript!=""&&this.sPackedEmissiveScript==""){this.sPackedEmissiveScript=this._processScript(this.sEmissiveScript,true,"vec3")}return this.sPackedEmissiveScript},setDiffuseScript:function(a){this.sDiffuseScript=a;this.sPackedDiffuseScript="";this.bShdKeyDirty=true;this.bShdDefDirty=true},getDiffuseScript:function(){return this.sDiffuseScript},getPackedDiffuseScript:function(){if(this.sDiffuseScript!=""&&this.sPackedDiffuseScript==""){this.sPackedDiffuseScript=this._processScript(this.sDiffuseScript,true,"vec3")}return this.sPackedDiffuseScript},setDiffusePowerScript:function(a){this.sDiffusePowerScript=a;this.sPackedDiffusePowerScript="";this.bShdKeyDirty=true;this.bShdDefDirty=true},getDiffusePowerScript:function(){return this.sDiffusePowerScript},getPackedDiffusePowerScript:function(){if(this.sDiffusePowerScript!=""&&this.sPackedDiffusePowerScript==""){this.sPackedDiffusePowerScript=this._processScript(this.sDiffusePowerScript,true,"float")}return this.sPackedDiffusePowerScript},setSpecularScript:function(a){this.sSpecularScript=a;this.sPackedSpecularScript="";this.bShdKeyDirty=true;this.bShdDefDirty=true},getSpecularScript:function(){return this.sSpecularScript},getPackedSpecularScript:function(){if(this.sSpecularScript!=""&&this.sPackedSpecularScript==""){this.sPackedSpecularScript=this._processScript(this.sSpecularScript,true,"vec3")}return this.sPackedSpecularScript},setSpecularPowerScript:function(a){this.sSpecularPowerScript=a;this.sPackedSpecularPowerScript="";this.bShdKeyDirty=true;this.bShdDefDirty=true},getSpecularPowerScript:function(){return this.sSpecularPowerScript},getPackedSpecularPowerScript:function(){if(this.sSpecularPowerScript!=""&&this.sPackedSpecularPowerScript==""){this.sPackedSpecularPowerScript=this._processScript(this.sSpecularPowerScript,true,"float")}return this.sPackedSpecularPowerScript},setNormalScript:function(a){this.sNormalScript=a;this.sPackedNormalScript="";this.bShdKeyDirty=true;this.bShdDefDirty=true},getNormalScript:function(){return this.sNormalScript},getPackedNormalScript:function(){if(this.sNormalScript!=""&&this.sPackedNormalScript==""){this.sPackedNormalScript=this._processScript(this.sNormalScript,true,"vec3")}return this.sPackedNormalScript},setAlphaScript:function(a){this.sAlphaScript=a;this.sPackedAlphaScript="";this.bShdKeyDirty=true;this.bShdDefDirty=true},getAlphaScript:function(){return this.sAlphaScript},getPackedAlphaScript:function(){if(this.sAlphaScript!=""&&this.sPackedAlphaScript==""){this.sPackedAlphaScript=this._processScript(this.sAlphaScript,true,"float")}return this.sPackedAlphaScript},setDctLightScript:function(a){this.sDctLightScript=a;this.sPackedDctLightScript="";this.bShdKeyDirty=true;this.bShdDefDirty=true},getDctLightScript:function(){return this.sDctLightScript},getPackedDctLightScript:function(){if(this.sDctLightScript!=""&&this.sPackedDctLightScript==""){this.sPackedDctLightScript=this._processScript(this.sDctLightScript,false)}return this.sPackedDctLightScript},setPointLightScript:function(a){this.sPointLightScript=a;this.sPackedPointLightScript="";this.bShdKeyDirty=true;this.bShdDefDirty=true},getPointLightScript:function(){return this.sPointLightScript},getPackedPointLightScript:function(){if(this.sPointLightScript!=""&&this.sPackedPointLightScript==""){this.sPackedPointLightScript=this._processScript(this.sPointLightScript,false)}return this.sPackedPointLightScript},setSpotLightScript:function(a){this.sSpotLightScript=a;this.sPackedSpotLightScript="";this.bShdKeyDirty=true;this.bShdDefDirty=true},getSpotLightScript:function(){return this.sSpotLightScript},getPackedSpotLightScript:function(){if(this.sSpotLightScript!=""&&this.sPackedSpotLightScript==""){this.sPackedSpotLightScript=this._processScript(this.sSpotLightScript,false)}return this.sPackedSpotLightScript},_setEntity:function(a){this.entity=a},_processScript:function(k,f,n){var u="";var h=k.length;var s=false;for(var o=0;o<h;++o){var v=k.charAt(o);if(v=="\n"){s=false;continue}if(s){continue}if(v==" "){if(u.length>0&&o<(h-1)){var l=u.charCodeAt(u.length-1);var q=k.charCodeAt(o+1);if(((l>=48&&l<=57)||(l>=65&&l<=90)||(l>=97&&l<=122))&&((q>=48&&q<=57)||(q>=65&&q<=90)||(q>=97&&q<=122))){u+=" "}}}else{if(v=="/"){if(o==h-1){u+="/"}else{if(k.charAt(o+1)=="/"){s=true}else{u+="/"}}}else{u+=v}}}if(u==""){return""}if(f){var p=u.match(/\breturn\b/g);if(p==null){u="return "+n+"("+u+");"}}u=u.replace(/(^|[^a-zA-Z0-9_\.])(\d+)(?![0-9]|\.)/g,"$1$2.0");u=u.replace(/\[(\d+)\.(\d*)\]/g,"[$1]");if(this.aTextureList[0]){u=u.replace(/\(ALBEDO1,/g," okFunc_FetchTexture(okUni_Sampler0,")}else{u=u.replace(/\(ALBEDO1,/g," okFunc_FetchDummyTexture(")}if(this.aTextureList[1]){u=u.replace(/\(ALBEDO2,/g," okFunc_FetchTexture(okUni_Sampler1,")}else{u=u.replace(/\(ALBEDO2,/g," okFunc_FetchDummyTexture(")}if(this.aTextureList[2]){u=u.replace(/\(ALBEDO3,/g," okFunc_FetchTexture(okUni_Sampler2,")}else{u=u.replace(/\(ALBEDO3,/g," okFunc_FetchDummyTexture(")}if(this.aTextureList[3]){u=u.replace(/\(ALBEDO4,/g," okFunc_FetchTexture(okUni_Sampler3,")}else{u=u.replace(/\(ALBEDO4,/g," okFunc_FetchDummyTexture(")}if(this.aTextureList[4]){u=u.replace(/\(NORMAL,/g," okFunc_FetchTexture(okUni_Sampler4,")}else{u=u.replace(/\(NORMAL,/g," okFunc_FetchDummyTexture(")}if(this.aTextureList[5]){u=u.replace(/\(OPACITY,/g," okFunc_FetchTexture(okUni_Sampler5,")}else{u=u.replace(/\(OPACITY,/g," okFunc_FetchDummyTexture(")}if(this.aTextureList[6]){u=u.replace(/\(SPECULARLEVEL,/g," okFunc_FetchTexture(okUni_Sampler6,")}else{u=u.replace(/\(SPECULARLEVEL,/g," okFunc_FetchDummyTexture(")}u=u.replace(/texture2D okFunc_FetchTexture\(/g,"texture2D");u=u.replace(/textureCube okFunc_FetchTexture\(/g,"textureCube");var m=okAllocator.array();var e=okAllocator.array();var d=okAllocator.array();var a=-1;var t=-1;var h=u.length;for(var o=0;o<h;++o){switch(u.charAt(o)){case"[":m.push("[");d.push(a);e.push(t);a=0;t=m.length-1;break;case"]":if(t!=-1){if(a>=1){m[t]=" vec"+(a+1)+"(";m.push(")")}else{m.push("]")}if(e.length>0){t=e.pop()}else{return""}a=d.pop()}else{return""}break;case"(":m.push("(");d.push(a);e.push(t);a=0;t=m.length-1;break;case")":if(t!=-1){m.push(")");if(e.length>0){t=e.pop()}else{return""}a=d.pop()}else{return""}break;case",":a+=1;m.push(",");break;default:m.push(u.charAt(o))}}u=m.join("");okAllocator._array(m);okAllocator._array(d);okAllocator._array(e);return u},_genShdKey:function(){var d=this.bEmissiveScript?this.getPackedEmissiveScript():"";var q=this.bDiffuseScript?this.getPackedDiffuseScript():"";var o=this.bDiffusePowerScript?this.getPackedDiffusePowerScript():"";var e=this.bSpecularScript?this.getPackedSpecularScript():"";var c=this.bSpecularPowerScript?this.getPackedSpecularPowerScript():"";var n=this.bAlphaScript?this.getPackedAlphaScript():"";var s=this.bNormalScript?this.getPackedNormalScript():"";var m=this.bDctLightScript?this.getPackedDctLightScript():"";var f=this.bPointLightScript?this.getPackedPointLightScript():"";var p=this.bSpotLightScript?this.getPackedSpotLightScript():"";var l=0;for(var k=0;k<7;++k){if(this.aTextureList[k]!=""){l+=(2<<(k*2));if(this.aTextureTypeList[0]==34067){l+=(2<<(k*2+1))}}}var a=""+((this.aUvAttribList[0]!="")?this.aUvAttribList[0].charAt(8):0)+((this.aUvAttribList[1]!="")?this.aUvAttribList[1].charAt(8):0)+((this.aUvAttribList[2]!="")?this.aUvAttribList[2].charAt(8):0)+((this.aUvAttribList[3]!="")?this.aUvAttribList[3].charAt(8):0)+((this.aUvAttribList[4]!="")?this.aUvAttribList[4].charAt(8):0)+((this.aUvAttribList[5]!="")?this.aUvAttribList[5].charAt(8):0)+((this.aUvAttribList[6]!="")?this.aUvAttribList[6].charAt(8):0);var h=(this.aTextureList[4]!="")?1:0;this.sShdKeyV=h;this.sShdKeyF=""+l+"_"+a+"_"+h+(this.bDynamicLighting?1:0)+(this.bBlend?1:0)+(this.bAlphaTest?1:0)+(this.bVertexColor?1:0)+(this.bTwoSide?1:0)+(this.bFog?1:0)+"_"+d+"_"+q+"_"+o+"_"+e+"_"+c+"_"+n+"_"+s+"_"+m+"_"+f+"_"+p;this.sShdKeyP=this.sShdKeyF},_genShdDef:function(){for(var n in this.aShdDef){delete this.aShdDef[n]}var c=this.bEmissiveScript?this.getPackedEmissiveScript():"";var o=this.bDiffuseScript?this.getPackedDiffuseScript():"";var k=this.bDiffusePowerScript?this.getPackedDiffusePowerScript():"";var d=this.bSpecularScript?this.getPackedSpecularScript():"";var a=this.bSpecularPowerScript?this.getPackedSpecularPowerScript():"";var h=this.bAlphaScript?this.getPackedAlphaScript():"";var p=this.bNormalScript?this.getPackedNormalScript():"";var f=this.bDctLightScript?this.getPackedDctLightScript():"";var e=this.bPointLightScript?this.getPackedPointLightScript():"";var m=this.bSpotLightScript?this.getPackedSpotLightScript():"";var l=this.aShdDef;if(this.bDynamicLighting){l.OK_DYNAMICLIGHTING=1}if(this.bVertexColor){l.OK_AUTO_VERTEX_COLOR=1}if(this.bTwoSidey){l.OK_TWO_SIDE=1}if(this.bBlend){l.OK_BLEND=1}if(this.bAlphaTest){l.OK_ALPHA_TEST=1}if(this.bFog){l.OK_FOG=1}if(this.aTextureList[0]!=""){l.OK_TEX_ALBEDO1=1}if(this.aTextureList[1]!=""){l.OK_TEX_ALBEDO2=1}if(this.aTextureList[2]!=""){l.OK_TEX_ALBEDO3=1}if(this.aTextureList[3]!=""){l.OK_TEX_ALBEDO4=1}if(this.aTextureList[4]!=""){l.OK_TEX_NORMALMAP=1}if(this.aTextureList[5]!=""){l.OK_TEX_OPACITY=1}if(this.aTextureList[6]!=""){l.OK_TEX_SPECULAR_LEVEL=1}if(this.aTangentAttribList[4]!=""){l.OK_TANGENT=1}if(this.aBinormalAttribList[4]!=""){l.OK_BINORMAL=1}if(this.aTextureTypeList[0]==34067){l.OK_TEX_ALBEDO1_CUBE=1}if(this.aTextureTypeList[1]==34067){l.OK_TEX_ALBEDO2_CUBE=1}if(this.aTextureTypeList[2]==34067){l.OK_TEX_ALBEDO3_CUBE=1}if(this.aTextureTypeList[3]==34067){l.OK_TEX_ALBEDO4_CUBE=1}if(c!=""){l.OK_SCRIPT_EMISSIVE_CODE=c}if(o!=""){l.OK_SCRIPT_DIFFUSE_CODE=o}if(k!=""){l.OK_SCRIPT_DIFFUSEPOWER_CODE=k}if(d!=""){l.OK_SCRIPT_SPECULAR_CODE=d}if(a!=""){l.OK_SCRIPT_SPECULARPOWER_CODE=a}if(h!=""){l.OK_SCRIPT_ALPHA_CODE=h}if(p!=""){l.OK_SCRIPT_NORMAL_CODE=p}if(f!=""){l.OK_SCRIPT_DCTLIGHT_CODE=f}if(e!=""){l.OK_SCRIPT_POINTLIGHT_CODE=e}if(m!=""){l.OK_SCRIPT_SPOTLIGHT_CODE=m}},_getShdKeyV:function(){if(this.bShdKeyDirty){this._genShdKey();this.bShdKeyDirty=false}return this.sShdKeyV},_getShdKeyF:function(){if(this.bShdKeyDirty){this._genShdKey();this.bShdKeyDirty=false}return this.sShdKeyF},_getShdKeyP:function(){if(this.bShdKeyDirty){this._genShdKey();this.bShdKeyDirty=false}return this.sShdKeyP},_getShdDef:function(c){if(this.bShdDefDirty){this._genShdDef();this.bShdDefDirty=false}for(var a in this.aShdDef){c[a]=this.aShdDef[a]}}};function okMeshSkin(){this.aBoneNameList=new Array;this.aBoneNameIdxMap=new Object;this.aBoneSkinMatList=new Array;this.bbox=new okAABBox(new okVec3(10000000000,10000000000,10000000000),new okVec3(-10000000000,-10000000000,-10000000000));this.sVertexBoneIdxAttribName="";this.sVertexBoneWeightAttribName=""}okMeshSkin.prototype={clear:function(){this.aBoneNameList=new Array;this.aBoneNameIdxMap=new Object;this.aBoneSkinMatList=new Array;this.bbox.set(new okVec3(10000000000,10000000000,10000000000),new okVec3(-10000000000,-10000000000,-10000000000));this.sVertexBoneIdxAttribName="";this.sVertexBoneWeightAttribName=""},setBoundingBox:function(c,a){this.bbox.set(c,a)},getBoundingBox:function(){return this.bbox},addBone:function(c,a){this.aBoneNameIdxMap[c]=this.aBoneNameList.length;this.aBoneNameList.push(c);this.aBoneSkinMatList.push(a.clone())},getBoneNum:function(){return this.aBoneNameList.length},setRefAttributeName:function(a,c){this.sVertexBoneIdxAttribName=a;this.sVertexBoneWeightAttribName=c},getVertexBoneIdxAttribName:function(){return this.sVertexBoneIdxAttribName},getVertexBoneWeightAttribName:function(){return this.sVertexBoneWeightAttribName},getBoneNameArray:function(){return this.aBoneNameList},getSkinMat:function(a){return this.aBoneSkinMatList[this.aBoneNameIdxMap[a]]},getSkinMatArray:function(){return this.aBoneSkinMatList}};function okMesh(a){this.rc=a;this.sName="";this.material=new okMaterial(a);this.bbox=new okAABBox();this.aAttribDataList=okAllocator.object();this.aAttribArrayBufferList=okAllocator.object();this.iAttribCount=0;this.iVertexCount=0;this.attribFmt=okAllocator.object();this.bAttribFmtDirty=true;this.aIndexDataList=okAllocator.object();this.aIndexArrayBufferList=okAllocator.object();this.aIndexTopologyList=okAllocator.object();this.iIndexCount=0;this.animSkin=new okMeshSkin}okMesh.prototype={clear:function(){this.sName="";this.material=new okMaterial(this.rc);this.bbox.set(OAK.VEC3_ZERO,OAK.VEC3_ZERO);this.iVertexCount=0;this.deleteAttribute();this.bAttribFmtDirty=true;this.deleteIndex();this.animSkin.clear()},setVertexNum:function(a){this.iVertexCount=a;this.bAttribFmtDirty=true},getVertexNum:function(){return this.iVertexCount},createAttribute:function(h,a,f,k){if(this.aAttribDataList[h]==null){this.iAttribCount+=1}var e=new Array(a);this.aAttribDataList[h]=e;if(f){for(var d=0;d<a;++d){e[d]=f[d]}}var c=new okArrayBuffer(this.rc);c.createBuffer(34962,5126,(k!=null)?k:35044,f?e:a);if(this.aAttribArrayBufferList[h]){this.aAttribArrayBufferList[h].releaseBuffer()}this.aAttribArrayBufferList[h]=c;this.bAttribFmtDirty=true},loadAttribute:function(h,c,a,d){var f=this.aAttribDataList[h];if(f){if(a<0){a=f.length-c}for(var e=c;e<c+a;++e){f[e]=d[e-c]}this.aAttribArrayBufferList[h].updateBuffer(c,a,d)}},deleteAttribute:function(a){if(a==null){this.aAttribDataList=new Object;this.aAttribArrayBufferList=new Object;this.iAttribCount=0}else{if(this.aAttribDataList[a]){delete this.aAttribDataList[a];delete this.aAttribArrayBufferList[a];this.iAttribCount-=1}}this.bAttribFmtDirty=true},_getAttribFmt:function(){if(this.bAttribFmtDirty){okAllocator._object(this.attribFmt);this.attribFmt=okAllocator.object();var c=this.aAttribArrayBufferList;var o=okAllocator.array();for(var n in c){var d=c[n];var l=n.split("/");var h=0;o.length=0;var e=l.length;for(var f=0;f<e;++f){var m=new okAttribFormat();var a=l[f];o.push(m);this.attribFmt[a]=m;m.sName=a;m.iIdx=f;m.iOffset=h;m.buf=d;switch(a){case"Position":case"Normal":case"Color":case"Texcoord1_Tangent":case"Texcoord1_Binormal":case"Texcoord2_Tangent":case"Texcoord2_Binormal":case"Texcoord3_Tangent":case"Texcoord3_Binormal":case"Texcoord4_Tangent":case"Texcoord4_Binormal":m.iSize=3;h+=3;break;case"Texcoord1":case"Texcoord2":case"Texcoord3":case"Texcoord4":m.iSize=2;h+=2;break;case"BoneIndex":case"BoneWeight":m.iSize=4;h+=4;break;default:}}e=o.length;for(var f=0;f<e;++f){o[f].iStride=h}}okAllocator._array(o);this.bAttribFmtDirty=false}return this.attribFmt},createIndex:function(f,a,k,l,h){if(this.aIndexDataList[f]==null){this.iIndexCount+=1}var c=new Array(a);this.aIndexDataList[f]=c;if(k){for(var e=0;e<a;++e){c[e]=k[e]}}var d=new okArrayBuffer(this.rc);d.createBuffer(34963,5123,(l!=null)?l:35044,k?c:a);if(this.aIndexArrayBufferList[f]){this.aIndexArrayBufferList[f].releaseBuffer()}this.aIndexArrayBufferList[f]=d;this.aIndexTopologyList[f]=(h!=null?h:4)},loadIndex:function(h,c,a,d){var e=this.aIndexDataList[h];if(e){if(a<0){a=e.length-c}for(var f=c;f<c+a;++f){e[f]=d[f-c]}this.aIndexArrayBufferList[h].updateBuffer(c,a,d)}},deleteIndex:function(a){for(var c in this.aIndexDataList){if(a==null||c==a){delete this.aIndexDataList[c];this.aIndexArrayBufferList[c].releaseBuffer();delete this.aIndexArrayBufferList[c];delete this.aIndexTopologyList[c];this.iIndexCount-=1}}},setIndexTopology:function(a,c){if(this.aIndexTopologyList[a]){this.aIndexTopologyList[a]=c}},getIndexTopology:function(a){return this.aIndexTopologyList[a]},setName:function(a){this.sName=a},getName:function(){return this.sName},getAttributeNum:function(){return this.iAttribCount},getIndexNum:function(){return this.iIndexCount},getAttributeArray:function(a){return this.aAttribDataList[a]},getAttributeArrayMap:function(){return this.aAttribDataList},getAttributeArrayBuffer:function(a){return this.aAttribArrayBufferList[a]},getAttributeArrayBufferMap:function(){return this.aAttribArrayBufferList},getIndexArray:function(a){return this.aIndexDataList[a]},getIndexArrayMap:function(){return this.aIndexDataList},getIndexArrayBuffer:function(a){return this.aIndexArrayBufferList[a]},getIndexArrayBufferMap:function(){return this.aIndexArrayBufferList},getMaterial:function(){return this.material},computeBoundingInfo:function(){this.bbox.set(OAK.VEC3_ZERO,OAK.VEC3_ZERO);for(var k in this.aAttribDataList){if(k.indexOf("Position")==0){var a=new okVec3(100000,100000,100000);var h=new okVec3(-100000,-100000,-100000);var f=this.aAttribDataList[k];var d=this.iVertexCount?(f.length/this.iVertexCount):3;for(var c=0;c<f.length;c+=d){var e=new okVec3(f[c],f[c+1],f[c+2]);a=okVec3Min(a,e);h=okVec3Max(h,e)}this.bbox.set(a,h);return}}},setBoundingBox:function(c,a){if(a==null){c.clone(this.bbox)}else{this.bbox.set(c,a)}},getBoundingBox:function(){return this.bbox},getBoundingSphereCenter:function(){return okVec3MulVal(okVec3Add(this.bbox.vMin,this.bbox.vMax),0.5)},getBoundingSphereRadius:function(){return okVec3Sub(this.bbox.vMax,this.bbox.vMin).len()*0.5},getSkin:function(){return this.animSkin},draw:function(c,a,d,e){var c=c!=null?c:"Default";this.aIndexArrayBufferList[c].drawIndex(a!=null?a:this.aIndexTopologyList[c],d,e)}};function okModel(a){this.rc=a;this.aMeshMap=new Object;this.iMeshCount=0;this.bbox=new okAABBox(OAK.VEC3_ZERO,OAK.VEC3_ZERO)}okModel.prototype={clear:function(){for(var a in this.aMeshMap){this.aMeshMap[a].clear()}this.aMeshMap=new Object;this.iMeshCount=0;this.bbox=new okAABBox(OAK.VEC3_ZERO,OAK.VEC3_ZERO)},createMesh:function(c){if(this.aMeshMap[c]==null){var a=new okMesh(this.rc);a.sName=c;this.aMeshMap[c]=a;this.iMeshCount+=1}return this.aMeshMap[c]},deleteMesh:function(c){for(var a in this.aMeshMap){if(c==null||a==c){this.aMeshMap[a].clear();delete this.aMeshMap[a]}}},getMesh:function(c){if(c){return this.aMeshMap[c]}for(var a in this.aMeshMap){return this.aMeshMap[a]}return null},getMeshMap:function(){return this.aMeshMap},getMeshNum:function(){return this.iMeshCount},computeBoundingInfo:function(){if(this.iMeshCount==0){this.bbox.set(OAK.VEC3_ZERO,OAK.VEC3_ZERO);return}var a=new okVec3(100000,100000,100000);var d=new okVec3(-100000,-100000,-100000);for(var c in this.aMeshMap){var e=this.aMeshMap[c];a=okVec3Min(a,e.getBoundingBox().vMin);d=okVec3Max(d,e.getBoundingBox().vMax)}this.bbox.set(a,d)},setBoundingBox:function(c,a){if(a==null){c.clone(this.bbox)}else{this.bbox.set(c,a)}},getBoundingBox:function(){return this.bbox},getBoundingSphereCenter:function(){return okVec3MulVal(okVec3Add(this.bbox.vMin,this.bbox.vMax),0.5)},getBoundingSphereRadius:function(){return okVec3Sub(this.bbox.vMax,this.bbox.vMin).len()*0.5}};function okSkAnimBone(){this.sName="";this.aKeyTransList=new Array;this.aKeyQuatList=new Array;this.parent=null;this.mCurMat=okAllocator.mat43();this.bCurMatDirty=true}okSkAnimBone.prototype={clone:function(){var c=new okSkAnimBone();c.sName=this.sName;for(var a=0;a<this.mMtList.length;++a){c.aKeyTransList.push(this.aKeyTransList[a].clone());c.aKeyQuatList.push(this.aKeyQuatList[a].clone())}c.parent=this.parent;c.mCurMat=new okMat4();c.bCurMatDirty=true},clear:function(){this.sName="";this.aKeyTransList.clear();this.aKeyQuatList.clear();this.parent=null;this.mCurMat.identity();this.bCurMatDirty=true},setName:function(a){this.sName=a},getName:function(){return this.sName},setParent:function(a){this.parent=a},getParent:function(){return this.parent},loadKeyTranslateList:function(c){this.aKeyTransList=new Array;for(var a=0;a<c.length;++a){this.aKeyTransList.push(c[a].clone())}},loadKeyQuaternionList:function(a){this.aKeyQuatList=new Array;for(var c=0;c<a.length;++c){this.aKeyQuatList.push(a[c].normalize())}},dirty:function(){this.bCurMatDirty=true},update:function(f,e,h){if(this.bCurMatDirty){var c=okVec3Lerp(this.aKeyTransList[f],this.aKeyTransList[e],h);var d=okQuatSlerp(this.aKeyQuatList[f],this.aKeyQuatList[e],h);var a=d.normalize();okAllocator._quat(d);d=a;d.toMat43(this.mCurMat);this.mCurMat.m03=c.x;this.mCurMat.m13=c.y;this.mCurMat.m23=c.z;okAllocator._vec3(c);if(this.parent){if(this.parent.bCurMatDirty){this.parent.update(f,e,h)}var a=okMat43Mul(this.parent.mCurMat,this.mCurMat);okAllocator._mat43(this.mCurMat);this.mCurMat=a}this.bCurMatDirty=false}},getMat43:function(){var a=new okMat43();this.mCurMat.clone(a);return a},getMat4:function(){var a=new okMat4();this.mCurMat.toMat4(a);return a}};function okSkAnimation(){this.aKeyFrameList=new Array;this.bbox=new okAABBox();this.aBoneList=new Object;this.iBoneNum=0;this.iFrameNum=0;this.fFrameTime=33;this.iCurTime=-1;this.iLerpKeyStart=-1;this.iLerpKeyEnd=-1;this.fLerpT=0}okSkAnimation.prototype={clear:function(){this.aKeyFrameList=new Array;this.bbox=new okAABBox();this.aBoneList=new Object;this.iBoneNum=0;this.iFrameNum=0;this.fFrameTime=33;this.iCurTime=-1;this.iLerpKeyStart=-1;this.iLerpKeyEnd=-1;this.fLerpT=0},setBoundingBox:function(c,a){this.bbox.set(c,a)},getBoundingBox:function(){return this.bbox},loadKeyFrameList:function(c){this.aKeyFrameList=new Array;for(var a=0;a<c.length;++a){this.aKeyFrameList.push(c[a])}},addBone:function(a){if(this.aBoneList[a.getName()]==null){this.iBoneNum+=1}this.aBoneList[a.getName()]=a},getBone:function(a){return this.aBoneList[a]},getBoneMat43:function(a){if(this.aBoneList[a]){return this.aBoneList[a].getMat43()}return okAllocator.mat43()},getBoneMat4:function(a){if(this.aBoneList[a]){return this.aBoneList[a].getMat4()}return okAllocator.mat4()},getBoneNum:function(){return this.iBoneNum},getBoneList:function(){return this.aBoneList},setFrameNum:function(a){this.iFrameNum=a},getFrameNum:function(){return this.iFrameNum},setFrameTime:function(a){this.fFrameTime=a},getFrameTime:function(){return this.fFrameTime},getAnimLength:function(){return this.iFrameNum*this.fFrameTime},setCurTime:function(c){if(this.iCurTime!=c){this.iCurTime=c;for(var a in this.aBoneList){this.aBoneList[a].dirty()}this._updateBoneList(this.iCurTime/this.fFrameTime)}},setCurFrame:function(c){if(this.iCurTime!=c*this.fFrameTime){this.iCurTime=c*this.fFrameTime;for(var a in this.aBoneList){this.aBoneList[a].dirty()}this._updateBoneList(c)}},getCurTime:function(){return this.iCurTime},_lerpFrame:function(a){for(var c=0;c<this.aKeyFrameList.length;++c){if(this.aKeyFrameList[c]>a){if(c>0){this.iLerpKeyStart=c-1;this.iLerpKeyEnd=c}else{this.iLerpKeyStart=this.iLerpKeyEnd=0}this.fLerpT=(a-this.aKeyFrameList[c-1])/(this.aKeyFrameList[c]-this.aKeyFrameList[c-1]);return}}this.iLerpKeyStart=this.iLerpKeyEnd=this.aKeyFrameList.length-1;this.fLerpT=0},_updateBoneList:function(a){this._lerpFrame(a);for(var c in this.aBoneList){this.aBoneList[c].update(this.iLerpKeyStart,this.iLerpKeyEnd,this.fLerpT)}}};function okSkAnimSubChannel(){this.attachedAnim=null;this.bLoop=false;this.fSpeed=1;this.iCurTime=0}okSkAnimSubChannel.prototype={clone:function(a){var a=a?a:new okSkAnimSubChannel();a.attachedAnim=this.attachedAnim;a.bLoop=this.bLoop;a.fSpeed=this.fSpeed;a.iCurTime=this.iCurTime;return a},attachAnim:function(a){this.attachedAnim=a},getAnim:function(){return this.attachedAnim},isActive:function(){return(this.attachedAnim!=null)&&(this.iCurTime<this.attachedAnim.getAnimLength())},setSpeed:function(a){this.fSpeed=a},getSpeed:function(){return this.fSpeed},enableLoop:function(a){this.bLoop=a},isLoop:function(){return this.bLoop},getFrameTime:function(){if(this.attachedAnim){return this.attachedAnim.getFrameTime()}return 0},setCurTime:function(a){this.iCurTime=a;if(this.attachedAnim){this.attachedAnim.setCurTime(a)}},update:function(a){if(this.attachedAnim){this.iCurTime+=(a*this.fSpeed);this.attachedAnim.setCurTime(this.bLoop?(this.iCurTime%this.attachedAnim.getAnimLength()):this.iCurTime)}},getBoneMat43:function(a){if(this.attachedAnim){return this.attachedAnim.getBoneMat43(a)}return new okMat4(1)}};function okSkAnimChannel(){this.bActive=false;this.mainChannel=new okSkAnimSubChannel();this.transChannel=new okSkAnimSubChannel();this.iTransTime=0;this.iCurTransTime=0}okSkAnimChannel.prototype={clone:function(a){a=a?a:new okSkAnimChannel();a.bActive=this.bActive;this.mainChannel.clone(a.mainChannel);this.transChannel.clone(a.transChannel);a.iTransTime=this.iTransTime;a.iCurTransTime=this.iCurTransTime;return a},activate:function(a){this.bActive=a},isActive:function(){return this.bActive},attachAnim:function(a,c){this.mainChannel.clone(this.transChannel);this.iTransTime=((c!=null)?c:0);this.iCurTransTime=0;this.mainChannel.attachAnim(a)},getAnim:function(){return this.mainChannel.getAnim()},setSpeed:function(a){this.mainChannel.setSpeed(a)},getSpeed:function(){return this.mainChannel.getSpeed()},enableLoop:function(a){this.mainChannel.enableLoop(a)},isLoop:function(){return this.mainChannel.isLoop()},getFrameTime:function(){if(this.mainChannel){return this.mainChannel.getFrameTime()}return 0},setCurTime:function(a){this.mainChannel.setCurTime(a)},update:function(a){this.mainChannel.update(a);if(this.iCurTransTime<this.iTransTime){this.transChannel.update(a)}this.iCurTransTime=Math.min(this.iCurTransTime+a,this.iTransTime)},getBoneMat43:function(d){var f=this.mainChannel.getBoneMat43(d);if(this.iCurTransTime>=this.iTransTime||!this.transChannel.isActive()){return f}var e=this.transChannel.getBoneMat43(d);var k=new okQuat();var m=new okQuat();f.toQuat(k);e.toQuat(m);var l=this.iCurTransTime/this.iTransTime;var h=okQuatSlerp(m,k,l);var a=okVec3Lerp(e.getColumn(3),f.getColumn(3),l);var c=new okMat43();h.toMat43(c);c.setColumn(3,a);return c}};function okSkAnimPlayer(){this.skinInfo=null;this.aBoneMatList=new Array;this.bBoneMatDirty=false;this.aBoneFinalMatList=new Array;this.bBoneFinalMatDirty=false;this.aChannelList=new Array;this.aChannelList.push(new okSkAnimChannel());this.aChannelList.push(new okSkAnimChannel());this.iBlendMode=1;this.bbox=new okAABBox();this.bBBoxDirty=true}okSkAnimPlayer.prototype={clear:function(){this.skinInfo=null;this.aBoneMatList=new Array;this.bBoneMatDirty=false;this.aBoneFinalMatList=new Array;this.bBoneFinalMatDirty=false;this.aChannelList=new Array;this.aChannelList.push(new okSkAnimChannel());this.aChannelList.push(new okSkAnimChannel());this.iBlendMode=1;this.bbox.set(OAK.VEC3_ZERO,OAK.VEC3_ZERO);this.bBBoxDirty=true},clone:function(a){a=a?a:new okSkAnimPlayer();a.skinInfo=this.skinInfo;a.bBoneMatDirty=true;a.bBoneFinalMatDirty=true;a.aChannelList=[this.aChannelList[0].clone(),this.aChannelList[1].clone()];a.iBlendMode=this.iBlendMode;a.bBBoxDirty=this.bBBoxDirty;return a},setSkin:function(a){this.skinInfo=a;this.bBoneMatDirty=true;this.bBoneFinalMatDirty=true;this.update(-1,0);this.bBBoxDirty=true},getSkin:function(){return this.skinInfo},getBoundingBox:function(){if(this.bBBoxDirty){this.bbox.set(new okVec3(10000000000,10000000000,10000000000),new okVec3(-10000000000,-10000000000,-10000000000));if(this.aChannelList[0].isActive()&&this.aChannelList[0].getAnim()){this.bbox=this.bbox.union(this.aChannelList[0].getAnim().getBoundingBox())}if(this.aChannelList[1].isActive()&&this.aChannelList[1].getAnim()){this.bbox=this.bbox.union(this.aChannelList[1].getAnim().getBoundingBox())}this.bBBoxDirty=false}return this.bbox},activateChannel:function(c,a){this.aChannelList[c].activate(a);this.bBoneMatDirty=true;this.bBoneFinalMatDirty=true;this.bBBoxDirty=true},isActive:function(a){return this.aChannelList[a].isActive()},attachAnim:function(c,a,d){this.aChannelList[c].attachAnim(a,d);this.bBoneMatDirty=true;this.bBoneFinalMatDirty=true;this.bBBoxDirty=true},getAnim:function(a){return this.aChannelList[a].getAnim()},setSpeed:function(c,a){this.aChannelList[c].setSpeed(a)},getSpeed:function(a){return this.aChannelList[a].getSpeed()},enableLoop:function(c,a){this.aChannelList[c].enableLoop(a)},isLoop:function(a){return this.aChannelList[a].isLoop()},setBlendMode:function(a){this.iBlendMode=a;this.bBoneMatDirty=true;this.bBoneFinalMatDirty=true},getBlendMode:function(){return this.iBlendMode},getFrameTime:function(a){if(this.aChannelList[a]){return this.aChannelList[a].getFrameTime()}return 0},setTime:function(c,d){if(c==-1){for(var a=0;a<this.aChannelList.length;++a){if(this.aChannelList[a].isActive()){this.aChannelList[a].setCurTime(d)}}}else{this.aChannelList[c].setCurTime(d)}this.bBoneMatDirty=true;this.bBoneFinalMatDirty=true},update:function(d,a){if(d==-1){for(var c=0;c<this.aChannelList.length;++c){if(this.aChannelList[c].isActive()){this.aChannelList[c].update(a)}}}else{this.aChannelList[d].update(a)}this.bBoneMatDirty=true;this.bBoneFinalMatDirty=true},getBoneMat43:function(m){var o=this.aChannelList[0].isActive();var n=this.aChannelList[1].isActive();if(o&&!n){return this.aChannelList[0].getBoneMat43(m)}else{if(!o&&n){return this.aChannelList[1].getBoneMat43(m)}else{if(!o&&!n){return new okMat4()}}}var h=new okMat43();if(this.iBlendMode==1){var f=this.aChannelList[0].getBoneMat43(m);var e=this.aChannelList[1].getBoneMat43(m);var d=f.getColumn(3);var a=e.getColumn(3);var p=okVec3Add(d,a);var l=new okQuat();var k=new okQuat();f.toQuat(l);e.toQuat(k);var c=okQuatMul(k,l);c.toMat43(h);h.setColumn(3,p)}else{if(this.iBlendMode==2){var f=this.aChannelList[0].getBoneMat43(m);var e=this.aChannelList[1].getBoneMat43(m);var d=f.getColumn(3);var a=e.getColumn(3);var p=okVec3Lerp(d,a,0.5);var l=new okQuat();var k=new okQuat();f.toQuat(l);e.toQuat(k);var c=okQuatSlerp(k,l,0.5);c.toMat43(h);h.setColumn(3,p)}}return h},getBoneMat43Array:function(){var c=this.skinInfo.getBoneNameArray();if(this.bBoneMatDirty){this.aBoneMatList.length=0;for(var a=0;a<c.length;++a){this.aBoneMatList.push(this.getBoneMat43(c[a]))}this.bBoneMatDirty=false}return this.aBoneMatList},getBoneFinalMat43:function(m){var o=this.aChannelList[0].isActive();var n=this.aChannelList[1].isActive();if(o&&!n){return okMat43Mul(this.aChannelList[0].getBoneMat43(m),this.skinInfo?this.skinInfo.getSkinMat(m):new okMat43())}else{if(!o&&n){return okMat43Mul(this.aChannelList[1].getBoneMat43(m),this.skinInfo?this.skinInfo.getSkinMat(m):new okMat43())}else{if(!o&&!n){return(this.skinInfo?this.skinInfo.getSkinMat(m):new okMat43())}}}var h=new okMat43();if(this.iBlendMode==1){var f=this.aChannelList[0].getBoneMat43(m);var e=this.aChannelList[1].getBoneMat43(m);var d=f.getColumn(3);var a=e.getColumn(3);var p=okVec3Add(d,a);var l=new okQuat();var k=new okQuat();f.toQuat(l);e.toQuat(k);var c=okQuatMul(k,l);c.toMat43(h);h.setColumn(3,p)}else{if(this.iBlendMode==2){var f=this.aChannelList[0].getBoneMat43(m);var e=this.aChannelList[1].getBoneMat43(m);var d=f.getColumn(3);var a=e.getColumn(3);var p=okVec3Lerp(d,a,0.5);var l=new okQuat();var k=new okQuat();f.toQuat(l);e.toQuat(k);var c=okQuatSlerp(k,l,0.5);c.toMat43(h);h.setColumn(3,p)}}if(this.skinInfo){return okMat43Mul(h,this.skinInfo.getSkinMat(m))}else{return h}},getBoneFinalMat43Array:function(){var c=this.skinInfo.getBoneNameArray();if(this.bBoneFinalMatDirty){this.aBoneFinalMatList.length=0;for(var a=0;a<c.length;++a){this.aBoneFinalMatList.push(this.getBoneFinalMat43(c[a]))}this.bBoneFinalMatDirty=false}return this.aBoneFinalMatList}};function okCharMetaData(e,c,f,d,a){this.code=0;this.tex=e;this.x=c;this.y=f;this.width=d;this.height=a}okCharMetaData.prototype={clone:function(){var c=new this.constructor();for(var a in this){if(c[a]!=this[a]){c[a]=this[a]}}return c}};function okFontTexture(d,c,a){this.rc=d;this.width=c;this.height=a;this.ok2DLayoutHelper=new okLayout2DHelper(c,a);this.texData=new okTexture(d);this.texData.createTexture(3553,c,a,6408,5121);this.charsList=new okList()}okFontTexture.prototype={addTex:function(a,d,k){var f=this.ok2DLayoutHelper.add(d,k);if(f!=null){var h=new Array();for(var e=0;e<a.length;++e){h.push(a[e])}this.texData.updateTexture(f.x,f.y,f.width,f.height,5121,h);var c=new okCharMetaData(this,f.x,f.y,d,k);this.charsList.pushFront(c);return this.charsList.getRoot()}else{return null}},updateCharNode:function(a){var c=a.data;this.charsList.remove(a);this.charsList.pushFront(c);return this.charsList.getRoot()},clearRoom:function(){var c=this.charsList.getTail();if(c!=null){var d=c.data;var a=new okRect(d.x,d.y,d.width,d.height);if(this.ok2DLayoutHelper.remove(a)){this.charsList.popBack();return{opFlag:true,codeRemoved:d.code}}}return{opFlag:false}}};function okGetFontName(a,e,c,d,f){return f+" "+c+" "+e+" "+d+" "+a}function okFont(){this.fontFamily="";this.fontSize=40;this.fontWeight="normal";this.fontVariant="";this.fontStyle="normal";this.bAutoWrap=true;this.texWidth=512;this.texHeight=512;this.rc=null;this.maxTexNumber=5;this.texArray=new Array();this.texDynamicList=new okList();this.codePages=new Object();this.program=null}okFont.prototype={setCodePageSize:function(e,a){var c=okAlignPower2(e);var d=okAlignPower2(a);if(c!=this.texWidth||d!=this.texHeight){this.clearAll();this.texWidth=c;this.texHeight=d}},setCodePageMaxNum:function(a){if(this.texArray.length>a){this.clearAll()}this.maxTexNumber=a},enableAutoWrap:function(a){this.bAutoWrap=a},isAutoWrapEnabled:function(){return this.bAutoWrap},drawText:function(w,u,B,d){var E=this.rc.canvas.width;var c=this.rc.canvas.height;var x;if(d!=null){E=d.iSizeU;c=d.iSizeV;x=new okFrameBuffer(this.rc);x.createBuffer();x.bind();x.attachRenderTexture(0,d)}var v;if(w==null){v=new okRect(0,0,E,c)}else{if(w.width<=0||w.height<=0){return}v=new okRect(w.x,w.y,w.x+w.width,w.y+w.height)}this.program.bind();var f=okMat4Trans(0,0,-3);this.program.setUniformMat4("matWorld",f);var o=okMat4Ortho(0,E,0,c,0.1,10);this.program.setUniformMat4("matProj",o);var z=new okMat4(1);if(B!=null){z.m00=B.x;z.m11=B.y;z.m22=B.z;if(B.w){z.m33=B.w}}this.program.setUniformMat4("matColor",z);var p=new okVec2(v.x,v.y);var e=new okVec2(0,0);var I=new okVec2(0,0);var h=new okVec2(0,0);var H;var D;var l=new Array();var q=0;var G=null;var t;var F;for(var C=0;C<u.length;++C){if(u.charAt(C)!="\n"){G=this.getCharTextureInfo(u.charAt(C),false);if(G==null){for(var n=0;n<l.length;++n){t=new okArrayBuffer(this.rc);t.createBuffer(34962,5126,35044,l[n].vertexArray);F=new okArrayBuffer(this.rc);F.createBuffer(34962,5126,35044,l[n].coordArray);this.program.setAttribute("position",t,3);this.program.setAttribute("vertex_coord",F,2);this.program.setSampler("tex",0);l[n].okTex.bind(0);this.rc.texParameteri(3553,10240,9729);this.rc.texParameteri(3553,10241,9729);this.rc.drawArrays(4,0,l[n].vertexArray.length/3)}l.splice(0,l.length);this.addIndividualCode(u.charAt(C));--C;continue}e.x=p.x+G.width-1;e.y=p.y+G.height-1;if(e.x>=v.width){if(this.bAutoWrap){var a=v.x;if(p.x-a>0.000001){p.x=v.x;p.y+=q;q=0;if(p.y>=v.height){break}else{--C;continue}}}e.x=v.width-1}if(e.y>=v.height){e.y=v.height-1}H=[e.x,p.y,0,p.x,p.y,0,e.x,e.y,0,p.x,p.y,0,p.x,e.y,0,e.x,e.y,0];I.x=G.x/G.tex.width;I.y=G.y/G.tex.height;h.x=(G.x+e.x-p.x)/G.tex.width;h.y=(G.y+e.y-p.y)/G.tex.height;D=[h.x,I.y,I.x,I.y,h.x,h.y,I.x,I.y,I.x,h.y,h.x,h.y];for(var A=0;A<l.length;++A){if(l[A].fontTex===G.tex){break}}if(A==l.length){var s=new Object();s.okTex=G.tex.texData;s.fontTex=G.tex;s.vertexArray=new Array();s.coordArray=new Array();l.push(s)}for(var y=0;y<H.length;++y){l[A].vertexArray.push(H[y])}for(y=0;y<D.length;++y){l[A].coordArray.push(D[y])}if(q<G.height){q=G.height}if(e.x>=v.width){if(this.bAutoWrap){p.x=v.x;p.y+=q;q=0;if(p.y>=v.height){break}}else{for(C=C+1;C<u.length;++C){if(u.charAt(C)=="\n"){break}}}}else{p.x+=G.width}}else{p.x=v.x;p.y+=q;q=0;if(p.y>=v.height){break}}}if(l.length>0){for(var n=0;n<l.length;++n){t=new okArrayBuffer(this.rc);t.createBuffer(34962,5126,35044,l[n].vertexArray);F=new okArrayBuffer(this.rc);F.createBuffer(34962,5126,35044,l[n].coordArray);this.program.setAttribute("position",t,3);this.program.setAttribute("vertex_coord",F,2);this.program.setSampler("tex",0);l[n].okTex.bind(0);this.rc.texParameteri(3553,10240,9729);this.rc.texParameteri(3553,10241,9729);this.rc.drawArrays(4,0,l[n].vertexArray.length/3)}}if(d!=null){x.unbind()}},getFontName:function(){return okGetFontName(this.fontFamily,this.fontSize,this.fontWeight,this.fontVariant,this.fontStyle)},isTexFull:function(){return this.texArray.length>=this.maxTexNumber},increaseFontTex:function(){if(!this.isTexFull()){var a=new okFontTexture(this.rc,this.texWidth,this.texHeight);this.texArray.push(a);return true}else{return false}},getFirstBlankTex:function(){if(this.texArray.length<=0){if(!this.increaseFontTex()){return null}}return this.texArray[this.texArray.length-1]},getFirstReplacableTex:function(){if(this.texArray.length<=0){return null}if(this.texDynamicList.getRoot()!=null){return this.texDynamicList.getRoot().data}else{return this.texArray[0]}},getTexture:function(c){var a=this.getCharTextureInfo(c);if(a!=null){return a.tex}else{return null}},updateTexTimeStamp:function(a){var c=this.texDynamicList.find(a);this.texDynamicList.remove(c);this.texDynamicList.pushFront(a)},addIndividualCode:function(d,l){if(okIsUndefined(this.codePages[d.toString()])){var n=okFontManager.get2DContext();okFontManager.clear2DContext();var h=n.font;n.font=this.getFontName();n.fillText(d,0,0);var e=n.measureText(d).width;if(e<=0){e=1}var f=n.getImageData(0,0,e,this.fontSize);n.font=h;var a=this.getFirstBlankTex();if(a==null){return false}var c=a.addTex(f.data,f.width,f.height);if(c==null){if(this.increaseFontTex()){a=this.getFirstBlankTex();c=a.addTex(f.data,f.width,f.height)}else{var m=true;if(!(l==null||okIsUndefined(l))){m=l}if(m){a=this.getFirstReplacableTex();if(a){do{var k=a.clearRoom();if(k.opFlag){delete this.codePages[k.codeRemoved];c=a.addTex(f.data,f.width,f.height)}else{break}}while(c==null)}}}}if(c!=null){c.data.code=d.toString();this.codePages[d.toString()]=c}else{return false}}return true},getCharTextureInfo:function(d,f){var c=this.codePages[d.toString()];if(okIsUndefined(c)){if(this.addIndividualCode(d,f)){c=this.codePages[d.toString()]}else{return null}}var a=c.data;var e=a.tex;this.updateTexTimeStamp(e);this.codePages[d.toString()]=e.updateCharNode(c);return a.clone()},initProgram:function(){var c=new okShader(this.rc,35633);c.loadSource("                       attribute vec3 position;                       attribute vec2 vertex_coord;                       uniform mat4 matWorld, matProj;                       varying vec2 pixel_coord;                       void main(void) {                            gl_Position = matProj * matWorld * vec4(position, 1.0);                            pixel_coord = vertex_coord;                       }                       ");c.compile();var a=new okShader(this.rc,35632);a.loadSource("                        precision highp float;                        varying vec2 pixel_coord;                        uniform sampler2D tex;                        uniform mat4 matColor;                        void main(void) {                        gl_FragColor = texture2D(tex, pixel_coord) * matColor;                         }                      ");a.compile();this.program=new okProgram(this.rc);this.program.attachVertexShader(c);this.program.attachFragmentShader(a);this.program.link()},clearAll:function(){this.texArray=new Array();this.texDynamicList=new okList();this.codePages=new Object()}};var okFontManager=(function(){var a={};var e=null;var c=null;var d=false;return{createFont:function(o,h,n,l,m,p){var k=o.canvas.getAttribute("ID")+okGetFontName(h,n,l,m,p);if(a[k]!=undefined){return a[k]}else{var f=new okFont();f.fontFamily=h;f.fontSize=n;f.fontWeight=l;f.fontVariant=m;f.fontStyle=p;f.rc=o;f.initProgram();a[k]=f;return f}},deleteFont:function(n,f,m,k,l,o){if(arguments.length==1){var h=n.rc.canvas.getAttribute("ID")+okGetFontName(n.fontFamily,n.fontSize,n.fontWeight,n.fontVariant,n.fontStyle)}else{var h=n.canvas.getAttribute("ID")+okGetFontName(f,m,k,l,o)}if(a[h]!=undefined){delete a[h]}},get2DContext:function(){if(c==null){e=document.createElement("canvas");e.width=512;e.height=512;c=e.getContext("2d");c.fillStyle="#ffffff";c.strokeStyle="#ffffff";c.textBaseline="top"}return c},clear2DContext:function(){c.clearRect(0,0,e.width,e.height)}}})();function okBillBoard(a){this.program=a;this.text="";this.font=null;this.posAttributeName="position";this.texcoordAttributeName="vertex_coord";this.samplertexAttributeName="tex"}okBillBoard.prototype={setText:function(a){this.text=a},getText:function(){return this.text},setFont:function(a){this.font=a},getFont:function(){return this.font},setPositionAttrName:function(a){this.posAttributeName=a},getPositionAttrName:function(){return this.posAttributeName},setTexcoordAttrName:function(a){this.texcoordAttributeName=a},getTexcoordAttrName:function(){return this.texcoordAttributeName},setSamplertexAttrName:function(a){this.samplertexAttributeName=a},getSamplertexAttrName:function(){return this.samplertexAttributeName},render:function(){if(this.font==null){return}var f=new Array();for(var p=0;p<this.text.length;++p){if(this.text.charAt(p)!="\n"){f.push(this.font.getCharTextureInfo(this.text.charAt(p)))}else{f.push(null)}}var q=new okVec2(0,0);var u=new okVec2(0,0);var o=new okVec2(0,0);var l=new okVec2(0,0);var c;var d;var v,s;var t=new Array();var a=0;for(var p=0;p<f.length;++p){if(f[p]!=null){u.x=q.x+f[p].width-1;u.y=q.y+f[p].height-1;c=[u.x,q.y,0,q.x,q.y,0,u.x,u.y,0,q.x,q.y,0,q.x,u.y,0,u.x,u.y,0];o.x=f[p].x/f[p].tex.width;o.y=f[p].y/f[p].tex.height;l.x=(f[p].x+f[p].width-1)/f[p].tex.width;l.y=(f[p].y+f[p].height-1)/f[p].tex.height;d=[l.x,o.y,o.x,o.y,l.x,l.y,o.x,o.y,o.x,l.y,l.x,l.y];for(var h=0;h<t.length;++h){if(t[h].fontTex===f[p].tex){break}}if(h==t.length){var n=new Object();n.okTex=f[p].tex.texData;n.fontTex=f[p].tex;n.vertexArray=new Array();n.coordArray=new Array();t.push(n)}for(var e=0;e<c.length;++e){t[h].vertexArray.push(c[e])}for(e=0;e<d.length;++e){t[h].coordArray.push(d[e])}q.x+=f[p].width;if(a<f[p].height){a=f[p].height}}else{q.x=0;q.y+=a;a=0}}this.program.bind();for(var p=0;p<t.length;++p){v=new okArrayBuffer(this.program.rc);v.createBuffer(34962,5126,35044,t[p].vertexArray);s=new okArrayBuffer(this.program.rc);s.createBuffer(34962,5126,35044,t[p].coordArray);this.program.setAttribute(this.posAttributeName,v,3);this.program.setAttribute(this.texcoordAttributeName,s,2);this.program.setSampler(this.samplertexAttributeName,0);t[p].okTex.bind(0);this.program.rc.texParameteri(3553,10240,9729);this.program.rc.texParameteri(3553,10241,9729);this.program.rc.drawArrays(4,0,t[p].vertexArray.length/3)}}};function okRenderEnvironment(){this.rc=null;this.camera=null;this.scene=null;this.canvas=null;this.iCanvasWidth=0;this.iCanvasHeight=0;this.vSkyColor=new okVec3(1,1,1);this.vGroundColor=new okVec3(0.3,0.3,0.3);this.bFogEnable=false;this.vFogColor=new okVec3(1,1,1);this.fFogDensity=3.5;this.fFogDistNear=0.1;this.fFogDistFar=1;this.bShadow=true;this.aStageEnableList=[true,true,true];this.iStartTime=0;this.iCurTime=0;this.fRandom=0}okRenderEnvironment.prototype.clear=function(){this.camera=null;this.scene=null;this.vSkyColor.set(1,1,1);this.vGroundColor.set(0.3,0.3,0.3);this.bFogEnable=false;this.vFogColor.set(1,1,1);this.fFogDensity=3.5;this.fFogDistNear=0.1;this.fFogDistFar=1;this.bShadow=true;this.aStageEnableList=[true,true,true];this.iStartTime=0;this.iCurTime=0;this.fRandom=0};function okBaseEntity(a){this.iType=0;this.iId=-1;this.zone=a;this.resourceManager=a.scene.resourceManager;this.sName="";this.mMatToP=okAllocator.mat43();this.mMat=okAllocator.mat43();this.mMatN=okAllocator.mat43();this.mMatInv=okAllocator.mat43();this.bMatNDirty=true;this.bMatInvDirty=true;this.bbox=new okAABBox();this.obox=new okOBBox();this.vBSphCenter=new okVec3();this.fBSphRadius=0;this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true;this.parent=null;this.aChildren=new okList();this.aResRefMap=okAllocator.object()}okBaseEntity.prototype.clear=function(){this.mMatToP.identity();this.mMat.identity();this.bMatNDirty=true;this.bMatInvDirty=true;this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true;this.clearChild();this.releaseResource()};okBaseEntity.prototype.getType=function(){return this.iType};okBaseEntity.prototype.setId=function(a){this.iId=a};okBaseEntity.prototype.getId=function(){return this.iId};okBaseEntity.prototype.setName=function(a){this.sName=a};okBaseEntity.prototype.getName=function(){return this.sName};okBaseEntity.prototype.getResourceRefCount=function(a){if(this.aResRefMap[a]==null){return 0}return this.aResRefMap[a]};okBaseEntity.prototype.addResourceRef=function(a){if(this.aResRefMap[a]==null){this.aResRefMap[a]=1}else{this.aResRefMap[a]+=1}};okBaseEntity.prototype.releaseResource=function(){var e=this.resourceManager;for(var a in this.aResRefMap){var d=this.aResRefMap[a];for(var c=0;c<d;++c){e.deleteResource(parseInt(a))}}okAllocator._object(this.aResRefMap);this.aResRefMap=okAllocator.object()};okBaseEntity.prototype.getState=function(){return 4};okBaseEntity.prototype.attachChild=function(a){if(a.parent!=this){this.aChildren.pushBack(a);a.parent=this;a._updateMat(true)}};okBaseEntity.prototype.detachChild=function(a){if(a.parent==this){this.aChildren.remove(this.aChildren.find(a));a.parent=null;a._updateMat(true)}};okBaseEntity.prototype.clearChild=function(){var a=this.aChildren.getRoot();while(a){var c=a.data;c.parent=null;c._updateMat(true);a=a.next}this.aChildren.clear()};okBaseEntity.prototype.getChildArray=function(c){if(c==null){c=okAllocator.array()}var a=this.aChildren.getRoot();while(a){c.push(a.data);a=a.next}return c};okBaseEntity.prototype._updateMat=function(a){if(!a){if(this.parent){var c=okMat43Mul(this.mMatToP,this.mMat);this.mMatToP=this.parent.mMat.inverse();this.mMat=okMat43Mul(this.parent.mMat,c);okAllocator._mat43(c);this.bMatNDirty=true;this.bMatInvDirty=true;this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true;this.dirtyMatFunc();this.zone.dirtyEntity(this);var d=this.aChildren.getRoot();while(d){d.data._updateMat(a);d=d.next}}else{this.mMatToP.identity()}}else{if(this.parent){this.mMatToP=this.parent.mMat.inverse()}else{this.mMatToP.identity()}}};okBaseEntity.prototype.getBoundingBox=function(a){if(a==2){if(this.bOBoxDirty){this.obox.setMin(-0.01,-0.01,-0.01);this.obox.setMax(0.01,0.01,0.01);this.obox.setMat(this.mMat);this.bOBoxDirty=false}return this.obox}else{if(this.bBBoxDirty){this.bbox.setMin(-0.01,-0.01,-0.01);this.bbox.setMax(0.01,0.01,0.01);this.bBBoxDirty=false}return this.bbox}};okBaseEntity.prototype.getBoundingSphereCenter=function(){if(this.bBSphDirty){var c=this.getBoundingBox(2);var a=okMat43MulVec3(c.mMat,c.vMin);var d=okMat43MulVec3(c.mMat,c.vMax);this.vBSphCenter.x=(a.x+d.x)*0.5;this.vBSphCenter.y=(a.y+d.y)*0.5;this.vBSphCenter.z=(a.z+d.z)*0.5;this.fBSphRadius=Math.sqrt((d.x-a.x)*(d.x-a.x)+(d.y-a.y)*(d.y-a.y)+(d.z-a.z)*(d.z-a.z))*0.5;okAllocator._vec3(a);okAllocator._vec3(d);this.bBSphDirty=false}return this.vBSphCenter.clone()};okBaseEntity.prototype.getBoundingSphereRadius=function(){if(this.bBSphDirty){var c=this.getBoundingBox(2);var a=okMat43MulVec3(c.mMat,c.vMin);var d=okMat43MulVec3(c.mMat,c.vMax);this.vBSphCenter.x=(a.x+d.x)*0.5;this.vBSphCenter.y=(a.y+d.y)*0.5;this.vBSphCenter.z=(a.z+d.z)*0.5;this.fBSphRadius=Math.sqrt((d.x-a.x)*(d.x-a.x)+(d.y-a.y)*(d.y-a.y)+(d.z-a.z)*(d.z-a.z))*0.5;okAllocator._vec3(a);okAllocator._vec3(d);this.bBSphDirty=false}return this.fBSphRadius};okBaseEntity.prototype.genRenderBatch=function(a,c,d){};okBaseEntity.prototype.setMat=function(a){a.clone(this.mMat);this.bMatNDirty=true;this.bMatInvDirty=true;this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true;this.dirtyMatFunc();this.zone.dirtyEntity(this);var c=this.aChildren.getRoot();while(c){c.data._updateMat(false);c=c.next}};okBaseEntity.prototype.getMat43=function(){var a=okAllocator.mat43();this.mMat.clone(a);return a};okBaseEntity.prototype.getMat4=function(){var a=okAllocator.mat4();this.mMat.toMat4(a);return a};okBaseEntity.prototype.getNormalMat3=function(){if(this.bMatNDirty){var c=okAllocator.mat43();c=this.mMat.inverse();okAllocator._mat43(this.mMatN);this.mMatN=c.transpose();okAllocator._mat43(c);this.bMatNDirty=false}var a=okAllocator.mat3();this.mMatN.toMat3(a);return a};okBaseEntity.prototype.getNormalMat43=function(){if(this.bMatNDirty){var c=okAllocator.mat43();c=this.mMat.inverse();okAllocator._mat43(this.mMatN);this.mMatN=c.transpose();okAllocator._mat43(c);this.bMatNDirty=false}var a=okAllocator.mat43();this.mMatN.clone(a);return a};okBaseEntity.prototype.getNormalMat4=function(){if(this.bMatNDirty){var c=okAllocator.mat43();c=this.mMat.inverse();okAllocator._mat43(this.mMatN);this.mMatN=c.transpose();okAllocator._mat43(c);this.bMatNDirty=false}var a=okAllocator.mat4();this.mMatN.toMat4(a);return a};okBaseEntity.prototype.getInvMat43=function(){if(this.bMatInvDirty){okAllocator._mat43(this.mMatInv);this.mMatInv=this.mMat.inverse();this.bMatInvDirty=false}var a=okAllocator.mat43();this.mMatInv.clone(a);return a};okBaseEntity.prototype.getInvMat4=function(){if(this.bMatInvDirty){okAllocator._mat43(this.mMatInv);this.mMatInv=this.mMat.inverse();this.bMatInvDirty=false}var a=okAllocator.mat4();this.mMatInv.toMat4(a);return a};okBaseEntity.prototype.setPos=function(d,c,a){if(c==null){this.mMat.m03=d.x;this.mMat.m13=d.y;this.mMat.m23=d.z}else{this.mMat.m03=d;this.mMat.m13=c;this.mMat.m23=a}this.bMatNDirty=true;this.bMatInvDirty=true;this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true;this.dirtyMatFunc();this.zone.dirtyEntity(this);var e=this.aChildren.getRoot();while(e){e.data._updateMat(false);e=e.next}};okBaseEntity.prototype.getPos=function(){var a=okAllocator.vec3();a.x=this.mMat.m03;a.y=this.mMat.m13;a.z=this.mMat.m23;return a};okBaseEntity.prototype.move=function(l,h,f,e){var c=null;if(f!=null){c=okMat43Trans(h,f,e)}else{c=okMat43Trans(h.x,h.y,h.z)}if(l==3){var a=okMat43Mul(c,this.mMat);okAllocator._mat43(this.mMat);this.mMat=a}else{if(l==2&&this.parent){var d=okMat43Mul(this.mMatToP,this.mMat);d=okMat43Mul(c,d);okAllocator._mat43(this.mMat);this.mMat=okMat43Mul(this.parent.mMat,d)}else{var a=okMat43Mul(this.mMat,c);okAllocator._mat43(this.mMat);this.mMat=a}}okAllocator._mat43(c);this.bMatNDirty=true;this.bMatInvDirty=true;this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true;this.dirtyMatFunc();this.zone.dirtyEntity(this);var k=this.aChildren.getRoot();while(k){k.data._updateMat(false);k=k.next}};okBaseEntity.prototype.rotTarget=function(f,k,h){var c=okAllocator.mat43();this.mMat.clone(c);c.m03-=k.x;c.m13-=k.y;c.m23-=k.z;var a=okMat43Rot(f,h);var d=okMat43Mul(a,c);okAllocator._mat43(c);d.m03+=k.x;d.m13+=k.y;d.m23+=k.z;d.clone(this.mMat);okAllocator._mat43(d);this.bMatNDirty=true;this.bMatInvDirty=true;this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true;this.dirtyMatFunc();this.zone.dirtyEntity(this);var e=this.aChildren.getRoot();while(e){e.data._updateMat(false);e=e.next}};okBaseEntity.prototype.getDir=function(a){return this.mMat.getColumn(a-1).normalize(true)};okBaseEntity.prototype.setDir=function(f,e,d,c,a){this._rotToDir(f,e,d,c,a);var h=this.aChildren.getRoot();while(h){h.data._updateMat(false);h=h.next}};okBaseEntity.prototype._rotToDir=function(c,k,e,d,f){var a=okAllocator.array();a.push(this.mMat.getColumn(0),this.mMat.getColumn(1),this.mMat.getColumn(2));var m=a[0].len();var l=a[1].len();var h=a[2].len();a[0].normalize(true);a[1].normalize(true);a[2].normalize(true);var n=c-1;if(typeof k=="number"){a[n].x=k;a[n].y=e;a[n].z=d}else{a[n].x=k.x;a[n].y=k.y;a[n].z=k.z;f=e}a[n].normalize(true);if(c==f){return}var o=((f!=null)?(f-1):null);if(o==null||o==((n+2)%3)){var p=a[(n+1)%3].clone();a[(n+1)%3]=okVec3Cross(a[(n+2)%3],a[n]);if(a[(n+1)%3].equal(OAK.VEC3_ZERO)){okAllocator._vec3(a[(n+1)%3]);a[(n+1)%3]=p;okAllocator._vec3(a[(n+2)%3]);a[(n+2)%3]=okVec3Cross(a[n],a[(n+1)%3]);okAllocator._vec3(a[(n+1)%3]);a[(n+1)%3]=okVec3Cross(a[(n+2)%3],a[n])}else{okAllocator._vec3(p);okAllocator._vec3(a[(n+2)%3]);a[(n+2)%3]=okVec3Cross(a[n],a[(n+1)%3])}}else{var p=a[(n+2)%3].clone();a[(n+2)%3]=okVec3Cross(a[n],a[(n+1)%3]);if(a[(n+2)%3].equal(OAK.VEC3_ZERO)){okAllocator._vec3(a[(n+2)%3]);a[(n+2)%3]=p;okAllocator._vec3(a[(n+1)%3]);a[(n+1)%3]=okVec3Cross(a[(n+2)%3],a[n]);okAllocator._vec3(a[(n+2)%3]);a[(n+2)%3]=okVec3Cross(a[n],a[(n+1)%3])}else{okAllocator._vec3(p);okAllocator._vec3(a[(n+1)%3]);a[(n+1)%3]=okVec3Cross(a[(n+2)%3],a[n])}}a[0].normalize(true);a[1].normalize(true);a[2].normalize(true);this.mMat.m00=a[0].x*m;this.mMat.m10=a[0].y*m;this.mMat.m20=a[0].z*m;this.mMat.m01=a[1].x*l;this.mMat.m11=a[1].y*l;this.mMat.m21=a[1].z*l;this.mMat.m02=a[2].x*h;this.mMat.m12=a[2].y*h;this.mMat.m22=a[2].z*h;this.bMatNDirty=true;this.bMatInvDirty=true;this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true;this.dirtyMatFunc();this.zone.dirtyEntity(this);okAllocator._vec3(a[0]);okAllocator._vec3(a[1]);okAllocator._vec3(a[2]);okAllocator._array(a)};okBaseEntity.prototype.rotQuat=function(h,f){var a=f.toMat43();if(h==3){var c=okMat43Mul(a,this.mMat);okAllocator._mat43(this.mMat);this.mMat=c}else{if(h==2&&this.parent){var d=okMat43Mul(this.mMatToP,this.mMat);d=okMat43Mul(a,d);okAllocator._mat43(this.mMat);this.mMat=okMat43Mul(this.parent.mMat,d)}else{var c=okMat43Mul(this.mMat,a);okAllocator._mat43(this.mMat);this.mMat=c}}okAllocator._mat43(a);this.bMatNDirty=true;this.bMatInvDirty=true;this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true;this.dirtyMatFunc();this.zone.dirtyEntity(this);var e=this.aChildren.getRoot();while(e){e.data._updateMat(false);e=e.next}};okBaseEntity.prototype.rotX=function(h,f){var a=okMat43RotX(f);if(h==3){var c=okMat43Mul(a,this.mMat);okAllocator._mat43(this.mMat);this.mMat=c}else{if(h==2&&this.parent){var d=okMat43Mul(this.mMatToP,this.mMat);d=okMat43Mul(a,d);okAllocator._mat43(this.mMat);this.mMat=okMat43Mul(this.parent.mMat,d)}else{var c=okMat43Mul(this.mMat,a);okAllocator._mat43(this.mMat);this.mMat=c}}okAllocator._mat43(a);this.bMatNDirty=true;this.bMatInvDirty=true;this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true;this.dirtyMatFunc();this.zone.dirtyEntity(this);var e=this.aChildren.getRoot();while(e){e.data._updateMat(false);e=e.next}};okBaseEntity.prototype.rotY=function(h,f){var a=okMat43RotY(f);if(h==3){var c=okMat43Mul(a,this.mMat);okAllocator._mat43(this.mMat);this.mMat=c}else{if(h==2&&this.parent){var d=okMat43Mul(this.mMatToP,this.mMat);d=okMat43Mul(a,d);okAllocator._mat43(this.mMat);this.mMat=okMat43Mul(this.parent.mMat,d)}else{var c=okMat43Mul(this.mMat,a);okAllocator._mat43(this.mMat);this.mMat=c}}okAllocator._mat43(a);this.bMatNDirty=true;this.bMatInvDirty=true;this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true;this.dirtyMatFunc();this.zone.dirtyEntity(this);var e=this.aChildren.getRoot();while(e){e.data._updateMat(false);e=e.next}};okBaseEntity.prototype.rotZ=function(h,f){var a=okMat43RotZ(f);if(h==3){var c=okMat43Mul(a,this.mMat);okAllocator._mat43(this.mMat);this.mMat=c}else{if(h==2&&this.parent){var d=okMat43Mul(this.mMatToP,this.mMat);d=okMat43Mul(a,d);okAllocator._mat43(this.mMat);this.mMat=okMat43Mul(this.parent.mMat,d)}else{var c=okMat43Mul(this.mMat,a);okAllocator._mat43(this.mMat);this.mMat=c}}okAllocator._mat43(a);this.bMatNDirty=true;this.bMatInvDirty=true;this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true;this.dirtyMatFunc();this.zone.dirtyEntity(this);var e=this.aChildren.getRoot();while(e){e.data._updateMat(false);e=e.next}};okBaseEntity.prototype.scale=function(l,f,e,d){var k=null;if(e!=null){k=okMat43Scale(f,e,d)}else{if(f.x){k=okMat43Scale(f.x,f.y,f.z)}else{k=okMat43Scale(f,f,f)}}if(l==3){var a=okMat43Mul(k,this.mMat);okAllocator._mat43(this.mMat);this.mMat=a}else{if(l==2&&this.parent){var c=okMat43Mul(this.mMatToP,this.mMat);c=okMat43Mul(k,c);okAllocator._mat43(this.mMat);this.mMat=okMat43Mul(this.parent.mMat,c)}else{var a=okMat43Mul(this.mMat,k);okAllocator._mat43(this.mMat);this.mMat=a}}okAllocator._mat43(k);this.bMatNDirty=true;this.bMatInvDirty=true;this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true;this.dirtyMatFunc();this.zone.dirtyEntity(this);var h=this.aChildren.getRoot();while(h){h.data._updateMat(false);h=h.next}};okBaseEntity.prototype.dirtyMatFunc=function(){};function okVisibleEntity(a){okBaseCall(this,a);this.iType=(1|2|32|64|128|256);this.bVisible=true;this.fVisibleDistance=-1;this.bCastShadow=false;this.bReceiveShadow=true;this.fShadowFadeFactor=0.06;this.fShadowResolution=1;this.bSkybox=false;this.aDctLights=okAllocator.array();this.aPointLights=okAllocator.array();this.aSpotLights=okAllocator.array()}okExtend(okVisibleEntity,okBaseEntity);okVisibleEntity.prototype.clear=function(){this.bVisible=true;this.fVisibleDistance=-1;if(this.bCastShadow){this.zone.iCastShadowEntityNum-=1}this.bCastShadow=false;this.bReceiveShadow=true;this.fShadowFadeFactor=0.0001;this.fShadowResolution=1;this.bSkybox=false;this.clearLight();okBaseCall(this,"clear")};okVisibleEntity.prototype.addLight=function(a){if(a.iType==4){this.aDctLights.push(a)}else{if(a.iType==8){this.aPointLights.push(a)}else{if(a.iType==16){this.aSpotLights.push(a)}}}};okVisibleEntity.prototype.removeLight=function(c){var e=null;if(c.iType==4){e=this.aDctLights}else{if(c.iType==8){e=this.aPointLights}else{if(c.iType==16){e=this.aSpotLights}}}if(e==null){return}var a=e.length;for(var d=0;d<a;++d){if(e[d]==c){e[d]=e[a-1];e.pop();break}}};okVisibleEntity.prototype.findLight=function(c){var e=null;if(c.iType==4){e=this.aDctLights}else{if(c.iType==8){e=this.aPointLights}else{if(c.iType==16){e=this.aSpotLights}}}if(e==null){return false}var a=e.length;for(var d=0;d<a;++d){if(e[d]==c){return true}}};okVisibleEntity.prototype.clearLight=function(){this.aDctLights.length=0;this.aPointLights.length=0;this.aSpotLights.length=0};okVisibleEntity.prototype.enableVisible=function(a){this.bVisible=a};okVisibleEntity.prototype.isVisible=function(){return this.bVisible};okVisibleEntity.prototype.setVisibleDistance=function(a){this.fVisibleDistance=a};okVisibleEntity.prototype.getVisibleDistance=function(){return this.fVisibleDistance};okVisibleEntity.prototype.enableSkyBox=function(a){this.bSkybox=a;this.zone.forceVisibleEntity(this,a)};okVisibleEntity.prototype.isSkyBox=function(){return this.bSkybox};okVisibleEntity.prototype.enableCastShadow=function(a){if(a!=this.bCastShadow){if(a){this.zone.iCastShadowEntityNum+=1}else{this.zone.iCastShadowEntityNum-=1}this.bCastShadow=a}};okVisibleEntity.prototype.isCastShadow=function(){return this.bCastShadow};okVisibleEntity.prototype.enableReceiveShadow=function(a){this.bReceiveShadow=a};okVisibleEntity.prototype.isReceiveShadow=function(){return this.bReceiveShadow};okVisibleEntity.prototype.setShadowFade=function(a){this.fShadowFadeFactor=a};okVisibleEntity.prototype.getShadowFade=function(){return this.fShadowFadeFactor};okVisibleEntity.prototype.setShadowResolution=function(a){this.fShadowResolution=a};okVisibleEntity.prototype.getShadowResolution=function(){return this.fShadowResolution};function okStaticEntity(a){okBaseCall(this,a);this.iType=1;this.iModelId=-1;this.aMtrlMap=new Object}okExtend(okStaticEntity,okVisibleEntity);okStaticEntity.prototype.clear=function(){var a=this.resourceManager;this.deleteModel();if(this.aMtrlMap){okAllocator._object(this.aMtrlMap)}this.aMtrlMap=okAllocator.object();this.onModelLoad=null;okBaseCall(this,"clear")};okStaticEntity.prototype.getState=function(){if(this.iModelId==-1){return 1}var a=this.resourceManager.getResourceState(this.iModelId);if(a!=5){return 1}return 4};okStaticEntity.prototype.loadModel=function(d,a,e){this.deleteModel();var c=this.zone.scene._packModelUrl(d);this.iModelId=this.resourceManager.createResource(1,c);this.resourceManager.registerListener(this.iModelId,this);if(this.resourceManager.getResourceState(this.iModelId)==2){if(a==null){this.resourceManager.loadModelByUrl(this.iModelId,c,e)}else{this.resourceManager.loadModelByText(this.iModelId,a,e)}}if(this.resourceManager.getResourceState(this.iModelId)==5){this._postLoadModel()}return true};okStaticEntity.prototype.getModel=function(){if(this.iModelId==-1||this.resourceManager.getResourceState(this.iModelId)!=5){return null}return this.resourceManager.getResource(this.iModelId)};okStaticEntity.prototype.deleteModel=function(){if(this.iModelId!=-1){this.resourceManager.deleteResource(this.iModelId);this.resourceManager.removeListener(this.iModelId,this);this.iModelId=-1;this.aMtrlMap=new Object;this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true}};okStaticEntity.prototype.getMaterialMap=function(){return this.aMtrlMap};okStaticEntity.prototype.getMaterial=function(c){if(c==null){for(var a in this.aMtrlMap){return this.aMtrlMap[a]}return null}return this.aMtrlMap[c]};okStaticEntity.prototype.getBoundingBox=function(e){if(e==2){if(this.bOBoxDirty){var c=this.getModel();if(c==null){var d=this.mMat.getColumn(3);this.obox.setMin(d);this.obox.setMax(d);this.obox.setMat(this.mMat);okAllocator._vec3(d)}else{var a=c.getBoundingBox();this.obox.setMin(a.vMin);this.obox.setMax(a.vMax);this.obox.setMat(this.mMat);this.bOBoxDirty=false}}return this.obox}else{if(this.bBBoxDirty){var c=this.getModel();if(c==null){var d=this.mMat.getColumn(3);this.bbox.set(d,d);okAllocator._vec3(d)}else{c.getBoundingBox().clone(this.bbox);this.bbox.transformMat(this.mMat);this.bBBoxDirty=false}}return this.bbox}};okStaticEntity.prototype.genRenderBatch=function(w,s){var u=this.zone.scene;var p=this.resourceManager;var f=this.getModel();if(f==null){return}var m=s.camera;if(this.fVisibleDistance>0){var e=m.getPos();var n=(e.x-this.mMat.m03)*(e.x-this.mMat.m03)+(e.y-this.mMat.m13)*(e.y-this.mMat.m13)+(e.z-this.mMat.m23)*(e.z-this.mMat.m23);if(n>this.fVisibleDistance*this.fVisibleDistance){return}}var a=f.getMeshMap();for(var h in a){var d=a[h];var v=this.getMaterial(h);var k=okAllocator.renderBatch();for(var q=0;q<7;++q){var t=v.getTextureResourceId(q);if(t==-1){continue}var o=p.getResource(t);if(!o){continue}if(o.isVideoTexture()){o.updateVideoTexture()}}k.aAttribFmt=d._getAttribFmt();if(v.bWireframe&&d.aIndexArrayBufferList.Wireframe){k.index=d.aIndexArrayBufferList.Wireframe;k.iDrawMode=1}else{k.index=d.aIndexArrayBufferList.Default;k.iDrawMode=4}k.iDrawStart=0;k.iDrawCount=k.index.getLength();k.materialRef=v;var l=this.getMat43();if(this.bSkybox){l.m03+=m.mCamMat.m03;l.m13+=m.mCamMat.m13;l.m23+=m.mCamMat.m23}k.mMatRef=l;k.mMatNRef=this.getNormalMat43();k.aDctLightListRef=this.aDctLights;k.aPointLightListRef=this.aPointLights;k.aSpotLightListRef=this.aSpotLights;var c=new okAABBox();d.getBoundingBox().clone(c);if(this.bSkybox){c.set(new okVec3(c.vMin.x+m.mCamMat.m03,c.vMin.y+m.mCamMat.m13,c.vMin.z+m.mCamMat.m23),new okVec3(c.vMax.x+m.mCamMat.m03,c.vMax.y+m.mCamMat.m13,c.vMax.z+m.mCamMat.m23))}c.transformMat(this.mMat);k.bboxRef=c;k.bReceiveShadow=this.bReceiveShadow;w.push(k)}};okStaticEntity.prototype.onMessage=function(a){switch(a.sMsg){case"RES_READY":if(this.iModelId==a.aArgs[0]){this._postLoadModel(a.aArgs[0])}break}};okStaticEntity.prototype._postLoadModel=function(){this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true;this.zone.dirtyEntity(this);var a=this.resourceManager.getResource(this.iModelId);if(a){for(var c in a.getMeshMap()){var d=new okMaterial();d.entity=this;a.getMesh(c).getMaterial().clone(d);this.aMtrlMap[c]=d}}if(this.onLoad){this.onLoad(this.getId(),this.iModelId)}else{if(this.onload){this.onload(this.getId(),this.iModelId)}}};function okDynamicEntity(a){okBaseCall(this,a);this.iType=2;this.iModelId=-1;this.aMtrlMap=new Object;this.defaultPlayer=new okSkAnimPlayer();this.aPlayerMap=new Object;this.bboxL=new okAABBox();this.bBBoxLDirty=true}okExtend(okDynamicEntity,okVisibleEntity);okDynamicEntity.prototype.clear=function(){this.deleteModel();this.defaultPlayer.clear();for(var a in this.aPlayerMap){this.aPlayerMap[a].clear()}okAllocator._object(this.aPlayerMap);this.aPlayerMap=okAllocator.object();this.bBBoxLDirty=true;okBaseCall(this,"clear")};okDynamicEntity.prototype.getState=function(){if(this.iModelId==-1){return 1}var a=this.resourceManager.getResourceState(this.iModelId);if(a!=5){return 1}return 4};okDynamicEntity.prototype.loadModel=function(d,a,e){this.deleteModel();var c=this.zone.scene._packModelUrl(d);this.iModelId=this.resourceManager.createResource(1,c);this.resourceManager.registerListener(this.iModelId,this);if(this.resourceManager.getResourceState(this.iModelId)==2){if(a==null){this.resourceManager.loadModelByUrl(this.iModelId,c,e)}else{this.resourceManager.loadModelByText(this.iModelId,a,e)}}if(this.resourceManager.getResourceState(this.iModelId)==5){this._postLoadModel(this.iModelId)}return true};okDynamicEntity.prototype.getModel=function(){if(this.iModelId==-1||this.resourceManager.getResourceState(this.iModelId)!=5){return null}return this.resourceManager.getResource(this.iModelId)};okDynamicEntity.prototype.loadSkAnimation=function(f,l,k,d,h){var a=this.resourceManager;var c=this.zone.scene._packSkAnimationUrl(k);var m=a.createResource(3,c);this.addResourceRef(m);if(a.getResourceState(m)==2){if(d==null){a.loadSkAnimationByUrl(m,c,true)}else{a.loadSkAnimationByText(m,d)}}var e=a.getResource(m);if(h){if(this.aPlayerMap[h]==null){this.aPlayerMap[h]=this.defaultPlayer.clone()}this.aPlayerMap[h].activateChannel(f,true);this.aPlayerMap[h].attachAnim(f,e,l)}else{for(var h in this.aPlayerMap){this.aPlayerMap[h].activateChannel(f,true);this.aPlayerMap[h].attachAnim(f,e,l)}this.defaultPlayer.activateChannel(f,true);this.defaultPlayer.attachAnim(f,e,l)}if(a.getResourceState(m)==5){this._postLoadAnim(m)}return true};okDynamicEntity.prototype.deleteModel=function(){if(this.iModelId!=-1){this.resourceManager.removeListener(this.iModelId,this);this.resourceManager.deleteResource(this.iModelId);this.iModelId=-1;this.aMtrlMap=new Object}};okDynamicEntity.prototype.deleteSkAnimation=function(d,c){if(c==null){for(var c in this.aPlayerMap){for(var a=0;a<2;++a){if(d==-1||a==d){this.aPlayerMap[c].activateChannel(a,false);this.aPlayerMap[c].attachAnim(a,null)}}}}else{if(this.aPlayerMap[c]){for(var a=0;a<2;++a){if(d==-1||a==d){this.aPlayerMap[c].activateChannel(a,false);this.aPlayerMap[c].attachAnim(a,null)}}}}};okDynamicEntity.prototype.getMaterialMap=function(){return this.aMtrlMap};okDynamicEntity.prototype.getMaterial=function(c){if(c==null){for(var a in this.aMtrlMap){return this.aMtrlMap[a]}return null}return this.aMtrlMap[c]};okDynamicEntity.prototype.getBoundingBox=function(f){if(this.bBBoxLDirty){if(this.resourceManager.getResourceState(this.iModelId)==5){var a=this.resourceManager.getResource(this.iModelId);this.bboxL=this.bboxL.union(a.getBoundingBox());this.bboxL=this.bboxL.union(this.defaultPlayer.getBoundingBox());for(var e in a.getMeshMap()){var h=a.getMesh(e);var d=this.aPlayerMap[e];if(d){this.bboxL=this.bboxL.union(d.getBoundingBox())}}}else{this.bboxL.set(OAK.VEC3_ZERO,OAK.VEC3_ZERO)}this.bBBoxLDirty=false;this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true}if(f==2){if(this.bOBoxDirty){var a=this.getModel();if(a==null){var c=this.mMat.getColumn(3);this.obox.setMin(c);this.obox.setMax(c);this.obox.setMat(this.mMat);okAllocator._vec3(c)}else{this.obox.setMin(this.bboxL.vMin);this.obox.setMax(this.bboxL.vMax);this.obox.setMat(this.mMat);this.bOBoxDirty=false}}return this.obox}else{if(this.bBBoxDirty){var a=this.getModel();if(a==null){var c=this.mMat.getColumn(3);this.bbox.set(c,c);okAllocator._vec3(c)}else{this.bboxL.clone(this.bbox);this.bbox.transformMat(this.mMat);this.bBBoxDirty=false}}return this.bbox}};okDynamicEntity.prototype.genRenderBatch=function(x,u){var p=this.resourceManager;var h=this.getModel();if(h==null){return}var m=u.camera;if(this.fVisibleDistance>0){var e=m.getPos();var n=(e.x-this.mMat.m03)*(e.x-this.mMat.m03)+(e.y-this.mMat.m13)*(e.y-this.mMat.m13)+(e.z-this.mMat.m23)*(e.z-this.mMat.m23);if(n>this.fVisibleDistance*this.fVisibleDistance){return}}var a=h.getMeshMap();for(var k in a){var d=a[k];var w=this.getMaterial(k);var l=okAllocator.renderBatch();for(var t=0;t<7;++t){var v=w.getTextureResourceId(t);if(v==-1){continue}var o=p.getResource(v);if(!o){continue}if(o.isVideoTexture()){o.updateVideoTexture()}}l.aAttribFmt=d._getAttribFmt();if(w.bWireframe&&d.aIndexArrayBufferList.Wireframe){l.index=d.aIndexArrayBufferList.Wireframe;l.iDrawMode=1}else{l.index=d.aIndexArrayBufferList.Default;l.iDrawMode=4}l.iDrawStart=0;l.iDrawCount=l.index.getLength();l.materialRef=w;l.mMatRef=this.getMat43();l.mMatNRef=this.getNormalMat43();l.aDctLightListRef=this.aDctLights;l.aPointLightListRef=this.aPointLights;l.aSpotLightListRef=this.aSpotLights;var s=(this.aPlayerMap[k]?this.aPlayerMap[k]:this.defaultPlayer);if(s.getAnim(0)||s.getAnim(1)){var q=d.getSkin();if(s.getSkin()!=q){s.setSkin(q)}var f=s.getBoneFinalMat43Array();l.aBoneMatList=[OAK.MAT43_ZERO].concat(f);if(q){l.sBoneIdxAttribName=q.getVertexBoneIdxAttribName();l.sBoneWeightAttribName=q.getVertexBoneWeightAttribName()}}var c=new okAABBox();d.getBoundingBox().clone(c);c.transformMat(this.mMat);l.bboxRef=c;l.bReceiveShadow=this.bReceiveShadow;x.push(l)}};okDynamicEntity.prototype.activateChannel=function(e,d,c){if(c){if(this.aPlayerMap[c]==null){this.aPlayerMap[c]=this.defaultPlayer.clone()}this.aPlayerMap[c].activateChannel(e,d)}else{for(var a in this.aPlayerMap){this.aPlayerMap[a].activateChannel(e,d)}this.defaultPlayer.activateChannel(e,d)}};okDynamicEntity.prototype.isActive=function(c,a){if(a){if(this.aPlayerMap[a]==null){return this.defaultPlayer.isActive(c)}return this.aPlayerMap[a].isActive(c)}else{return this.defaultPlayer.isActive(c)}};okDynamicEntity.prototype.setSpeed=function(e,a,d){if(d){if(this.aPlayerMap[d]==null){this.aPlayerMap[d]=this.defaultPlayer.clone()}this.aPlayerMap[d].setSpeed(e,a)}else{for(var c in this.aPlayerMap){this.aPlayerMap[c].setSpeed(e,a)}this.defaultPlayer.setSpeed(e,a)}};okDynamicEntity.prototype.getSpeed=function(c,a){if(a){if(this.aPlayerMap[a]==null){return this.defaultPlayer.getSpeed(c)}return this.aPlayerMap[a].getSpeed(c)}else{return this.defaultPlayer.getSpeed(c)}};okDynamicEntity.prototype.enableLoop=function(e,a,d){if(d){if(this.aPlayerMap[d]==null){this.aPlayerMap[d]=this.defaultPlayer.clone()}this.aPlayerMap[d].enableLoop(e,a)}else{for(var c in this.aPlayerMap){this.aPlayerMap[c].enableLoop(e,a)}this.defaultPlayer.enableLoop(e,a)}};okDynamicEntity.prototype.isLoop=function(c,a){if(a){if(this.aPlayerMap[a]==null){return this.defaultPlayer.isLoop(c)}return this.aPlayerMap[a].isLoop(c)}else{return this.defaultPlayer.isLoop(c)}return 0};okDynamicEntity.prototype.setBlendMode=function(d,c){if(c){if(this.aPlayerMap[c]==null){this.aPlayerMap[c]=this.defaultPlayer.clone()}this.aPlayerMap[c].setBlendMode(d)}else{for(var a in this.aPlayerMap){this.aPlayerMap[a].setBlendMode(d)}this.defaultPlayer.setBlendMode(d)}};okDynamicEntity.prototype.getBlendMode=function(a){if(a){if(this.aPlayerMap[a]==null){return this.defaultPlayer.getBlendMode()}return this.aPlayerMap[a].getBlendMode()}else{return this.defaultPlayer.getBlendMode()}return 0};okDynamicEntity.prototype.getFrameTime=function(c,a){if(a){if(this.aPlayerMap[a]==null){return this.defaultPlayer.getFrameTime(c)}return this.aPlayerMap[a].getFrameTime(c)}else{return this.defaultPlayer.getFrameTime(c)}return 0};okDynamicEntity.prototype.setTime=function(d,e,c){if(c){if(this.aPlayerMap[c]==null){this.aPlayerMap[c]=this.defaultPlayer.clone()}this.aPlayerMap[c].setTime(d,e)}else{for(var a in this.aPlayerMap){this.aPlayerMap[a].setTime(d,e)}this.defaultPlayer.setTime(d,e)}};okDynamicEntity.prototype.update=function(a,d){if(d){if(this.aPlayerMap[d]==null){this.aPlayerMap[d]=this.defaultPlayer.clone()}this.aPlayerMap[d].update(-1,a)}else{for(var c in this.aPlayerMap){this.aPlayerMap[c].update(-1,a)}this.defaultPlayer.update(-1,a)}};okDynamicEntity.prototype.onMessage=function(a){switch(a.sMsg){case"RES_READY":if(this.iModelId==a.aArgs[0]){this._postLoadModel(a.aArgs[0])}else{this._postLoadAnim(a.aArgs[0])}break}};okDynamicEntity.prototype._postLoadModel=function(a){var c=this.resourceManager.getResource(this.iModelId);var c=this.resourceManager.getResource(this.iModelId);if(c){for(var d in c.getMeshMap()){var e=new okMaterial();e.entity=this;c.getMesh(d).getMaterial().clone(e);this.aMtrlMap[d]=e}}this.bBBoxLDirty=true;this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true;this.zone.dirtyEntity(this);if(this.onLoad){this.onLoad(this.getId(),a)}if(this.onload){this.onload(this.getId(),a)}};okDynamicEntity.prototype._postLoadAnim=function(a){this.bBBoxLDirty=true;this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true;this.zone.dirtyEntity(this);if(this.onLoad){this.onLoad(this.getId(),a)}if(this.onload){this.onload(this.getId(),a)}};function okCustomMeshEntity(a){okBaseCall(this,a);this.iType=64;this.mesh=new okMesh(this.resourceManager.rc);this.mtrl=new okMaterial();this.mtrl.entity=this;this.sDrawIndex="";this.iDrawMode=0;this.iDrawStart=0;this.iDrawCount=0;this.bboxL=new okAABBox()}okExtend(okCustomMeshEntity,okVisibleEntity);okCustomMeshEntity.prototype.clear=function(){this.mesh.clear();this.mtrl.clear();this.sDrawIndex="";this.iDrawMode=0;this.iDrawStart=0;this.iDrawCount=0;this.bboxL=new okAABBox();okBaseCall(this,"clear")};okCustomMeshEntity.prototype.getMesh=function(){return this.mesh};okCustomMeshEntity.prototype.setVertexNum=function(a){this.mesh.setVertexNum(a)};okCustomMeshEntity.prototype.getVertexNum=function(){return this.mesh.getVertexNum()};okCustomMeshEntity.prototype.createAttribute=function(d,a,c,e){this.mesh.createAttribute(d,a,c,e)};okCustomMeshEntity.prototype.loadAttribute=function(e,c,a,d){this.mesh.loadAttribute(e,c,a,d)};okCustomMeshEntity.prototype.deleteAttribute=function(a){this.mesh.deleteAttribute(a)};okCustomMeshEntity.prototype.createIndex=function(c,a,e,f,d){this.mesh.createIndex(c,a,e,f,d)};okCustomMeshEntity.prototype.loadIndex=function(e,c,a,d){this.mesh.loadIndex(e,c,a,d)};okCustomMeshEntity.prototype.deleteIndex=function(a){this.mesh.deleteIndex(a)};okCustomMeshEntity.prototype.setIndexTopology=function(a,c){this.mesh.setIndexTopology(a,c)};okCustomMeshEntity.prototype.getIndexTopology=function(a){return this.mesh.getIndexTopology(a)},okCustomMeshEntity.prototype.setActiveIndex=function(c,d,a,e){this.sDrawIndex=((c!=null)?c:"");this.iDrawMode=((d!=null)?d:this.mesh.getIndexTopology());this.iDrawStart=((a!=null)?a:0);this.iDrawCount=((e!=null)?e:0)};okCustomMeshEntity.prototype.getAttributeNum=function(){return this.mesh.iAttribCount};okCustomMeshEntity.prototype.getIndexNum=function(){return this.mesh.iIndexCount};okCustomMeshEntity.prototype.getAttributeArray=function(a){return this.mesh.aAttribDataList[a]};okCustomMeshEntity.prototype.getAttributeArrayBuffer=function(a){return this.mesh.aAttribArrayBufferList[a]};okCustomMeshEntity.prototype.getIndexArray=function(a){return this.mesh.aIndexDataList[a]};okCustomMeshEntity.prototype.getIndexArrayBuffer=function(a){return this.mesh.aIndexArrayBufferList[a]};okCustomMeshEntity.prototype.getMaterial=function(){return this.mtrl};okCustomMeshEntity.prototype.setBoundingBox=function(f,e,d){if(f==1){this.bboxL.set(e,d)}else{if(f==3){var a=this.mMat.inverse();var c=okMat43MulVec3(a,e);var h=okMat43MulVec3(a,d);this.bboxL.set(c,h);okAllocator._vec3(c);okAllocator._vec3(h)}}this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true;this.zone.dirtyEntity(this)};okCustomMeshEntity.prototype.computeBoundingBox=function(){this.mesh.computeBoundingInfo();this.mesh.getBoundingBox().clone(this.bboxL);this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true;this.zone.dirtyEntity(this)};okCustomMeshEntity.prototype.getBoundingBox=function(a){if(a==2){if(this.bOBoxDirty){this.obox.setMin(this.bboxL.vMin);this.obox.setMax(this.bboxL.vMax);this.obox.setMat(this.mMat);this.bOBoxDirty=false}return this.obox}else{if(this.bBBoxDirty){this.bboxL.clone(this.bbox);this.bbox.transformMat(this.mMat);this.bBBoxDirty=false}return this.bbox}};okCustomMeshEntity.prototype.genRenderBatch=function(d,l){var a=l.camera;var c=this.resourceManager;if(this.fVisibleDistance>0){var f=a.getPos();var o=(f.x-this.mMat.m03)*(f.x-this.mMat.m03)+(f.y-this.mMat.m13)*(f.y-this.mMat.m13)+(f.z-this.mMat.m23)*(f.z-this.mMat.m23);if(o>this.fVisibleDistance*this.fVisibleDistance){return}}var s=this.mesh;var h=this.mtrl;var n=okAllocator.renderBatch();for(var e=0;e<7;++e){var q=h.getTextureResourceId(e);if(q==-1){continue}var m=c.getResource(q);if(!m){continue}if(m.isVideoTexture()){m.updateVideoTexture()}}n.aAttribFmt=s._getAttribFmt();if(this.sDrawIndex==""){if(h.bWireframe&&s.aIndexArrayBufferList.Wireframe){n.index=s.aIndexArrayBufferList.Wireframe;n.iDrawMode=1}else{n.index=s.aIndexArrayBufferList.Default;n.iDrawMode=4}n.iDrawStart=0;n.iDrawCount=n.index.getLength()}else{n.index=s.getIndexArrayBuffer(this.sDrawIndex);n.iDrawMode=this.iDrawMode;n.iDrawStart=this.iDrawStart;n.iDrawCount=this.iDrawCount}n.materialRef=h;var k=this.getMat43();if(this.bSkybox){k.m03+=a.mCamMat.m03;k.m13+=a.mCamMat.m13;k.m23+=a.mCamMat.m23}n.mMatRef=k;n.mMatNRef=this.getNormalMat43();n.aDctLightListRef=this.aDctLights;n.aPointLightListRef=this.aPointLights;n.aSpotLightListRef=this.aSpotLights;var p=new okAABBox();s.getBoundingBox().clone(p);p.transformMat(this.mMat);n.bboxRef=p;n.bReceiveShadow=this.bReceiveShadow;d.push(n)};function okParticle(){this.lf=0;this.tlf=0;this.m=new okMat43();this.v=new okVec3();this.ac=new okVec3();this.s=new okVec2(0.1,0.1);this.s0=new okVec2(0.1,0.1);this.s1=new okVec2(0.1,0.1);this.c=new okVec3(1,1,1);this.c0=new okVec3();this.c1=new okVec3();this.a=0;this.fdi=0;this.fdo=0}function okParticleEntity(a){okBaseCall(this,a);this.iType=256;this.mesh=new okMesh(this.resourceManager.rc);this.sTexName="";var c=this.mesh.getMaterial();c.entity=this;c.setEmissive(0,0,0);c.setDiffuse(1,1,1);c.enableBlend(true);c.enableDynamicLighting(false);c.enableTwoSide(true);c.enableDepthWrite(false);c.setDiffuseScript("VC");c.setAlphaScript("TC2.x * ALPHA");this.aParticles=new okList();this.iMaxCount=-1;this.bAutoCalMaxCount=true;this.bMaxCountDirty=true;this.aLife=[3000,3000];this.fEmitCycle=50;this.iEmitFlow=1;this.fEmitLastTime=50;this.aEmitDirRange=[0,30];this.aEmitPosRange=[new okVec3(0,0,0),new okVec3(0,0,0)];this.aEmitV=[1,1];this.aA=[new okVec3(0,0,0),new okVec3(0,0,0)];this.aSize0=[new okVec2(0.5,0.5),new okVec2(0.5,0.5)];this.aSize1=[new okVec2(0.5,0.5),new okVec2(0.5,0.5)];this.bVarySize=false;this.aColor0=[new okVec3(1,1,1),new okVec3(1,1,1)];this.aColor1=[new okVec3(1,1,1),new okVec3(1,1,1)];this.bVaryColor=false;this.aFadeIn=[1000,1000];this.aFadeOut=[1000,1000];this.iAnimWidth=1;this.iAnimHeight=1;this.iAnimCount=1;this.aAttribFmt=okAllocator.object();this.aAttribFmt.Position=new okAttribFormat();this.aAttribFmt.Color=new okAttribFormat();this.aAttribFmt.Texcoord1=new okAttribFormat();this.aAttribFmt.Texcoord2=new okAttribFormat();this.aAttribFmt.Position=new okAttribFormat();this.aAttribFmt.Position.sName="Position";this.aAttribFmt.Position.iIdx=0;this.aAttribFmt.Position.iOffset=0;this.aAttribFmt.Position.iSize=3;this.aAttribFmt.Position.iStride=3;this.aAttribFmt.Color=new okAttribFormat();this.aAttribFmt.Color.sName="Color";this.aAttribFmt.Color.iIdx=0;this.aAttribFmt.Color.iOffset=0;this.aAttribFmt.Color.iSize=3;this.aAttribFmt.Color.iStride=7;this.aAttribFmt.Texcoord1=new okAttribFormat();this.aAttribFmt.Texcoord1.sName="Texcoord1";this.aAttribFmt.Texcoord1.iIdx=1;this.aAttribFmt.Texcoord1.iOffset=3;this.aAttribFmt.Texcoord1.iSize=2;this.aAttribFmt.Texcoord1.iStride=7;this.aAttribFmt.Texcoord2=new okAttribFormat();this.aAttribFmt.Texcoord2.sName="Texcoord2";this.aAttribFmt.Texcoord2.iIdx=2;this.aAttribFmt.Texcoord2.iOffset=5;this.aAttribFmt.Texcoord2.iSize=2;this.aAttribFmt.Texcoord2.iStride=7;this.bActive=true}okExtend(okParticleEntity,okVisibleEntity);okParticleEntity.prototype.setTexture=function(a,c,e,f,d){var h=this.mesh.getMaterial();h.setTextureName(0,a);h.setTextureCoord(0,"Texcoord1");if(a!=""){h.setDiffuseScript("VC * (ALBEDO1, TC1).rgb")}else{h.setDiffuseScript("VC")}if(a!=""){h.setAlphaScript("TC2.x * ALPHA * (ALBEDO1, TC1)."+(okIsString(c)?c.toLowerCase():"a"))}else{h.setAlphaScript("TC2.x * ALPHA")}this.iAnimWidth=(e?e:1);this.iAnimHeight=(f?f:1);this.iAnimCount=(d?d:1)};okParticleEntity.prototype.setParticleMaxNum=function(a){if(a!=this.iMaxCount){this.iMaxCount=Math.min(a,16384);this.bAutoCalMaxCount=(this.iMaxCount<0);this.bMaxCountDirty=true}};okParticleEntity.prototype._evalMaxNum=function(){if(this.bAutoCalMaxCount){this.iMaxCount=Math.floor(this.aLife[1]/this.fEmitCycle*this.iEmitFlow)+1;this.iMaxCount=Math.min(this.iMaxCount,16384)}this.mesh.createAttribute("Position",this.iMaxCount*4*3,null,35048);this.mesh.createAttribute("Color/Texcoord1/Texcoord2",this.iMaxCount*4*7,null,35048);var a=okAllocator.array();for(var c=0;c<this.iMaxCount;++c){a.push(c*4,c*4+1,c*4+3,c*4+3,c*4+1,c*4+2)}this.mesh.createIndex("Default",this.iMaxCount*2*3,a,35048,4);okAllocator._array(a)};okParticleEntity.prototype.getParticleMaxNum=function(){return this.iMaxCount};okParticleEntity.prototype.setEmitDir=function(d,c,a){this._rotToDir(2,d,c,a)};okParticleEntity.prototype.getEmitDir=function(){return this.mMat.getColumn(2)};okParticleEntity.prototype.setEmitDirRange=function(a,c){this.aEmitDirRange[0]=a;this.aEmitDirRange[1]=((c!=null)?c:a)};okParticleEntity.prototype.getEmitDirRangeMin=function(){return this.aEmitDirRange[0]};okParticleEntity.prototype.getEmitDirRangeMax=function(){return this.aEmitDirRange[1]};okParticleEntity.prototype.setEmitCycle=function(a){this.fEmitCycle=a;this.fEmitLastTime=a;if(this.bAutoCalMaxCount){this.bMaxCountDirty=true}};okParticleEntity.prototype.getEmitCycle=function(){return this.fEmitCycle};okParticleEntity.prototype.setEmitFlow=function(a){this.iEmitFlow=a;if(this.bAutoCalMaxCount){this.bMaxCountDirty=true}};okParticleEntity.prototype.getEmitFlow=function(){return this.iEmitFlow};okParticleEntity.prototype.setEmitPos=function(d,c,a){this.setPos(d,c,a)};okParticleEntity.prototype.getEmitPos=function(){return this.mMat.getColumn(3)};okParticleEntity.prototype.setEmitPosRange=function(c,e,h,a,d,f){if(f!=null){this.aEmitPosRange[0].x=c;this.aEmitPosRange[0].y=e;this.aEmitPosRange[0].z=h;this.aEmitPosRange[1].x=a;this.aEmitPosRange[1].y=d;this.aEmitPosRange[1].z=f}else{if(fZ!=null){this.aEmitPosRange[0].x=c;this.aEmitPosRange[0].y=e;this.aEmitPosRange[0].z=h;this.aEmitPosRange[1].x=c;this.aEmitPosRange[1].y=e;this.aEmitPosRange[1].z=h}else{if(fY!=null){this.aEmitPosRange[0].x=c.x;this.aEmitPosRange[0].y=c.y;this.aEmitPosRange[0].z=c.z;this.aEmitPosRange[1].x=e.x;this.aEmitPosRange[1].y=e.y;this.aEmitPosRange[1].z=e.z}else{this.aEmitPosRange[0].x=c.x;this.aEmitPosRange[0].y=c.y;this.aEmitPosRange[0].z=c.z;this.aEmitPosRange[1].x=c.x;this.aEmitPosRange[1].y=c.y;this.aEmitPosRange[1].z=c.z}}}};okParticleEntity.prototype.getEmitPosRangeMin=function(){return this.aEmitOffset[0].clone()};okParticleEntity.prototype.getEmitPosRangeMax=function(){return this.aEmitOffset[1].clone()};okParticleEntity.prototype.setEmitVelocity=function(a,c){this.aEmitV[0]=a;this.aEmitV[1]=(c!=null?c:a)};okParticleEntity.prototype.getEmitVelocityMin=function(){return this.aEmitV[0]};okParticleEntity.prototype.getEmitVelocityMax=function(){return this.aEmitV[1]};okParticleEntity.prototype.setParticleLife=function(a,c){this.aLife[0]=a;this.aLife[1]=((c!=null)?c:a);if(this.bAutoCalMaxCount){this.bMaxCountDirty=true}};okParticleEntity.prototype.getParticleLifeMin=function(){return this.aLife[0]};okParticleEntity.prototype.getParticleLifeMax=function(){return this.aLife[1]};okParticleEntity.prototype.setParticleAcceleration=function(c,e,h,a,d,f){if(f!=null){this.aA[0].x=c;this.aA[0].y=e;this.aA[0].z=h;this.aA[1].x=a;this.aA[1].y=d;this.aA[1].z=f}else{if(h!=null){this.aA[0].x=c;this.aA[0].y=e;this.aA[0].z=h;this.aA[1].x=c;this.aA[1].y=e;this.aA[1].z=h}else{if(e!=null){this.aA[0].x=c.x;this.aA[0].y=c.y;this.aA[0].z=c.z;this.aA[1].x=e.x;this.aA[1].y=e.y;this.aA[1].z=e.z}else{this.aA[0].x=c.x;this.aA[0].y=c.y;this.aA[0].z=c.z;this.aA[1].x=c.x;this.aA[1].y=c.y;this.aA[1].z=c.z}}}};okParticleEntity.prototype.getParticleAccelerationMin=function(){return this.aA[0].clone()};okParticleEntity.prototype.getParticleAccelerationMax=function(){return this.aA[1].clone()};okParticleEntity.prototype.setParticleSize=function(a,d,f,c,e){if(a&1){if(e!=null){this.aSize0[0].x=d;this.aSize0[0].y=f;this.aSize0[1].x=c;this.aSize0[1].y=e}else{if(okIsNumber(f)){this.aSize0[0].x=d;this.aSize0[0].y=f;this.aSize0[1].x=d;this.aSize0[1].y=f}else{if(f){this.aSize0[0].x=d.x;this.aSize0[0].y=d.y;this.aSize0[1].x=f.x;this.aSize0[1].y=f.y}else{this.aSize0[0].x=d.x;this.aSize0[0].y=d.y;this.aSize0[1].x=d.x;this.aSize0[1].y=d.y}}}}if(a&2){if(e!=null){this.aSize1[0].x=d;this.aSize1[0].y=f;this.aSize1[1].x=c;this.aSize1[1].y=e}else{if(okIsNumber(f)){this.aSize1[0].x=d;this.aSize1[0].y=f;this.aSize1[1].x=d;this.aSize1[1].y=f}else{if(f){this.aSize1[0].x=d.x;this.aSize1[0].y=d.y;this.aSize1[1].x=f.x;this.aSize1[1].y=f.y}else{this.aSize1[0].x=d.x;this.aSize1[0].y=d.y;this.aSize1[1].x=d.x;this.aSize1[1].y=d.y}}}}};okParticleEntity.prototype.getParticleSizeMin=function(a){if(a==1){return this.aSize0[0].clone()}else{return this.aSize1[0].clone()}};okParticleEntity.prototype.getParticleSizeMax=function(a){if(a==OAK.PTIME_BEGIN){return this.aSize0[1].clone()}else{return this.aSize1[1].clone()}};okParticleEntity.prototype.enableVarySize=function(a){this.bVarySize=a};okParticleEntity.prototype.isVarySize=function(){return this.bVarySize};okParticleEntity.prototype.setParticleColor=function(a,h,f,k,d,c,e){if(a&1){if(e!=null){this.aColor0[0].x=h;this.aColor0[0].y=f;this.aColor0[0].z=k;this.aColor0[1].x=d;this.aColor0[1].y=c;this.aColor0[1].z=e}else{if(k!=null){this.aColor0[0].x=h;this.aColor0[0].y=f;this.aColor0[0].z=k;this.aColor0[1].x=h;this.aColor0[1].y=f;this.aColor0[1].z=k}else{if(f!=null){this.aColor0[0].x=h.x;this.aColor0[0].y=h.y;this.aColor0[0].z=h.z;this.aColor0[1].x=f.x;this.aColor0[1].y=f.y;this.aColor0[1].z=f.z}else{this.aColor0[0].x=h.x;this.aColor0[0].y=h.y;this.aColor0[0].z=h.z;this.aColor0[1].x=h.x;this.aColor0[1].y=h.y;this.aColor0[1].z=h.z}}}}if(a&2){if(e!=null){this.aColor1[0].x=h;this.aColor1[0].y=f;this.aColor1[0].z=k;this.aColor1[1].x=d;this.aColor1[1].y=c;this.aColor1[1].z=e}else{if(k!=null){this.aColor1[0].x=h;this.aColor1[0].y=f;this.aColor1[0].z=k;this.aColor1[1].x=h;this.aColor1[1].y=f;this.aColor1[1].z=k}else{if(f!=null){this.aColor1[0].x=h.x;this.aColor1[0].y=h.y;this.aColor1[0].z=h.z;this.aColor1[1].x=f.x;this.aColor1[1].y=f.y;this.aColor1[1].z=f.z}else{this.aColor1[0].x=h.x;this.aColor1[0].y=h.y;this.aColor1[0].z=h.z;this.aColor1[1].x=h.x;this.aColor1[1].y=h.y;this.aColor1[1].z=h.z}}}}};okParticleEntity.prototype.getParticleColorMin=function(a){if(a==1){return this.aColor0[0].clone()}else{return this.aColor1[0].clone()}};okParticleEntity.prototype.getParticleColorMax=function(a){if(a==1){return this.aColor0[1].clone()}else{return this.aColor1[1].clone()}};okParticleEntity.prototype.enableVaryColor=function(a){this.bVaryColor=a};okParticleEntity.prototype.isVaryColor=function(){return this.bVaryColor};okParticleEntity.prototype.setParticleFadeInTime=function(a,c){this.aFadeIn[0]=a;this.aFadeIn[1]=((c!=null)?c:a)};okParticleEntity.prototype.getParticleFadeInTimeMin=function(){return this.aFadeIn[0]};okParticleEntity.prototype.getParticleFadeInTimeMax=function(){return this.aFadeIn[1]};okParticleEntity.prototype.setParticleFadeOutTime=function(a,c){this.aFadeOut[0]=a;this.aFadeOut[1]=((c!=null)?c:a)};okParticleEntity.prototype.getParticleFadeOutTimeMin=function(){return this.aFadeOut[0]};okParticleEntity.prototype.getParticleFadeOutTimeMax=function(){return this.aFadeOut[1]};okParticleEntity.prototype.getMaterial=function(){return this.mesh.getMaterial()};okParticleEntity.prototype.getBoundingBox=function(a){if(a==2){if(this.bOBoxDirty){this.bOBoxDirty=false}return this.obox}else{if(this.bBBoxDirty){this.bBBoxDirty=false}return this.bbox}};okParticleEntity.prototype.update=function(n){if(!this.bActive){return}if(this.bMaxCountDirty){this._evalMaxNum();this.bMaxCountDirty=false}var e=okAllocator.array();var a=this.getNormalMat43();var q=this.mMat.getColumn(3);var u=this.mMat.getColumn(3);var v=this.aParticles.getRoot();while(v){var s=v.data;s.lf+=n;if(s.lf>s.tlf){var x=v.next;okAllocator._particle(s);this.aParticles.remove(v);v=x;continue}s.m.m03+=s.v.x*n/1000;s.m.m13+=s.v.y*n/1000;s.m.m23+=s.v.z*n/1000;s.v.x+=s.ac.x*n/1000;s.v.y+=s.ac.y*n/1000;s.v.z+=s.ac.z*n/1000;var o=s.lf/s.tlf;if(this.bVarySize){s.s.x=(1-o)*s.s0.x+o*s.s1.x;s.s.y=(1-o)*s.s0.y+o*s.s1.y}if(this.bVaryColor){s.c.x=(1-o)*s.c0.x+o*s.c1.x;s.c.y=(1-o)*s.c0.y+o*s.c1.y;s.c.z=(1-o)*s.c0.z+o*s.c1.z}if(s.lf<=s.fdi){s.a=s.lf/s.fdi}else{if(s.lf>=s.tlf-s.fdo){s.a=(s.tlf-s.lf)/s.fdo}else{s.a=1}}q.x=(q.x<s.m.m03?q.x:s.m.m03);q.y=(q.y<s.m.m13?q.y:s.m.m13);q.z=(q.z<s.m.m23?q.z:s.m.m23);u.x=(u.x>s.m.m03?u.x:s.m.m03);u.y=(u.y>s.m.m13?u.y:s.m.m13);u.z=(u.z>s.m.m23?u.z:s.m.m23);var k=Math.floor(s.lf/s.tlf*this.iAnimCount);var h=Math.floor(k/this.iAnimWidth);var l=k-h*this.iAnimWidth;var c=l/this.iAnimWidth,f=(l+1)/this.iAnimWidth;var z=h/this.iAnimHeight,m=(h+1)/this.iAnimHeight;e.push(s.c.x,s.c.y,s.c.z,c,z,s.a,0,s.c.x,s.c.y,s.c.z,c,m,s.a,0,s.c.x,s.c.y,s.c.z,f,m,s.a,0,s.c.x,s.c.y,s.c.z,f,z,s.a,0);v=v.next}this.fEmitLastTime+=n;if(this.fEmitLastTime>=this.fEmitCycle){this.fEmitLastTime-=this.fEmitCycle;var d=this.iEmitFlow;while(d>0&&this.aParticles.getSize()<this.iMaxCount){d-=1;var s=okAllocator.particle();this.aParticles.pushBack(s);var A=Math.random();s.tlf=(1-A)*this.aLife[0]+A*this.aLife[1];s.lf=0;this.mMat.clone(s.m);A=Math.random();s.m.m03+=(1-A)*this.aEmitPosRange[0].x+A*this.aEmitPosRange[1].x;A=Math.random();s.m.m13+=(1-A)*this.aEmitPosRange[0].y+A*this.aEmitPosRange[1].y;A=Math.random();s.m.m23+=(1-A)*this.aEmitPosRange[0].z+A*this.aEmitPosRange[1].z;A=Math.random();var w=new okVec3(0,1,0);w.rotZ((1-A)*this.aEmitDirRange[0]+A*this.aEmitDirRange[1],true);w.rotY(Math.random()*360,true);w=okMat43MulVec3(a,w);A=Math.random();var y=(1-A)*this.aEmitV[0]+A*this.aEmitV[1];s.v.x=w.x*y;s.v.y=w.y*y;s.v.z=w.z*y;A=Math.random();s.ac.x=(1-A)*this.aA[0].x+A*this.aA[1].x;s.ac.y=(1-A)*this.aA[0].y+A*this.aA[1].y;s.ac.z=(1-A)*this.aA[0].z+A*this.aA[1].z;A=Math.random();s.s0.x=(1-A)*this.aSize0[0].x+A*this.aSize0[1].x;A=Math.random();s.s0.y=(1-A)*this.aSize0[0].y+A*this.aSize0[1].y;A=Math.random();s.s1.x=(1-A)*this.aSize1[0].x+A*this.aSize1[1].x;A=Math.random();s.s1.y=(1-A)*this.aSize1[0].x+A*this.aSize1[1].x;s.s.x=s.s0.x;s.s.y=s.s0.y;A=Math.random();s.c0.x=(1-A)*this.aColor0[0].x+A*this.aColor0[1].x;A=Math.random();s.c0.y=(1-A)*this.aColor0[0].y+A*this.aColor0[1].y;A=Math.random();s.c0.z=(1-A)*this.aColor0[0].z+A*this.aColor0[1].z;A=Math.random();s.c1.x=(1-A)*this.aColor1[0].x+A*this.aColor1[1].x;A=Math.random();s.c1.y=(1-A)*this.aColor1[0].y+A*this.aColor1[1].y;A=Math.random();s.c1.z=(1-A)*this.aColor1[0].z+A*this.aColor1[1].z;s.c.x=s.c0.x;s.c.y=s.c0.y;s.c.z=s.c0.z;A=Math.random();s.fdi=(1-A)*this.aFadeIn[0]+A*this.aFadeIn[1];A=Math.random();s.fdo=(1-A)*this.aFadeOut[0]+A*this.aFadeOut[1];s.a=0;q.x=(q.x<s.m.m03?q.x:s.m.m03);q.y=(q.y<s.m.m13?q.y:s.m.m13);q.z=(q.z<s.m.m23?q.z:s.m.m23);u.x=(u.x>s.m.m03?u.x:s.m.m03);u.y=(u.y>s.m.m13?u.y:s.m.m13);u.z=(u.z>s.m.m23?u.z:s.m.m23);var k=Math.floor(s.lf/s.tlf*this.iAnimCount);var h=Math.floor(k/this.iAnimWidth);var l=k-h*this.iAnimWidth;var c=l/this.iAnimWidth,f=(l+1)/this.iAnimWidth;var z=h/this.iAnimHeight,m=(h+1)/this.iAnimHeight;e.push(s.c.x,s.c.y,s.c.z,c,z,s.a,0,s.c.x,s.c.y,s.c.z,c,m,s.a,0,s.c.x,s.c.y,s.c.z,f,m,s.a,0,s.c.x,s.c.y,s.c.z,f,z,s.a,0)}}this.mesh.loadAttribute("Color/Texcoord1/Texcoord2",0,this.aParticles.getSize()*4*7,e);this.bbox.set(q,u);this.obox.setMin(q);this.obox.setMax(u);this.vBSphCenter.x=(q.x+u.x)*0.5;this.vBSphCenter.y=(q.y+u.y)*0.5;this.vBSphCenter.z=(q.z+u.z)*0.5;this.fBSphRadius=Math.sqrt((u.x-q.x)*(u.x-q.x)+(u.y-q.y)*(u.y-q.y)+(u.z-q.z)*(u.z-q.z))*0.5;this.bBBoxDirty=false;this.bOBoxDirty=false;this.bBSphDirty=false;okAllocator._array(e);okAllocator._vec3(q);okAllocator._vec3(u)};okParticleEntity.prototype.genRenderBatch=function(A,x){if(this.iCount==0||!this.bActive){return}if(this.bMaxCountDirty){this._evalMaxNum();this.bMaxCountDirty=false}var u=this.resourceManager;var w=x.camera;var a=this.mesh;var z=this.mesh.getMaterial();var h=okAllocator.renderBatch();for(var v=0;v<7;++v){var y=z.getTextureResourceId(v);if(y==-1){continue}var n=u.getResource(y);if(!n){continue}if(n.isVideoTexture()){n.updateVideoTexture()}}var e=w.getRightDir();var d=w.getUpDir();var m=okAllocator.vec3();var k=okAllocator.vec3();var l=okAllocator.array();var t=this.aParticles.getRoot();while(t){var s=t.data;var c=s.s.x*0.5,q=s.s.y*0.5;m.x=e.x*c;m.y=e.y*c;m.z=e.z*c;k.x=d.x*q;k.y=d.y*q;k.z=d.z*q;l.push(s.m.m03-m.x+k.x,s.m.m13-m.y+k.y,s.m.m23-m.z+k.z,s.m.m03-m.x-k.x,s.m.m13-m.y-k.y,s.m.m23-m.z-k.z,s.m.m03+m.x-k.x,s.m.m13+m.y-k.y,s.m.m23+m.z-k.z,s.m.m03+m.x+k.x,s.m.m13+m.y+k.y,s.m.m23+m.z+k.z);t=t.next}this.mesh.loadAttribute("Position",0,this.aParticles.getSize()*4*3,l);okAllocator._vec3(e);okAllocator._vec3(d);okAllocator._vec3(m);okAllocator._vec3(k);okAllocator._array(l);h.aAttribFmt=okAllocator.object();var o=this.mesh.aAttribArrayBufferList;this.aAttribFmt.Position.buf=o.Position;this.aAttribFmt.Color.buf=o["Color/Texcoord1/Texcoord2"];this.aAttribFmt.Texcoord1.buf=o["Color/Texcoord1/Texcoord2"];this.aAttribFmt.Texcoord2.buf=o["Color/Texcoord1/Texcoord2"];h.aAttribFmt.Position=this.aAttribFmt.Position;h.aAttribFmt.Color=this.aAttribFmt.Color;h.aAttribFmt.Texcoord1=this.aAttribFmt.Texcoord1;h.aAttribFmt.Texcoord2=this.aAttribFmt.Texcoord2;h.index=a.aIndexArrayBufferList.Default;h.iDrawMode=4;h.iDrawStart=0;h.iDrawCount=this.aParticles.getSize()*6;h.materialRef=z;var f=OAK.MAT43_I;if(this.bSkybox){f.m03+=cam.mCamMat.m03;f.m13+=cam.mCamMat.m13;f.m23+=cam.mCamMat.m23}h.mMatRef=f;h.mMatNRef=OAK.MAT43_I;h.aDctLightListRef=this.aDctLights;h.aPointLightListRef=this.aPointLights;h.aSpotLightListRef=this.aSpotLights;h.bboxRef=this.bbox;h.bReceiveShadow=false;A.push(h)};okParticleEntity.prototype.activate=function(d){this.bActive=d;if(this.bActive=false){var a=this.aParticles.getRoot();while(a){var c=a.data;okAllocator._particle(c);a=a.next}this.aParticles.clear();this.fEmitLastTime=this.fEmitCycle}};okParticleEntity.prototype.isActive=function(){return this.bActive};function okTerrainMesh(a){this.rc=a;this.material=new okMaterial(a);this.parentTerrain;this.aChildMeshArray=new Array;this.localLeafMeshMap=new okArray2D;this.sName;this.bbox=new okAABBox();this.aAttribDataList=new Object;this.aAttribArrayBufferList=new Object;this.iAttribCount=0;this.aIndexDataList=new Object;this.aIndexArrayBufferList=new Object;this.iIndexCount=0;this.iChunkWidth;this.iChunkHeight;this.iTerrainWidth;this.iTerrainHeight;this.gridSpace=new okVec2;this.globalIndex=new okVec2;this.iCurLOD;this.iMaxLOD;this.top=false;this.bottom=false;this.left=false;this.right=false}okTerrainMesh.prototype={clear:function(){for(var e in this.aAttribDataList){if(sAttribName==null||e==sAttribName){delete this.aAttribDataList[e];this.aAttribArrayBufferList[e].releaseBuffer();delete this.aAttribArrayBufferList[e];this.iAttribCount-=1}}for(var d in this.aIndexDataList){if(sIndexName==null||d==sIndexName){delete this.aIndexDataList[d];this.aIndexArrayBufferList[d].releaseBuffer();delete this.aIndexArrayBufferList[d];this.iIndexCount-=1}}for(var a=0;a<this.aChildMeshArray.length;++a){var c=this.aChildMeshArray[a];c.clear()}this.material.clear()},setBoundingBox:function(c,a){var e=new okVec3(c.x,c.y,c.z);var d=new okVec3(a.x,a.y,a.z);if(d==null){e.clone(this.bbox)}else{this.bbox.set(e,d)}},getBoundingBox:function(){return this.bbox},setParentTerrain:function(a){this.parentTerrain=a},getParentTerrain:function(){return this.parentTerrain},getMaterial:function(){return this.material},setGlobalIndex:function(c,a){this.globalIndex.set(c,a)},getGlobalIndex:function(){return this.globalIndex},setChunkSize:function(a,c){this.iChunkWidth=a;this.iChunkHeight=c;this.computeMaxLOD()},getChunkWidth:function(){return this.iChunkWidth},getChunkHeight:function(){return this.iChunkHeight},setTerrainSize:function(a,c){this.iTerrainWidth=a;this.iTerrainHeight=c},setGridSpace:function(a){this.gridSpace=a},setName:function(a){this.sName=a},getName:function(){return this.sName},detectCollision:function(n){var A=this.iChunkWidth;var p=this.iChunkHeight;var e=this.bbox.vMax.x-this.bbox.vMin.x;var B=this.bbox.vMax.y-this.bbox.vMin.y;var t=e/(A-1);var q=B/(p-1);var o=(n.x-this.bbox.vMin.x)/t;var k=(n.y-this.bbox.vMin.y)/q;i=Math.floor(o);j=Math.floor(k);if(i==o&&j==k){var f=this.aAttribDataList.Position;if(!f){return}var v=f[(i+j*A)*3+2];return v}var l=new okVec2(n.x,n.y);var y=i+j*A;var x=(i+1)+(j+1)*A;var u=i+(j+1)*A;var s=(i+1)+j*A;if((i+j)%2==0){if(this._insideTriangle(x,u,y,l)){return this._intersectedPoint(x,u,y,l)}else{if(this._insideTriangle(y,s,x,l)){return this._intersectedPoint(y,s,x,l)}}}else{if(this._insideTriangle(s,y,u,l)){return this._intersectedPoint(s,y,u,l)}else{if(this._insideTriangle(u,x,s,l)){return this._intersectedPoint(u,x,s,l)}}}},_insideTriangle:function(s,p,o,l){var f=this.aAttribDataList.Position;if(!f){return}var d=new okVec2(f[s*3+0],f[s*3+1]);var t=new okVec2(f[p*3+0],f[p*3+1]);var n=new okVec2(f[o*3+0],f[o*3+1]);var v=okVec2Sub(l,d);var u=okVec2Sub(l,t);var q=okVec2Sub(l,n);var k=okVec2Cross(v,u);var h=okVec2Cross(u,q);var e=okVec2Cross(q,v);if(k>=0&&h>=0&&e>=0){return true}if(k<=0&&h<=0&&e<=0){return true}return false},_intersectedPoint:function(v,s,o,f){var e=this.aAttribDataList.Position;if(!e){return}var w=f.x;var q=f.y;var d=new okVec3(e[v*3+0],e[v*3+1],e[v*3+2]);var u=new okVec3(e[s*3+0],e[s*3+1],e[s*3+2]);var l=new okVec3(e[o*3+0],e[o*3+1],e[o*3+2]);var k=d.z-(d.z-u.z)*(d.x-w)/(d.x-u.x);var t=d.y-(d.y-u.y)*(d.x-w)/(d.x-u.x);var h=d.z-(d.z-l.z)*(d.x-w)/(d.x-l.x);var p=d.y-(d.y-l.y)*(d.x-w)/(d.x-l.x);var n=k-(k-h)*(t-q)/(t-p);return n},createAttribute:function(h,a,f,k){if(!this.aAttribDataList[h]){this.aAttribDataList[h]=new Array}for(var d=0;d<f.length;++d){this.aAttribDataList[h].push(f[d])}var e=this.aAttribDataList[h];var c=new okArrayBuffer(this.rc);c.createBuffer(34962,5126,(k!=null)?k:35044,new Float32Array(e));if(this.aAttribArrayBufferList[h]){this.aAttribArrayBufferList[h].releaseBuffer()}this.aAttribArrayBufferList[h]=c},createAttributeData:function(d,a){this.releaseAttributeArrayBuffer(d);if(!this.aAttribDataList[d]){this.aAttribDataList[d]=new Array}for(var c=0;c<a.length;++c){this.aAttribDataList[d].push(a[c])}},releaseAttributeData:function(c){this.releaseAttributeArrayBuffer(c);for(var d in this.aAttribDataList){if(c==null||d==c){var a=this.aAttribDataList[d];delete a;a=[]}}},createAttributeArrayBuffer:function(d,e){for(var f in this.aAttribDataList){if(d==null||f==d){var c=this.aAttribDataList[f];var a=new okArrayBuffer(this.rc);a.createBuffer(34962,5126,(e!=null)?e:35044,new Float32Array(c));if(this.aAttribArrayBufferList[f]){this.aAttribArrayBufferList[f].releaseBuffer()}this.aAttribArrayBufferList[f]=a}}},releaseAttributeArrayBuffer:function(a){for(var c in this.aAttribArrayBufferList){if(a==null||c==a){this.aAttribArrayBufferList[c].releaseBuffer();delete this.aAttribArrayBufferList[c]}}},createIndexData:function(d,a){this.releaseIndexArrayBuffer(d);if(!this.aIndexDataList[d]){this.aIndexDataList[d]=new Array}for(var c=0;c<a.length;++c){this.aIndexDataList[d].push(a[c])}},releaseIndexData:function(a){this.releaseIndexArrayBuffer(a);for(var d in this.aIndexDataList){if(a==null||d==a){var c=this.aIndexDataList[curAttribName];delete c;c=[]}}},createIndexArrayBuffer:function(d){for(var e in this.aIndexDataList){if(d==null||e==d){var a=this.aIndexDataList[e];var c=new okArrayBuffer(this.rc);c.createBuffer(34963,5123,35044,new Uint16Array(a));if(this.aIndexArrayBufferList[e]){this.aIndexArrayBufferList[e].releaseBuffer()}this.aIndexArrayBufferList[e]=c}}},releaseIndexArrayBuffer:function(a){for(var c in this.aIndexArrayBufferList){if(a==null||c==a){this.aIndexArrayBufferList[c].releaseBuffer();delete this.aIndexArrayBufferList[c]}}},distributeAttribute:function(k,n){var m=new Array(this.iChunkWidth*this.iChunkHeight);var l=this.globalIndex.x;var e=this.globalIndex.y;var h=l*(this.iChunkWidth-1);var f=e*(this.iChunkHeight-1);for(var c=0;c<this.iChunkWidth;++c){for(var a=0;a<this.iChunkHeight;++a){var q=h+c;var p=f+a;var o=p*this.iTerrainWidth+q;var d=a*this.iChunkWidth+c;if(k=="Normal"){m[d*3+0]=n[o*3+0];m[d*3+1]=n[o*3+1];m[d*3+2]=n[o*3+2]}else{if(k=="Texcoord1"){m[d*3+0]=n[o*3+0];m[d*3+1]=n[o*3+1]}}}}this.createAttribute(k,m.length,m)},clearFillCrashFlag:function(){this.top=false;this.bottom=false;this.left=false;this.right=false},computeMaxLOD:function(){var c=this.iChunkWidth-1;var d=1;for(var a=0;;++a){d=d*2;if(d>=c){this.iMaxLOD=a+1;return}}},cullByFrustum:function(f,d,e,h){if(e.collideAABBox(this.getBoundingBox())==0){return}this.computeLOD(h);var c=this.globalIndex.x;var a=this.globalIndex.y;f.addElement(c,a,this)},getCurrentLOD:function(){return this.iCurLOD},setCurrentLOD:function(a){this.iCurLOD=a},computeLOD:function(d){var e=this.getBoundingBox();var m=80;var a=new okVec3((e.vMin.x+e.vMax.x)/2,(e.vMin.y+e.vMax.y)/2,e.vMax.z);var l=okVec3Len(a,d);var k=Math.abs(e.vMax.x-e.vMin.x);var h=k*2;for(var f=0;f<=this.iMaxLOD;++f){h=h/2;if(l>=m*h){return}this.iCurLOD=f}},computePosInIndexArray:function(){var c=this.globalIndex.x;var a=this.globalIndex.y;if(this.iCurLOD==0){if((c+a)%2==0){return 0}else{return 1}}else{return(this.iCurLOD<<4)+(8*this.bottom+4*this.right+2*this.top+1*this.left)}},computeNormal:function(){var C=this.aAttribDataList.Position;if(!C){return}var B=this.iChunkWidth;var I=this.iChunkHeight;var A;var v;var u;var F;var E=new Array(B*I);for(var H=0;H<B;++H){for(var G=0;G<I;++G){if(H==0||H==B-1||G==0||G==I-1){A=0;v=0;u=1;F=H+G*B}else{var k=(H-1)+(G-1)*B;var e=H+(G-1)*B;var d=(H+1)+(G-1)*B;var c=(H-1)+G*B;F=H+G*B;var a=(H+1)+G*B;var L=(H-1)+(G+1)*B;var K=H+(G+1)*B;var J=(H+1)+(G+1)*B;var t=C[k*3+2];var s=C[e*3+2];var q=C[d*3+2];var o=C[c*3+2];var D=C[F*3+2];var n=C[a*3+2];var m=C[L*3+2];var l=C[K*3+2];var f=C[J*3+2];A=(t*1+o*2+m*1+q*(-1)+n*(-2)+f*(-1))/8/2;v=(t*1+s*2+q*1+m*(-1)+l*(-2)+f*(-1))/8/2;u=1}E[F*3+0]=A;E[F*3+1]=v;E[F*3+2]=u}}this._normalizeNormals();this.createAttributeData("Normal",E)},computeNormalOfTriangle:function(n,m,l){var k=this.iChunkWidth*this.iChunkHeight;if(n<0||n>=k||m<0||m>=k||l<0||l>=k){return okVec3(0,0,0)}var e=this.aAttribDataList["Position/Normal"];if(!e){return okVec3(0,0,0)}var d=new okVec3(e[n*6],e[n*6+1],e[n*6+2]);var o=new okVec3(e[m*6],e[m*6+1],e[m*6+2]);var h=new okVec3(e[l*6],e[l*6+1],e[l*6+2]);var p=okVec3Sub(d,o);var f=okVec3Sub(h,o);return okVec3Cross(f,p)},_normalizeNormals:function(a){if(!a){return}var e=this.iChunkWidth*this.iChunkHeight;for(var d=0;d<e;++d){var c=new okVec3(a[d*3+0],a[d*3+1],a[d*3+2]);c=c.normalize();a[d*3+0]=c.x;a[d*3+1]=c.y;a[d*3+2]=c.z}},fixNormal:function(f,h){var c=h.x;var k=h.y;var e=f.getElement(c,k-1);this._fixTopNormal(e);var a=f.getElement(c-1,k);this._fixLeftNormal(a);var d=f.getElement(c-1,k-1);this._fixTopLeftNormal(e,a,d)},_fixTopNormal:function(l){if(!l){return}var m=this.aAttribDataList.Position;if(!m){return}var k=l.aAttribDataList.Position;if(!k){return}var d=this.aAttribDataList.Normal;if(!d){return}var c=l.aAttribDataList.Normal;if(!c){return}var H=l.iChunkWidth*(l.iChunkWidth-2);var V=l.iChunkWidth*(l.iChunkWidth-1);for(var O=1;O<this.iChunkWidth-1;++O){var U=H+(O-1);var T=H+O;var S=H+(O+1);var e=V+(O-1);var f=V+O;var K=V+(O+1);var R=O-1;var I=O;var Q=O+1;var N=this.iChunkWidth+(O-1);var M=this.iChunkWidth+O;var L=this.iChunkWidth+(O+1);var B=k[U*3+2];var A=k[T*3+2];var w=k[S*3+2];var a=k[e*3+2];var J=k[f*3+2];var G=k[K*3+2];var u=m[R*3+2];var P=m[I*3+2];var t=m[Q*3+2];var q=m[N*3+2];var o=m[M*3+2];var n=m[L*3+2];var E=(B*1+u*2+q*1+w*(-1)+t*(-2)+n*(-1))/8/2;var D=(B*1+A*2+w*1+q*(-1)+o*(-2)+n*(-1))/8/2;var C=1;var F=new okVec3(E,D,C);F=F.normalize();d[I*3+0]=c[f*3+0]=F.x;d[I*3+1]=c[f*3+1]=F.y;d[I*3+2]=c[f*3+2]=F.z}},_fixLeftNormal:function(d){if(!d){return}var O=this.aAttribDataList.Position;if(!O){return}var N=d.aAttribDataList.Position;if(!N){return}var c=this.aAttribDataList.Normal;if(!c){return}var U=d.aAttribDataList.Normal;if(!U){return}var G=this.iChunkWidth;for(var L=1;L<this.iChunkHeight-1;++L){var l=L*G-2;var k=L*G-1;var m=(L-1)*G;var f=(L-1)*G+1;var e=(L+1)*G-2;var I=(L+1)*G-1;var J=L*G;var a=L*G+1;var T=(L+2)*G-2;var S=(L+2)*G-1;var P=(L+1)*G;var R=(L+1)*G+1;var B=N[l*3+2];var A=N[k*3+2];var K=O[m*3+2];var u=O[f*3+2];var t=N[e*3+2];var M=N[I*3+2];var Q=O[J*3+2];var s=O[a*3+2];var q=N[T*3+2];var o=N[S*3+2];var F=O[P*3+2];var n=O[R*3+2];var E=(B*1+t*2+q*1+u*(-1)+s*(-2)+n*(-1))/8/2;var D=(B*1+A*2+u*1+q*(-1)+o*(-2)+n*(-1))/8/2;var C=1;var H=new okVec3(E,D,C);H=H.normalize();U[I*3+0]=c[J*3+0]=H.x;U[I*3+1]=c[J*3+1]=H.y;U[I*3+2]=c[J*3+2]=H.z}},_fixTopLeftNormal:function(H,B,u){if(!H||!B||!u){return}var O=this.aAttribDataList.Position;if(!O){return}var N=H.aAttribDataList.Position;if(!N){return}var L=B.aAttribDataList.Position;if(!L){return}var K=u.aAttribDataList.Position;if(!K){return}var c=this.aAttribDataList.Normal;if(!c){return}var U=H.aAttribDataList.Normal;if(!U){return}var S=B.aAttribDataList.Normal;if(!S){return}var Q=u.aAttribDataList.Normal;if(!Q){return}var M=this.iChunkHeight;var F=this.iChunkWidth;var l=(M-1)*F-2;var f=(M-1)*F-1;var e=(M-2)*F+1;var d=F-2;var J=0;var a=1;var T=2*F-2;var R=F;var P=F+1;var A=K[l*3+2];var t=K[f*3+2];var s=N[e*3+2];var q=L[d*3+2];var I=O[J*3+2];var o=O[a*3+2];var n=L[T*3+2];var m=O[R*3+2];var k=O[P*3+2];var E=(A*1+q*2+n*1+s*(-1)+o*(-2)+k*(-1))/8/2;var D=(A*1+t*2+s*1+n*(-1)+m*(-2)+k*(-1))/8/2;var C=1;var G=new okVec3(E,D,C);G=G.normalize();c[0+0]=U[(M-1)*F*3+0]=S[(F-1)*3+0]=Q[(M*F-1)*3+0]=G.x;c[0+1]=U[(M-1)*F*3+1]=S[(F-1)*3+1]=Q[(M*F-1)*3+1]=G.y;c[0+2]=U[(M-1)*F*3+2]=S[(F-1)*3+2]=Q[(M*F-1)*3+2]=G.z}};function okTerrainTile(a){this.rc=a;this.aChildMeshArray=new Array;this.localLeafMeshMap=new okArray2D;this.bbox=new okAABBox();this.iState=1;this.sUrl="";this.parentTerrain;this.iChunkWidth;this.iChunkHeight;this.iTerrainWidth;this.iTerrainHeight;this.iWorldMapWidth;this.iWorldMapHeight;this.globalIndex=new okVec2}okTerrainTile.prototype={setParentTerrain:function(a){this.parentTerrain=a},getParentTerrain:function(){return this.parentTerrain},setBoundingBox:function(c,a){var e=new okVec3(c.x,c.y,c.z);var d=new okVec3(a.x,a.y,a.z);if(d==null){e.clone(this.bbox)}else{this.bbox.set(e,d)}},getBoundingBox:function(){var a=new okAABBox();this.bbox.clone(a);return a},setUrl:function(a){this.sUrl=a},getUrl:function(){return this.sUrl},setGlobalIndex:function(c,a){this.globalIndex.set(c,a)},getGlobalIndex:function(){return this.globalIndex},setChunkSize:function(a,c){this.iChunkWidth=a;this.iChunkHeight=c},getChunkWidth:function(){return this.iChunkWidth},getChunkHeight:function(){return this.iChunkHeight},setWorldMapSize:function(a,c){this.iWorldMapWidth=a;this.iWorldMapHeight=c},setTerrainSize:function(a,c){this.iTerrainWidth=a;this.iTerrainHeight=c},setGridSpace:function(a){this.gridSpace=a},setState:function(a){this.iState=a},getState:function(){return this.iState},getMaterialArray:function(){var h=new Array;this.createLocalLeafMeshMap();var a=this.localLeafMeshMap.getOneDimLength();var f=this.localLeafMeshMap.getTwoDimLength();for(var e=0;e<a;++e){for(var d=0;d<f;++d){var c=this.localLeafMeshMap.getElement(e,d);if(!c){continue}h.push(c.getMaterial())}}return h},getMaterialMap:function(){var k=new Array;this.createLocalLeafMeshMap();var a=this.localLeafMeshMap.getOneDimLength();var h=this.localLeafMeshMap.getTwoDimLength();for(var e=0;e<a;++e){for(var d=0;d<h;++d){var c=this.localLeafMeshMap.getElement(e,d);if(!c){continue}var f=c.getName();k[f]=c.getMaterial()}}return k},getMaterial:function(f){this.createLocalLeafMeshMap();var a=this.localLeafMeshMap.getOneDimLength();var h=this.localLeafMeshMap.getTwoDimLength();for(var e=0;e<a;++e){for(var d=0;d<h;++d){var c=this.localLeafMeshMap.getElement(e,d);if(!c){continue}if(c.getName()==f){return c.getMaterial()}}}return NULL},getLeafChunkMap:function(){this.createLocalLeafMeshMap();return this.localLeafMeshMap},addChlidMesh:function(a){a.setParentTerrain(this.parentTerrain);a.setChunkSize(this.iChunkWidth,this.iChunkHeight);this.aChildMeshArray.push(a)},createLeafMesh:function(n,d,k,t,u){var e=new okVec3(-100000,-100000,-100000);var v=new okVec3(100000,100000,100000);var p=new okTerrainMesh(this.rc);p.setName("chunk_"+n.toString()+"_"+d.toString());p.setGlobalIndex(n,d);p.setChunkSize(this.iChunkWidth,this.iChunkHeight);p.setTerrainSize(this.iTerrainWidth,this.iTerrainHeight);p.setGridSpace(this.gridSpace);this.aChildMeshArray.push(p);var q=new Array;for(var h=0;h<this.iChunkHeight;++h){for(var m=0;m<this.iChunkWidth;++m){var c=n*(this.iChunkWidth-1)+m;var l=d*(this.iChunkHeight-1)+h;var o=c+l*this.iTerrainWidth;var s=u[o];var f=c*this.gridSpace.x;var a=l*this.gridSpace.y;q.push(f);q.push(a);q.push(s);v=okVec3Min(v,new okVec3(f,a,s));e=okVec3Max(e,new okVec3(f,a,s))}}p.setBoundingBox(v,e);k.set(v.x,v.y,v.z);t.set(e.x,e.y,e.z);p.createAttribute("Position",q.length,q,35044)},createChildMesh:function(l,a,h,o,e,q,s){var c=new okVec3(-100000,-100000,-100000);var u=new okVec3(100000,100000,100000);var p=new okTerrainTile(this.rc);p.setGlobalIndex(l,a);p.setWorldMapSize(this.iWorldMapWidth,this.iWorldMapHeight);p.setTerrainSize(this.iTerrainWidth,this.iTerrainHeight);p.setChunkSize(this.iChunkWidth,this.iChunkHeight);p.setGridSpace(this.gridSpace);this.aChildMeshArray.push(p);for(var k=0;k<2;++k){for(var f=0;f<2;++f){var m=l*2+k;var t=a*2+f;var d=new okVec3;var n=new okVec3;if(e>=q-1){p.createLeafMesh(m,t,d,n,s)}else{p.createChildMesh(m,t,d,n,e+1,q,s)}u=okVec3Min(u,d);c=okVec3Max(c,n)}}p.setBoundingBox(u,c);h.set(u.x,u.y,u.z);o.set(c.x,c.y,c.z)},detectCollision:function(e){for(var c=0;c<this.aChildMeshArray.length;++c){var d=this.aChildMeshArray[c];var a=d.getBoundingBox();if(e.x>=a.vMin.x&&e.x<=a.vMax.x&&e.y>=a.vMin.y&&e.y<=a.vMax.y){return d.detectCollision(e)}}},computeNormal:function(){this.createLocalLeafMeshMap();var a=this.localLeafMeshMap.getOneDimLength();var f=this.localLeafMeshMap.getTwoDimLength();for(var d=0;d<a;++d){for(var c=0;c<f;++c){var e=this.localLeafMeshMap.getElement(d,c);if(!e){continue}e.computeNormal();e.fixNormal(this.localLeafMeshMap,new okVec2(d,c))}}},fixNormal:function(l){var s=this.globalIndex.x;var q=this.globalIndex.y;var c=l.getElement(s-1,q);if(c&&c.getState()==3){c.createLocalLeafMeshMap();var f=c.localLeafMeshMap.getOneDimLength();var u=c.localLeafMeshMap.getTwoDimLength();for(var p=0;p<u;++p){var t=c.localLeafMeshMap.getElement(f-1,p);var k=this.localLeafMeshMap.getElement(0,p);k.fixLeftNormal(t)}}var y=l.getElement(s+1,q);if(y&&y.getState()==3){y.createLocalLeafMeshMap();var f=y.localLeafMeshMap.getOneDimLength();var u=y.localLeafMeshMap.getTwoDimLength();for(var p=0;p<u;++p){var v=y.localLeafMeshMap.getElement(0,p);var k=this.localLeafMeshMap.getElement(f-1,p);v.LeftfixNormal(k)}}var n=l.getElement(s,q-1);if(n&&n.getState()==3){n.createLocalLeafMeshMap();var f=n.localLeafMeshMap.getOneDimLength();var u=n.localLeafMeshMap.getTwoDimLength();for(var p=0;p<f;++p){var d=n.localLeafMeshMap.getElement(p,u-1);var k=this.localLeafMeshMap.getElement(p,0);k.fixTopNormal(d)}}var e=l.getElement(s,q+1);if(e&&e.getState()==3){e.createLocalLeafMeshMap();var f=e.localLeafMeshMap.getOneDimLength();var u=e.localLeafMeshMap.getTwoDimLength();for(var p=0;p<f;++p){var z=e.localLeafMeshMap.getElement(p,0);var k=this.localLeafMeshMap.getElement(p,u-1);z.fixTopNormal(k)}}var o=l.getElement(s-1,q-1);if(o&&o.getState()==3&&n&&n.getState()==3&&c&&c.getState()==3){this.createLocalLeafMeshMap();var f=this.localLeafMeshMap.getOneDimLength();var u=this.localLeafMeshMap.getTwoDimLength();var k=this.localLeafMeshMap.getElement(0,0);var d=n.localLeafMeshMap.getElement(0,u-1);var t=c.localLeafMeshMap.getElement(f-1,0);var x=o.localLeafMeshMap.getElement(f-1,u-1);k.fixTopLeftNormal(d,t,x)}if(n&&n.getState()==3){var a=new Array;var f=n.localLeafMeshMap.getOneDimLength();var u=n.localLeafMeshMap.getTwoDimLength();for(var p=0;p<f;++p){a.push(new okVec2(p,u-1))}n.createAttributeArrayBuffer("Normal",a)}if(c&&c.getState()==3){var a=new Array;var f=c.localLeafMeshMap.getOneDimLength();var u=c.localLeafMeshMap.getTwoDimLength();for(var p=0;p<u;++p){a.push(new okVec2(f-1,p))}c.createAttributeArrayBuffer("Normal",a)}if(e&&e.getState()==3){var a=new Array;var f=e.localLeafMeshMap.getOneDimLength();var u=e.localLeafMeshMap.getTwoDimLength();for(var p=0;p<f;++p){a.push(new okVec2(p,0))}e.createAttributeArrayBuffer("Normal",a)}if(y&&y.getState()==3){var a=new Array;var f=y.localLeafMeshMap.getOneDimLength();var u=y.localLeafMeshMap.getTwoDimLength();for(var p=0;p<u;++p){a.push(new okVec2(0,p))}y.createAttributeArrayBuffer("Normal",a)}if(o&&o.getState()==3){var a=new Array;var f=y.localLeafMeshMap.getOneDimLength();var u=y.localLeafMeshMap.getTwoDimLength();a.push(new okVec2(f-1,u-1));o.createAttributeArrayBuffer("Normal",a)}},distributeAttribute:function(f,c){this.createLocalLeafMeshMap();var a=this.localLeafMeshMap.getOneDimLength();var k=this.localLeafMeshMap.getTwoDimLength();for(var e=0;e<a;++e){for(var d=0;d<k;++d){var h=this.localLeafMeshMap.getElement(e,d);if(!h){continue}h.distributeAttribute(f,c)}}},createLocalLeafMeshMap:function(){var a=this.aChildMeshArray;var c=new Array;while(1){for(var f=0;f<a.length;++f){var n=a[f];for(var e=0;e<n.aChildMeshArray.length;e++){c.push(n.aChildMeshArray[e])}}if(c.length==0){break}a=c;c=[]}var d=0;var h=0;this.localLeafMeshMap.clear();if(a.length>0){var l=a[0].getGlobalIndex();d=l.x;h=l.y}for(var f=0;f<a.length;++f){var n=a[f];var l=n.getGlobalIndex();var m=l.x-d;var k=l.y-h;this.localLeafMeshMap.addElement(m,k,n)}},loadTextureFromXml:function(n,z){this.createLocalLeafMeshMap();var f=this.localLeafMeshMap.getElement(0,0);var v=f.getGlobalIndex();var l=v.x;var q=v.y;var h=(z[14]-z[2])/(z[12]-z[0]);var y=(z[15]-z[3])/(z[13]-z[1]);var a=z[12]/(this.iChunkWidth-1);var e=z[13]/(this.iChunkHeight-1);var A=z[0]/(this.iChunkWidth-1);var d=z[1]/(this.iChunkHeight-1);for(var t=A;t<a;++t){for(var s=d;s<e;++s){var m=this.localLeafMeshMap.getElement(t-l,s-q);if(!m){continue}var w=(t*(this.iChunkWidth-1)+z[0])*h+z[2];var k=(s*(this.iChunkHeight-1)+z[1])*y+z[3];var c=new Array;for(var u=0;u<this.iChunkHeight;++u){for(var o=0;o<this.iChunkWidth;++o){var p=(u*this.iChunkWidth+o)*2;c[p]=w+o*h;c[p+1]=k+u*y}}m.createAttribute(n,c.length,c);var x=m.getMaterial();x.entity=m.parentTerrain;x.setEmissive(OAK.VEC3_ZERO);x.setAmbient(0.01,0.01,0.01);x.setDiffuse(0.976471,0.990196,0.901961);x.setSpecular(0.01,0.01,0.01);x.setTextureCoord(0,n)}}},cullByFrustum:function(f,c,d,h){if(d.collideAABBox(this.getBoundingBox())==0){return}for(var a=0;a<this.aChildMeshArray.length;++a){var e=this.aChildMeshArray[a];if(!e){continue}e.cullByFrustum(f,c,d,h)}},createAttributeArrayBuffer:function(h,l){this.createLocalLeafMeshMap();var k=this.localLeafMeshMap.getOneDimLength();var f=this.localLeafMeshMap.getTwoDimLength();for(var d=0;d<k;++d){for(var c=0;c<f;++c){var n=this.localLeafMeshMap.getElement(d,c);if(!n){continue}if(!l||l.length==0){n.createAttributeArrayBuffer(h)}else{for(var a=0;a<l.length;++a){var e=l[a];if(d==e.x&&c==e.y){n.createAttributeArrayBuffer(h);break}}}}}}};function okTerrainEntity(a){okBaseCall(this,a);this.iType=32;this.iChunkWidth;this.iChunkHeight;this.iWorldMapWidth;this.iWorldMapHeight;this.iTerrainWidth;this.iTerrainHeight;this.iTerrainCustomWidth;this.iTerrainCustomHeight;this.iWorldMapTreeHeight;this.gridSpace=new okVec2;this.aChunkIndexArrayBufferList=new Array;this.aWorldMapArray=new Array;this.worldMapMap=new okArray2D;this.aMeshMaterialIdMap=new Object;this.bLoaded=false;this.bWireFrame=false}okExtend(okTerrainEntity,okVisibleEntity);okTerrainEntity.prototype.clear=function(){var e=this.resourceManager;if(this.aMeshMaterialIdMap){okAllocator._object(this.aMeshMaterialIdMap)}this.aMeshMaterialIdMap=okAllocator.object();for(var d=0;d<this.aChunkIndexArrayBufferList.length;++d){var a=this.aChunkIndexArrayBufferList[d];a.releaseBuffer();delete a}for(var d=0;d<this.aWorldMapArray.length;d++){var c=this.aWorldMapArray[d];c.clear()}okBaseCall(this,"clear")};okTerrainEntity.prototype.setChunkSize=function(a,d){this.iChunkWidth=a;this.iChunkHeight=d;var c;if(this.bWireFrame==false||this.bWireFrame==null){c="Default"}else{c="Wireframe"}this.createChunkIndexBufferArray(a,d,c)};okTerrainEntity.prototype.setWorldMapSize=function(a,c){this.iWorldMapWidth=a;this.iWorldMapHeight=c};okTerrainEntity.prototype.setTerrainSize=function(a,d){this.iTerrainCustomWidth=a;this.iTerrainCustomHeight=d;var c=Math.ceil(Math.log(a-1)/Math.log(2));var e=Math.ceil(Math.log(d-1)/Math.log(2));this.iTerrainWidth=Math.pow(2,c)+1;this.iTerrainHeight=Math.pow(2,e)+1};okTerrainEntity.prototype.setGridSpacing=function(a,c){this.gridSpace.set(a,c)};okTerrainEntity.prototype.getMaterialMap=function(){var e=new Object;for(var f=0;f<this.aWorldMapArray.length;++f){var h=this.aWorldMapArray[f];if(!h){continue}var a=h.getLeafChunkMap();var o=a.getOneDimLength();var k=a.getTwoDimLength();for(var d=0;d<o;++d){for(var c=0;c<k;++c){var l=a.getElement(d,c);e[l.getName()]=l.getMaterial()}}}return e};okTerrainEntity.prototype.getMaterial=function(e){for(var c=0;c<this.aWorldMapArray.length;++c){var a=this.aWorldMapArray[c];if(!a){continue}var d=a.getMaterial(e);if(d){return d}}return NULL};okTerrainEntity.prototype.loadAttribute=function(m,o){o=this._fillData(m,o);if(m=="Height"){this.rotX(1,-90);this.bLoaded=false;this.iWorldMapTreeHeight=Math.log((this.iWorldMapWidth-1)/(this.iChunkWidth-1))/Math.log(2);var n=(this.iTerrainWidth-1)/(this.iWorldMapWidth-1);var k=(this.iTerrainHeight-1)/(this.iWorldMapHeight-1);var d=new okVec3(10000,10000,10000);var l=new okVec3(-10000,-10000,-10000);for(var f=0;f<n;++f){for(var e=0;e<k;++e){var a=new okVec3;var c=new okVec3;this.createWorldMap(f,e,0,a,c,o);d=okVec3Min(d,a);l=okVec3Max(l,c)}}this.bbox.set(d,l);this.bLoaded=true}else{if(m=="Normal"||m=="Texcoord1"){for(var f=0;f<this.aWorldMapArray.length;++f){var h=this.aWorldMapArray[f];if(!h){continue}h.distributeAttribute(m,o)}}}};okTerrainEntity.prototype._fillData=function(h,l){var a=this.iTerrainWidth;var m=this.iTerrainHeight;var f=this.iTerrainCustomWidth;var k=this.iTerrainCustomHeight;if(h=="Height"&&l.length<a*m){var e=new Array;for(var c=0;c<m;++c){for(var d=0;d<a;++d){if(d<f&&c<k){e.push(l[c*f+d])}else{e.push(0)}}}return e}else{if(h=="Normal"&&l.length<a*m*3){var e=new Array;for(var c=0;c<m;++c){for(var d=0;d<a;++d){if(d<f&&c<k){e.push(l[(c*f+d)*3+0]);e.push(l[(c*f+d)*3+1]);e.push(l[(c*f+d)*3+2])}else{e.push(0);e.push(0);e.push(1)}}}return e}else{if(h=="Texcoord1"&&l.length<a*m*2){var e=new Array;for(var c=0;c<m;++c){for(var d=0;d<a;++d){if(d<f&&c<k){e.push(l[(c*f+d)*2+0]);e.push(l[(c*f+d)*2+1])}else{e.push(0);e.push(0)}}}return e}else{return l}}}};okTerrainEntity.prototype.computeNormal=function(){var f=this.worldMapMap.getOneDimLength();var a=this.worldMapMap.getTwoDimLength();for(var e=0;e<f;++e){for(var c=0;c<a;++c){var d=this.worldMapMap.getElement(e,c);if(!d){continue}d.computeNormal();d.fixNormal(this.worldMapMap)}}for(var e=0;e<f;++e){for(var c=0;c<a;++c){var d=this.worldMapMap.getElement(e,c);if(!d){continue}d.createAttributeArrayBuffer("Normal")}}};okTerrainEntity.prototype.enableWireframe=function(a){this.bWireFrame=a};okTerrainEntity.prototype.getState=function(){if(!this.bLoaded){return 1}else{return 4}};okTerrainEntity.prototype.cullByFrustum=function(h){if(h.collideAABBox(this.getBoundingBox(1))==0){return 0}for(var e=0;e<this.aWorldMapArray.length;++e){var d=this.aWorldMapArray[e];var c=d.getBoundingBox();c.transformMat43(this.mMat);if(h.collideAABBox(c)==0){continue}if(d.getState()==1){var k=this;var f=okGenXmlHttpRequest();var a=this.zone.scene.getTerrainUrl()+"/"+d.getUrl();f.open("GET",a,true);if(okIsIE()){f.onreadystatechange=function(){if(f.readyState==4){if(f.status==200||f.status==0){okResourceParser.loadWorldMapFromXml(k,okParseXML(f.responseText));k.zone.dirtyEntity(k)}}}}else{f.onload=function(){okResourceParser.loadWorldMapFromXml(k,okParseXML(f.responseText));k.zone.dirtyEntity(k)}}f.send();d.setState(2)}}return 1};okTerrainEntity.prototype.load=function(c){this.rotX(1,-90);this.bLoaded=false;c=this.zone.scene.getTerrainUrl()+"/"+c;var a=okGenXmlHttpRequest();a.open("GET",c,false);a.send();okResourceParser.loadTerrainFromXml(this,okParseXML(a.responseText),this.bWireFrame);this.bLoaded=true};okTerrainEntity.prototype.getWorldMaps=function(){return this.aWorldMapArray};okTerrainEntity.prototype.getWorldMapMap=function(){return this.worldMapMap};okTerrainEntity.prototype.createWorldMap=function(n,d,f,k,q,s){if(f>this.iWorldMapTreeHeight){return}var o=new okTerrainTile(this.resourceManager.rc);o.setGlobalIndex(n,d);this.addWorldMap(o);o.setWorldMapSize(this.iWorldMapWidth,this.iWorldMapHeight);o.setTerrainSize(this.iTerrainWidth,this.iTerrainHeight);o.setChunkSize(this.iChunkWidth,this.iChunkHeight);o.setGridSpace(this.gridSpace);var l=new okVec3(-100000,-100000,-100000);var a=new okVec3(100000,100000,100000);if(this.iWorldMapTreeHeight==0){o.createLeafMesh(n,d,a,l,s)}else{for(var m=0;m<2;++m){for(var h=0;h<2;++h){var t=n*2+m;var e=d*2+h;var p=new okVec3;var c=new okVec3;if(this.iWorldMapTreeHeight==1){o.createLeafMesh(t,e,p,c,s)}else{o.createChildMesh(t,e,p,c,f+1,this.iWorldMapTreeHeight,s)}a=okVec3Min(a,p);l=okVec3Max(l,c)}}}o.setBoundingBox(a,l);k.set(a.x,a.y,a.z);q.set(l.x,l.y,l.z);o.setState(3)};okTerrainEntity.prototype.addWorldMap=function(c){c.setParentTerrain(this);c.setChunkSize(this.iChunkWidth,this.iChunkHeight);this.aWorldMapArray.push(c);var a=c.getGlobalIndex();this.worldMapMap.addElement(a.x,a.y,c)};okTerrainEntity.prototype.addTexture=function(a){};okTerrainEntity.prototype.fixNormalOfWorldMap=function(a){};okTerrainEntity.prototype.createChunkIndexBufferArray=function(v,D,m){var d;var z=1;for(var C=0;;++C){z=z*2;if(z>=v-1){d=C+1;break}}var G=new Array;for(var A=0;A<=d;++A){var s=1;for(var C=0;C<A;C++){s*=2}var E=(v-1)/s;if(A==0){var C=0;var B=0;var c=new Array;c[0]=(C+(B+1)*v)*E;c[1]=(C+B*v)*E;c[2]=((C+1)+B*v)*E;this._addToIndexArrayList(G,m,c,0);var a=new Array;a[0]=(C+(B+1)*v)*E;a[1]=((C+1)+B*v)*E;a[2]=((C+1)+(B+1)*v)*E;this._addToIndexArrayList(G,m,a,0);var c=new Array;c[0]=(C+(B+1)*v)*E;c[1]=(C+B*v)*E;c[2]=((C+1)+(B+1)*v)*E;this._addToIndexArrayList(G,m,c,1);var a=new Array;a[0]=(C+B*v)*E;a[1]=((C+1)+B*v)*E;a[2]=((C+1)+(B+1)*v)*E;this._addToIndexArrayList(G,m,a,1)}else{for(var o=0;o<16;++o){var p=(A<<4)+o;var t=0;var x=0;var e=s;var n=s;var k=o&1;var y=(o>>1)&1;var F=(o>>2)&1;var u=(o>>3)&1;if(k==1){t=1}if(F==1){e=s-1}if(y==1){x=1}if(u==1){n=s-1}for(var C=t;C<e;++C){for(var B=x;B<n;++B){if((C+B)%2==0){var c=new Array;c[0]=(C+B*v)*E;c[1]=((C+1)+(B+1)*v)*E;c[2]=(C+(B+1)*v)*E;this._addToIndexArrayList(G,m,c,p);var a=new Array;a[0]=(C+B*v)*E;a[1]=((C+1)+B*v)*E;a[2]=((C+1)+(B+1)*v)*E;this._addToIndexArrayList(G,m,a,p)}else{var c=new Array;c[0]=(C+B*v)*E;c[1]=((C+1)+B*v)*E;c[2]=(C+(B+1)*v)*E;this._addToIndexArrayList(G,m,c,p);var a=new Array;a[0]=(C+(B+1)*v)*E;a[1]=((C+1)+B*v)*E;a[2]=((C+1)+(B+1)*v)*E;this._addToIndexArrayList(G,m,a,p)}}}if(y==1){var B=0;for(var C=0;C<s;C+=2){if(C!=0||k==0){var c=new Array;c[0]=(C+B*v)*E;c[1]=((C+1)+(B+1)*v)*E;c[2]=(C+(B+1)*v)*E;this._addToIndexArrayList(G,m,c,p)}var a=new Array;a[0]=(C+B*v)*E;a[1]=((C+2)+B*v)*E;a[2]=((C+1)+(B+1)*v)*E;this._addToIndexArrayList(G,m,a,p);if(C!=s-2||F==0){var H=new Array;H[0]=((C+1)+(B+1)*v)*E;H[1]=((C+2)+B*v)*E;H[2]=((C+2)+(B+1)*v)*E;this._addToIndexArrayList(G,m,H,p)}}}if(u==1){var B=s-1;for(var C=0;C<s;C+=2){if(C!=0||k==0){var c=new Array;c[0]=(C+B*v)*E;c[1]=((C+1)+B*v)*E;c[2]=(C+(B+1)*v)*E;this._addToIndexArrayList(G,m,c,p)}var a=new Array;a[0]=(C+(B+1)*v)*E;a[1]=((C+1)+B*v)*E;a[2]=((C+2)+(B+1)*v)*E;this._addToIndexArrayList(G,m,a,p);if(C!=s-2||F==0){var H=new Array;H[0]=((C+1)+B*v)*E;H[1]=((C+2)+B*v)*E;H[2]=((C+2)+(B+1)*v)*E;this._addToIndexArrayList(G,m,H,p)}}}if(k==1){var C=0;for(var B=0;B<s;B+=2){if(B!=0||y==0){var c=new Array;c[0]=(C+B*v)*E;c[1]=((C+1)+B*v)*E;c[2]=((C+1)+(B+1)*v)*E;this._addToIndexArrayList(G,m,c,p)}var a=new Array;a[0]=(C+B*v)*E;a[1]=((C+1)+(B+1)*v)*E;a[2]=(C+(B+2)*v)*E;this._addToIndexArrayList(G,m,a,p);if(B!=s-2||u==0){var H=new Array;H[0]=(C+(B+2)*v)*E;H[1]=((C+1)+(B+1)*v)*E;H[2]=((C+1)+(B+2)*v)*E;this._addToIndexArrayList(G,m,H,p)}}}if(F==1){var C=s-1;for(var B=0;B<s;B+=2){if(B!=0||y==0){var c=new Array;c[0]=(C+B*v)*E;c[1]=((C+1)+B*v)*E;c[2]=(C+(B+1)*v)*E;this._addToIndexArrayList(G,m,c,p)}var a=new Array;a[0]=(C+(B+1)*v)*E;a[1]=((C+1)+B*v)*E;a[2]=((C+1)+(B+2)*v)*E;this._addToIndexArrayList(G,m,a,p);if(B!=s-2||u==0){var H=new Array;H[0]=(C+(B+2)*v)*E;H[1]=(C+(B+1)*v)*E;H[2]=((C+1)+(B+2)*v)*E;this._addToIndexArrayList(G,m,H,p)}}}}}}for(var C=0;C<G.length;++C){var q=G[C];if(!q){continue}var f=new okArrayBuffer(this.resourceManager.rc);f.createBuffer(34963,5123,35044,new Uint16Array(q));this.aChunkIndexArrayBufferList[C]=f}};okTerrainEntity.prototype._addToIndexArrayList=function(f,d,l,a){if(!f[a]){f[a]=new Array}var e=new Array;if(d=="Wireframe"){var m=l[0];var k=l[1];var h=l[2];e.push(m,k,k,h,h,m)}else{var m=l[0];var k=l[1];var h=l[2];e.push(m,k,h)}for(var c=0;c<e.length;c++){f[a].push(e[c])}};okTerrainEntity.prototype.createMaterial=function(c){var a="EntityMtrl"+this.sName+c;this.aMeshMaterialIdMap[c]=this.resourceManager.createMaterial(a)};okTerrainEntity.prototype.getMaterial=function(e){var a=this.aMeshMaterialIdMap[e];if(!(a>=0)){var f=this.getModels();if(f.length<0){return null}for(var d=0;d<f.length;++d){var c=f[d];return c.getMesh(e).getDefaultMaterial()}}return this.resourceManager.getMaterial(a)};okTerrainEntity.prototype.getBoundingBox=function(e){if(e==2){if(this.bOBoxDirty){if(this.aWorldMapArray.length==0){this.obox.setMin(OAK.VEC3_ZERO);this.obox.setMax(OAK.VEC3_ZERO);this.obox.setMat(this.mMat)}else{var a=okAllocator.aabbox();for(var d=0;d<this.aWorldMapArray.length;++d){var c=this.aWorldMapArray[d];if(d==0){c.getBoundingBox().clone(a)}else{a=a.union(c.getBoundingBox())}}this.obox.setMin(a.vMin);this.obox.setMax(a.vMax);this.obox.setMat(this.mMat);this.bOBoxDirty=false;okAllocator._aabbox(a)}}return this.obox}else{if(this.bBBoxDirty){if(this.aWorldMapArray.length==0){this.bbox.set(OAK.VEC3_ZERO,OAK.VEC3_ZERO)}else{for(var d=0;d<this.aWorldMapArray.length;++d){var c=this.aWorldMapArray[d];if(d==0){c.getBoundingBox().clone(this.bbox)}else{this.bbox=this.bbox.union(c.getBoundingBox())}}this.bbox.transformMat(this.mMat);this.bBBoxDirty=false}}return this.bbox}};okTerrainEntity.prototype.detectCollision=function(k){var e=this.getInvMat43();var h=okMat43MulVec3(e,k);for(var d=0;d<this.aWorldMapArray.length;++d){var c=this.aWorldMapArray[d];var a=c.getBoundingBox();if(h.x>=a.vMin.x&&h.x<=a.vMax.x&&h.y>=a.vMin.y&&h.y<=a.vMax.y){var f=c.detectCollision(h);h.z=f;return okMat43MulVec3(this.getMat43(),h)}}return null};okTerrainEntity.prototype.genRenderBatch=function(C,p){if(this.aWorldMapArray.length==0){return}var q=p.camera;var c=q.getPos();c=okMat43MulVec3(this.mMat.inverse(),c);var B=new okFrustum();var d=new okMat4();okMat43Mul(this.mMat.inverse(),q.mCamMat).toMat4(d);var o=d.inverse();B.setByViewProjMat(okMat4Mul(q.mProjMat,o));var S=new okArray2D;for(var P=0;P<this.aWorldMapArray.length;++P){var h=this.aWorldMapArray[P];if(h.getState()==3){h.cullByFrustum(S,q,B,c)}}var m=false;var H=S.getOneDimLength();var G=S.getTwoDimLength();while(!m){m=true;for(var P=0;P<H;++P){for(var O=0;O<G;++O){var v=S.getElement(P,O);if(!v){continue}v.clearFillCrashFlag();var E=v.getGlobalIndex().x;var n=v.getGlobalIndex().y;var M=S.getElement(E-1,n);if(M){if(M.getCurrentLOD()-v.getCurrentLOD()<=-2){M.setCurrentLOD(M.getCurrentLOD()+1);m=false}else{if(M.getCurrentLOD()-v.getCurrentLOD()==-1){v.left=true}}}var L=S.getElement(E,n-1);if(L){if(L.getCurrentLOD()-v.getCurrentLOD()<=-2){L.setCurrentLOD(L.getCurrentLOD()+1);m=false}else{if(L.getCurrentLOD()-v.getCurrentLOD()==-1){v.top=true}}}var K=S.getElement(E+1,n);if(K){if(K.getCurrentLOD()-v.getCurrentLOD()<=-2){K.setCurrentLOD(K.getCurrentLOD()+1);m=false}else{if(K.getCurrentLOD()-v.getCurrentLOD()==-1){v.right=true}}}var J=S.getElement(E,n+1);if(J){if(J.getCurrentLOD()-v.getCurrentLOD()<=-2){J.setCurrentLOD(J.getCurrentLOD()+1);m=false}else{if(J.getCurrentLOD()-v.getCurrentLOD()==-1){v.bottom=true}}}}}}var Q=new Object;var u=new Object;var F=this.resourceManager;var H=S.getOneDimLength();var G=S.getTwoDimLength();for(var P=0;P<H;++P){for(var O=0;O<G;++O){var v=S.getElement(P,O);if(!v){continue}var U=v.getMaterial();U.enableWireframe(this.bWireFrame);var D=v.computePosInIndexArray();var a=this.aChunkIndexArrayBufferList[D];if(!U.isWireframeEnabled()){v.aIndexArrayBufferList.Default=a}else{v.aIndexArrayBufferList.Wireframe=a}var T=this.zone.scene.sTexturePath;var l=okAllocator.renderBatch();l.aAttribFmt=okAllocator.object();var W=v.aAttribArrayBufferList;var w=okAllocator.array();for(var I in W){var t=W[I];var e=I.split("/");var z=0;w.length=0;var f=e.length;for(var N=0;N<f;++N){var V=new okAttribFormat();var A=e[N];w.push(V);l.aAttribFmt[A]=V;V.sName=A;V.iIdx=N;V.iOffset=z;V.buf=t;switch(A){case"Position":case"Normal":case"Color":case"Texcoord1_Tangent":case"Texcoord1_Binormal":case"Texcoord2_Tangent":case"Texcoord2_Binormal":case"Texcoord3_Tangent":case"Texcoord3_Binormal":case"Texcoord4_Tangent":case"Texcoord4_Binormal":V.iSize=3;z+=3;break;case"Texcoord1":case"Texcoord2":case"Texcoord3":case"Texcoord4":V.iSize=2;z+=2;break;case"BoneIndex":case"BoneWeight":V.iSize=4;z+=4;break;default:}}f=w.length;for(var N=0;N<f;++N){w[N].iStride=z}}okAllocator._array(w);if(U.bWireframe&&v.aIndexArrayBufferList.Wireframe){l.index=v.aIndexArrayBufferList.Wireframe;l.iDrawMode=1;l.iDrawStart=0;l.iDrawCount=l.index.getLength()}else{l.index=v.aIndexArrayBufferList.Default;l.iDrawMode=4;l.iDrawStart=0;l.iDrawCount=l.index.getLength()}l.materialRef=U;var R=this.getMat43();if(this.bSkybox){R.m03+=cam.mCamMat.m03;R.m13+=cam.mCamMat.m13;R.m23+=cam.mCamMat.m23}l.mMatRef=R;l.mMatNRef=this.getNormalMat43();l.aDctLightListRef=this.aDctLights;l.aPointLightListRef=this.aPointLights;l.aSpotLightListRef=this.aSpotLights;var s=new okAABBox();v.getBoundingBox().clone(s);s.transformMat(this.mMat);l.bboxRef=s;l.bReceiveShadow=this.bReceiveShadow;C.push(l)}}};function okVideoEntity(a){okBaseCall(this,a);this.iType=128;this.mesh=new okMesh(this.resourceManager.rc);this.mtrl=new okMaterial();this.mtrl.entity=this;this.mtrl.setTextureWrap(0,33071);this.bboxL=new okAABBox();this.lastUpdateTime=new Date();this._init()}okExtend(okVideoEntity,okVisibleEntity);okVideoEntity.prototype.clear=function(){var a=this.resourceManager;this.mesh.clear();this.mtrl.clear();this.mtrl.setTextureWrap(0,33071);this.bboxL=new okAABBox();okBaseCall(this,"clear")};okVideoEntity.prototype.getState=function(){var c=this.mtrl.getTextureResourceId(0);if(c==-1){return 1}var a=this.resourceManager.getResourceState(c);if(a!=5){return 1}return 4};okVideoEntity.prototype._init=function(){var a=new Array;a.push(-1);a.push(-1);a.push(0);a.push(0);a.push(0);a.push(1);a.push(1);a.push(-1);a.push(0);a.push(0);a.push(0);a.push(1);a.push(-1);a.push(1);a.push(0);a.push(0);a.push(0);a.push(1);a.push(1);a.push(1);a.push(0);a.push(0);a.push(0);a.push(1);this.mesh.deleteAttribute("Position/Normal");this.mesh.createAttribute("Position/Normal",a.length,a,35044);var d=new Array;d.push(0);d.push(1);d.push(1);d.push(1);d.push(0);d.push(0);d.push(1);d.push(0);this.mesh.deleteAttribute("Texcoord1");this.mesh.createAttribute("Texcoord1",d.length,d,35044);this.bboxL.set(new okVec3(-1,-1,-0.001),new okVec3(1,1,0.001));this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true;var c=new Array;c.push(1);c.push(2);c.push(0);c.push(1);c.push(3);c.push(2);this.mesh.deleteIndex("Default");this.mesh.createIndex("Default",c.length,c,35044,4);this.mtrl.fAlpha=1;this.mtrl.bWireframe=false;this.mtrl.vEmissive=new okVec3(0,0,0);this.mtrl.vAmbient=new okVec3(0,0,0);this.mtrl.vDiffuse=new okVec3(1,1,1);this.mtrl.vSpecular=new okVec3(0,0,0);this.mtrl.enableDynamicLighting(false);this.mtrl.setTextureType(0,3553);this.mtrl.setTextureCoord(0,"Texcoord1")};okVideoEntity.prototype.setScreenBoard=function(a,k,c,e,f){f=f?f:0;var d=new Array;d.push(a);d.push(k);d.push(f);d.push(0);d.push(0);d.push(1);d.push(a+c);d.push(k);d.push(f);d.push(0);d.push(0);d.push(1);d.push(a);d.push(k+e);d.push(f);d.push(0);d.push(0);d.push(1);d.push(a+c);d.push(k+e);d.push(f);d.push(0);d.push(0);d.push(1);this.mesh.deleteAttribute("Position/Normal");this.mesh.createAttribute("Position/Normal",d.length,d,35044);this.bboxL.set(new okVec3(a,k,f-0.001),new okVec3(a+c,k+e,f+0.001));this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true};okVideoEntity.prototype.loadVideo=function(a){this.mtrl.setTextureName(0,a)};okVideoEntity.prototype.getVideo=function(){var d=this.resourceManager;var f=this.mtrl;var e=this.mtrl.getTextureResourceId(0);if(e==-1){return null}var c=d.getResource(e);if(!c){return null}var a=c.video;if(!a){return null}return a};okVideoEntity.prototype.getVideoName=function(){var c=this.resourceManager;var d=this.mtrl;var a=d.getTextureName(0);return a};okVideoEntity.prototype.getVideoTexture=function(){var c=this.resourceManager;var e=this.mtrl;var d=e.getTextureResourceId(0);if(d==-1){return null}var a=c.getResource(d);return a};okVideoEntity.prototype.setTime=function(d){var e=this.mtrl.getTextureResourceId(0);if(this.resourceManager.getResourceState(e)!=5){return}var c=this.getVideoTexture();var a=c.video;if(!a){return}if(d>a.duration){d=a.duration}if(d<0){d=0}a.currentTime=d/1000};okVideoEntity.prototype.getTime=function(){var a=this.getVideo();if(!a){return -1}return a.currentTime*1000};okVideoEntity.prototype.getVideoLength=function(){var a=this.getVideo();if(!a){return -1}return a.duration*1000};okVideoEntity.prototype.enableMute=function(c){var a=this.getVideo();if(!a){return}a.muted=c};okVideoEntity.prototype.isMute=function(){var a=this.getVideo();if(!a){return true}return a.muted};okVideoEntity.prototype.getMaterial=function(){return this.mtrl};okVideoEntity.prototype.getMesh=function(){return this.mesh};okVideoEntity.prototype.getBoundingBox=function(a){if(a==2){if(this.bOBoxDirty){this.obox.setMin(this.bboxL.vMin);this.obox.setMax(this.bboxL.vMax);this.obox.setMat(this.mMat);this.bOBoxDirty=false}return this.obox}else{if(this.bBBoxDirty){this.bboxL.clone(this.bbox);this.bbox.transformMat(this.mMat);this.bBBoxDirty=false}return this.bbox}};okVideoEntity.prototype.genRenderBatch=function(d,k){var a=k.camera;if(this.fVisibleDistance>0){var e=a.getPos();var n=(e.x-this.mMat.m03)*(e.x-this.mMat.m03)+(e.y-this.mMat.m13)*(e.y-this.mMat.m13)+(e.z-this.mMat.m23)*(e.z-this.mMat.m23);if(n>this.fVisibleDistance*this.fVisibleDistance){return}}var c=this.resourceManager;var s=this.mesh;var f=this.mtrl;var m=okAllocator.renderBatch();var q=f.getTextureResourceId(0);if(q!=-1){var l=c.getResource(q);if(l&&l.isVideoTexture()){curTime=new Date();var p=curTime.getTime()-this.lastUpdateTime.getTime();if(p>=1000/24){this.lastUpdateTime=new Date();l.updateVideoTexture()}}}m.aAttribFmt=s._getAttribFmt();if(f.bWireframe&&s.aIndexArrayBufferList.Wireframe){m.index=s.aIndexArrayBufferList.Wireframe;m.iDrawMode=1;m.iDrawStart=0;m.iDrawCount=m.index.getLength()}else{m.index=s.aIndexArrayBufferList.Default;m.iDrawMode=4;m.iDrawStart=0;m.iDrawCount=m.index.getLength()}m.materialRef=f;var h=this.getMat43();if(this.bSkybox){h.m03+=a.mCamMat.m03;h.m13+=a.mCamMat.m13;h.m23+=a.mCamMat.m23}m.mMatRef=h;m.mMatNRef=this.getNormalMat43();m.aDctLightListRef=this.aDctLights;m.aPointLightListRef=this.aPointLights;m.aSpotLightListRef=this.aSpotLights;var o=new okAABBox();this.getBoundingBox().clone(o);m.bboxRef=o;d.push(m)};function okLightEntity(a){okBaseCall(this,a);this.iType=(4|8|16);this.bVisible=true;this.vColor=new okVec3(1,1,1);this.fIntensity=1;this.bCastShadow=false;this.vShadowColor=new okVec3(0.5,0.5,0.5);this.iShadowIdx=3;this.fShadowFadeFactor=0.06;this.aAffectEntities=okAllocator.array()}okExtend(okLightEntity,okBaseEntity);okLightEntity.prototype.clear=function(){this.bVisible=true;this.vColor=new okVec3(1,1,1);this.fIntensity=1;if(this.bCastShadow){this.zone.iCastShadowLightNum-=1}this.bCastShadow=false;this.vShadowColor.set(0.5,0.5,0.5);this.iShadowIdx=3;this.fShadowFadeFactor=0.006;this.clearAffectEntity();okBaseCall(this,"clear")};okLightEntity.prototype.addAffectEntity=function(a){this.aAffectEntities.push(a)};okLightEntity.prototype.removeAffectEntity=function(c){var a=this.aAffectEntities.length;for(var d=0;d<a;++d){if(this.aAffectEntities[d]==c){this.aAffectEntities[d]=this.aAffectEntities[a-1];this.aAffectEntities.pop();return}}};okLightEntity.prototype.findAffectEntity=function(c){var a=this.aAffectEntities.length;for(var d=0;d<a;++d){if(this.aAffectEntities[d]==c){return true}}return false};okLightEntity.prototype.clearAffectEntity=function(){this.aAffectEntities.length=0};okLightEntity.prototype.enableVisible=function(a){this.bVisible=a};okLightEntity.prototype.isVisible=function(){return this.bVisible};okLightEntity.prototype.enableCastShadow=function(a){if(a!=this.bCastShadow){if(a){this.zone.iCastShadowLightNum+=1}else{this.zone.iCastShadowLightNum-=1}this.bCastShadow=a}};okLightEntity.prototype.isCastShadow=function(){return this.bCastShadow};okLightEntity.prototype.setShadowColor=function(d,c,a){if(c==null){d.clone(this.vShadowColor)}else{this.vShadowColor.set(d,c,a)}};okLightEntity.prototype.setShadowFade=function(a){this.fShadowFadeFactor=a};okLightEntity.prototype.getShadowFade=function(){return this.fShadowFadeFactor};okLightEntity.prototype.setColor=function(d,c,a){if(c==null){d.x=(d.x>1?1:d.x);d.x=(d.x<0?0:d.x);d.y=(d.y>1?1:d.y);d.y=(d.y<0?0:d.y);d.z=(d.z>1?1:d.z);d.z=(d.z<0?0:d.z);d.clone(this.vColor)}else{d=(d>1?1:d);d=(d<0?0:d);c=(c>1?1:c);c=(c<0?0:c);a=(a>1?1:a);a=(a<0?0:a);this.vColor.set(d,c,a)}};okLightEntity.prototype.getColor=function(){return this.vColor};okLightEntity.prototype.setIntensity=function(a){this.fIntensity=(a<0?0:a)};okLightEntity.prototype.getIntensity=function(){return this.fIntensity};okLightEntity.prototype.isAffectEntity=function(a){return true};function okDctLightEntity(a){okBaseCall(this,a);this.iType=4}okExtend(okDctLightEntity,okLightEntity);okDctLightEntity.prototype.clear=function(){okBaseCall(this,"clear")};okDctLightEntity.prototype.setLightDir=function(e,d,c){var a=okAllocator.vec3();if(d==null){a.x=-e.x;a.y=-e.y;a.z=-e.z}else{a.x=-e;a.y=-d;a.z=-c}this.setDir(3,a);okAllocator._vec3(a)};okDctLightEntity.prototype.getLightDir=function(){var a=this.mMat.getColumn(2);a.x=-a.x;a.y=-a.y;a.z=-a.z;a.normalize(true);return a};function okPointLightEntity(a){okBaseCall(this,a);this.iType=8;this.fRange=10}okExtend(okPointLightEntity,okLightEntity);okPointLightEntity.prototype.clear=function(){this.fRange=10;okBaseCall(this,"clear")};okPointLightEntity.prototype.setRange=function(a){this.fRange=a;this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true;this.zone.dirtyEntity(this)};okPointLightEntity.prototype.getRange=function(){return this.fRange};okPointLightEntity.prototype.isAffectEntity=function(c){var a=c.getPos();var e=this.mMat.getColumn(3);var d=(a.x-e.x)*(a.x-e.x)+(a.y-e.y)*(a.y-e.y)+(a.z-e.z)*(a.z-e.z);return(d<=this.fRange*this.fRange)};function okSpotLightEntity(a){okBaseCall(this,a);this.iType=16;this.mMat.identity();this.mMat.setColumn(0,1,0,0);this.mMat.setColumn(1,0,0,-1);this.mMat.setColumn(2,0,1,0);this.fRange=10;this.fInnerCone=Math.PI*60/180;this.fOuterCone=Math.PI*75/180;this.frustum=new okFrustum();this.bFrustumDirty=true}okExtend(okSpotLightEntity,okLightEntity);okSpotLightEntity.prototype.clear=function(){this.fRange=10;this.fInnerCone=Math.PI*60/180;this.fOuterCone=Math.PI*75/180;this.bFrustumDirty=true;okBaseCall(this,"clear")};okSpotLightEntity.prototype.setLightDir=function(e,d,c){var a=okAllocator.vec3();if(d==null){a.x=-e.x;a.y=-e.y;a.z=-e.z}else{a.x=-e;a.y=-d;a.z=-c}this.setDir(3,a);okAllocator._vec3(a)};okSpotLightEntity.prototype.getLightDir=function(){var a=this.mMat.getColumn(2);a.x=-a.x;a.y=-a.y;a.z=-a.z;a.normalize(true);return a};okSpotLightEntity.prototype.setRange=function(a){this.fRange=a;this.bBBoxDirty=true;this.bOBoxDirty=true;this.bBSphDirty=true;this.bFrustumDirty=true;this.zone.dirtyEntity(this)};okSpotLightEntity.prototype.getRange=function(){return this.fRange};okSpotLightEntity.prototype.setInnerCone=function(a){var c=a*Math.PI/180;this.fInnerCone=c;this.bFrustumDirty=true};okSpotLightEntity.prototype.getInnerCone=function(){return this.fInnerCone*180/Math.PI};okSpotLightEntity.prototype.setOuterCone=function(a){var c=a*Math.PI/180;this.fOuterCone=c;this.bFrustumDirty=true};okSpotLightEntity.prototype.getOuterCone=function(){return this.fOuterCone*180/Math.PI};okSpotLightEntity.prototype.getLightFrustum=function(){if(this.bFrustumDirty){var c=okMat4Proj(this.fOuterCone*180/Math.PI,1,0.01,this.fRange);var d=this.getInvMat4();var a=okMat4Mul(c,d);this.frustum.setByViewProjMat(a);this.bFrustumDirty=false}return this.frustum};okSpotLightEntity.prototype.isAffectEntity=function(a){return(this.getLightFrustum().collideAABBox(a.getBoundingBox())!=0)};okSpotLightEntity.prototype.dirtyMatFunc=function(){this.bFrustumDirty=true};function okConfigEntity(a){okBaseCall(this,a);this.iType=512;this.vSkyColor=new okVec3(0.3,0.3,0.3);this.vGroundColor=new okVec3(0.3,0.3,0.3);this.bShadow=true;this.bFogEnable=false;this.vFogColor=new okVec3(1,1,1);this.fFogDensity=3.5;this.fFogDistNear=0.1;this.fFogDistFar=1}okExtend(okConfigEntity,okBaseEntity);okConfigEntity.prototype.setSkyColor=function(c,a,d){if(fY!=null){this.vSkyColor.set(c,a,d)}else{c.clone(this.vSkyColor)}};okConfigEntity.prototype.getSkyColor=function(){return this.vSkyColor};okConfigEntity.prototype.setGroundColor=function(c,a,d){if(fY!=null){this.vGroundColor.set(c,a,d)}else{c.clone(this.vGroundColor)}};okConfigEntity.prototype.getGroundColor=function(){return this.vGroundColor};okConfigEntity.prototype.enableShadow=function(a){this.bShadow=a};okConfigEntity.prototype.isShadowEnabled=function(){return this.bShadow};okConfigEntity.prototype.enableFog=function(c,a){this.bFogEnable=a};okConfigEntity.prototype.isFogEnabled=function(a){return this.bFogEnable};okConfigEntity.prototype.setFogColor=function(e,c,a,d){if(fY==null){this.vFogColor.x=c.x;this.vFogColor.y=c.y;this.vFogColor.z=c.z}else{this.vFogColor.x=c;this.vFogColor.y=a;this.vFogColor.z=d}};okConfigEntity.prototype.getFogColor=function(a){var c=okAllocator.vec3();return this.vFogColor.clone(c)};okConfigEntity.prototype.setFogDistanceNear=function(c,a){this.fFogDistNear=Math.max(0.001,a)};okConfigEntity.prototype.setFogDistanceFar=function(c,a){this.fFogDistFar=Math.max(0.001,a)};okConfigEntity.prototype.getFogDistanceNear=function(a){return this.fFogDistNear};okConfigEntity.prototype.getFogDistanceFar=function(a){return this.fFogDistFar};okConfigEntity.prototype.setFogDensity=function(c,a){this.fFogDensity=a};okConfigEntity.prototype.getFogDensity=function(a){return this.fFogDensity};function okSceneNode(){this.parent=null;this.iParentIdx=-1;this.aChildrenList=[null,null,null,null,null,null,null,null];this.iChildCount=0;this.bbox=okAllocator.aabbox();this.aChildrenBBox=[okAllocator.aabbox(),okAllocator.aabbox(),okAllocator.aabbox(),okAllocator.aabbox(),okAllocator.aabbox(),okAllocator.aabbox(),okAllocator.aabbox(),okAllocator.aabbox()];this.aEntities=okAllocator.array();this.iLevel=0}okSceneNode.prototype={clear:function(){this.parent=null;this.iParentIdx=-1;for(var a=0;a<8;++a){if(this.aChildrenList[a]){this.deleteChild(a)}}this.bbox.set(OAK.VEC3_ZERO,OAK.VEC3_ZERO);this.aChildrenBBox[0].set(OAK.VEC3_ZERO,OAK.VEC3_ZERO);this.aChildrenBBox[1].set(OAK.VEC3_ZERO,OAK.VEC3_ZERO);this.aChildrenBBox[2].set(OAK.VEC3_ZERO,OAK.VEC3_ZERO);this.aChildrenBBox[3].set(OAK.VEC3_ZERO,OAK.VEC3_ZERO);this.aChildrenBBox[4].set(OAK.VEC3_ZERO,OAK.VEC3_ZERO);this.aChildrenBBox[5].set(OAK.VEC3_ZERO,OAK.VEC3_ZERO);this.aChildrenBBox[6].set(OAK.VEC3_ZERO,OAK.VEC3_ZERO);this.aChildrenBBox[7].set(OAK.VEC3_ZERO,OAK.VEC3_ZERO);this.aEntities.length=0;this.iLevel=0},setBoundingBox:function(c){c.clone(this.bbox);var h=(c.vMin.x+c.vMax.x)*0.5;var e=(c.vMin.y+c.vMax.y)*0.5;var d=(c.vMin.z+c.vMax.z)*0.5;var f=okAllocator.vec3();var a=okAllocator.vec3();f.x=c.vMin.x;f.y=c.vMin.y;f.z=c.vMin.z;a.x=h;a.y=e;a.z=d;this.aChildrenBBox[0].set(f,a);f.x=h;f.y=c.vMin.y;f.z=c.vMin.z;a.x=c.vMax.x;a.y=e;a.z=d;this.aChildrenBBox[1].set(f,a);f.x=c.vMin.x;f.y=c.vMin.y;f.z=d;a.x=h;a.y=e;a.z=c.vMax.z;this.aChildrenBBox[2].set(f,a);f.x=h;f.y=c.vMin.y;f.z=d;a.x=c.vMax.x;a.y=e;a.z=c.vMax.z;this.aChildrenBBox[3].set(f,a);f.x=c.vMin.x;f.y=e;f.z=c.vMin.z;a.x=h;a.y=c.vMax.y;a.z=d;this.aChildrenBBox[4].set(f,a);f.x=h;f.y=e;f.z=c.vMin.z;a.x=c.vMax.x;a.y=c.vMax.y;a.z=d;this.aChildrenBBox[5].set(f,a);f.x=c.vMin.x;f.y=e;f.z=d;a.x=h;a.y=c.vMax.y;a.z=c.vMax.z;this.aChildrenBBox[6].set(f,a);f.x=c.vMin.x;f.y=e;f.z=d;a.x=c.vMax.x;a.y=c.vMax.y;a.z=c.vMax.z;this.aChildrenBBox[7].set(f,a);okAllocator._vec3(f);okAllocator._vec3(a)},createChild:function(a){if(this.aChildrenList[a]!=null){return this.aChildrenList[a]}var c=okAllocator.sceneNode();c.parent=this;c.iParentIdx=a;c.iLevel=this.iLevel+1;c.setBoundingBox(this.aChildrenBBox[a]);this.aChildrenList[a]=c;this.iChildCount+=1;return this.aChildrenList[a]},deleteChild:function(a){if(this.aChildrenList[a]!=null){this.aChildrenList[a].clear();okAllocator._sceneNode(this.aChildrenList[a]);this.aChildrenList[a]=null;this.iChildCount-=1}},getChild:function(a){return this.aChildrenList[a]},getChildNum:function(){return this.iChildCount},attachEntity:function(a){if(a==null){alert(0)}this.aEntities.push(a)},removeEntity:function(c){var a=this.aEntities.length;for(var d=0;d<a;++d){if(this.aEntities[d]==c){this.aEntities[d]=this.aEntities[a-1];this.aEntities.pop();break}}},getEntityNum:function(){return this.aEntities.length},getBoundingBox:function(){return this.bbox},traverseTree:function(d){var e=new Array;e.push(this);while(e.length!=0){var c=e.shift();for(var a=0;a<8;++a){if(c.aChildrenList[a]!=null){e.push(c.aChildrenList[a])}}d(c)}}};function okSceneZone(a){this.sName="";this.scene=a;this.iMaxLevel=4;this.iGranularity=4;this.rootNode=okAllocator.sceneNode();this.aEntityList=new okCollection();this.aLightList=new okList();this.iCastShadowLightNum=0;this.iCastShadowEntityNum=0;this.aForceVisibleEntityMap=new Object;this.aDirtyEntityMap=new Object;this.aUpdateEntityList=new okList();this.iCurVisitFlag=0}okSceneZone.prototype={clear:function(){this.iMaxLevel=4;this.iGranularity=1;this.rootNode.clear();this.aLightList.clear();okAllocator._object(this.aDirtyEntityMap);this.aDirtyEntityMap=okAllocator.object();this.aUpdateEntityList.clear();this.aEntityList.resetIterator();var a;while(a=this.aEntityList.iterate()){a.clear()}this.aEntityList.clear();this.aForceVisibleEntityMap=new Object},setName:function(a){this.sName=a},getName:function(a){return this.sName},getScene:function(){return this.scene},getRootNode:function(){return this.rootNode},setBoundingBox:function(d,c){this.rootNode.clear();this.rootNode.setBoundingBox(d,c);this.aEntityList.resetIterator();var a;while(a=this.aEntityList.iterate()){a.__aSceneNodes.length=0;this.aDirtyEntityMap[a.getId()]=a}},getBoundingBox:function(){return this.rootNode.getBoundingBox()},setMaxLevel:function(a){this.iMaxLevel=a},getMaxLevel:function(){return this.iMaxLevel},setGranularity:function(a){this.iGranularity=a},getGranularity:function(){return this.iGranularity},createEntity:function(f){var c=null;switch(f){case 1:c=new okStaticEntity(this);break;case 2:c=new okDynamicEntity(this);break;case 256:c=new okParticleEntity(this);break;case 32:c=new okTerrainEntity(this);break;case 128:c=new okVideoEntity(this);break;case 4:c=new okDctLightEntity(this);this.aLightList.pushBack(c);break;case 8:c=new okPointLightEntity(this);this.aLightList.pushBack(c);break;case 16:c=new okSpotLightEntity(this);this.aLightList.pushBack(c);break;case 64:c=new okCustomMeshEntity(this);break;case 512:c=new okConfigEntity(this);break}c.setId(this.aEntityList.add(c));c.__iSceneVisitFlag=-1;if((f&(1|2|32|64|128|256))!=0){c.__aSceneNodes=okAllocator.array();this._addEntityToTree(this.rootNode,c)}if((f&(2|256))!=0){this.aUpdateEntityList.pushBack(c)}if((f&(1|2|32|64|128|256))!=0){var e=this.aLightList.getRoot();while(e){var a=e.data;if(a.isAffectEntity(c)){c.addLight(a)}a.addAffectEntity(c);e=e.next}}else{if((f&(4|8|16))!=0){var a=c;this.aEntityList.resetIterator();var d;while(d=this.aEntityList.iterate()){if(((d.iType&(1|2|32|64|128|256))!=0)&&a.isAffectEntity(d)){d.addLight(a);a.addAffectEntity(d)}}}}return c},deleteEntity:function(c){var e=c;if(okIsNumber(c)){e=this.aEntityList.getDataByIndex(c)}else{if(okIsString(c)){this.aEntityList.resetIterator();var m;while(m=this.aEntityList.iterate()){if(m.sName==c){e=m;break}}}}e.clear();if((e.iType&(4|8|16))!=0){var f=e;var a=f.aAffectEntities.length;for(var h=0;h<a;++h){f.aAffectEntities[h].removeLight(f)}f.clearAffectEntity();this.aLightList.remove(this.aLightList.find(f))}else{if((e.iType&(1|2|32|64|128|256))!=0){this._removeEntityFromTree(e)}var k=e.aDctLights.length;for(var h=0;h<k;++h){e.aDctLights[h].removeAffectEntity(e)}var l=e.aPointLights.length;for(var h=0;h<l;++h){e.aPointLights[h].removeAffectEntity(e)}var d=e.aSpotLights.length;for(var h=0;h<d;++h){e.aSpotLights[h].removeAffectEntity(e)}e.clearLight()}if(this.aDirtyEntityMap[e.getId()]!=null){delete this.aDirtyEntityMap[e.getId()]}if((e.iType&(2|256))!=0){this.aUpdateEntityList.remove(this.aUpdateEntityList.find(e))}this.aEntityList.removeByIndex(e.getId())},getEntity:function(a){if(okIsNumber(a)){return this.aEntityList.getDataByIndex(a)}else{if(okIsString(a)){this.aEntityList.resetIterator();var c;while(c=this.aEntityList.iterate()){if(c.sName==a){return c}}}}return null},getEntityArray:function(d,e,c){d=((d!=null)?d:okAllocator.array());e=((e!=null)?e:-1);this.aEntityList.resetIterator();var a;while(a=this.aEntityList.iterate()){if(e&a.iType){if(c&&!c(a)){continue}d.push(a)}}return d},dirtyEntity:function(a){var c=a.getId();if(this.aDirtyEntityMap[c]==null){this.aDirtyEntityMap[c]=a}},forceVisibleEntity:function(a,c){if(c){this.aForceVisibleEntityMap[a.getId()]=a.getId()}else{if(this.aForceVisibleEntityMap[a.getId()]){delete this.aForceVisibleEntityMap[a.getId()]}}},cullByFrustum:function(o,a,p,n,d){this._upDE();if(p==null){p=-1}if(d==null){d=1}this.iCurVisitFlag+=1;var m=[this.rootNode];while(m.length!=0){var c=m.shift();var h=c.aEntities.length;for(var f=0;f<h;++f){var e=c.aEntities[f];if(e.__iSceneVisitFlag<this.iCurVisitFlag&&(e.iType&p)&&(n==null||n(e))&&(e.getState()!=1)){var k=false;if(d==1){k=o.collideAABBox(e.getBoundingBox(d))}else{k=o.collideOBBox(e.getBoundingBox(d))}if(k!=0){a.push(e)}e.__iSceneVisitFlag=this.iCurVisitFlag}}for(var f=0;f<8;++f){if(c.aChildrenList[f]==null){continue}var l=o.collideAABBox(c.aChildrenBBox[f]);if(l==1){m.push(c.aChildrenList[f])}else{if(l==2){this._dumpTree(c.aChildrenList[f],a)}}}}},pick:function(p,h,s,o,c){if(s==null){s=-1}if(c==null){c=1}this._upDE();this.iCurVisitFlag+=1;var k=null;var q=10000000000;var n=new Object;var m=[this.rootNode];while(m.length!=0){var a=m.shift();var f=a.aEntities.length;for(var e=0;e<f;++e){var d=a.aEntities[e];if(d.__iSceneVisitFlag<this.iCurVisitFlag&&d.getState()!=1&&(d.iType&s)&&(o==null||o(d))){if(d.getBoundingBox(c).collideRay(p,h,n)!=0){if(n.fT0>0&&n.fT0<q){k=d;q=n.fT0}}d.__iSceneVisitFlag=this.iCurVisitFlag}}for(var e=0;e<8;++e){if(a.aChildrenList[e]==null){continue}var l=a.aChildrenBBox[e].collideRay(p,h);if(l!=0){m.push(a.aChildrenList[e])}}}return k},update:function(a){var c=this.aUpdateEntityList.getRoot();while(c){c.data.update(a);c=c.next}},_visCull:function(x,J){this._upDE();this.iCurVisitFlag+=1;for(var l in this.aForceVisibleEntityMap){var I=this.getEntity(this.aForceVisibleEntityMap[l]);I.__iSceneVisitFlag+=1;J.push(I)}var u=x.getFrustum();var d=x.getPos();var c=x.getForwardDir();var E=x.getUpDir();var G=x.getRightDir();var H=x.getVisibleFar();var h=x.getViewportWidth()/x.getViewportHeight();var a=x.getFov()*Math.PI/360;var w=Math.tan(a);var n=Math.cos(a);var p=Math.cos(Math.atan(w*h));var C=x.getProjMode();var v,t;if(C){v=h*w;t=w}else{v=x.getViewportWidth()/x.getViewportHeight();t=1}var K=okAllocator.array();K.push(this.rootNode);while(K.length!=0){var D=K.shift();var f=D.aEntities.length;for(var F=0;F<f;++F){var y=D.aEntities[F];if(y.__iSceneVisitFlag<this.iCurVisitFlag){if(y.getState()!=1){var B=false;var k=y.getBoundingSphereCenter();k.x-=d.x;k.y-=d.y;k.z-=d.z;var L=y.getBoundingSphereRadius();var s=G.x*k.x+G.y*k.y+G.z*k.z;var q=E.x*k.x+E.y*k.y+E.z*k.z;var o=c.x*k.x+c.y*k.y+c.z*k.z;if(C){var A=L/p;var z=L/n;if(s>=-o*v-A&&s<=o*v+A&&q>=-o*t-z&&q<=o*t+z&&o>=-L&&o<=H+L){B=true}}else{if(s>=-v-L&&s<=v+L&&q>=-t-L&&q<=t+L&&o>=-L&&o<=H+L){B=true}}okAllocator._vec3(k);if(B){if(y.iType!=32){J.push(y)}else{if(y.cullByFrustum(u)!=0){J.push(y)}}}}y.__iSceneVisitFlag=this.iCurVisitFlag}}for(var F=0;F<8;++F){if(D.aChildrenList[F]==null){continue}var m=u.collideAABBox(D.aChildrenBBox[F]);if(m==1){K.push(D.aChildrenList[F])}else{if(m==2){this._dumpTree(D.aChildrenList[F],J)}}}}okAllocator._array(K);okAllocator._vec3(d);okAllocator._vec3(c);okAllocator._vec3(E);okAllocator._vec3(G)},_logTree:function(d){this._upDE();var a=new Array;a.push((d!=null)?d:this.rootNode);while(a.length!=0){var h=a.pop();var k="";for(var f=0;f<h.iLevel;++f){k+="________"}k+="[Min:"+h.bbox.vMin.x+","+h.bbox.vMin.y+","+h.bbox.vMin.z+"  Max:"+h.bbox.vMax.x+","+h.bbox.vMax.y+","+h.bbox.vMax.z+"]";k+="[E:";var e=true;var c=h.aEntities.length;for(var f=0;f<c;++f){if(!e){k+=","}e=false;k+=h.aEntities[f].getId()}k+="]";window.console.log(k);for(var f=0;f<h.aChildrenList.length;++f){if(h.aChildrenList[f]!=null){a.push(h.aChildrenList[f])}}}},_addEntityToTree:function(d,a){var f=a.getBoundingBox();if(d.iLevel==this.iMaxLevel||f.collideAABBox(d.bbox)!=1){d.attachEntity(a);a.__aSceneNodes.push(d);return}else{if(d.aEntities.length<=this.iGranularity&&d.getChildNum()==0){d.attachEntity(a);a.__aSceneNodes.push(d);if(d.aEntities.length>this.iGranularity){this._splitNode(d)}return}}for(var c=0;c<8;++c){var e=d.aChildrenBBox[c].collideAABBox(f);if(e==1){this._addEntityToTree(d.createChild(c),a)}else{if(e==2){this._addEntityToTree(d.createChild(c),a);break}}}},_splitNode:function(c){var m=okAllocator.array();var k=c.aEntities.length;for(var d=0;d<k;++d){var f=c.aEntities[d];var n=f.getBoundingBox();if(n.collideAABBox(c.bbox)!=1){m.push(f)}else{var a=f.__aSceneNodes.length;for(var h=0;h<a;++h){if(f.__aSceneNodes[h]==c){f.__aSceneNodes[h]=f.__aSceneNodes[a-1];f.__aSceneNodes.pop();break}}c.aEntities[d]=c.aEntities[k-1];c.aEntities.pop();k-=1;--d;for(var e=0;e<8;++e){var l=c.aChildrenBBox[e].collideAABBox(n);if(l==1){this._addEntityToTree(c.createChild(e),f)}else{if(l==2){this._addEntityToTree(c.createChild(e),f);break}}}}}okAllocator._array(c.aEntities);c.aEntities=m},_removeEntityFromTree:function(c){var a=c.__aSceneNodes.length;for(var e=0;e<a;++e){var h=c.__aSceneNodes[e];h.removeEntity(c);if(h.aEntities.length==0&&h.getChildNum()==0){var d=h;while(d!=null){var f=d.parent;if(f!=null){f.deleteChild(d.iParentIdx);if(f.getEntityNum()==0&&f.getChildNum()==0){d=f}else{d=null}}else{d=null}}}}c.__aSceneNodes.length=0},_upDE:function(){var e=okAllocator.array();for(var d in this.aDirtyEntityMap){var a=this.aDirtyEntityMap[d];e.push(a);if((a.iType&(1|2|32|64|128|256))!=0){this._removeEntityFromTree(a)}delete this.aDirtyEntityMap[d]}var f=e.length;for(var c=0;c<f;++c){var a=e[c];if((a.iType&(1|2|32|64|128|256))!=0){this._addEntityToTree(this.rootNode,a)}this._evalLE(a)}okAllocator._array(e)},_evalLE:function(d){var h=d.getType();if((h&(4|8|16))!=0){var c=d;var a=c.aAffectEntities.length;for(var f=0;f<a;++f){c.aAffectEntities[f].removeLight(c)}c.clearAffectEntity();this.aEntityList.resetIterator();var e;while(e=this.aEntityList.iterate()){if(((e.iType&(1|2|32|64|128|256))!=0)&&c.isAffectEntity(e)){e.addLight(c);c.addAffectEntity(e)}}}else{if((h&(1|2|32|64|128|256))!=0){var k=d.aDctLights.length;for(var f=0;f<k;++f){d.aDctLights[f].removeAffectEntity(d)}var k=d.aPointLights.length;for(var f=0;f<k;++f){d.aPointLights[f].removeAffectEntity(d)}var k=d.aSpotLights.length;for(var f=0;f<k;++f){d.aSpotLights[f].removeAffectEntity(d)}d.clearLight();lightNode=this.aLightList.getRoot();while(lightNode){var c=lightNode.data;if(c.isAffectEntity(d)){d.addLight(c);c.addAffectEntity(d)}lightNode=lightNode.next}}}},_dumpTree:function(f,h){var k=okAllocator.array();k.push(f);while(k.length!=0){var e=k.shift();var a=e.aEntities.length;for(var d=0;d<a;++d){var c=e.aEntities[d];if(c.__iSceneVisitFlag<this.iCurVisitFlag){if(c.getState()!=1){h.push(c)}c.__iSceneVisitFlag=this.iCurVisitFlag}}for(var d=0;d<8;++d){if(e.aChildrenList[d]==null){continue}k.push(e.aChildrenList[d])}}okAllocator._array(k)}};function okScene(d,c){this.resourceManager=c;this.sName=d;this.aZoneList=new Object;var a=new okSceneZone(this);a.setName("Default");this.aZoneList.Default=a;this.sBasePath="";this.sModelPath="";this.sAnimationPath="";this.sTerrainPath="";this.sTexturePath="";this.aCameraList=new okList()}okScene.prototype={clear:function(){this.clearEntity();this.clearCamera()},clearEntity:function(){for(var c in this.aZoneList){this.aZoneList[c].clear()}okAllocator._object(this.aZoneList);this.aZoneList=okAllocator.object();var a=new okSceneZone(this);a.setName("Default");this.aZoneList.Default=a},clearCamera:function(){var a=this.aCameraList.getRoot();while(a){a.data.clear();a=a.next}this.aCameraList.clear()},getName:function(){return this.sName},setBaseUrl:function(a){a=a.replace(/\\/g,"/");a=a.replace(/\/$/g,"");this.sBasePath=a},getBaseUrl:function(a){return this.sBasePath},setModelUrl:function(a){a=a.replace(/\\/g,"/");a=a.replace(/\/$/g,"");this.sModelPath=a},_packModelUrl:function(c){c=c.replace(/\\/g,"/");c=c.replace(/^\/+/g,"");if(c.indexOf(":")!=-1){return c}var a=this.sBasePath;a+=((a!="")?("/"+this.sModelPath):this.sModelPath);a+=((a!="")?("/"+c):c);return a},getModelUrl:function(){return this.sModelPath},setSkAnimationUrl:function(a){a=a.replace(/\\/g,"/");a=a.replace(/\/$/g,"");this.sAnimationPath=a},getSkAnimationUrl:function(){return this.sAnimationPath},_packSkAnimationUrl:function(c){c=c.replace(/\\/g,"/");c=c.replace(/^\/+/g,"");if(c.indexOf(":")!=-1){return c}var a=this.sBasePath;a+=((a!="")?("/"+this.sAnimationPath):this.sAnimationPath);a+=((a!="")?("/"+c):c);return a},setTerrainUrl:function(a){a=a.replace(/\\/g,"/");a=a.replace(/\/$/g,"");this.sTerrainPath=a},getTerrainUrl:function(){return this.sTerrainPath},_packTerrainUrl:function(c){c=c.replace(/\\/g,"/");c=c.replace(/^\/+/g,"");if(c.indexOf(":")!=-1){return c}var a=this.sBasePath;a+=((a!="")?("/"+this.sTerrainPath):this.sTerrainPath);a+=((a!="")?("/"+c):c);return a},setTextureUrl:function(a){a=a.replace(/\\/g,"/");a=a.replace(/\/$/g,"");this.sTexturePath=a},getTextureUrl:function(){return this.sTexturePath},_packTextureUrl:function(c){c=c.replace(/\\/g,"/");c=c.replace(/^\/+/g,"");if(c.indexOf(":")!=-1){return c}var a=this.sBasePath;a+=((a!="")?("/"+this.sTexturePath):this.sTexturePath);a+=((a!="")?("/"+c):c);return a},getZone:function(a){return this.aZoneList[(a!=null)?a:"Default"]},setZoneBoundingBox:function(e,c,d){var a=this.aZoneList[(d!=null)?d:"Default"];a.setBoundingBox(new okAABBox(e,c))},getZoneBoundingBox:function(c){var a=this.aZoneList[(c!=null)?c:"Default"];return a.getBoundingBox()},setZoneGranularity:function(c,d){var a=this.aZoneList[(d!=null)?d:"Default"];a.setGranularity(c)},getZoneGranularity:function(c){var a=this.aZoneList[(c!=null)?c:"Default"];return a.getGranularity()},setZoneMaxLevel:function(c,d){var a=this.aZoneList[(d!=null)?d:"Default"];a.setMaxLevel(c)},getZoneMaxLevel:function(c){var a=this.aZoneList[(c!=null)?c:"Default"];return a.getMaxLevel()},createCamera:function(c){var a=new okCamera(this.resourceManager.rc);a.scene=this;if(c!=null){a.setName(c)}this.aCameraList.pushBack(a);return a},deleteCamera:function(c){if(okIsString(c)){var a=this.aCameraList.getRoot();while(a){if(a.data.getName()==c){a.data.clear();this.aCameraList.remove(a);return}a=a.next}}else{c.clear();this.aCameraList.remove(this.aCameraList.find(c))}},getCamera:function(c){var a=this.aCameraList.getRoot();while(a){if(a.data.getName()==c){return a.data}a=a.next}return null},getCameraArray:function(c,a){if(c==null){c=okAllocator.array()}var d=this.aCameraList.getRoot();while(d){if(a==null||a(d.data)){c.push(d.data)}d=d.next}return c},createEntity:function(c,h,d){var a=this.aZoneList[(d!=null)?d:"Default"];var f=a.createEntity(c);if(h){f.setName(h)}return f},deleteEntity:function(c,d){var a=this.aZoneList[(d!=null)?d:"Default"];return a.deleteEntity(c)},getEntity:function(c,d){var a=this.aZoneList[(d!=null)?d:"Default"];return a.getEntity(c)},getEntityArray:function(d,f,c,e){if(d==null){d=okAllocator.array()}var a=this.aZoneList[(e!=null)?e:"Default"];a.getEntityArray(d,f,c);return d},cullByFrustum:function(h,d,k,c,e,f){var a=this.aZoneList[(f!=null)?f:"Default"];return a.cullByFrustum(h,d,k,c,e)},pick:function(d,k,h,c,e,f){var a=this.aZoneList[(f!=null)?f:"Default"];return a.pick(d,k,h,c,e)},update:function(c,d){var a=this.aZoneList[(d!=null)?d:"Default"];a.update(c)}};function okSceneManager(a,c){this.resourceManager=c;this.aSceneList=new Object}okSceneManager.prototype={clear:function(){for(var a in this.aSceneList){this.aSceneList[a].clear()}okAllocator._object(this.aSceneList);this.aSceneList=okAllocator.object()},createScene:function(a){var c=this.aSceneList[a];if(!c){c=new okScene(a,this.resourceManager);this.aSceneList[a]=c}return c},deleteScene:function(a){var c=this.aSceneList[a];if(c){c.clear();delete this.aSceneList[a]}},getScene:function(a){return this.aSceneList[a]}};function okResource(){this.iType=0;this.data=null;this.sKey=null;this.iRef=0;this.iState=1;this.bCustom=false;this.aListenerList=new okList()}okResource.prototype={clear:function(){if(this.data){if(this.iType==1){this.data.clear()}else{if(this.iType==2){this.data.releaseTexture()}else{if(this.iType==3){this.data.clear()}}}this.data=null}this.iType=0;this.sKey=null;this.iRef=0;this.iState=1;this.bCustom=false;this.aListenerList.clear()}};function okResourceManager(a,c){this.rc=c;this.aResList=new okCollection();this.aKeyIdMap=new Object;this.bAsyncLoad=a.bAsyncLoad}okResourceManager.prototype={clear:function(){this.aResList.resetIterator();var a;while(a=this.aResList.iterate()){a.clear()}this.aResList.clear();okAllocator._object(this.aKeyIdMap);this.aKeyIdMap=okAllocator.object()},getResourceType:function(a){if(!this.aResList.isIndexValid(a)){return 0}return this.aResList.getDataByIndex(a).iType},getResourceState:function(a){if(!this.aResList.isIndexValid(a)){return 1}return this.aResList.getDataByIndex(a).iState},getResourceNum:function(){return this.aResList.getSize()},setCustomResourceState:function(d,c){if(!this.aResList.isIndexValid(d)){return false}var a=this.aResList.getDataByIndex(d);if(!a.bCustom){return false}a.iState=c;return true},createResource:function(e,h,f){var a=this.aKeyIdMap[h];if(a!=null){var c=this.aResList.getDataByIndex(a);c.iRef+=1;return a}var c=new okResource();c.iType=e;c.iRef=1;c.iState=(f==true)?5:2;c.sKey=h;c.bCustom=f==true?true:false;if(e==1){c.data=new okModel(this.rc)}else{if(e==2){c.data=new okTexture(this.rc)}else{if(e==3){c.data=new okSkAnimation()}}}var d=this.aResList.add(c);this.aKeyIdMap[h]=d;return d},getResource:function(c){if(okIsNumber(c)){if(c<0){return null}return this.aResList.getDataByIndex(c).data}var a=this.aKeyIdMap[c];if(a!=null){return this.aResList.getDataByIndex(a).data}return null},getResourceId:function(a){if(this.aKeyIdMap[a]!=null){return this.aKeyIdMap[a]}return -1},deleteResource:function(c){var d=null;var e=-1;if(okIsNumber(c)){d=this.aResList.getDataByIndex(c);e=c}else{var a=this.aKeyIdMap[c];if(a!=null){d=this.aResList.getDataByIndex(a);e=a}}if(d){d.iRef-=1;if(d.iRef==0){this.postMessage(e,"RES_DELETED",[e]);delete this.aKeyIdMap[d.sKey];d.clear();this.aResList.removeByIndex(e)}}},registerListener:function(d,c){if(this.aResList.isIndexValid(d)){var a=this.aResList.getDataByIndex(d);if(a.aListenerList.find(c)==null){a.aListenerList.pushBack(c)}}},removeListener:function(d,c){if(this.aResList.isIndexValid(d)){var a=this.aResList.getDataByIndex(d);a.aListenerList.remove(a.aListenerList.find(c))}},loadModelByUrl:function(k,a,d,e){if(!this.aResList.isIndexValid(k)){return false}var c=this.aResList.getDataByIndex(k);if(c.iType!=1||c.bCustom){return false}if(c.iState!=3){c.iState=3;var f=this;var h=okGenXmlHttpRequest();h.open("GET",a,this.bAsyncLoad&&(e!=true));h.overrideMimeType("text/plain; charset=x-user-defined");if(okIsIE()){h.onreadystatechange=function(){if(h.readyState==4){if(h.status==200||h.status==0){var l=h.responseText.substr(0,6);if(l=="OKMDBI"){if(okResourceParser.loadModel(3,c.data,h.responseText,d,true,true)==false){c.iState=2;return}}else{if(okResourceParser.loadModel(1,c.data,h.responseText,d,true,true)==false){c.iState=2;return false}}c.iState=5;f.postMessage(k,"RES_READY",[k])}}}}else{h.onload=function(){var l=h.responseText.substr(0,6);if(l=="OKMDBI"){if(okResourceParser.loadModel(3,c.data,h.responseText,d,true,true)==false){c.iState=2;return false}}else{if(okResourceParser.loadModel(1,c.data,h.responseText,d,true,true)==false){c.iState=2;return false}}c.iState=5;f.postMessage(k,"RES_READY",[k])};h.onerror=function(){c.iState=2}}h.send()}else{return false}return true},loadModelByText:function(f,a,d){if(!this.aResList.isIndexValid(f)){return false}var c=this.aResList.getDataByIndex(f);if(c.iType!=1||c.bCustom){return false}if(c.iState!=3){c.iState=3;var e=a.substr(0,6);if(e=="OKMDBI"){if(okResourceParser.loadModel(3,c.data,a,d,true,true)==false){c.iState=2;return false}}else{if(okResourceParser.loadModel(1,c.data,a,d,true,true)==false){c.iState=2;return false}}c.iState=5;this.postMessage(f,"RES_READY",[f])}else{return false}return true},loadSkAnimationByUrl:function(h,a,e){if(!this.aResList.isIndexValid(h)){return false}var d=this.aResList.getDataByIndex(h);if(d.iType!=3||d.bCustom){return false}if(d.iState!=3){d.iState=3;var f=this;var c=new okGenXmlHttpRequest();c.open("GET",a,this.bAsyncLoad&&(e!=true));c.overrideMimeType("text/plain; charset=x-user-defined");if(okIsIE()){c.onreadystatechange=function(){if(c.readyState==4){if(c.status==200||c.status==0){var k=c.responseText.substr(0,6);if(k=="OKAMBI"){if(okResourceParser.loadSkAnimation(3,d.data,c.responseText)==false){d.iState=2;return}}else{if(okResourceParser.loadSkAnimation(1,d.data,c.responseText)==false){d.iState=2;return false}}d.iState=5;f.postMessage(h,"RES_READY",[h])}}}}else{c.onload=function(){var k=c.responseText.substr(0,6);if(k=="OKAMBI"){if(okResourceParser.loadSkAnimation(3,d.data,c.responseText)==false){d.iState=2;return}}else{if(okResourceParser.loadSkAnimation(1,d.data,c.responseText)==false){d.iState=2;return false}}d.iState=5;f.postMessage(h,"RES_READY",[h])};c.onerror=function(){d.iState=2}}c.send()}else{return false}return true},loadSkAnimationByText:function(e,a){if(!this.aResList.isIndexValid(e)){return false}var c=this.aResList.getDataByIndex(e);if(c.iType!=3||c.bCustom){return false}if(c.iState!=3){c.iState=3;var d=a.substr(0,6);if(d=="OKAMBI"){if(okResourceParser.loadSkAnimation(3,c.data,a)==false){c.iState=2;return false}}else{if(okResourceParser.loadSkAnimation(1,c.data,a)==false){c.iState=2;return false}}c.iState=5;this.postMessage(e,"RES_READY",[e])}else{return false}return true},loadTextureByUrl:function(a,p,o){if(!this.aResList.isIndexValid(a)){return false}var m=this.aResList.getDataByIndex(a);if(m.iType==0){m.iType=2;m.data=new okTexture(this.rc)}if(m.iType!=2||m.bCustom){return false}if(m.iState!=3){m.iState=3;var d=this;var e=okFileFilter(p);if(e!="mp4"&&e!="ogg"&&e!="ogv"){var f=new Image();f.onload=function(){okResourceParser.loadTextureFromImage(m.data,f,o);m.data.genMipMap();m.iState=5;d.postMessage(a,"RES_READY",[a])};f.onerror=function(){m.iState=2};f.src=p}else{var k=p;var p=p.substring(0,p.lastIndexOf("."));p.replace("\\","/");p=p.substring(p.lastIndexOf("/")+1,p.length);var c=document.getElementById(p);if(!c){c=document.createElement("video");c.src=k;c.id=p;c.autoplay=true;c.preload="auto";c.loop=true;m.data.video=c}function l(q){okResourceParser.loadTextureFromVideo(m.data,c,o);m.iState=5;m.data.video=c;d.postMessage(a,"RES_READY",[a])}function h(q){c.play()}function n(q){m.iState=2}c.addEventListener("canplaythrough",l,false);c.addEventListener("error",n,false);c.addEventListener("ended",h,false)}}else{return false}return true},loadTextureByImage:function(e,d,a){if(!this.aResList.isIndexValid(e)){return false}var c=this.aResList.getDataByIndex(e);if(c.iType==0){c.iType=2;c.data=new okTexture(this.rc)}if(c.iType!=2||c.bCustom){return false}if(c.iState!=3){c.iState=3;okResourceParser.loadTextureFromImage(c.data,d,a);c.data.genMipMap();c.iState=5;this.postMessage(e,"RES_READY",[e])}else{return false}return true},loadTextureByVideo:function(e,d,a){if(!this.aResList.isIndexValid(e)){return false}var c=this.aResList.getDataByIndex(e);if(c.iType==0){c.iType=2;c.data=new okTexture(this.rc)}if(c.iType!=2||c.bCustom){return false}if(c.iState!=3){c.iState=3;okResourceParser.loadTextureFromVideo(c.data,d,a);c.data.video=d;c.iState=5;this.postMessage(e,"RES_READY",[e])}else{return false}return true},loadCubeTextureByUrl:function(a,q,f,n,e,l,d,s){if(!this.aResList.isIndexValid(a)){return false}var h=this.aResList.getDataByIndex(a);if(h.iType==0){h.iType=2;h.data=new okTexture(this.rc)}if(h.iType!=2||h.bCustom){return false}if(h.iState!=3){h.iState=3;var p=h.data;var c=this;var o=new Image();o.onerror=function(){h.iState=2};var v=new Image();v.onerror=function(){h.iState=2};var m=new Image();m.onerror=function(){h.iState=2};var u=new Image();u.onerror=function(){h.iState=2};var k=new Image();k.onerror=function(){h.iState=2};var t=new Image();t.onerror=function(){h.iState=2};o.onload=function(){v.onload=function(){m.onload=function(){u.onload=function(){k.onload=function(){t.onload=function(){p.createTexture(34067,o.width,o.height,6408,5121,o,v,m,u,k,t);p.genMipMap();h.iState=5;c.postMessage(a,"RES_READY",[a])};t.src=d};k.src=l};u.src=e};m.src=n};v.src=f};o.src=q}else{return false}return true},postMessage:function(h,a,f){if(!this.aResList.isIndexValid(h)){return false}var e=new Object;e.sMsg=a;e.aArgs=f.slice();var c=this.aResList.getDataByIndex(h);var d=c.aListenerList.getRoot();while(d){d.data.onMessage(e);d=d.next}}};function okShaderManager(a){this.rc=a.rc;this.engineInfo=a.engineInfo;this.sShaderSourcePath="";this.sFloatPrecision="mediump";this.aIncludeMap=null;this.aVertexShaderMap=new Object;this.aFragmentShaderMap=new Object;this.aProgramMap=new Object;this.sGlobayKey=""+this.engineInfo.bFloatRt;this.aVertexSourceMap=new Object;this.aFragmentSourceMap=new Object;this.aIncludeMap=new Object;this.aIncludeMap.HeaderCommon="varying vec3 okVary_Pos;varying vec4 okVary_ScrTC;\n#ifdef OK_NORMAL\nvarying vec3 okVary_Normal;\n#endif\n#ifdef OK_VERTEX_COLOR\nvarying vec3 okVary_Color;\n#endif\n#ifdef OK_TC12\nvarying vec4 okVary_TC12;\n#else\n#ifdef OK_TC1\nvarying vec2 okVary_TC1;\n#endif\n#ifdef OK_TC2\nvarying vec2 okVary_TC2;\n#endif\n#endif\n#ifdef OK_TC34\nvarying vec4 okVary_TC34;\n#else\n#ifdef OK_TC3\nvarying vec2 okVary_TC3;\n#endif\n#ifdef OK_TC4\nvarying vec2 okVary_TC4;\n#endif\n#endif\n#ifdef OK_TANGENT\nvarying vec3 okVary_Tangent;\n#endif\n#ifdef OK_BINORMAL\nvarying vec3 okVary_Binormal;\n#endif\n";this.aIncludeMap.HeaderFS="uniform vec4 okUni_General[46];\n#ifdef OK_TEX_ALBEDO1\n#ifdef OK_TEX_ALBEDO1_CUBE\nuniform samplerCube okUni_Sampler0;\n#else\nuniform sampler2D okUni_Sampler0;\n#endif\n#endif\n#ifdef OK_TEX_ALBEDO2\n#ifdef OK_TEX_ALBEDO2_CUBE\nuniform samplerCube okUni_Sampler1;\n#else\nuniform sampler2D okUni_Sampler1;\n#endif\n#endif\n#ifdef OK_TEX_ALBEDO3\n#ifdef OK_TEX_ALBEDO3_CUBE\nuniform samplerCube okUni_Sampler2;\n#else\nuniform sampler2D okUni_Sampler2;\n#endif\n#endif\n#ifdef OK_TEX_ALBEDO4\n#ifdef OK_TEX_ALBEDO4_CUBE\nuniform samplerCube okUni_Sampler3;\n#else\nuniform sampler2D okUni_Sampler3;\n#endif\n#endif\n#ifdef OK_TEX_NORMALMAP\nuniform sampler2D okUni_Sampler4;\n#endif\n#ifdef OK_TEX_OPACITY\nuniform sampler2D okUni_Sampler5;\n#endif\n#ifdef OK_TEX_SPECULAR_LEVEL\nuniform sampler2D okUni_Sampler6;\n#endif\nvec3 okGlb_P;vec2 okGlb_ScrTC;vec3 okGlb_N;vec3 okGlb_V;vec3 okGlb_R;\n#define P okGlb_P\n#define SCRTC okGlb_ScrTC\n#define CP okUni_General[7].xyz\n#define N okGlb_N\n#define V okGlb_V\n#define R okGlb_R\n#define T okUni_General[4].w\n#define RAND okUni_General[5].w\n#define EMI okUni_General[0].xyz\n#define AMB okUni_General[1].xyz\n#define DIF okUni_General[2].xyz\n#define SPE okUni_General[3].xyz\n#define GLO okUni_General[0].w\n#define ALPHA okUni_General[2].w\n#define GROUND okUni_General[4].xyz\n#define SKY okUni_General[5].xyz\n#ifdef OK_VERTEX_COLOR\n#define VC okVary_Color\n#else\n#define VC vec3(0.0,0.0,0.0)\n#endif\n#ifdef OK_TC12\n#define TC1 okVary_TC12.xy\n#define TC2 okVary_TC12.zw\n#else\n#ifdef OK_TC1\n#define TC1 okVary_TC1\n#else\n#define TC1 vec2(0.0)\n#endif\n#ifdef OK_TC2\n#define TC2 okVary_TC2\n#else\n#define TC2 vec2(0.0)\n#endif\n#endif\n#ifdef OK_TC34\n#define TC3 okVary_TC34.xy\n#define TC4 okVary_TC34.zw\n#else\n#ifdef OK_TC3\n#define TC3 okVary_TC3\n#else\n#define TC3 vec2(0.0)\n#endif\n#ifdef OK_TC4\n#define TC4 okVary_TC4\n#else\n#define TC4 vec2(0.0)\n#endif\n#endif\nvec2 okRotTC(vec2 d,float e){float a=cos(e);float b=sin(e);mat2 c=mat2(a,b,-b,a);return(c*(d-0.5))+0.5;}vec3 okFunc_GetMaterialEmissive(){\n#ifdef OK_SCRIPT_EMISSIVE_CODE\n{OK_SCRIPT_EMISSIVE_CODE}\n#else\nreturn okUni_General[0].xyz;\n#endif\n}vec3 okFunc_GetMaterialDiffuse(){\n#ifdef OK_SCRIPT_DIFFUSE_CODE\n{OK_SCRIPT_DIFFUSE_CODE}\n#else\n#if defined(OK_TEX_ALBEDO1)||defined(OK_TEX_ALBEDO2)||defined(OK_TEX_ALBEDO3)||defined(OK_TEX_ALBEDO4)\nvec3 albedo=vec3(1,1,1);\n#ifdef OK_TEX_ALBEDO1\n#ifdef OK_TEX_ALBEDO1_CUBE\nalbedo=textureCube(okUni_Sampler0,R).xyz;\n#else\nalbedo=texture2D(okUni_Sampler0,OK_ALBEDO1_TC).xyz;\n#endif\n#endif\n#ifdef OK_TEX_ALBEDO2\n#ifdef OK_TEX_ALBEDO2_CUBE\nvec4 albedo2=textureCube(okUni_Sampler1,R);\n#else\nvec4 albedo2=texture2D(okUni_Sampler1,OK_ALBEDO2_TC);\n#endif\nalbedo=albedo.xyz*albedo2.xyz;\n#endif\n#ifdef OK_TEX_ALBEDO3\n#ifdef OK_TEX_ALBEDO3_CUBE\nvec4 albedo3=textureCube(okUni_Sampler2,R);\n#else\nvec4 albedo3=texture2D(okUni_Sampler2,OK_ALBEDO3_TC);\n#endif\nalbedo=albedo.xyz*albedo3.xyz;\n#endif\n#ifdef OK_TEX_ALBEDO4\n#ifdef OK_TEX_ALBEDO4_CUBE\nvec4 albedo4=textureCube(okUni_Sampler3,R);\n#else\nvec4 albedo4=texture2D(okUni_Sampler3,OK_ALBEDO4_TC);\n#endif\nalbedo=albedo.xyz*albedo4.xyz;\n#endif\nreturn albedo*okUni_General[2].xyz;\n#else\nreturn okUni_General[2].xyz;\n#endif\n#endif\n}float okFunc_GetMaterialDiffusePower(){\n#ifdef OK_SCRIPT_DIFFUSEPOWER_CODE\n{OK_SCRIPT_DIFFUSEPOWER_CODE}\n#else\nreturn 1.0;\n#endif\n}vec3 okFunc_GetMaterialSpecular(){\n#ifdef OK_SCRIPT_SPECULAR_CODE\n{OK_SCRIPT_SPECULAR_CODE}\n#else\n#ifdef OK_TEX_SPECULAR_LEVEL\nreturn texture2D(okUni_Sampler6,OK_SPECULAR_LEVEL_TC).xyz*okUni_General[3].xyz;\n#else\nreturn vec3(okUni_General[1].w)*okUni_General[3].xyz;\n#endif\n#endif\n}float okFunc_GetMaterialSpecularPower(){\n#ifdef OK_SCRIPT_SPECULARPOWER_CODE\n{OK_SCRIPT_SPECULARPOWER_CODE}\n#else\nreturn okUni_General[0].w;\n#endif\n}float okFunc_GetMaterialAlpha(){\n#ifdef OK_SCRIPT_ALPHA_CODE\n{OK_SCRIPT_ALPHA_CODE}\n#else\n#ifdef OK_TEX_OPACITY\nreturn texture2D(okUni_Sampler5,OK_OPACITY_TC).a;\n#else\nreturn okUni_General[2].a;\n#endif\n#endif\n}\n#ifdef OK_SCRIPT_NORMAL_CODE\nvec3 okFunc_GetNormalScript(){OK_SCRIPT_NORMAL_CODE}\n#endif\nvec3 okFunc_GetMaterialNormal(){\n#ifdef OK_NORMAL\nvec3 vertexNormal=okVary_Normal;\n#else\nvec3 vertexNormal=vec3(0.0,1.0,0.0);\n#endif\n#ifdef OK_SCRIPT_NORMAL_CODE\nvec3 normalT=okFunc_GetNormalScript();mat3 matTangent=mat3(\n#ifdef OK_TANGENT\nokVary_Tangent,\n#else\nvec3(1.0,0.0,0.0),\n#endif\n#ifdef OK_BINORMAL\nokVary_Binormal,\n#else\nvec3(0.0,1.0,0.0),\n#endif\nvertexNormal);vec3 retNormal=normalize(matTangent*normalT);\n#else\n#ifdef OK_TEX_NORMALMAP\nvec3 normalT=texture2D(okUni_Sampler4,OK_NORMALMAP_TC).xyz;normalT=normalT*2.0-1.0;mat3 matTangent=mat3(\n#ifdef OK_TANGENT\nokVary_Tangent,\n#else\nvec3(1.0,0.0,0.0),\n#endif\n#ifdef OK_BINORMAL\nokVary_Binormal,\n#else\nvec3(0.0,1.0,0.0),\n#endif\nvertexNormal);vec3 retNormal=normalize(matTangent*normalT);\n#else\nvec3 retNormal=normalize(vertexNormal);\n#endif\n#endif\n#ifdef OK_TWO_SIDE\nreturn retNormal*(gl_FrontFacing?1.0:-1.0);\n#else\nreturn retNormal;\n#endif\n}void okFunc_GetMaterialDctLighting(vec3 LDIR,vec3 LCOLOR,inout vec3 LDIFFUSE,inout vec3 LSPECULAR){\n#ifdef OK_SCRIPT_DCTLIGHT_CODE\n{OK_SCRIPT_DCTLIGHT_CODE}\n#endif\n}void okFunc_GetMaterialPointLighting(vec3 LPOS,vec3 LCOLOR,vec3 LRANGE,inout vec3 LDIFFUSE,inout vec3 LSPECULAR){\n#ifdef OK_SCRIPT_POINTLIGHT_CODE\n{OK_SCRIPT_POINTLIGHT_CODE}\n#endif\n}void okFunc_GetMaterialSpotLighting(vec3 LPOS,vec3 LCOLOR,vec3 LDIR,float LINCONE,float LOUTCONE,inout vec3 LDIFFUSE,inout vec3 LSPECULAR){\n#ifdef OK_SCRIPT_SPOTLIGHT_CODE\n{OK_SCRIPT_SPOTLIGHT_CODE}\n#endif\n}void okFunc_ProcessFragment(){P=okVary_Pos;SCRTC=okUni_General[6].xy+(okVary_ScrTC.xy/okVary_ScrTC.w+1.0)*0.5*okUni_General[6].zw;vec3 normal=okFunc_GetMaterialNormal();N=normal;vec3 camVec=normalize(okUni_General[7].xyz-P);V=-camVec;vec3 reflectVec=normalize(reflect(-camVec,normal));R=reflectVec;\n#ifdef OK_ALPHA_TEST\nif(okFunc_GetMaterialAlpha()<=okUni_General[3].w)discard;\n#endif\n}";this.aIncludeMap.HeaderVS="attribute vec3 okAttr_Pos;\n#ifdef OK_NORMAL\nattribute vec3 okAttr_Normal;\n#endif\n#ifdef OK_VERTEX_COLOR\nattribute vec3 okAttr_Color;\n#endif\n#ifdef OK_TC12\nattribute vec4 okAttr_TC12;\n#else\n#ifdef OK_TC1\nattribute vec2 okAttr_TC1;\n#endif\n#ifdef OK_TC2\nattribute vec2 okAttr_TC2;\n#endif\n#endif\n#ifdef OK_TC34\nattribute vec4 okAttr_TC34;\n#else\n#ifdef OK_TC3\nattribute vec2 okAttr_TC3;\n#endif\n#ifdef OK_TC4\nattribute vec2 okAttr_TC4;\n#endif\n#endif\n#ifdef OK_TANGENT\nattribute vec3 okAttr_Tangent;\n#endif\n#ifdef OK_BINORMAL\nattribute vec3 okAttr_Binormal;\n#endif\n#ifdef OK_SKANIMATION\nattribute vec4 okAttr_BoneIdx;attribute vec4 okAttr_BoneWeight;uniform vec4 okUni_BoneMat[32*3];\n#endif\nuniform mat4 okUni_TransMat[4];void okFunc_ProcessVertex(){\n#ifdef OK_SKANIMATION\nmat4 a=mat4(0.0);{int c=int(okAttr_BoneIdx[0])+1;vec4 d=vec4(okUni_BoneMat[c*3].x,okUni_BoneMat[c*3+1].x,okUni_BoneMat[c*3+2].x,0.0);vec4 e=vec4(okUni_BoneMat[c*3].y,okUni_BoneMat[c*3+1].y,okUni_BoneMat[c*3+2].y,0.0);vec4 f=vec4(okUni_BoneMat[c*3].z,okUni_BoneMat[c*3+1].z,okUni_BoneMat[c*3+2].z,0.0);vec4 g=vec4(okUni_BoneMat[c*3].w,okUni_BoneMat[c*3+1].w,okUni_BoneMat[c*3+2].w,1.0);a+=okAttr_BoneWeight[0]*mat4(d,e,f,g);}{int c=int(okAttr_BoneIdx[1])+1;vec4 d=vec4(okUni_BoneMat[c*3].x,okUni_BoneMat[c*3+1].x,okUni_BoneMat[c*3+2].x,0.0);vec4 e=vec4(okUni_BoneMat[c*3].y,okUni_BoneMat[c*3+1].y,okUni_BoneMat[c*3+2].y,0.0);vec4 f=vec4(okUni_BoneMat[c*3].z,okUni_BoneMat[c*3+1].z,okUni_BoneMat[c*3+2].z,0.0);vec4 g=vec4(okUni_BoneMat[c*3].w,okUni_BoneMat[c*3+1].w,okUni_BoneMat[c*3+2].w,1.0);a+=okAttr_BoneWeight[1]*mat4(d,e,f,g);}{int c=int(okAttr_BoneIdx[2])+1;vec4 d=vec4(okUni_BoneMat[c*3].x,okUni_BoneMat[c*3+1].x,okUni_BoneMat[c*3+2].x,0.0);vec4 e=vec4(okUni_BoneMat[c*3].y,okUni_BoneMat[c*3+1].y,okUni_BoneMat[c*3+2].y,0.0);vec4 f=vec4(okUni_BoneMat[c*3].z,okUni_BoneMat[c*3+1].z,okUni_BoneMat[c*3+2].z,0.0);vec4 g=vec4(okUni_BoneMat[c*3].w,okUni_BoneMat[c*3+1].w,okUni_BoneMat[c*3+2].w,1.0);a+=okAttr_BoneWeight[2]*mat4(d,e,f,g);}{int c=int(okAttr_BoneIdx[3])+1;vec4 d=vec4(okUni_BoneMat[c*3].x,okUni_BoneMat[c*3+1].x,okUni_BoneMat[c*3+2].x,0.0);vec4 e=vec4(okUni_BoneMat[c*3].y,okUni_BoneMat[c*3+1].y,okUni_BoneMat[c*3+2].y,0.0);vec4 f=vec4(okUni_BoneMat[c*3].z,okUni_BoneMat[c*3+1].z,okUni_BoneMat[c*3+2].z,0.0);vec4 g=vec4(okUni_BoneMat[c*3].w,okUni_BoneMat[c*3+1].w,okUni_BoneMat[c*3+2].w,1.0);a+=okAttr_BoneWeight[3]*mat4(d,e,f,g);}\n#endif\n#ifdef OK_NORMAL\nokVary_Normal=(\n#ifdef OK_BILLBOARD\nokUni_TransMat[3]*\n#endif\nokUni_TransMat[1]*\n#ifdef OK_SKANIMATION\na*\n#endif\nvec4(okAttr_Normal,0.0)).xyz;\n#endif\n#ifdef OK_VERTEX_COLOR\nokVary_Color=okAttr_Color;\n#endif\n#ifdef OK_TC12\nokVary_TC12=okAttr_TC12;\n#else\n#ifdef OK_TC1\nokVary_TC1=okAttr_TC1;\n#endif\n#ifdef OK_TC2\nokVary_TC2=okAttr_TC2;\n#endif\n#endif\n#ifdef OK_TC34\nokVary_TC34=okAttr_TC34;\n#else\n#ifdef OK_TC3\nokVary_TC3=okAttr_TC3;\n#endif\n#ifdef OK_TC4\nokVary_TC4=okAttr_TC4;\n#endif\n#endif\n#ifdef OK_TANGENT\nokVary_Tangent=(\n#ifdef OK_BILLBOARD\nokUni_TransMat[3]*\n#endif\nokUni_TransMat[1]*\n#ifdef OK_SKANIMATION\na*\n#endif\nvec4(okAttr_Tangent,0.0)).xyz;\n#endif\n#ifdef OK_BINORMAL\nokVary_Binormal=(\n#ifdef OK_BILLBOARD\nokUni_TransMat[3]*\n#endif\nokUni_TransMat[1]*\n#ifdef OK_SKANIMATION\na*\n#endif\nvec4(okAttr_Binormal,0.0)).xyz;\n#endif\nvec4 b=\n#ifdef OK_BILLBOARD\nokUni_TransMat[3]*\n#endif\nokUni_TransMat[0]*\n#ifdef OK_SKANIMATION\na*\n#endif\nvec4(okAttr_Pos,1.0);okVary_Pos=b.xyz;gl_Position=okUni_TransMat[2]*b;okVary_ScrTC=gl_Position;}";this.aIncludeMap.Lighting="void okFunc_DctLighting(vec3 normal,vec3 camVec,vec3 reflectVec,vec3 lightDir,vec3 lightColor\n#ifdef OK_DYNAMICSHADOW\n,vec4 shadowMask,vec4 shadowFactor\n#endif\n,inout vec3 diffuse,inout vec3 specular){vec3 curDiffuse=vec3(0.0),curSpecular=vec3(0.0);\n#ifdef OK_SCRIPT_DCTLIGHT_CODE\nokFunc_GetMaterialDctLighting(lightDir,lightColor,curDiffuse,curSpecular);\n#else\nvec3 lightVec=-lightDir;float diffuseFactor=max(0.0,dot(lightVec,normal));\n#ifdef OK_SCRIPT_DIFFUSEPOWER_CODE\ndiffuseFactor=pow(diffuseFactor,okFunc_GetMaterialDiffusePower());\n#endif\ncurDiffuse=diffuseFactor*lightColor;float specularFactor=pow(clamp(dot(reflectVec,lightVec),0.0,1.0),okFunc_GetMaterialSpecularPower());curSpecular=specularFactor*lightColor;\n#endif\n#ifdef OK_DYNAMICSHADOW\nvec3 shadow=mix(vec3(1)-lightColor,vec3(1),dot(shadowMask,shadowFactor));curDiffuse*=shadow;curSpecular*=shadow;\n#endif\ndiffuse+=curDiffuse;specular+=curSpecular;}void okFunc_PointLighting(vec3 pos,vec3 normal,vec3 camVec,vec3 reflectVec,vec3 lightPos,float lightRange,vec3 lightColor\n#ifdef OK_DYNAMICSHADOW\n,vec4 shadowMask,vec4 shadowFactor\n#endif\n,inout vec3 diffuse,inout vec3 specular){vec3 curDiffuse=vec3(0.0),curSpecular=vec3(0.0);\n#ifdef OK_SCRIPT_POINTLIGHT_CODE\nokFunc_GetMaterialPointLighting(lightPos,lightColor,lightRange,curDiffuse,curSpecular);\n#else\nvec3 lightVec=normalize(lightPos-pos);float lenFactor=max(0.0,1.0-distance(lightPos,pos)/lightRange);float diffuseFactor=max(0.0,dot(lightVec,normal))*lenFactor;\n#ifdef OK_SCRIPT_DIFFUSEPOWER_CODE\ndiffuseFactor=pow(diffuseFactor,okFunc_GetMaterialDiffusePower());\n#endif\ncurDiffuse=diffuseFactor*lightColor;float specularFactor=pow(clamp(dot(reflectVec,lightVec),0.0,1.0),okFunc_GetMaterialSpecularPower());curSpecular=specularFactor*lightColor;\n#endif\n#ifdef OK_DYNAMICSHADOW\nvec3 shadow=mix(vec3(1)-lightColor,vec3(1),dot(shadowMask,shadowFactor));curDiffuse*=shadow;curSpecular*=shadow;\n#endif\ndiffuse+=curDiffuse;specular+=curSpecular;}void okFunc_SpotLighting(vec3 pos,vec3 normal,vec3 camVec,vec3 reflectVec,vec3 lightPos,vec3 lightDir,float innerCone,float outerCone,vec3 lightColor\n#ifdef OK_DYNAMICSHADOW\n,vec4 shadowMask,vec4 shadowFactor\n#endif\n,inout vec3 diffuse,inout vec3 specular){vec3 curDiffuse=vec3(0.0),curSpecular=vec3(0.0);\n#ifdef OK_SCRIPT_SPOTLIGHT_CODE\nokFunc_GetMaterialSpotLighting(lightPos,lightColor,lightDir,innerCone,outerCone,curDiffuse,curSpecular);\n#else\nvec3 lightVec=normalize(lightPos-pos);float spotAngl=dot(lightVec,-lightDir);float innerAngl=cos(innerCone*0.5);float outerAngl=cos(outerCone*0.5);float diffuseFactor=clamp((spotAngl-outerAngl)/(innerAngl-outerAngl),0.0,1.0)*max(0.0,dot(lightVec,normal));\n#ifdef OK_SCRIPT_DIFFUSEPOWER_CODE\ndiffuseFactor=pow(diffuseFactor,okFunc_GetMaterialDiffusePower());\n#endif\ncurDiffuse=diffuseFactor*lightColor;float specularFactor=pow(clamp(dot(reflectVec,lightVec),0.0,1.0),okFunc_GetMaterialSpecularPower());curSpecular=specularFactor*lightColor;\n#endif\n#ifdef OK_DYNAMICSHADOW\nvec3 shadow=mix(vec3(1)-lightColor,vec3(1),dot(shadowMask,shadowFactor));curDiffuse*=shadow;curSpecular*=shadow;\n#endif\ndiffuse+=curDiffuse;specular+=curSpecular;}";this.aIncludeMap.Utility="vec4 okFunc_EncodeFloat(float d){vec4 a=vec4(256*256*256,256*256,256,1);vec4 b=vec4(0,1.0/256.0,1.0/256.0,1.0/256.0);vec4 c=fract(d*a);c-=c.xxyz*b;return c;}float okFunc_DecodeFloat(vec4 e){return dot(vec4(1.0/(256.0*256.0*256.0),1.0/(256.0*256.0),1.0/256.0,1.0),e);}vec3 okFunc_DecodeChar3(float d){return fract(d*vec3(1.0,256.0,65536.0));}vec4 okFunc_FetchTexture(sampler2D f,vec2 g){return texture2D(f,g);}vec4 okFunc_FetchTexture(sampler2D f,vec2 g,float k,float l,float m){m=floor(m);vec2 h=1.0/vec2(k,l);float i=floor(m/k);float j=m-k*i;return texture2D(f,vec2(j,i)*h+g/vec2(k,l));}vec4 okFunc_FetchTexture(samplerCube f,vec3 n){return textureCube(f,n);}vec4 okFunc_FetchDummyTexture(vec2 g){return vec4(1.0);}vec4 okFunc_FetchDummyTexture(vec2 g,float k,float l,float m){return vec4(1.0);}vec4 okFunc_FetchDummyTexture(vec3 n){return vec4(1.0);}";this.aVertexSourceMap.Depth='#include"Utility"\n#include"HeaderCommon"\n#include"HeaderVS"\nvoid main(void){okFunc_ProcessVertex();}';this.aFragmentSourceMap.Depth='#include"Utility"\n#include"HeaderCommon"\n#include"HeaderFS"\nvoid main(void){okFunc_ProcessFragment();\n#ifdef OK_SUPPORT_FLOAT_RT\ngl_FragColor.a=gl_FragCoord.z;\n#else\ngl_FragColor=okFunc_EncodeFloat(gl_FragCoord.z);\n#endif\n}';this.aVertexSourceMap.DepthDefault='#include"Utility"\n#include"HeaderVS"\nvoid main(void){gl_Position=okUni_TransMat[2]*(okUni_TransMat[0]*vec4(okAttr_Pos,1.0));}';this.aFragmentSourceMap.DepthDefault='#include"Utility"\nvoid main(void){\n#ifdef OK_SUPPORT_FLOAT_RT\ngl_FragColor.a=gl_FragCoord.z;\n#else\ngl_FragColor=encodeFloat(gl_FragCoord.z);\n#endif\n}';this.aVertexSourceMap.FlatColor="#if TEX\nvarying vec2 fragmentTexCoord;\n#endif\nattribute vec3 position;\n#if TEX\nattribute vec2 texcoord;\n#endif\nuniform mat4 matWorld;uniform mat4 matViewProj;void main(void){\n#if TEX\nfragmentTexCoord=texcoord;\n#endif\ngl_Position=matViewProj*matWorld*vec4(position,1.0);}";this.aFragmentSourceMap.FlatColor="#if TEX\nvarying vec2 fragmentTexCoord;\n#endif\nuniform vec3 color;\n#if TEX\nuniform sampler2D texSampler;\n#endif\nvoid main(void){\n#if TEX\nvec3 a=color*texture2D(texSampler,fragmentTexCoord).xyz;\n#else\nvec3 a=color;\n#endif\ngl_FragColor=vec4(a,1.0);}";this.aVertexSourceMap.GaussianFilter="varying vec2 okVary_ScrTC;attribute vec3 okAttr_Pos;void main(void){gl_Position=vec4(okAttr_Pos,1.0);okVary_ScrTC=(gl_Position.xy+1.0)*0.5;}";this.aFragmentSourceMap.GaussianFilter="varying vec2 okVary_ScrTC;uniform vec4 okUni_ScreenPosOffsetAndScale;uniform vec2 okUni_TexelSize;uniform sampler2D okUni_Tex;void main(void){vec2 a=okUni_ScreenPosOffsetAndScale.xy+okVary_ScrTC*okUni_ScreenPosOffsetAndScale.zw;vec4 b=texture2D(okUni_Tex,a)*0.25;b+=(texture2D(okUni_Tex,a+okUni_TexelSize*vec2(3.0,0.0))+texture2D(okUni_Tex,a+okUni_TexelSize*vec2(-3.0,0.0))+texture2D(okUni_Tex,a+okUni_TexelSize*vec2(0.0,3.0))+texture2D(okUni_Tex,a+okUni_TexelSize*vec2(0.0,-3.0)))*0.125;b+=(texture2D(okUni_Tex,a+okUni_TexelSize*vec2(3.0,3.0))+texture2D(okUni_Tex,a+okUni_TexelSize*vec2(3.0,-3.0))+texture2D(okUni_Tex,a+okUni_TexelSize*vec2(-3.0,3.0))+texture2D(okUni_Tex,a+okUni_TexelSize*vec2(-3.0,-3.0)))*0.0625;gl_FragColor=b;}";this.aVertexSourceMap.Glow='#include"Utility"\n#include"HeaderCommon"\n#include"HeaderVS"\nvoid main(void){okFunc_ProcessVertex();}';this.aFragmentSourceMap.Glow='#include"Utility"\n#include"HeaderCommon"\n#include"HeaderFS"\nvoid main(void){okFunc_ProcessFragment();vec3 glowColor=okUni_General[42].xyz;\n#ifdef OK_FOG\n{float d=distance(okVary_Pos,okUni_General[7].xyz);float fog=clamp(1.0-1.0/exp(clamp((d-okUni_General[41].x)*okUni_General[41].y,0.0,1.0)*okUni_General[40].w),0.0,1.0);fog=smoothstep(0.0,0.95,fog);glowColor=mix(glowColor,okUni_General[40].xyz,fog);}\n#endif\ngl_FragColor=vec4(glowColor,1.0);}';this.aVertexSourceMap.GlowDefault='#include"HeaderVS"\nvoid main(void){gl_Position=okUni_TransMat[2]*(okUni_TransMat[0]*vec4(okAttr_Pos,1.0));}';this.aFragmentSourceMap.GlowDefault="void main(void){gl_FragColor=vec4(0.0,0.0,0.0,0.0);}";this.aVertexSourceMap.Lighting='#include"Utility"\n#include"HeaderCommon"\n#include"HeaderVS"\nvoid main(void){okFunc_ProcessVertex();}';this.aFragmentSourceMap.Lighting='#include"Utility"\n#include"HeaderCommon"\n#include"HeaderFS"\n#include"Lighting"\n#ifdef OK_DYNAMICSHADOW\nuniform sampler2D okUni_shadowSampler;\n#endif\nvoid main(void){okFunc_ProcessFragment();\n#ifdef OK_DYNAMICLIGHTING\nvec3 emissive=okFunc_GetMaterialEmissive();vec3 ambient=mix(okUni_General[4].xyz,okUni_General[5].xyz,(N.y+1.0)*0.5);ambient*=(okUni_General[1].xyz+okUni_General[3].xyz*pow(clamp(dot(-V,R),0.0,1.0),8.0)*okFunc_GetMaterialSpecular());vec3 diffuse=vec3(0.0);vec3 specular=vec3(0.0);vec3 customlighting=vec3(0.0);\n#ifdef OK_DYNAMICSHADOW\nvec4 shadowFactor=vec4(texture2D(okUni_shadowSampler,SCRTC).xyz,1.0);\n#endif\n#endif\n#ifdef OK_DYNAMICLIGHTING\n#if OK_DCTLIGHT_NUM>=1\nokFunc_DctLighting(N,-V,R,okUni_General[8].xyz,fract(okUni_General[8].w*vec3(1.0,256.0,65536.0))*okUni_General[43].x\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[12],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_DCTLIGHT_NUM>=2\nokFunc_DctLighting(N,-V,R,okUni_General[9].xyz,fract(okUni_General[9].w*vec3(1.0,256.0,65536.0))*okUni_General[43].y\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[13],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_DCTLIGHT_NUM>=3\nokFunc_DctLighting(N,-V,R,okUni_General[10].xyz,fract(okUni_General[10].w*vec3(1.0,256.0,65536.0))*okUni_General[43].z\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[14],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_DCTLIGHT_NUM>=4\nokFunc_DctLighting(N,-V,R,okUni_General[11].xyz,fract(okUni_General[11].w*vec3(1.0,256.0,65536.0))*okUni_General[43].w\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[15],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_POINTLIGHT_NUM>=1\nokFunc_PointLighting(P,N,-V,R,okUni_General[16].xyz,okUni_General[16].w,fract(okUni_General[24].w*vec3(1.0,256.0,65536.0))*okUni_General[44].x\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[20],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_POINTLIGHT_NUM>=2\nokFunc_PointLighting(P,N,-V,R,okUni_General[17].xyz,okUni_General[17].w,fract(okUni_General[25].w*vec3(1.0,256.0,65536.0))*okUni_General[44].y\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[21],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_POINTLIGHT_NUM>=3\nokFunc_PointLighting(P,N,-V,R,okUni_General[18].xyz,okUni_General[18].w,fract(okUni_General[26].w*vec3(1.0,256.0,65536.0))*okUni_General[44].z\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[22],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_POINTLIGHT_NUM>=4\nokFunc_PointLighting(P,N,-V,R,okUni_General[19].xyz,okUni_General[19].w,fract(okUni_General[27].w*vec3(1.0,256.0,65536.0))*okUni_General[44].w\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[23],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_SPOTLIGHT_NUM>=1\nokFunc_SpotLighting(P,N,-V,R,okUni_General[24].xyz,okUni_General[28].xyz,okUni_General[32].x,okUni_General[32].y,fract(okUni_General[28].w*vec3(1.0,256.0,65536.0))*okUni_General[45].x\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[36],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_SPOTLIGHT_NUM>=2\nokFunc_SpotLighting(P,N,-V,R,okUni_General[25].xyz,okUni_General[29].xyz,okUni_General[33].x,okUni_General[33].y,fract(okUni_General[29].w*vec3(1.0,256.0,65536.0))*okUni_General[45].y\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[37],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_SPOTLIGHT_NUM>=3\nokFunc_SpotLighting(P,N,-V,R,okUni_General[26].xyz,okUni_General[30].xyz,okUni_General[34].x,okUni_General[34].y,fract(okUni_General[30].w*vec3(1.0,256.0,65536.0))*okUni_General[45].z\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[38],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#if OK_SPOTLIGHT_NUM>=4\nokFunc_SpotLighting(P,N,-V,R,okUni_General[27].xyz,okUni_General[31].xyz,okUni_General[35].x,okUni_General[35].y,fract(okUni_General[31].w*vec3(1.0,256.0,65536.0))*okUni_General[45].w\n#ifdef OK_DYNAMICSHADOW\n,okUni_General[39],shadowFactor\n#endif\n,diffuse,specular);\n#endif\n#endif\n#ifdef OK_DYNAMICLIGHTING\nvec3 lightingColor=emissive+(ambient+diffuse)*okFunc_GetMaterialDiffuse()+specular*okFunc_GetMaterialSpecular();\n#else\nvec3 lightingColor=okFunc_GetMaterialEmissive()+(okUni_General[1].xyz+okUni_General[2].xyz)*okFunc_GetMaterialDiffuse();\n#endif\n#ifdef OK_AUTO_VERTEX_COLOR\nlightingColor+=VC;\n#endif\n#ifdef OK_FOG\n{float d=distance(P,okUni_General[7].xyz);float fog=clamp(1.0-1.0/exp(clamp((d-okUni_General[41].x)*okUni_General[41].y,0.0,1.0)*okUni_General[40].w),0.0,1.0);fog=smoothstep(0.0,0.95,fog);lightingColor=mix(lightingColor,okUni_General[40].xyz,fog);}\n#endif\ngl_FragColor=vec4(lightingColor,\n#if defined(OK_BLEND)||defined(OK_ALPHA_TEST)\nokFunc_GetMaterialAlpha()\n#else\n1.0\n#endif\n);}';this.aVertexSourceMap.LightingDefault='#include"HeaderVS"\nvoid main(void){gl_Position=okUni_TransMat[2]*(okUni_TransMat[0]*vec4(okAttr_Pos,1.0));}';this.aFragmentSourceMap.LightingDefault="void main(void){gl_FragColor=vec4(1.0,0.0,0.0,1.0);}";this.aVertexSourceMap.Output="varying vec2 okVary_ScrTC;attribute vec3 okAttr_Pos;uniform vec4 okUni_SrcOffsetScale;uniform vec4 okUni_DestOffsetScale;void main(void){vec2 a=(okAttr_Pos.xy+1.0)*0.5;gl_Position=vec4((okUni_DestOffsetScale.xy+a*okUni_DestOffsetScale.zw)*2.0-1.0,okAttr_Pos.z,1.0);okVary_ScrTC=okUni_SrcOffsetScale.xy+a*okUni_SrcOffsetScale.zw;}";this.aFragmentSourceMap.Output="varying vec2 okVary_ScrTC;uniform sampler2D okUni_Tex;void main(void){vec4 a=texture2D(okUni_Tex,okVary_ScrTC);gl_FragColor=a;}";this.aVertexSourceMap.ShadowDepth='#include"Utility"\n#include"HeaderCommon"\nvarying float okVary_Depth;\n#include"HeaderVS"\nvoid main(void){okFunc_ProcessVertex();okVary_Depth=gl_Position.z;}';this.aFragmentSourceMap.ShadowDepth='#include"Utility"\n#include"HeaderCommon"\nvarying float okVary_Depth;\n#include"HeaderFS"\nvoid main(void){okFunc_ProcessFragment();\n#ifdef OK_SUPPORT_FLOAT_RT\ngl_FragColor.a=okVary_Depth;\n#else\ngl_FragColor=okFunc_EncodeFloat(okVary_Depth);\n#endif\n}';this.aVertexSourceMap.ShadowDepthDefault='#include"Utility"\nvarying float okVary_Depth;\n#include"HeaderVS"\nvoid main(void){gl_Position=okUni_TransMat[2]*(okUni_TransMat[0]*vec4(okAttr_Pos,1.0));okVary_Depth=gl_Position.z;}';this.aFragmentSourceMap.ShadowDepthDefault='#include"Utility"\nvarying float okVary_Depth;void main(void){\n#ifdef OK_SUPPORT_FLOAT_RT\ngl_FragColor.a=okVary_Depth;\n#else\ngl_FragColor=okFunc_EncodeFloat(okVary_Depth);\n#endif\n}';this.aVertexSourceMap.ShadowFinal="varying vec4 screenPos;uniform mat4 matArray[3];attribute vec4 vertMask0;attribute vec4 vertMask1;uniform vec3 vertList[8];void main(void){vec3 a=vertList[0]*vertMask0.x;a+=vertList[1]*vertMask0.y;a+=vertList[2]*vertMask0.z;a+=vertList[3]*vertMask0.w;a+=vertList[4]*vertMask1.x;a+=vertList[5]*vertMask1.y;a+=vertList[6]*vertMask1.z;a+=vertList[7]*vertMask1.w;gl_Position=matArray[0]*vec4(a,1);screenPos=gl_Position;}";this.aFragmentSourceMap.ShadowFinal="varying vec4 screenPos;uniform mat4 matArray[3];uniform vec4 screenPosOffsetAndScale;uniform vec3 shadowPixelSizeAndOffset;uniform sampler2D samplerArray[2];vec4 a=vec4(1.0/(256.0*256.0*256.0),1.0/(256.0*256.0),1.0/256.0,1.0);float o(vec4 g){vec4 i=vec4(min(1.0,g.z-shadowPixelSizeAndOffset.z));vec2 j=g.xy/g.w;\n#ifdef OK_SUPPORT_FLOAT_RT\nfloat k=texture2D(samplerArray[1],j).a;\n#else\nfloat k=dot(a,texture2D(samplerArray[1],j));\n#endif\nvec4 m=vec4(dot(a,texture2D(samplerArray[1],j+shadowPixelSizeAndOffset.xy*vec2(-1,-1))),dot(a,texture2D(samplerArray[1],j+shadowPixelSizeAndOffset.xy*vec2(0,-1))),dot(a,texture2D(samplerArray[1],j+shadowPixelSizeAndOffset.xy*vec2(1,-1))),dot(a,texture2D(samplerArray[1],j+shadowPixelSizeAndOffset.xy*vec2(-1,0))));vec4 n=vec4(dot(a,texture2D(samplerArray[1],j+shadowPixelSizeAndOffset.xy*vec2(1,0))),dot(a,texture2D(samplerArray[1],j+shadowPixelSizeAndOffset.xy*vec2(-1,1))),dot(a,texture2D(samplerArray[1],j+shadowPixelSizeAndOffset.xy*vec2(0,1))),dot(a,texture2D(samplerArray[1],j+shadowPixelSizeAndOffset.xy*vec2(1,1))));return(dot(sign(m-i),vec4(1.0))+dot(sign(n-i),vec4(1.0))+k)*0.111111;}void main(void){vec2 b=screenPos.xy/screenPos.w;vec2 c=screenPosOffsetAndScale.xy+(b+1.0)*0.5*screenPosOffsetAndScale.zw;\n#ifdef OK_SUPPORT_FLOAT_RT\nfloat d=texture2D(samplerArray[0],c).a;\n#else\nfloat d=dot(a,texture2D(samplerArray[0],c));\n#endif\nvec4 f=matArray[1]*vec4(b,d*2.0-1.0,1.0);f/=f.w;vec4 g=matArray[2]*f;float h=o(g);gl_FragColor=vec4(vec3(h),1.0);}";this.aVertexSourceMap.ShadowVolume="attribute vec4 vertMask0;attribute vec4 vertMask1;uniform vec3 vertList[8];uniform mat4 matViewProj;void main(void){vec3 a=vertList[0]*vertMask0.x;a+=vertList[1]*vertMask0.y;a+=vertList[2]*vertMask0.z;a+=vertList[3]*vertMask0.w;a+=vertList[4]*vertMask1.x;a+=vertList[5]*vertMask1.y;a+=vertList[6]*vertMask1.z;a+=vertList[7]*vertMask1.w;gl_Position=matViewProj*vec4(a,1);}";this.aFragmentSourceMap.ShadowVolume="void main(void){gl_FragColor=vec4(1,0,0,1);}"}okShaderManager.prototype={clear:function(){this.sFloatPrecision="mediump";for(var d in this.aVertexShaderMap){this.aVertexShaderMap[d].releaseShader();this.aVertexShaderMap[d].releaseSource()}okAllocator._object(this.aVertexShaderMap);this.aVertexShaderMap=okAllocator.object();for(var a in this.aFragmentShaderMap){this.aFragmentShaderMap[a].releaseShader();this.aFragmentShaderMap[a].releaseSource()}okAllocator._object(this.aFragmentShaderMap);this.aFragmentShaderMap=okAllocator.object();for(var c in this.aProgramMap){this.aProgramMap[c].releaseProgram()}okAllocator._object(this.aProgramMap);this.aProgramMap=okAllocator.object()},setShaderSourcePath:function(a){this.sShaderSourcePath=a},getProgram:function(a,d,c){switch(a){case"Lighting":return this.getLightingProgram(d,c);case"Depth":return this.getDepthProgram(d,c);case"Glow":return this.getGlowProgram(d,c);case"ShadowDepth":return this.getShadowDepthProgram(d,c);case"ShadowVolume":return this.getShadowVolumeProgram();case"ShadowFinal":return this.getShadowFinalProgram();case"Output":return this.getOutputProgram()}},getFlatColorProgram:function(e){var p="Fl";var o=this.aProgramMap[p];if(o!=null){return o}var l="Fl";var c="Fl";var n=this.aVertexShaderMap[l];var h=this.aFragmentShaderMap[c];if(n==null||h==null){var a=null,k=null;if(n==null){a=new okShader(this.rc,35633)}if(h==null){k=new okShader(this.rc,35632)}var d=new Object;d.sVs=a;d.sFs=k;this._getSrc("FlatColor",d);var m=new Object;m.TEX=(e?1:0);if(n==null){a.compile(m);this.aVertexShaderMap[l]=a;n=a}if(h==null){k.setFloatPrecision(this.sFloatPrecision);k.compile(m);this.aFragmentShaderMap[c]=k;h=k}}var f=new okProgram(this.rc);f.attachVertexShader(n);f.attachFragmentShader(h);f.link();this.aProgramMap[p]=f;return f},getOutputProgram:function(){var n="Op";var m=this.aProgramMap[n];if(m!=null){return m}var k="Op";var c="Op";var l=this.aVertexShaderMap[k];var f=this.aFragmentShaderMap[c];if(l==null||f==null){var a=null,h=null;if(l==null){a=new okShader(this.rc,35633)}if(f==null){h=new okShader(this.rc,35632)}var d=new Object;d.sVs=a;d.sFs=h;this._getSrc("Output",d);if(l==null){a.compile();this.aVertexShaderMap[k]=a;l=a}if(f==null){h.setFloatPrecision(this.sFloatPrecision);h.compile();this.aFragmentShaderMap[c]=h;f=h}}var e=new okProgram(this.rc);e.attachVertexShader(l);e.attachFragmentShader(f);e.link();this.aProgramMap[n]=e;return e},getGaussianProgram:function(l){var p="Gau"+l;var o=this.aProgramMap[p];if(o!=null){return o}var k="Gau";var c=p;var n=this.aVertexShaderMap[k];var f=this.aFragmentShaderMap[c];if(n==null||f==null){var m=new Object;if(l==0){m.OK_HORIZONTAL=1}else{m.OK_VERTICAL=1}var a=null,h=null;if(n==null){a=new okShader(this.rc,35633)}if(f==null){h=new okShader(this.rc,35632)}var d=new Object;d.sVs=a;d.sFs=h;this._getSrc("GaussianFilter",d);if(n==null){a.compile(m);this.aVertexShaderMap[k]=a;n=a}if(f==null){h.setFloatPrecision(this.sFloatPrecision);h.compile(m);this.aFragmentShaderMap[c]=h;f=h}}var e=new okProgram(this.rc);e.attachVertexShader(n);e.attachFragmentShader(f);e.link();this.aProgramMap[p]=e;return e},getDefaultDepthProgram:function(){var k="DeD"+this.sGlobayKey;var m=this.aProgramMap[k];if(m!=null){return m}var l=this.aVertexShaderMap[k];var e=this.aFragmentShaderMap[k];if(l==null||e==null){var h=okAllocator.object();if(this.engineInfo.bFloatRt){h.OK_SUPPORT_FLOAT_RT=1}var a=null,f=null;if(l==null){a=new okShader(this.rc,35633)}if(e==null){f=new okShader(this.rc,35632)}var c=new Object;c.sVs=a;c.sFs=f;this._getSrc("DepthDefault",c);if(l==null){a.compile(h);this.aVertexShaderMap[k]=a;l=a}if(e==null){f.setFloatPrecision(this.sFloatPrecision);f.compile(h);this.aFragmentShaderMap[k]=f;e=f}okAllocator._object(h)}var d=new okProgram(this.rc);d.attachVertexShader(l);d.attachFragmentShader(e);d.link();this.aProgramMap[k]=d;return d},getDepthProgram:function(h,f){var q="De"+this.sGlobalKey+"_"+f._getShdKeyP(h,true);var p=this.aProgramMap[q];if(p=="Fail"){return this.getDefaultShadowDepthProgram()}if(p!=null){return p}var m="De"+f._getShdKeyV(h,true);var c="De"+f._getShdKeyF(h,true);var o=this.aVertexShaderMap[m];var k=this.aFragmentShaderMap[c];if(o==null||k==null){var n=okAllocator.object();if(this.engineInfo.bFloatRt){n.OK_SUPPORT_FLOAT_RT=1}f._getShdDef(h,true,n);var a=null,l=null;if(o==null){a=new okShader(this.rc,35633)}if(k==null){l=new okShader(this.rc,35632)}var d=new Object;d.sVs=a;d.sFs=l;this._getSrc("Depth",d);if(o==null){if(a.compile(n)){this.aVertexShaderMap[m]=a;o=a}else{this.aProgramMap[q]="Fail";return this.getDefaultDepthProgram()}}if(k==null){l.setFloatPrecision(this.sFloatPrecision);if(l.compile(n)){this.aFragmentShaderMap[c]=l;k=l}else{this.aProgramMap[q]="Fail";return this.getDefaultDepthProgram()}}okAllocator._object(n)}var e=new okProgram(this.rc);e.attachVertexShader(o);e.attachFragmentShader(k);if(!e.link()){return this.getDefaultDepthProgram()}this.aProgramMap[q]=e;return e},getGlowProgram:function(l,h){var f=h.materialRef;var s="Gl"+this.sGlobalKey+"_"+h._getShdKeyP(l,true);if(l.bFogEnable&&f.bFog){s+="_1"}var q=this.aProgramMap[s];if(q=="Fail"){return this.getDefaultShadowDepthProgram()}if(q!=null){return q}var n="Gl"+this.sGlobalKey+"_"+h._getShdKeyV(l,true);var c="Gl"+this.sGlobalKey+"_"+h._getShdKeyF(l,true);if(l.bFogEnable&&f.bFog){c+="_1"}var p=this.aVertexShaderMap[n];var k=this.aFragmentShaderMap[c];if(p==null||k==null){var o=okAllocator.object();if(this.engineInfo.bFloatRt){o.OK_SUPPORT_FLOAT_RT=1}if(l.bFogEnable&&f.bFog){o.OK_FOG="1"}h._getShdDef(l,true,o);var a=null,m=null;if(p==null){a=new okShader(this.rc,35633)}if(k==null){m=new okShader(this.rc,35632)}var d=new Object;d.sVs=a;d.sFs=m;this._getSrc("Glow",d);if(p==null){if(a.compile(o)){this.aVertexShaderMap[n]=a;p=a}else{this.aProgramMap[s]="Fail";return this.getDefaultDepthProgram()}}if(k==null){m.setFloatPrecision(this.sFloatPrecision);if(m.compile(o)){this.aFragmentShaderMap[c]=m;k=m}else{this.aProgramMap[s]="Fail";return this.getDefaultDepthProgram()}}okAllocator._object(o)}var e=new okProgram(this.rc);e.attachVertexShader(p);e.attachFragmentShader(k);if(!e.link()){return this.getDefaultDepthProgram()}this.aProgramMap[s]=e;return e},getDefaultGlowProgram:function(){var k="GlD"+this.sGlobalKey;var m=this.aProgramMap[k];if(m!=null){return m}var l=this.aVertexShaderMap[k];var e=this.aFragmentShaderMap[k];if(l==null||e==null){var h=okAllocator.object();if(this.engineInfo.bFloatRt){h.OK_SUPPORT_FLOAT_RT=1}var a=null,f=null;if(l==null){a=new okShader(this.rc,35633)}if(e==null){f=new okShader(this.rc,35632)}var c=new Object;c.sVs=a;c.sFs=f;this._getSrc("GlowDefault",c);if(l==null){a.compile(h);this.aVertexShaderMap[k]=a;l=a}if(e==null){f.setFloatPrecision(this.sFloatPrecision);f.compile(h);this.aFragmentShaderMap[k]=f;e=f}okAllocator._object(h)}var d=new okProgram(this.rc);d.attachVertexShader(l);d.attachFragmentShader(e);d.link();this.aProgramMap[k]=d;return d},getDefaultShadowDepthProgram:function(){var k="ShDD"+this.sGlobalKey;var m=this.aProgramMap[k];if(m!=null){return m}var l=this.aVertexShaderMap[k];var e=this.aFragmentShaderMap[k];if(l==null||e==null){var h=okAllocator.object();if(this.engineInfo.bFloatRt){h.OK_SUPPORT_FLOAT_RT=1}var a=null,f=null;if(l==null){a=new okShader(this.rc,35633)}if(e==null){f=new okShader(this.rc,35632)}var c=new Object;c.sVs=a;c.sFs=f;this._getSrc("ShadowDepthDefault",c);if(l==null){a.compile(h);this.aVertexShaderMap[k]=a;l=a}if(e==null){f.setFloatPrecision(this.sFloatPrecision);f.compile(h);this.aFragmentShaderMap[k]=f;e=f}okAllocator._object(h)}var d=new okProgram(this.rc);d.attachVertexShader(l);d.attachFragmentShader(e);d.link();this.aProgramMap[k]=d;return d},getShadowDepthProgram:function(h,f){var q="ShD"+this.sGlobalKey+"_"+f._getShdKeyP(h,true);var p=this.aProgramMap[q];if(p=="Fail"){return this.getDefaultShadowDepthProgram()}if(p!=null){return p}var m="ShD"+this.sGlobalKey+"_"+f._getShdKeyV(h,true);var c="ShD"+this.sGlobalKey+"_"+f._getShdKeyF(h,true);var o=this.aVertexShaderMap[m];var k=this.aFragmentShaderMap[c];if(o==null||k==null){var n=okAllocator.object();if(this.engineInfo.bFloatRt){n.OK_SUPPORT_FLOAT_RT=1}f._getShdDef(h,true,n);var a=null,l=null;if(o==null){a=new okShader(this.rc,35633)}if(k==null){l=new okShader(this.rc,35632)}var d=new Object;d.sVs=a;d.sFs=l;this._getSrc("ShadowDepth",d);if(o==null){if(a.compile(n)){this.aVertexShaderMap[m]=a;o=a}else{this.aProgramMap[q]="Fail";return this.getDefaultShadowDepthProgram()}}if(k==null){l.setFloatPrecision(this.sFloatPrecision);if(l.compile(n)){this.aFragmentShaderMap[c]=l;k=l}else{this.aProgramMap[q]="Fail";return this.getDefaultShadowDepthProgram()}}okAllocator._object(n)}var e=new okProgram(this.rc);e.attachVertexShader(o);e.attachFragmentShader(k);if(!e.link()){this.aProgramMap[q]="Fail";return this.getDefaultShadowDepthProgram()}this.aProgramMap[q]=e;return e},getShadowVolumeProgram:function(){var n="ShV";var m=this.aProgramMap[n];if(m!=null){return m}var k="ShV";var c="ShV";var l=this.aVertexShaderMap[k];var f=this.aFragmentShaderMap[c];if(l==null||f==null){var a=null,h=null;if(l==null){a=new okShader(this.rc,35633)}if(f==null){h=new okShader(this.rc,35632)}var d=new Object;d.sVs=a;d.sFs=h;this._getSrc("ShadowVolume",d);if(l==null){a.compile();this.aVertexShaderMap[k]=a;l=a}if(f==null){h.setFloatPrecision(this.sFloatPrecision);h.compile();this.aFragmentShaderMap[c]=h;f=h}}var e=new okProgram(this.rc);e.attachVertexShader(l);e.attachFragmentShader(f);e.link();this.aProgramMap[n]=e;return e},getShadowFinalProgram:function(){var k="ShF"+this.sGlobalKey;var m=this.aProgramMap[k];if(m!=null){return m}var l=this.aVertexShaderMap[k];var e=this.aFragmentShaderMap[k];if(l==null||e==null){var h=okAllocator.object();if(this.engineInfo.bFloatRt){h.OK_SUPPORT_FLOAT_RT=1}var a=null,f=null;if(l==null){a=new okShader(this.rc,35633)}if(e==null){f=new okShader(this.rc,35632)}var c=new Object;c.sVs=a;c.sFs=f;this._getSrc("ShadowFinal",c);if(l==null){a.compile(h);this.aVertexShaderMap[k]=a;l=a}if(e==null){f.setFloatPrecision(this.sFloatPrecision);f.compile(h);this.aFragmentShaderMap[k]=f;e=f}okAllocator._object(h)}var d=new okProgram(this.rc);d.attachVertexShader(l);d.attachFragmentShader(e);d.link();this.aProgramMap[k]=d;return d},getDefaultLightingProgram:function(){var k="LiD"+this.sGlobalKey;var m=this.aProgramMap[k];if(m!=null){return m}var l=this.aVertexShaderMap[k];var e=this.aFragmentShaderMap[k];if(l==null||e==null){var h=okAllocator.object();if(this.engineInfo.bFloatRt){h.OK_SUPPORT_FLOAT_RT=1}var a=null,f=null;if(l==null){a=new okShader(this.rc,35633)}if(e==null){f=new okShader(this.rc,35632)}var c=new Object;c.sVs=a;c.sFs=f;this._getSrc("LightingDefault",c);if(l==null){a.compile(h);this.aVertexShaderMap[k]=a;l=a}if(e==null){f.setFloatPrecision(this.sFloatPrecision);f.compile(h);this.aFragmentShaderMap[k]=f;e=f}okAllocator._object(h)}var d=new okProgram(this.rc);d.attachVertexShader(l);d.attachFragmentShader(e);d.link();this.aProgramMap[k]=d;return d},getLightingProgram:function(h,f){var q="Li"+this.sGlobalKey+"_"+this.sGlobalKey+"_"+f._getShdKeyP(h,false);var p=this.aProgramMap[q];if(p=="Fail"){return this.getDefaultLightingProgram()}else{if(p){return p}}var m="Li"+this.sGlobalKey+"_"+f._getShdKeyV(h,false);var c="Li"+this.sGlobalKey+"_"+f._getShdKeyF(h,false);var o=this.aVertexShaderMap[m];var k=this.aFragmentShaderMap[c];if(o==null||k==null){var n=okAllocator.object();if(this.engineInfo.bFloatRt){n.OK_SUPPORT_FLOAT_RT=1}f._getShdDef(h,false,n);var a=null,l=null;if(o==null){a=new okShader(this.rc,35633)}if(k==null){l=new okShader(this.rc,35632)}var d=new Object;d.sVs=a;d.sFs=l;this._getSrc("Lighting",d);if(o==null){if(a.compile(n)){this.aVertexShaderMap[m]=a;o=a}else{this.aProgramMap[q]="Fail";return this.getDefaultLightingProgram()}}if(k==null){l.setFloatPrecision(this.sFloatPrecision);if(l.compile(n)){this.aFragmentShaderMap[c]=l;k=l}else{this.aProgramMap[q]="Fail";return this.getDefaultLightingProgram()}}okAllocator._object(n)}var e=new okProgram(this.rc);e.attachVertexShader(o);e.attachFragmentShader(k);if(!e.link()){this.aProgramMap[q]="Fail";return this.getDefaultLightingProgram()}this.aProgramMap[q]=e;return e},_getSrc:function(a,c){if(this.aVertexSourceMap){if(c.sVs){c.sVs.loadSource(this.aVertexSourceMap[a],this.aIncludeMap)}if(c.sFs){c.sFs.loadSource(this.aFragmentSourceMap[a],this.aIncludeMap)}}}};function okRenderBaseStage(){this.renderer=null;this.bEnable=true;this.__aMatArray=[new okMat4(),new okMat4(),new okMat4(),new okMat4()]}okRenderBaseStage.prototype.clear=function(){this.bEnable=true;this.deleteResource()};okRenderBaseStage.prototype.enable=function(a){this.bEnable=a};okRenderBaseStage.prototype.isEnabled=function(){return this.bEnable};okRenderBaseStage.prototype.init=function(a){this.renderer=a};okRenderBaseStage.prototype.createResource=function(){};okRenderBaseStage.prototype.deleteResource=function(){};okRenderBaseStage.prototype.beginView=function(a){};okRenderBaseStage.prototype.endView=function(){};okRenderBaseStage.prototype.prepare=function(){};okRenderBaseStage.prototype.render=function(){};okRenderBaseStage.prototype._renderBatches=function(e,W,l,k,aa,ae,y){var X=this.renderer.rc;var E=this.renderer.renderEnv;var J=this.renderer.resourceManager;var T=this.renderer.renderTargetCollector;var N=this.renderer.shaderManager;var F=E.camera;var G=E.iCanvasWidth;var O=E.iCanvasHeight;var K=J.getResource("$R$White");var af=J.getResource("$R$WhiteCube");var P=F.getPos();var f=(y?y:F.getViewProjMat4());var u=F.getViewInvMat4();u.m03=u.m13=u.m23=0;var w=okAllocator.array();w.push(0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,E.vGroundColor.x,E.vGroundColor.y,E.vGroundColor.z,E.iCurTime/1000,E.vSkyColor.x,E.vSkyColor.y,E.vSkyColor.z,E.fRandom,F.iViewportX/G,(O-F.iViewportY-F.iViewportHeight)/O,F.iViewportWidth/G,F.iViewportHeight/O,P.x,P.y,P.z,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,E.vFogColor.x,E.vFogColor.y,E.vFogColor.z,E.fFogDensity,E.fFogDistNear,1/(E.fFogDistFar-E.fFogDistNear),0,0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1);var U=e.length;for(var ad=0;ad<U;++ad){var m=e[ad];if(aa&&aa(m)==false){continue}var z=m.aAttribFmt;var aj=m.materialRef;var ag=E.bShadow&&!aj.bWireframe&&m.bReceiveShadow&&E.aStageEnableList[1];var B=0;var a=N.getProgram(W,E,m);a.bind();m.mMatRef.toMat4(this.__aMatArray[0]);m.mMatNRef.toMat4(this.__aMatArray[1]);this.__aMatArray[2]=f;this.__aMatArray[3]=u;a.setUniformMat4Array("okUni_TransMat",this.__aMatArray);var Q=z.Position;if(Q){a.setAttribute("okAttr_Pos",Q.buf,Q.iSize,Q.iOffset,Q.iStride)}if(l||aj.bAlphaTest){var R=z.Normal;if(R){a.setAttribute("okAttr_Normal",R.buf,R.iSize,R.iOffset,R.iStride)}var o=z.Color;if(o){a.setAttribute("okAttr_Color",o.buf,o.iSize,o.iOffset,o.iStride)}}if(aj.bDepthTest){X.enable(2929)}else{X.disable(2929)}if(aj.bDepthWrite){X.depthMask(true)}else{X.depthMask(false)}if(aj.bTwoSide){X.disable(2884)}else{X.enable(2884)}if(m.iDrawMode==1){X.lineWidth(aj.fLineWidth)}if(aj.bBlend){X.blendEquationSeparate(aj.iBlendEquation,aj.iBlendEquationAlpha);X.blendFuncSeparate(aj.iBlendSrc,aj.iBlendDest,aj.iBlendSrcAlpha,aj.iBlendDestAlpha)}if(k||aj.bAlphaTest){w[0]=aj.vEmissive.x;w[1]=aj.vEmissive.y;w[2]=aj.vEmissive.z;w[3]=aj.fGlossiness;w[4]=aj.vAmbient.x;w[5]=aj.vAmbient.y;w[6]=aj.vAmbient.z;w[7]=aj.fSpecularLevel;w[8]=aj.vDiffuse.x;w[9]=aj.vDiffuse.y;w[10]=aj.vDiffuse.z;w[11]=aj.fAlpha;w[12]=aj.vSpecular.x;w[13]=aj.vSpecular.y;w[14]=aj.vSpecular.z;w[15]=aj.fAlphaTestValue;w[168]=aj.vGlowColor.x;w[169]=aj.vGlowColor.y;w[170]=aj.vGlowColor.z}if(l){var d=T.getRenderTarget("ShadowProj");if(ag&&d){a.setSampler("okUni_shadowSampler",B);d.bind(B);X.texParameteri(3553,10240,9729);X.texParameteri(3553,10241,9729);X.texParameteri(3553,10242,33071);X.texParameteri(3553,10243,33071);B+=1}var ah=(m.aDctLightListRef.length<4?m.aDctLightListRef.length:4);for(var Y=0;Y<ah;++Y){var H=m.aDctLightListRef[Y];var V=H.getLightDir();var S=H.getColor();w[(8+Y)*4]=V.x;w[(8+Y)*4+1]=V.y;w[(8+Y)*4+2]=V.z;w[(8+Y)*4+3]=okPackVec3ToFloat(S);w[43*4+Y]=H.fIntensity;if(ag){w[(12+Y)*4]=H.iShadowIdx==0?1:0;w[(12+Y)*4+1]=H.iShadowIdx==1?1:0;w[(12+Y)*4+2]=H.iShadowIdx==2?1:0;w[(12+Y)*4+3]=H.iShadowIdx==3?1:0}}var ak=(m.aPointLightListRef.length<4?m.aPointLightListRef.length:4);for(var Y=0;Y<ak;++Y){var H=m.aPointLightListRef[Y];var C=H.getPos();var A=H.getRange();var S=H.getColor();w[(16+Y)*4]=C.x;w[(16+Y)*4+1]=C.y;w[(16+Y)*4+2]=C.z;w[(16+Y)*4+3]=A;w[(24+Y)*4+3]=okPackVec3ToFloat(S);w[44*4+Y]=H.fIntensity;if(ag){w[(20+Y)*4]=H.iShadowIdx==0?1:0;w[(20+Y)*4+1]=H.iShadowIdx==1?1:0;w[(20+Y)*4+2]=H.iShadowIdx==2?1:0;w[(20+Y)*4+3]=H.iShadowIdx==3?1:0}}var L=(m.aSpotLightListRef.length<4?m.aSpotLightListRef.length:4);for(var Y=0;Y<L;++Y){var H=m.aSpotLightListRef[Y];var C=H.getPos();var V=H.getLightDir();var ai=H.getInnerCone()*Math.PI/180;var h=H.getOuterCone()*Math.PI/180;var S=H.getColor();w[(24+Y)*4]=C.x;w[(24+Y)*4+1]=C.y;w[(24+Y)*4+2]=C.z;w[(28+Y)*4]=V.x;w[(28+Y)*4+1]=V.y;w[(28+Y)*4+2]=V.z;w[(28+Y)*4+3]=okPackVec3ToFloat(S);w[(32+Y)*4]=ai;w[(32+Y)*4+1]=h;w[45*4+Y]=H.fIntensity;if(ag){w[(36+Y)*4]=H.iShadowIdx==0?1:0;w[(36+Y)*4+1]=H.iShadowIdx==1?1:0;w[(36+Y)*4+2]=H.iShadowIdx==2?1:0;w[(36+Y)*4+3]=H.iShadowIdx==3?1:0}}}if(k||l||aj.bAlphaTest){a.setUniformFloat4Array("okUni_General",w)}if(l||aj.bAlphaTest){for(var ac=0;ac<7;++ac){if(aj.aTextureResIdList[ac]!=-1){var D=J.getResource(aj.aTextureResIdList[ac]);var c=D.isValid();var M=3553;var x=K;if(D.getType()==34067){M=34067;x=af}a.setSampler("okUni_Sampler"+ac,B);if(c){D.bind(B);var I=D.isMipMap();X.texParameteri(M,10240,aj.aTextureFilterList[ac]);if(I){if(aj.aTextureFilterList[ac]==9729){X.texParameteri(M,10241,9985)}else{if(aj.aTextureFilterList[ac]==9728){X.texParameteri(M,10241,9984)}else{X.texParameteri(M,10241,aj.aTextureFilterList[ac])}}}else{if(aj.aTextureFilterList[ac]==9984||aj.aTextureFilterList[ac]==9986){X.texParameteri(M,10241,9728)}else{if(aj.aTextureFilterList[ac]==9985||aj.aTextureFilterList[ac]==9987){X.texParameteri(M,10241,9729)}else{X.texParameteri(M,10241,aj.aTextureFilterList[ac])}}}}else{x.bind(B);X.texParameteri(M,10240,9728);X.texParameteri(M,10241,9728)}X.texParameteri(M,10242,aj.aTextureWrapUList[ac]);X.texParameteri(M,10243,aj.aTextureWrapVList[ac]);B+=1}}var n=z.Texcoord1;var s=z.Texcoord2;if(n&&s&&n.buf==s.buf&&n.iIdx==s.iIdx-1){a.setAttribute("okAttr_TC12",n.buf,n.iSize+s.iSize,n.iOffset,n.iStride)}else{if(n){a.setAttribute("okAttr_TC1",n.buf,n.iSize,n.iOffset,n.iStride)}else{if(s){a.setAttribute("okAttr_TC2",s.buf,s.iSize,s.iOffset,s.iStride)}}}var q=z.Texcoord3;var t=z.Texcoord4;if(q&&t&&q.buf==t.buf&&q.iIdx==t.iIdx-1){a.setAttribute("okAttr_TC34",q.buf,q.iSize+q.iSize,q.iOffset,q.iStride)}else{if(q){a.setAttribute("okAttr_TC3",q.buf,q.iSize,q.iOffset,q.iStride)}else{if(t){a.setAttribute("okAttr_TC4",t.buf,t.iSize,t.iOffset,t.iStride)}}}var p=z[aj.aTangentAttribList[4]];if(p){a.setAttribute("okAttr_Tangent",p.buf,p.iSize,p.iOffset,p.iStride)}var ab=z[aj.aBinormalAttribList[4]];if(ab){a.setAttribute("okAttr_Binormal",ab.buf,ab.iSize,ab.iOffset,ab.iStride)}}if(m.aBoneMatList){var Z=z[m.sBoneIdxAttribName];var v=z[m.sBoneWeightAttribName];a.setAttribute("okAttr_BoneIdx",Z.buf,Z.iSize,Z.iOffset,Z.iStride);a.setAttribute("okAttr_BoneWeight",v.buf,v.iSize,v.iOffset,v.iStride);a.setUniformMat43Array("okUni_BoneMat",m.aBoneMatList,false)}if(ae){ae(X,m)}m.index.drawIndex(m.iDrawMode,m.iDrawStart,m.iDrawCount)}X.enable(2929);X.depthMask(true);X.depthFunc(515);X.enable(2884);okAllocator._array(w)};function okRenderDepthStage(){okBaseCall(this);this.depthFbo=null;this.depthTex=null;this.depthBuffer=null}okExtend(okRenderDepthStage,okRenderBaseStage);okRenderDepthStage.prototype.createResource=function(){var c=this.renderer.rc;var e=this.renderer.renderEnv;var a=this.renderer.renderTargetCollector;var d=this.renderer.engineInfo;if(this.depthTex==null){this.depthTex=new okTexture(c)}this.depthTex.createTexture(3553,e.iCanvasWidth,e.iCanvasHeight,d.bFloatRt?6406:6408,d.bFloatRt?5126:5121);a.setRenderTarget("DTex",this.depthTex);if(this.depthStencilBuffer==null){this.depthStencilBuffer=new okRenderBuffer(c)}this.depthStencilBuffer.createBuffer(34041,e.iCanvasWidth,e.iCanvasHeight);a.setRenderTarget("DSBuf",this.depthStencilBuffer);if(this.depthFbo==null){this.depthFbo=new okFrameBuffer(c)}this.depthFbo.createBuffer();this.depthFbo.bind();this.depthFbo.attachRenderTexture(0,this.depthTex);this.depthFbo.attachDepthStencilBuffer(this.depthStencilBuffer);this.depthFbo.unbind()};okRenderDepthStage.prototype.deleteResource=function(){var c=this.renderer.rc;var d=this.renderer.renderEnv;var a=this.renderer.renderTargetCollector;if(this.depthTex){this.depthTex.releaseTexture();a.setRenderTarget("DTex",null)}if(this.depthStencilBuffer){this.depthStencilBuffer.releaseBuffer();a.setRenderTarget("DSBuf",null)}if(this.depthFbo){this.depthFbo.releaseBuffer()}};okRenderDepthStage.prototype.beginView=function(a){var d=this.renderer.rc;var c=this.renderer.renderEnv.camera;if(a!=true){this.depthFbo.bind();c.bindViewport();d.clearColor(1,1,1,1);d.clearDepth(1);d.clear(16384|256|1024);this.depthFbo.unbind()}};okRenderDepthStage.prototype.endView=function(){};okRenderDepthStage.prototype.render=function(){var d=this.renderer.rc;var f=this.renderer.renderEnv;var a=this.renderer.renderSourceCollector;var e=this.renderer.engineInfo;if(f.bShadow==false||f.scene==null||f.scene.getZone().iCastShadowLightNum==0||f.scene.getZone().iCastShadowEntityNum==0){return}this.depthFbo.bind();f.camera.bindViewport();d.enable(2929);d.depthFunc(515);d.enable(2884);d.depthMask(true);var c=a.getBatchList("Visible_Opaque");if(c.length>0){this._renderBatches(c,"Depth",false,false,this._clipBatch)}if(e.iDepthBits<24){d.clearDepth(1);d.clear(256)}this.depthFbo.unbind()};okRenderDepthStage.prototype._clipBatch=function(a){return a.materialRef.bDepthWrite};function okRenderShadowStage(){okBaseCall(this);this.aShadowCasterList=new Array;this.iDepthTexSize=512;this.lightFbo=null;this.lightTex=null;this.lightDepthBuffer=null;this.projFbo=null;this.projTex=null;this.frustumMask=null;this.frustumIndexBuf=null;this.tempSamplerArray=[0,1]}okExtend(okRenderShadowStage,okRenderBaseStage);okRenderShadowStage.prototype.clear=function(){this.aShadowCasterList.length=0;okBaseCall(this,"clear")};okRenderShadowStage.prototype.createResource=function(){var d=this.renderer.rc;var f=this.renderer.renderEnv;var c=this.renderer.renderSourceCollector;var a=this.renderer.renderTargetCollector;var e=this.renderer.engineInfo;if(this.lightTex==null){this.lightTex=new okTexture(d)}this.lightTex.createTexture(3553,Math.min(this.iDepthTexSize,f.iCanvasWidth),Math.min(this.iDepthTexSize,f.iCanvasHeight),e.bFloatRt?6406:6408,e.bFloatRt?5126:5121);a.setRenderTarget("ShadowDepth",this.lightTex);if(this.lightDepthBuffer==null){this.lightDepthBuffer=new okRenderBuffer(d)}this.lightDepthBuffer.createBuffer(33189,Math.min(this.iDepthTexSize,f.iCanvasWidth),Math.min(this.iDepthTexSize,f.iCanvasHeight));if(this.lightFbo==null){this.lightFbo=new okFrameBuffer(d)}this.lightFbo.createBuffer();this.lightFbo.bind();this.lightFbo.attachRenderTexture(0,this.lightTex);this.lightFbo.attachDepthBuffer(this.lightDepthBuffer);this.lightFbo.unbind();if(this.projTex==null){this.projTex=new okTexture(d)}this.projTex.createTexture(3553,f.iCanvasWidth,f.iCanvasHeight,6408);a.setRenderTarget("ShadowProj",this.projTex);if(this.projFbo==null){this.projFbo=new okFrameBuffer(d)}this.projFbo.createBuffer();this.projFbo.bind();this.projFbo.attachRenderTexture(0,this.projTex);this.projFbo.attachDepthStencilBuffer(a.getRenderTarget("DSBuf"));this.projFbo.unbind();if(this.frustumMask==null){this.frustumMask=[new okArrayBuffer(d),new okArrayBuffer(d)]}this.frustumMask[0].createBuffer(34962,5126,35044,new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));this.frustumMask[1].createBuffer(34962,5126,35044,new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]));if(this.frustumIndexBuf==null){this.frustumIndexBuf=new okArrayBuffer(d)}this.frustumIndexBuf.createBuffer(34963,5123,35044,new Uint16Array([0,1,2,0,2,3,1,5,6,1,6,2,3,2,6,3,6,7,4,0,3,4,3,7,4,5,1,4,1,0,4,7,6,4,6,5]))};okRenderShadowStage.prototype.deleteResource=function(){var d=this.renderer.rc;var e=this.renderer.renderEnv;var c=this.renderer.renderSourceCollector;var a=this.renderer.renderTargetCollector;if(this.lightTex){this.lightTex.releaseTexture();a.setRenderTarget("ShadowDepth",null)}if(this.lightDepthBuffer){this.lightDepthBuffer.releaseBuffer()}if(this.lightFbo){this.lightFbo.releaseBuffer()}if(this.projTex){this.projTex.releaseTexture();a.setRenderTarget("ShadowProj",null)}if(this.projFbo){this.projFbo.releaseBuffer()}if(this.frustumMask[0]){this.frustumMask[0].releaseBuffer()}if(this.frustumMask[1]){this.frustumMask[1].releaseBuffer()}if(this.frustumIndexBuf){this.frustumIndexBuf.releaseBuffer()}};okRenderShadowStage.prototype.beginView=function(){};okRenderShadowStage.prototype.endView=function(){};okRenderShadowStage.prototype.render=function(){var y=this.renderer.rc;var F=this.renderer.renderEnv;var s=this.renderer.shaderManager;var K=F.scene;var J=K.getZone();var d=this.renderer.renderSourceCollector;var H=this.renderer.renderTargetCollector;var E=F.camera;var D=E.getPos();var v=Math.min(F.iCanvasWidth,this.iDepthTexSize);var u=Math.min(F.iCanvasHeight,this.iDepthTexSize);var x=E.getViewInvMat4();x.m03=x.m13=x.m23=0;if(!F.bShadow||!K){return}this.aShadowCasterList.length=0;var n=J.aLightList;var o=0;var M=n.getRoot();while(M){var e=M.data;if(!e.bCastShadow||!e.bVisible){e.iShadowIdx=3}else{e.iShadowIdx=o;o+=1;var f=e.aAffectEntities.length;for(var C=0;C<f;++C){var p=e.aAffectEntities[C];if((p.getType()&(1|2|32|64|128|256))&&p.bVisible&&p.bCastShadow&&p.getState()!=1){this._genShadowCaster(e,p,F)}}}M=M.next}var A=this.aShadowCasterList.length;var l=0;var I=new okLayout2DHelper(v,u);for(var C=0;C<A;++C){var k=this.aShadowCasterList[C];var z=new okVec2(0,0);if(k.fRatio>=1){z.x=Math.min(v,k.fResolution*Math.max(F.camera.getViewportWidth(),F.camera.getViewportHeight()));z.y=Math.min(u,z.x/k.fRatio)}else{z.y=Math.min(u,k.fResolution*Math.max(F.camera.getViewportWidth(),F.camera.getViewportHeight()));z.x=Math.min(v,z.y*k.fRatio)}z.x=Math.max(8,z.x);z.y=Math.max(8,z.y);k.rTexLayout=I.add(z.x,z.y);if(k.rTexLayout==null){k.bNextPass=true;I.reset(v,u);k.rTexLayout=I.add(z.x,z.y)}k.rTexLayout.width=Math.min(k.rTexLayout.width,F.iCanvasWidth);k.rTexLayout.height=Math.min(k.rTexLayout.height,F.iCanvasHeight);k.rTexLayout.width-=3;k.rTexLayout.height-=3;k.rTexLayout.width=okAlign(k.rTexLayout.width,4);k.rTexLayout.height=okAlign(k.rTexLayout.height,4);k.rTexLayout.x+=2;k.rTexLayout.y+=2;k.rTexLayout.width-=2;k.rTexLayout.height-=2;var a=new okVec2(k.rTexLayout.x/v,k.rTexLayout.y/u);var w=new okVec2(k.rTexLayout.width/v,k.rTexLayout.height/u);var B=new okMat4();k.mLightViewProjMat.clone(B);B.m00=(B.m00+B.m30)/2;B.m01=(B.m01+B.m31)/2;B.m02=(B.m02+B.m32)/2;B.m03=(B.m03+B.m33)/2;B.m00=B.m00*w.x+B.m30*a.x;B.m01=B.m01*w.x+B.m31*a.x;B.m02=B.m02*w.x+B.m32*a.x;B.m03=B.m03*w.x+B.m33*a.x;B.m10=(B.m10+B.m30)/2;B.m11=(B.m11+B.m31)/2;B.m12=(B.m12+B.m32)/2;B.m13=(B.m13+B.m33)/2;B.m10=B.m10*w.y+B.m30*a.y;B.m11=B.m11*w.y+B.m31*a.y;B.m12=B.m12*w.y+B.m32*a.y;B.m13=B.m13*w.y+B.m33*a.y;k.mShadowMat=B}this.projFbo.bind();E.bindViewport();y.clearColor(1,1,1,1);y.clear(16384|1024);var q=H.getRenderTarget("DTex");var h=0;while(h<A){this.lightFbo.bind();y.viewport(0,0,v,u);y.scissor(0,0,v,u);y.clearColor(1,1,1,1);y.clear(16384|256);y.enable(2929);y.depthFunc(515);var t=0;for(t=h;t<A;++t){var k=this.aShadowCasterList[t];if(k.bNextPass){k.bNextPass=false;break}var G=k.rTexLayout;y.viewport(G.x,G.y,G.width,G.height);var L=k.aBatchList;if(L.length>0){this._renderBatches(L,"ShadowDepth",false,false,null,this._setDepthBatch,k.mLightViewProjMat)}}this.projFbo.bind();E.bindViewport();for(var C=h;C<t;++C){var k=this.aShadowCasterList[C];var c=k.light;y.enable(2929);y.disable(2884);y.enable(2960);y.stencilFunc(519,0,4294967295);y.stencilOpSeparate(1028,7680,34056,7680);y.stencilOpSeparate(1029,7680,34055,7680);y.colorMask(false,false,false,false);y.depthMask(false);var m=s.getShadowVolumeProgram();m.bind();m.setAttribute("vertMask0",this.frustumMask[0],4);m.setAttribute("vertMask1",this.frustumMask[1],4);if(k.lightFrustum.bPointDirty){k.lightFrustum._genPointList()}m.setUniformVec3Array("vertList",k.lightFrustum.aPointList);m.setUniformMat4("matViewProj",E.getViewProjMat4());this.frustumIndexBuf.drawIndex(4);y.disable(2929);y.stencilFunc(517,0,4294967295);y.stencilOp(7680,7680,7681);y.enable(3042);y.blendFuncSeparate(774,0,772,0);y.colorMask(c.iShadowIdx==0,c.iShadowIdx==1,c.iShadowIdx==2,false);var m=s.getShadowFinalProgram();m.bind();m.setAttribute("vertMask0",this.frustumMask[0],4);m.setAttribute("vertMask1",this.frustumMask[1],4);m.setUniformVec3Array("vertList",k.lightFrustum.aPointList);E.getViewProjMat4().clone(this.__aMatArray[0]);E.getViewProjInvMat4().clone(this.__aMatArray[1]);k.mShadowMat.clone(this.__aMatArray[2]);m.setUniformMat4Array("matArray",this.__aMatArray);m.setUniformFloat4("screenPosOffsetAndScale",E.iViewportX/this.projTex.getSizeU(),(y.canvas.clientHeight-E.iViewportY-E.iViewportHeight)/this.projTex.getSizeV(),E.iViewportWidth/this.projTex.getSizeU(),E.iViewportHeight/this.projTex.getSizeV());m.setUniformFloat3("shadowPixelSizeAndOffset",1/v,1/u,Math.max(e.fShadowFadeFactor,k.entity.fShadowFadeFactor));m.setSamplerArray("samplerArray",this.tempSamplerArray);q.bind(0);y.texParameteri(3553,10240,9728);y.texParameteri(3553,10241,9728);y.texParameteri(3553,10242,33071);y.texParameteri(3553,10243,33071);this.lightTex.bind(1);y.texParameteri(3553,10240,9728);y.texParameteri(3553,10241,9728);y.texParameteri(3553,10242,33071);y.texParameteri(3553,10243,33071);this.frustumIndexBuf.drawIndex(4);y.disable(3042);y.enable(2929);h+=1}y.enable(2884);y.disable(2960);y.depthMask(true);y.colorMask(true,true,true,true);this.projFbo.unbind();E.bindViewport()}};okRenderShadowStage.prototype._setDepthBatch=function(c,a){c.enable(2929)};okRenderShadowStage.prototype._genShadowCaster=function(k,u,H){var F=H.camera;if(k.getType()==4){var G=k.getMat43();G.setColumn(3,0,0,0);var p=k.getInvMat43();var a=u.getBoundingBox();var B=new okVec3(1000000,1000000,1000000);var A=new okVec3(-1000000,-1000000,-1000000);for(var D=0;D<8;++D){var t=a.getPoint(D);var z=okMat43MulVec3(p,t);B=okVec3Min(B,z);A=okVec3Max(A,z)}var w=okVec3MulVal(okVec3Add(B,A),0.5);w.z=A.z+0.1;var n=okVec3Sub(A,B);G.setColumn(3,okMat43MulVec3(G,w));p=G.inverse();var q=new okShadowCaster();q.entity=u;q.light=k;q.aBatchList=new Array;u.genRenderBatch(q.aBatchList,H);q.mLightViewMat=new okMat4();p.toMat4(q.mLightViewMat);q.mLightViewProjMat=okMat4Mul(okMat4Ortho(-n.x*0.5,n.x*0.5,n.y*0.5,-n.y*0.5,0.1,n.z+0.1),q.mLightViewMat);var h=0.1,s=n.z+0.1;q.mLightViewProjMat.m20=-p.m20/(s-h);q.mLightViewProjMat.m21=-p.m21/(s-h);q.mLightViewProjMat.m22=-p.m22/(s-h);q.mLightViewProjMat.m23=(-p.m23-h)/(s-h);q.lightFrustum=new okFrustum();q.lightFrustum.setByViewProjMat(okMat4Mul(okMat4Ortho(-n.x*0.5,n.x*0.5,n.y*0.5,-n.y*0.5,0.1,10000),q.mLightViewMat));q.fRatio=n.x/n.y;var C=okVec3Sub(a.vMax,a.vMin).len();var y=new okVec4((a.vMax.x+a.vMin.x)*0.5,(a.vMax.y+a.vMin.y)*0.5,(a.vMax.z+a.vMin.z)*0.5,1);var f=okMat4MulVec4(F.getViewProjMat4(),y);q.fResolution=u.fShadowResolution*C/Math.max(1,Math.abs(f.w));this.aShadowCasterList.push(q)}else{if(k.getType()==16){var G=k.getMat43();var p=G.inverse();var a=u.getBoundingBox();var B=new okVec3(1000000,1000000,1000000);var A=new okVec3(-1000000,-1000000,-1000000);for(var D=0;D<8;++D){var t=a.getPoint(D);var z=okMat43MulVec3(p,t);B=okVec3Min(B,z);A=okVec3Max(A,z)}var q=new okShadowCaster();q.entity=u;q.light=k;q.aBatchList=new Array;u.genRenderBatch(q.aBatchList,H);q.mLightViewMat=new okMat4();p.toMat4(q.mLightViewMat);q.fRatio=1;var s=-B.z+0.1,h=Math.max(0.1,-A.z);q.mLightViewProjMat=okMat4Mul(okMat4Proj(k.getOuterCone(),1,h,s),q.mLightViewMat);q.mLightViewProjMat.m20=-q.mLightViewMat.m20/(s-h);q.mLightViewProjMat.m21=-q.mLightViewMat.m21/(s-h);q.mLightViewProjMat.m22=-q.mLightViewMat.m22/(s-h);q.mLightViewProjMat.m23=(-q.mLightViewMat.m23-h)/(s-h);q.lightFrustum=new okFrustum();q.lightFrustum.setByViewProjMat(okMat4Mul(okMat4Proj(k.getOuterCone(),1,h,k.fRange),q.mLightViewMat));var C=okVec3Sub(a.vMax,a.vMin).len();var y=new okVec4((a.vMax.x+a.vMin.x)*0.5,(a.vMax.y+a.vMin.y)*0.5,(a.vMax.z+a.vMin.z)*0.5,1);var f=okMat4MulVec4(F.getViewProjMat4(),y);q.fResolution=u.fShadowResolution*C/Math.max(1,Math.abs(f.w));this.aShadowCasterList.push(q)}else{if(k.getType()==8){var l=okVec3Sub(k.getPos(),u.getPos());var m=new okVec3(0,1,0);var o=okVec3Cross(m,l);if(o.equal(OAK.VEC3_ZERO)){m.set(1,0,0);o=okVec3Cross(m,l)}m=okVec3Cross(l,o);o=o.normalize();m=m.normalize();l=l.normalize();var G=new okMat43();G.setColumn(0,o);G.setColumn(1,m);G.setColumn(2,l);G.setColumn(3,k.getPos());var p=G.inverse();var a=u.getBoundingBox();var B=new okVec3(1000000,1000000,1000000);var A=new okVec3(-1000000,-1000000,-1000000);var e=0,d=0;for(var D=0;D<8;++D){var t=a.getPoint(D);var z=okMat43MulVec3(p,t);B=okVec3Min(B,z);A=okVec3Max(A,z);e=Math.max(e,Math.atan(Math.abs(z.x)/Math.max(0.1,-z.z)));d=Math.max(d,Math.atan(Math.abs(z.y)/Math.max(0.1,-z.z)))}if(Math.max(e,d)<120*Math.PI/180){var q=new okShadowCaster();q.entity=u;q.light=k;q.aBatchList=new Array;u.genRenderBatch(q.aBatchList,H);q.mLightViewMat=new okMat4();p.toMat4(q.mLightViewMat);q.fRatio=Math.tan(e)/Math.tan(d);var s=-B.z+0.1,h=Math.max(0.1,-A.z);q.mLightViewProjMat=okMat4Mul(okMat4Proj(d*2*180/Math.PI,q.fRatio,h,s),q.mLightViewMat);q.mLightViewProjMat.m20=-q.mLightViewMat.m20/(s-h);q.mLightViewProjMat.m21=-q.mLightViewMat.m21/(s-h);q.mLightViewProjMat.m22=-q.mLightViewMat.m22/(s-h);q.mLightViewProjMat.m23=(-q.mLightViewMat.m23-h)/(s-h);q.lightFrustum=new okFrustum();q.lightFrustum.setByViewProjMat(okMat4Mul(okMat4Proj(d*2*180/Math.PI,q.fRatio,h,k.fRange),q.mLightViewMat));var C=okVec3Sub(a.vMax,a.vMin).len();var y=new okVec4((a.vMax.x+a.vMin.x)*0.5,(a.vMax.y+a.vMin.y)*0.5,(a.vMax.z+a.vMin.z)*0.5,1);var f=okMat4MulVec4(F.getViewProjMat4(),y);q.fResolution=u.fShadowResolution*C/Math.max(1,Math.abs(f.w));this.aShadowCasterList.push(q)}else{var I=[new okMat43(),new okMat43(),new okMat43(),new okMat43(),new okMat43(),new okMat43()];var x=k.getPos();I[0].setColumn(0,0,1,0);I[0].setColumn(1,0,0,1);I[0].setColumn(2,1,0,0);I[0].setColumn(3,x);I[1].setColumn(0,0,-1,0);I[1].setColumn(1,0,0,1);I[1].setColumn(2,-1,0,0);I[1].setColumn(3,x);I[2].setColumn(0,-1,0,0);I[2].setColumn(1,0,0,1);I[2].setColumn(2,0,1,0);I[2].setColumn(3,x);I[3].setColumn(0,1,0,0);I[3].setColumn(1,0,0,1);I[3].setColumn(2,0,-1,0);I[3].setColumn(3,x);I[4].setColumn(0,1,0,0);I[4].setColumn(1,0,1,0);I[4].setColumn(2,0,0,1);I[4].setColumn(3,x);I[5].setColumn(0,1,0,0);I[5].setColumn(1,0,-1,0);I[5].setColumn(2,0,0,-1);I[5].setColumn(3,x);var c=[I[0].inverse(),I[1].inverse(),I[2].inverse(),I[3].inverse(),I[4].inverse(),I[5].inverse()];for(var D=0;D<6;++D){var p=c[D];var a=u.getBoundingBox();var B=new okVec3(1000000,1000000,1000000);var A=new okVec3(-1000000,-1000000,-1000000);var e=0,d=0;for(var D=0;D<8;++D){var t=a.getPoint(D);var z=okMat43MulVec3(p,t);B=okVec3Min(B,z);A=okVec3Max(A,z)}var s=-B.z+0.1,h=Math.max(0.1,-A.z);if(s<0.1){continue}var E=new okFrustum();E.setByViewProjMat(okMat4Mul(okMat4Proj(91,1,h,k.fRange),p));if(E.collideAABBox(a)==0){continue}var q=new okShadowCaster();q.entity=u;q.light=k;q.aBatchList=new Array;u.genRenderBatch(q.aBatchList,H);q.mLightViewMat=new okMat4();p.toMat4(q.mLightViewMat);q.fRatio=1;q.mLightViewProjMat=okMat4Mul(okMat4Proj(d*2*180/Math.PI,q.fRatio,h,s),q.mLightViewMat);q.mLightViewProjMat.m20=-q.mLightViewMat.m20/(s-h);q.mLightViewProjMat.m21=-q.mLightViewMat.m21/(s-h);q.mLightViewProjMat.m22=-q.mLightViewMat.m22/(s-h);q.mLightViewProjMat.m23=(-q.mLightViewMat.m23-h)/(s-h);q.lightFrustum=E;var C=okVec3Sub(a.vMax,a.vMin).len();var y=new okVec4((a.vMax.x+a.vMin.x)*0.5,(a.vMax.y+a.vMin.y)*0.5,(a.vMax.z+a.vMin.z)*0.5,1);var f=okMat4MulVec4(F.getViewProjMat4(),y);q.fResolution=u.fShadowResolution*C/Math.max(1,Math.abs(f.w));this.aShadowCasterList.push(q)}}}}}};function okShadowCaster(){this.entity=null;this.light=null;this.aBatchList=null;this.mLightMat=null;this.mLightViewMat=null;this.mLightViewProjMat=null;this.lightFrustum=null;this.mShadowMat=null;this.fRatio=1;this.fResolution=0;this.rTexLayout=null;this.bNextPass=false}function okRenderLightingStage(){okBaseCall(this);this.lightFbo=null;this.lightTex=null}okExtend(okRenderLightingStage,okRenderBaseStage);okRenderLightingStage.prototype.createResource=function(){var c=this.renderer.rc;var d=this.renderer.renderEnv;var a=this.renderer.renderTargetCollector;if(this.lightTex==null){this.lightTex=new okTexture(c)}this.lightTex.createTexture(3553,d.iCanvasWidth,d.iCanvasHeight,6408);a.setRenderTarget("LTex",this.lightTex);if(this.lightFbo==null){this.lightFbo=new okFrameBuffer(c)}this.lightFbo.createBuffer();this.lightFbo.bind();this.lightFbo.attachRenderTexture(0,this.lightTex);this.lightFbo.attachDepthStencilBuffer(a.getRenderTarget("DSBuf"));this.lightFbo.unbind()};okRenderLightingStage.prototype.deleteResource=function(){var c=this.renderer.rc;var d=this.renderer.renderEnv;var a=this.renderer.renderTargetCollector;if(this.lightTex){this.lightTex.releaseTexture();a.setRenderTarget("LTex",null)}if(this.lightFbo){this.lightFbo.releaseBuffer()}};okRenderLightingStage.prototype.renderBackTex=function(c){var e=this.renderer.rc;var k=this.renderer.renderEnv;var d=k.camera;e.disable(2929);e.depthMask(false);e.disable(3042);var h=this.renderer.resourceManager.getResource("$R$Quad");var f=h.getMesh(0);var a=this.renderer.shaderManager.getOutputProgram();a.bind();a.setAttribute("okAttr_Pos",f.getAttributeArrayBuffer("Position"),3);a.setUniformFloat4("okUni_DestOffsetScale",0,0,1,1);a.setUniformFloat4("okUni_SrcOffsetScale",0,1,1,-1);a.setTexture("okUni_Tex",c,33071,9729);f.draw();e.enable(2929);e.depthMask(true)};okRenderLightingStage.prototype.beginView=function(a){var d=this.renderer.rc;var c=this.renderer.renderEnv.camera;if(a!=true){this.lightFbo.bind();c.bindViewport();if(c.iBackTexId==-1){var e=c.getBackColor();d.clearColor(e.x,e.y,e.z,e.w);d.clear(16384)}else{this.renderBackTex(this.renderer.resourceManager.getResource(c.iBackTexId))}this.lightFbo.unbind()}};okRenderLightingStage.prototype.endView=function(){};okRenderLightingStage.prototype.render=function(f){var e=this.renderer.rc;var f=this.renderer.renderEnv;var c=this.renderer.renderSourceCollector;this.lightFbo.bind();f.camera.bindViewport();var d=c.getBatchList("Visible_Opaque");if(d.length>0){e.enable(2929);e.depthFunc(515);e.enable(2884);e.disable(3042);this._renderBatches(d,"Lighting",true,true)}var a=c.getBatchList("Visible_Trans");if(a.length>0){e.enable(3042);e.enable(2884);this._renderBatches(a,"Lighting",true,true);e.disable(3042)}this.lightFbo.unbind()};function okRenderPostStage(){okBaseCall(this);this.postTex=null;this.postTex_Half=null;this.dsBuffer_Half=null;this.postFbo=null}okExtend(okRenderPostStage,okRenderBaseStage);okRenderPostStage.prototype.createResource=function(){var c=this.renderer.rc;var d=this.renderer.renderEnv;var a=this.renderer.renderTargetCollector;if(this.postTex==null){this.postTex=new okTexture(c)}this.postTex.createTexture(3553,d.iCanvasWidth,d.iCanvasHeight,6408);if(this.postTex_Half==null){this.postTex_Half=new okTexture(c)}this.postTex_Half.createTexture(3553,Math.floor(d.iCanvasWidth*0.5),Math.floor(d.iCanvasHeight*0.5),6408);if(this.dsBuffer_Half==null){this.dsBuffer_Half=new okRenderBuffer(c)}this.dsBuffer_Half.createBuffer(34041,Math.floor(d.iCanvasWidth*0.5),Math.floor(d.iCanvasHeight*0.5));if(this.postFbo==null){this.postFbo=new okFrameBuffer(c)}this.postFbo.createBuffer()};okRenderPostStage.prototype.deleteResource=function(){var c=this.renderer.rc;var d=this.renderer.renderEnv;var a=this.renderer.renderTargetCollector;if(this.postTex){this.postTex.releaseTexture()}if(this.postTex_Half){this.postTex_Half.releaseTexture()}if(this.dsBuffer_Half){this.dsBuffer_Half.releaseBuffer()}if(this.postFbo){this.postFbo.releaseBuffer()}};okRenderPostStage.prototype.beginView=function(a){};okRenderPostStage.prototype.endView=function(){};okRenderPostStage.prototype.render=function(){var a=this.renderer.rc;var h=this.renderer.renderEnv;var p=this.renderer.shaderManager;var k=this.renderer.resourceManager;var d=this.renderer.renderSourceCollector;var q=this.renderer.renderTargetCollector;var n=h.camera;var l=h.iCanvasWidth;var o=h.iCanvasHeight;var f=k.getResource("$R$Quad");var m=f.getMesh();var c=d.getBatchList("Visible_Glow");if(c.length>0){this.postFbo.bind();this.postFbo.attachRenderTexture(0,this.postTex);this.postFbo.attachDepthStencilBuffer(q.getRenderTarget("DSBuf"));a.clearColor(0,0,0,0);a.clear(16384);a.enable(2929);a.depthFunc(515);n.bindViewport();this._renderBatches(c,"Glow",false,true,null,null,null,true);a.disable(2929);a.depthMask(false);this.postFbo.attachRenderTexture(0,this.postTex_Half);this.postFbo.attachDepthStencilBuffer(this.dsBuffer_Half);a.viewport(0,0,this.postTex_Half.getSizeU(),this.postTex_Half.getSizeV());var e=p.getGaussianProgram(0);e.bind();e.setAttribute("okAttr_Pos",m.getAttributeArrayBuffer("Position"),3);e.setUniformFloat2("okUni_TexelSize",1/this.postTex.getSizeU(),1/this.postTex.getSizeV());e.setUniformFloat4("okUni_ScreenPosOffsetAndScale",n.iViewportX/l,(o-n.iViewportY-n.iViewportHeight)/o,n.iViewportWidth/l,n.iViewportHeight/o);e.setTexture("okUni_Tex",this.postTex,33071,9729,9729);m.draw();a.enable(3042);a.blendEquation(32774);a.blendFunc(1,1);this.postFbo.attachRenderTexture(0,q.getRenderTarget("LTex"));this.postFbo.attachDepthStencilBuffer(q.getRenderTarget("DSBuf"));a.viewport(0,0,l,o);var e=p.getGaussianProgram(1);e.bind();e.setAttribute("okAttr_Pos",m.getAttributeArrayBuffer("Position"),3);e.setUniformFloat2("okUni_TexelSize",1/this.postTex_Half.getSizeU(),1/this.postTex_Half.getSizeV());e.setUniformFloat4("okUni_ScreenPosOffsetAndScale",0,0,1,1);e.setTexture("okUni_Tex",this.postTex_Half,33071,9729,9729);m.draw();this.postFbo.unbind();a.enable(2929);a.depthMask(true);a.disable(3042)}};function okAttribFormat(){this.sName="";this.iOffset=0;this.iStride=0;this.iSize=0;this.iIdx=0;this.buf=null}okAttribFormat.prototype={clear:function(){this.sName="";this.iOffset=0;this.iStride=0;this.iSize=0;this.buf=null}};function okRenderBatch(){this.aAttribFmt=okAllocator.object();this.index=null;this.iDrawMode=0;this.iDrawStart=0;this.iDrawCount=0;this.materialRef=null;this.mMatRef=null;this.mMatNRef=null;this.aDctLightListRef=null;this.aPointLightListRef=null;this.aSpotLightListRef=null;this.bboxRef=null;this.aBoneMatList=null;this.sBoneIdxAttribName=null;this.sBoneWeightAttribName=null;this.bReceiveShadow=true;this.bFaceCamera=false;this.aResourceIdList=new Array;this.fSortKey=0;this.sShdKeyV="";this.sShdKeyF="";this.sShdKeyP="";this.sShdKeyVS="";this.sShdKeyFS="";this.sShdKeyPS="";this.aShdDef=okAllocator.object();this.aShdDefS=okAllocator.object();this.bShdKeyDirty=true;this.bShdDefDirty=true}okRenderBatch.prototype={clear:function(){this.aAttribFmt=null;this.index=null;this.iDrawMode=0;this.iDrawStart=0;this.iDrawCount=0;this.materialRef=null;this.mMatRef=null;this.mMatNRef=null;this.aDctLightListRef=null;this.aPointLightListRef=null;this.aSpotLightListRef=null;this.aBoneMatList=null;this.sBoneIdxAttribName=null;this.sBoneWeightAttribName=null;this.bboxRef=null;this.bReceiveShadow=true;this.bFaceCamera=false;this.aResourceIdList.length=0;this.sShdKeyV="";this.sShdKeyF="";this.sShdKeyP="";this.sShdKeyVS="";this.sShdKeyFS="";this.sShdKeyPS="";for(var a in this.aShdDef){delete this.aShdDef[a]}for(var a in this.aShdDefS){delete this.aShdDefS[a]}this.bShdKeyDirty=true;this.bShdDefDirty=true;this.fSortKey=0},addResourceId:function(a){this.aResourceIdList.push(a)},_genShdKey:function(u){var x=this.materialRef;var a=this.aAttribFmt;var y=this.aDctLightListRef?this.aDctLightListRef.length:0;var z=this.aPointLightListRef?this.aPointLightListRef.length:0;var s=this.aSpotLightListRef?this.aSpotLightListRef.length:0;var c=u.bShadow&&!x.bWireframe&&this.bReceiveShadow&&u.aStageEnableList[1];var e=x._getShdKeyV();var l=x._getShdKeyF();var f=x._getShdKeyP();var v=a.Texcoord1;var t=a.Texcoord2;var q=a.Texcoord3;var p=a.Texcoord4;var o=(v?1:0)+(t?2:0)+(q?4:0)+(p?8:0)+((v&&t&&v.iIdx==(t.iIdx-1))?16:0)+((q&&p&&q.iIdx==(p.iIdx-1))?32:0);var h=0,w=0,m=0;var n=0,d=0,k=0;h=(this.aBoneMatList?1:0)+(this.bFaceCamera?2:0)+(a.Normal?4:0)+(a.Color?8:0);w=(a.Normal?1:0)+(a.Color?2:0)+(c?4:0)+(u.bFogEnable?8:0);m=(this.aBoneMatList?1:0)+(this.bFaceCamera?2:0)+(a.Normal?4:0)+(a.Color?8:0)+(c?16:0)+(u.bFogEnable?32:0);if(x.bAlphaTest){n=(this.aBoneMatList?1:0)+(this.bFaceCamera?2:0)+(a.Normal?4:0)+(a.Color?8:0);d=(a.Normal?1:0)+(a.Color?2:0);k=(this.aBoneMatList?1:0)+(this.bFaceCamera?2:0)+(a.Normal?4:0)+(a.Color?8:0)}else{n=(this.aBoneMatList?1:0)+(this.bFaceCamera?2:0);d=0;k=(this.aBoneMatList?1:0)+(this.bFaceCamera?2:0)}this.sShdKeyV="0"+e+"_"+o+"_"+h;this.sShdKeyF="0"+l+"_"+y+z+s+"_"+o+"_"+w;this.sShdKeyP="0"+f+"_"+y+z+s+"_"+o+"_"+m;if(x.bAlphaTest){this.sShdKeyVS="1"+e+"_"+o+"_"+n;this.sShdKeyFS="1"+l+"_"+o+"_"+d;this.sShdKeyPS="1"+f+"_"+o+"_"+k}else{this.sShdKeyVS="2"+n;this.sShdKeyFS="2"+d;this.sShdKeyPS="2"+k}},_genShdDef:function(h){var e=this.materialRef;var a=this.aAttribFmt;var q=this.aDctLightListRef?this.aDctLightListRef.length:0;var c=this.aPointLightListRef?this.aPointLightListRef.length:0;var d=this.aSpotLightListRef?this.aSpotLightListRef.length:0;var t=h.bShadow&&!e.bWireframe&&this.bReceiveShadow&&h.aStageEnableList[1];var m=a.Texcoord1;var l=a.Texcoord2;var k=a.Texcoord3;var f=a.Texcoord4;var v=(m?1:0)+(l?2:0)+(k?4:0)+(f?8:0)+((m&&l&&m.iIdx==(l.iIdx-1))?16:0)+((k&&f&&k.iIdx==(f.iIdx-1))?32:0);var p=this.aShdDef;e._getShdDef(p);p.OK_DCTLIGHT_NUM=q;p.OK_POINTLIGHT_NUM=c;p.OK_SPOTLIGHT_NUM=d;if(this.aBoneMatList){p.OK_SKANIMATION=1}if(this.bFaceCamera){p.OK_BILLBOARD=1}if(a.Normal){p.OK_NORMAL=1}if(a.Color){p.OK_VERTEX_COLOR=1}if(t){p.OK_DYNAMICSHADOW=1}if(!h.bFogEnable&&p.OK_FOG){delete p.OK_FOG}var o=okAllocator.object();if(v&16){p.OK_TC12=1;o.Texcoord1="okVary_TC12.xy";o.Texcoord2="okVary_TC12.zw"}else{if(v&1){p.OK_TC1=1;o.Texcoord1="okVary_TC1"}else{o.Texcoord1="vec2(0.0, 0.0)"}if(v&2){p.OK_TC2=1;o.Texcoord2="okVary_TC2"}else{o.Texcoord2="vec2(0.0, 0.0)"}}if(v&32){p.OK_TC34=1;o.Texcoord3="okVary_TC34.xy";o.Texcoord4="okVary_TC34.zw"}else{if(v&4){p.OK_TC3=1;o.Texcoord3="okVary_TC3"}else{o.Texcoord3="vec2(0.0, 0.0)"}if(v&8){p.OK_TC4=1;o.Texcoord4="okVary_TC4"}else{o.Texcoord4="vec2(0.0, 0.0)"}}if(o[e.aUvAttribList[0]]){p.OK_ALBEDO1_TC=o[e.aUvAttribList[0]]}if(o[e.aUvAttribList[1]]){p.OK_ALBEDO2_TC=o[e.aUvAttribList[1]]}if(o[e.aUvAttribList[2]]){p.OK_ALBEDO3_TC=o[e.aUvAttribList[2]]}if(o[e.aUvAttribList[3]]){p.OK_ALBEDO4_TC=o[e.aUvAttribList[3]]}if(o[e.aUvAttribList[4]]){p.OK_NORMALMAP_TC=o[e.aUvAttribList[4]]}if(o[e.aUvAttribList[5]]){p.OK_OPACITY_TC=o[e.aUvAttribList[5]]}if(o[e.aUvAttribList[6]]){p.OK_SPECULAR_LEVEL_TC=o[e.aUvAttribList[6]]}okAllocator._object(o);var n=this.aShdDefS;if(e.bAlphaTest){for(var u in this.aShdDef){n[u]=this.aShdDef[u]}}else{if(this.aBoneMatList){n.OK_SKANIMATION=1}if(this.bFaceCamera){n.OK_BILLBOARD=1}}},_getShdKeyV:function(a,c){if(this.bShdKeyDirty){this._genShdKey(a);this.bShdKeyDirty=false}return c?this.sShdKeyVS:this.sShdKeyV},_getShdKeyF:function(a,c){if(this.bShdKeyDirty){this._genShdKey(a);this.bShdKeyDirty=false}return c?this.sShdKeyFS:this.sShdKeyF},_getShdKeyP:function(a,c){if(this.bShdKeyDirty){this._genShdKey(a);this.bShdKeyDirty=false}return c?this.sShdKeyPS:this.sShdKeyP},_getShdDef:function(d,e,c){if(this.bShdDefDirty){this._genShdDef(d);this.bShdDefDirty=false}if(e){for(var a in this.aShdDefS){c[a]=this.aShdDefS[a]}}else{for(var a in this.aShdDef){c[a]=this.aShdDef[a]}}}};function okRenderSourceCollector(){this.aRenderEntityMap=new Object;this.aRenderBatchMap=new Object;this.aRenderBatchReleaseFlagMap=new Object;this.aLightListMap=new Object}okRenderSourceCollector.prototype={clear:function(){this.aRenderEntityMap=new Object;for(var d in this.aRenderBatchMap){var e=this.aRenderBatchMap[d];if(this.aRenderBatchReleaseFlagMap[d]==true){var a=e.length;for(var c=0;c<a;++c){okAllocator._renderBatch(e[c])}}e.length=0;delete this.aRenderBatchMap[d]}this.aRenderBatchReleaseFlagMap=new Object;this.aLightListMap=new Object},createEntityList:function(a){var c=new Array;this.aRenderEntityMap[a]=c;return c},clearEntityList:function(a){if(this.aRenderEntityMap[a]){this.aRenderEntityMap[a].length=0}},attachEntity:function(d,a,c){this.aRenderEntityMap[d].push(a)},genBatchList:function(e,l){var k=this.aRenderEntityMap[e];var f=l.camera;if(k!=null){var h=new Array;var d=k.length;for(var c=0;c<d;++c){var a=k[c];if(a.bVisible&&a.getState(f.getFrustum())!=1){a.genRenderBatch(h,l)}}this.aRenderBatchMap[e]=h;this.aRenderBatchReleaseFlagMap[e]=false}},sortBatchListByCamera:function(k,m,p){var o=m.camera;var e=this.aRenderBatchMap[k];var f=o.getPos();var a=e.length;for(var l=0;l<a;++l){var h=e[l];var q=h.bboxRef;var n=q.vMin;var s=q.vMax;var c=new okVec3((n.x+s.x)*0.5,(n.y+s.y)*0.5,(n.z+s.z)*0.5);h.fSortKey=okVec3Len(c,f)}var d=e.sort(p?this._N2FSortFunc:this._F2NSortFunc);this.aRenderBatchMap[k]=d},getEntityList:function(a){return this.aRenderEntityMap[a]},createBatchList:function(a){this.aRenderBatchReleaseFlagMap[a]=false;this.aRenderBatchMap[a]=okAllocator.array();return this.aRenderBatchMap[a]},getBatchList:function(a){return this.aRenderBatchMap[a]},enableReleaseBatch:function(c,a){this.aRenderBatchReleaseFlagMap[c]=a},createLightList:function(a){this.aLightListMap[a]=new Array},attachLight:function(c,a){this.aLightListMap[c].push(a)},getLightList:function(a){return this.aLightListMap[a]},_F2NSortFunc:function(d,c){return c.fSortKey-d.fSortKey},_N2FSortFunc:function(d,c){return d.fSortKey-c.fSortKey}};function okRenderTargetCollector(a){this.rc=a;this.aRenderTargetMap=new Object}okRenderTargetCollector.prototype={clear:function(){for(var a in this.aRenderTargetMap){delete this.aRenderTargetMap[a]}},setRenderTarget:function(c,a){this.aRenderTargetMap[c]=a},getRenderTarget:function(a){return this.aRenderTargetMap[a]},setFinalRenderTarget:function(){this.rc.bindFramebuffer(36160,null)}};function okRenderer(f,h){var c=f.canvas;this.rc=h.rc;this.ext=h.ext;this.engineInfo=h.engineInfo;this.resourceManager=h.resourceManager;this.sceneManager=h.sceneManager;this.shaderManager=new okShaderManager(this);this.renderSourceCollector=new okRenderSourceCollector();this.renderTargetCollector=new okRenderTargetCollector(this.rc);this.renderEnv=new okRenderEnvironment();this.renderEnv.canvas=c;this.renderEnv.iCanvasWidth=c.width;this.renderEnv.iCanvasHeight=c.height;this.renderEnv.iStartTime=(new Date).getTime();this.renderEnv.iCurTime=0;var o=this.resourceManager.createResource(1,"$R$Quad",true);this.resourceManager.setCustomResourceState(o,5);var e=this.resourceManager.getResource(o);okGenQuadMesh(e.createMesh("Quad"),-1,1,1,-1,false,true);var k=this.resourceManager.createResource(2,"$R$White",true);this.resourceManager.setCustomResourceState(k,5);this.resourceManager.getResource(k).createTexture(3553,1,1,6408,5121,[255,255,255,255]);var m=this.resourceManager.createResource(2,"$R$Black",true);this.resourceManager.setCustomResourceState(m,5);this.resourceManager.getResource(m).createTexture(3553,1,1,6408,5121,[0,0,0,0]);var l=this.resourceManager.createResource(2,"$R$WhiteCube",true);this.resourceManager.setCustomResourceState(l,5);this.resourceManager.getResource(l).createTexture(34067,1,1,6408,5121,[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255],[255,255,255,255]);var a=this.resourceManager.createResource(2,"$R$BlackCube",true);this.resourceManager.setCustomResourceState(a,5);this.resourceManager.getResource(a).createTexture(34067,1,1,6408,5121,[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]);this.targetFbo=new okFrameBuffer(this.rc);this.targetFbo.createBuffer();this.renderPipeline=[new okRenderDepthStage(),new okRenderShadowStage(),new okRenderLightingStage(),new okRenderPostStage()];var n=this.renderPipeline.length;for(var d=0;d<n;++d){this.renderPipeline[d].init(this)}this._createPipelineResource();for(var d=0;d<this.engineInfo.iTexNum;++d){this.rc.activeTexture(33984+d);this.rc.bindTexture(3553,null)}}okRenderer.prototype={clear:function(){this.shaderManager.clear();this.renderSourceCollector.clear();this.renderTargetCollector.clear();this.renderEnv.clear();this.resourceManager.deleteResource("$R$Quad");this.resourceManager.deleteResource("$R$White");this.resourceManager.deleteResource("$R$Black");this.resourceManager.deleteResource("$R$WhiteCube");this.resourceManager.deleteResource("$R$BlackCube");if(this.targetFbo){this.targetFbo.releaseBuffer();this.targetFbo=null}var c=this.renderPipeline.length;for(var a=0;a<c;++a){this.renderPipeline[a].clear()}},_createPipelineResource:function(){var c=this.renderPipeline.length;for(var a=0;a<c;++a){this.renderPipeline[a].createResource()}},_deletePipelineResource:function(){var c=this.renderPipeline.length;for(var a=0;a<c;++a){this.renderPipeline[a].init(this);this.renderPipeline[a].deleteResource()}},_onResize:function(){this.renderEnv.iCanvasWidth=this.renderEnv.canvas.width;this.renderEnv.iCanvasHeight=this.renderEnv.canvas.height;this._deletePipelineResource();this._createPipelineResource()},enableStage:function(c,a){this.renderPipeline[c].enable(a);this.renderEnv.aStageEnableList[c]=a},isStageEnabled:function(a){return this.renderEnv.aStageEnableList[a]},getRenderSourceCollector:function(){return this.renderSourceCollector},getRenderTargetCollector:function(){return this.renderTargetCollector},clearView:function(a,f,c,e){var d=this.rc;this.renderPipeline[2].lightFbo.bind();if(a&16384){if(f==null){f=this.renderEnv.camera.vBackColor}d.clearColor(f.x,f.y,f.z,f.w)}if(a&256){d.clearDepth(c?c:1)}if(a&1024){d.stencilFunc(519,e?e:0,4294967295)}d.clear(a)},beginView:function(f,d){var e=this.rc;var k=this.resourceManager;this.renderEnv.camera=f;e.enable(3089);f.bindViewport();var h=this.renderPipeline.length;for(var c=0;c<h;++c){var a=this.renderPipeline[c];a.beginView(d)}},endView:function(){var d=this.renderPipeline.length;for(var c=0;c<d;++c){var a=this.renderPipeline[c];a.endView()}this.renderEnv.camera=null},renderScene:function(f){this.renderEnv.scene=f;var d=this.renderSourceCollector;d.clear();f.getZone()._visCull(this.renderEnv.camera,d.createEntityList("Visible"));this._postCull();var e=this.renderPipeline.length;for(var c=0;c<e;++c){var a=this.renderPipeline[c];if(a.bEnable){a.render()}}this.renderEnv.scene=null},renderEntity:function(a){var h=this.renderSourceCollector;h.clear();var f=h.createEntityList("Visible");f.push(a);this._postCull();var d=this.renderEnv.aStageEnableList[1];this.enableStage(1,false);var k=this.renderPipeline.length;for(var e=0;e<k;++e){var c=this.renderPipeline[e];if(c.bEnable){c.render()}}this.enableStage(1,d)},renderEntityArray:function(l){var h=this.renderSourceCollector;h.clear();var f=h.createEntityList("Visible");var a=l.length;for(var e=0;e<a;++e){f.push(l[e])}this._postCull();var d=this.renderEnv.aStageEnableList[1];this.enableStage(1,false);var k=this.renderPipeline.length;for(var e=0;e<k;++e){var c=this.renderPipeline[e];if(c.bEnable){c.render()}}this.enableStage(1,d)},present:function(c){this.renderEnv.iCurTime=(new Date).getTime()-this.renderEnv.iStartTime;this.renderEnv.fRandom=Math.random();var a=this.rc;var k=this.renderEnv;var n=this.renderTargetCollector;var h=n.getRenderTarget("LTex");if(c==null){a.bindFramebuffer(36160,null);a.viewport(0,0,k.iCanvasWidth,k.iCanvasHeight);a.scissor(0,0,k.iCanvasWidth,k.iCanvasHeight)}else{this.targetFbo.bind();this.targetFbo.attachRenderTexture(0,c);var m=c.getSizeU(),d=c.getSizeV();a.viewport(0,0,m,d);a.scissor(0,0,m,d)}a.disable(2929);a.depthMask(false);a.disable(3042);var f=this.resourceManager.getResource("$R$Quad");var l=f.getMesh(0);var e=this.shaderManager.getOutputProgram();e.bind();e.setAttribute("okAttr_Pos",l.getAttributeArrayBuffer("Position"),3);e.setTexture("okUni_Tex",h,33071,9728);e.setUniformFloat4("okUni_DestOffsetScale",0,0,1,1);if(c==null){e.setUniformFloat4("okUni_SrcOffsetScale",0,0,1,1)}else{e.setUniformFloat4("okUni_SrcOffsetScale",0,0,c.getSizeU()/k.iCanvasWidth,c.getSizeV()/k.iCanvasHeight)}l.draw();a.enable(2929);a.depthMask(true);if(c){this.targetFbo.unbind()}if(this.renderEnv.iCanvasWidth!=this.renderEnv.canvas.width||this.renderEnv.iCanvasHeight!=this.renderEnv.canvas.height){this._onResize()}},setSceneConfig:function(a){a.vSkyColor.clone(this.renderEnv.vSkyColor);a.vGroundColor.clone(this.renderEnv.vGroundColor);this.renderEnv.bShadow=a.bShadow;this.renderEnv.bFogEnable=a.bFogEnable;a.vFogColor.clone(this.renderEnv.vFogColor);this.renderEnv.fFogDistNear=a.fFogDistNear;this.renderEnv.fFogDistFar=a.fFogDistFar;this.renderEnv.fFogDensity=a.fFogDensity;a.iFogMode=this.renderEnv.iFogMode},setSkyColor:function(d,c,a){if(c!=null){this.renderEnv.vSkyColor.set(d,c,a)}else{d.clone(this.renderEnv.vSkyColor)}},getSkyColor:function(){return this.renderEnv.vSkyColor},setGroundColor:function(d,c,a){if(c!=null){this.renderEnv.vGroundColor.set(d,c,a)}else{d.clone(this.renderEnv.vGroundColor)}},getGroundColor:function(){return this.renderEnv.vGroundColor},enableFog:function(c,a){this.renderEnv.bFogEnable=a},isFogEnabled:function(a){return this.renderEnv.bFogEnable},setFogColor:function(e,d,c,a){if(c==null){this.renderEnv.vFogColor.x=d.x;this.renderEnv.vFogColor.y=d.y;this.renderEnv.vFogColor.z=d.z}else{this.renderEnv.vFogColor.x=d;this.renderEnv.vFogColor.y=c;this.renderEnv.vFogColor.z=a}},getFogColor:function(a){var c=okAllocator.vec3();return this.renderEnv.vFogColor.clone(c)},setFogDistanceNear:function(c,a){this.renderEnv.fFogDistNear=Math.max(0.001,a)},setFogDistanceFar:function(c,a){this.renderEnv.fFogDistFar=Math.max(0.001,a)},getFogDistanceNear:function(a){return this.renderEnv.fFogDistNear},getFogDistanceFar:function(a){return this.renderEnv.fFogDistFar},setFogDensity:function(c,a){this.renderEnv.fFogDensity=a},getFogDensity:function(a){return this.renderEnv.fFogDensity},enableShadow:function(a){this.renderEnv.bShadow=a},isShadowEnabled:function(){return this.renderEnv.bShadow},_drawTexture:function(a){this.rc.bindFramebuffer(36160,null);this.rc.viewport(0,0,a.getSizeU(),a.getSizeV());this.rc.disable(2929);var e=this.resourceManager.getResource("$R$Quad");var d=e.getMesh();var c=this.shaderManager.getFlatColorProgram(true);c.bind();c.setUniformMat4("matWorld",okMat4Mul(okMat4Trans(0,0,-0.1),okMat4Scale(a.getSizeU()*0.5,a.getSizeV()*0.5,1)));c.setUniformMat4("matViewProj",okMat4Ortho(-a.getSizeU()*0.5,a.getSizeU()*0.5,a.getSizeV()*0.5,-a.getSizeV()*0.5,0.1,100));c.setAttribute("position",d.getAttributeArrayBuffer("Position"),3);c.setAttribute("texcoord",d.getAttributeArrayBuffer("Texcoord1"),2);c.setUniformFloat3("color",1,1,1);c.setSampler("texSampler",0);a.bind(0);this.rc.texParameteri(3553,10240,9728);this.rc.texParameteri(3553,10241,9728);this.rc.texParameteri(3553,10242,33071);this.rc.texParameteri(3553,10243,33071);d.draw()},_postCull:function(){var a=this.renderSourceCollector;a.genBatchList("Visible",this.renderEnv);a.enableReleaseBatch("Visible",true);var k=a.getBatchList("Visible");var d=a.createBatchList("Visible_Opaque");var l=a.createBatchList("Visible_Trans");var m=a.createBatchList("Visible_Glow");var c=k.length;for(var f=0;f<c;++f){var h=k[f];var e=h.materialRef;if(e.bBlend){l.push(h)}else{d.push(h)}if(e.bGlow){m.push(h)}}a.sortBatchListByCamera("Visible_Trans",this.renderEnv,0)}};function okEngineInfo(a){this.rc=a;this.sPlatform="";this.sBrowserAgent="";this.sBrowserVendor="";this.sWebGLVersion="";this.sGLSLVersion="";this.iAttributeNum=0;this.iUniformNum=0;this.iVaryingNum=0;this.iRedBits=0;this.iGreenBits=0;this.iBlueBits=0;this.iAlphaBits=0;this.iDepthBits=0;this.iTexNum=0;this.iVertexTexNum=0;this.iTexSize=0;this.iCubeTexSize=0;this.iViewportWidth=0;this.iViewportHeight=0;this.bFloatTex=false;this.bFloatRt=false}okEngineInfo.prototype={clear:function(){this.sPlatform="";this.sBrowserAgent="";this.sBrowserVendor="";this.sWebGLVersion="";this.sGLSLVersion="";this.iAttributeNum=0;this.iUniformNum=0;this.iVaryingNum=0;this.iRedBits=0;this.iGreenBits=0;this.iBlueBits=0;this.iAlphaBits=0;this.iDepthBits=0;this.iTexNum=0;this.iVertexTexNum=0;this.iTexSize=0;this.iCubeTexSize=0;this.iViewportWidth=0;this.iViewportHeight=0;this.bFloatTex=false;this.bFloatRt=false},init:function(){var k=this.rc;this.sPlatform=navigator.platform;this.sBrowserAgent=navigator.userAgent;this.sBrowserVendor=k.getParameter(7936);var c=k.getParameter(7936);this.sWebGLVersion=c.substr(6,(c.indexOf(" ",6)!=-1)?c.indexOf(" ",6)-6:null);var c=k.getParameter(35724);this.sGLSLVersion=c.substr(6,(c.indexOf(" ",14)!=-1)?c.indexOf(" ",14)-14:null);var e=k.getSupportedExtensions();this.iAttributeNum=k.getParameter(34921);this.iUniformNum=k.getParameter(36347);this.iVaryingNum=k.getParameter(36348);this.iRedBits=k.getParameter(3410);this.iGreenBits=k.getParameter(3411);this.iBlueBits=k.getParameter(3412);this.iAlphaBits=k.getParameter(3413);this.iDepthBits=k.getParameter(3414);this.iTexNum=k.getParameter(35661);this.iVertexTexNum=k.getParameter(35660);this.iTexSize=k.getParameter(3379);this.iCubeTexSize=k.getParameter(34076);this.iViewportWidth=k.getParameter(3386)[0];this.iViewportHeight=k.getParameter(3386)[1];this.bFloatTex=false;for(var d=0;d<e.length;++d){if(e[d]=="OES_texture_float"){this.bFloatTex=true;break}}if(this.sPlatform.indexOf("Mac")!=-1){this.bFloatTex=false}this.bFloatRt=false;if(this.bFloatTex){var a=new okTexture(k);a.createTexture(3553,2,2,6408,5126);var h=new okRenderBuffer(k);h.createBuffer(34041,2,2);var f=new okFrameBuffer(k);f.createBuffer();f.bind();f.attachRenderTexture(0,a);f.attachDepthStencilBuffer(h);if(k.checkFramebufferStatus(36160)==36053){this.bFloatRt=true}f.unbind();f.releaseBuffer();h.releaseBuffer();a.releaseTexture()}},getPlatform:function(){return this.sPlatform},getBrowserAgent:function(){return this.sBrowserAgent},getBrowserVendor:function(){return this.sBrowserVendor},getWebGLVersion:function(){return this.sWebGLVersion},getGLSLVersion:function(){return this.sGLSLVersion},getShaderAttributeMaxNum:function(){return this.iAttributeNum},getShaderUniformMaxNum:function(){return this.iUniformNum},getShaderVaryingMaxNum:function(){return this.iVaryingNum},getRedBits:function(){return this.iRedBits},getGreenBits:function(){return this.iGreenBits},getBlueBits:function(){return this.iBlueBits},getAlphaBits:function(){return this.iAlphaBits},getDepthBits:function(){return this.iDepthBits},getShaderTextureMaxNum:function(){return this.iTexNum},getShaderVertexTextureMaxNum:function(){return this.iVertexTexNum},getTextureMaxSize:function(){return this.iTexSize},getCubeMapTextureMaxSize:function(){return this.iCubeTexSize},getViewportMaxWidth:function(){return this.iViewportWidth},getViewportMaxHeight:function(){return this.iViewportHeight},isFloatTextureSupported:function(){return this.bFloatTex},isFloatRenderTargetSupported:function(){return this.bFloatRt=false}};function okEngineSetting(){this.canvas=null;this.bAntiAlias=false;this.bAsyncLoad=false}function okEngine(){this.canvas=null;this.rc=null;this.ext=null;this.engineInfo=null;this.resourceManager=null;this.sceneManager=null;this.renderer=null;this.bInitializaed=false}okEngine.prototype={init:function(c){this.clear();if(c==null){return false}var a=null;try{a=c.canvas.getContext("experimental-webgl",{antialias:c.bAntiAlias,stencil:true});if(a==null){a=c.canvas.getContext("webgl",{antialias:c.bAntiAlias,stencil:true})}}catch(d){}if(!a){return false}this.canvas=c.canvas;this.rc=a;this.ext=new okExtension(this.rc);this.engineInfo=new okEngineInfo(this.rc);this.engineInfo.init();this.resourceManager=new okResourceManager(c,this.rc);this.sceneManager=new okSceneManager(c,this.resourceManager);this.renderer=new okRenderer(c,this);this.bInitializaed=true;return true},clear:function(){if(this.ext){this.ext=null}if(this.engineInfo){this.engineInfo.clear();this.engineInfo=null}if(this.sceneManager){this.sceneManager.clear();this.sceneManager=null}if(this.renderer){this.renderer.clear();this.renderer=null}if(this.resourceManager){this.resourceManager.clear();this.resourceManager=null}this.rc=null;this.canvas=null;this.bInitializaed=false},getCanvas:function(){return this.canvas},getRenderContext:function(){return this.rc},getEngineInfo:function(){return this.engineInfo},getSceneManager:function(){return this.sceneManager},getResourceManager:function(){return this.resourceManager},getRenderer:function(){return this.renderer}};